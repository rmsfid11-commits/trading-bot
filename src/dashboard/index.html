<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="íŠ¸ë ˆì´ë”©">
  <meta name="theme-color" content="#0B0E11">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <title>íŠ¸ë ˆì´ë”© ë´‡</title>
  <style>
    :root {
      --bg-primary: #0B0E11;
      --bg-secondary: #12161C;
      --bg-card: rgba(255,255,255,.03);
      --bg-card-hover: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.06);
      --border-active: rgba(99,102,241,.4);
      --text-primary: #EAECEF;
      --text-secondary: #848E9C;
      --text-tertiary: #5E6673;
      --accent: #6366f1;
      --accent-dim: rgba(99,102,241,.15);
      --green: #0ECB81;
      --green-dim: rgba(14,203,129,.12);
      --red: #F6465D;
      --red-dim: rgba(246,70,93,.12);
      --yellow: #FCD535;
      --yellow-dim: rgba(252,213,53,.12);
      --radius-sm: 10px;
      --radius-md: 16px;
      --radius-lg: 22px;
      --radius-xl: 28px;
      --nav-h: 64px;
      --safe-b: env(safe-area-inset-bottom, 0px);
    }
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}

    /* === Layout === */
    .app{max-width:430px;margin:0 auto;position:relative;min-height:100dvh;display:flex;flex-direction:column}
    .tab-content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:calc(var(--nav-h) + var(--safe-b) + 16px)}
    .tab-panel{display:none;padding:0 20px}
    .tab-panel.active{display:block}

    /* === Bottom Nav === */
    .bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:rgba(11,14,17,.92);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);padding:6px 0 calc(6px + var(--safe-b));z-index:100;display:flex}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;cursor:pointer;transition:all .2s;-webkit-user-select:none}
    .nav-item svg{width:22px;height:22px;stroke:var(--text-tertiary);fill:none;stroke-width:1.8;transition:all .2s}
    .nav-item span{font-size:10px;font-weight:600;color:var(--text-tertiary);transition:all .2s}
    .nav-item.active svg{stroke:var(--accent)}.nav-item.active span{color:var(--accent)}

    /* === Common === */
    .glass{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden}
    .section-gap{margin-bottom:16px}
    .section-head{display:flex;align-items:center;justify-content:space-between;padding:20px 20px 0}
    .section-head h2{font-size:13px;font-weight:700;color:var(--text-secondary);letter-spacing:.3px}
    .section-head .badge{font-size:11px;font-weight:600;color:var(--text-tertiary)}

    /* === Status Bar === */
    .status-bar{display:flex;align-items:center;justify-content:space-between;padding:14px 20px}
    .status-left{display:flex;align-items:center;gap:8px}
    .status-dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
    .status-dot.off{background:var(--red);animation:none}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
    .status-label{font-size:13px;font-weight:600;color:var(--text-primary)}
    .status-right{font-size:11px;color:var(--text-tertiary);font-weight:500}

    /* === HOME TAB === */
    .home-hero{padding:28px 20px 24px;text-align:center}
    .hero-label{font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px}
    .hero-amount{font-size:44px;font-weight:900;letter-spacing:-2px;transition:color .4s}
    .hero-sub{margin-top:8px;display:inline-flex;align-items:center;gap:5px;font-size:13px;font-weight:700;padding:5px 14px;border-radius:20px}
    .hero-sub.up{color:var(--green);background:var(--green-dim)}
    .hero-sub.down{color:var(--red);background:var(--red-dim)}
    .hero-sub.zero{color:var(--text-tertiary);background:rgba(255,255,255,.04)}
    .hero-chart{height:56px;margin-top:16px;padding:0 20px}
    .hero-chart svg{width:100%;height:100%}

    /* Stats row */
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);border-radius:var(--radius-md);overflow:hidden;margin:0 20px 16px}
    .stat-cell{background:var(--bg-secondary);padding:14px 8px;text-align:center}
    .stat-val{font-size:17px;font-weight:800}
    .stat-label{font-size:10px;color:var(--text-tertiary);margin-top:3px;font-weight:500}

    /* Bot card */
    .bot-card{margin:0 20px 16px;padding:16px 18px;display:flex;align-items:center;gap:14px}
    .bot-icon{width:44px;height:44px;border-radius:14px;background:var(--accent-dim);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
    .bot-info{flex:1;min-width:0}
    .bot-title{font-size:14px;font-weight:700;line-height:1.3}
    .bot-desc{font-size:12px;color:var(--text-secondary);margin-top:1px}

    /* Position cards */
    .pos-list{padding:0 20px;display:flex;flex-direction:column;gap:10px;margin-bottom:16px}
    .pos-card{padding:16px 18px;cursor:pointer;transition:all .15s;-webkit-user-select:none}
    .pos-card:active{transform:scale(.98);background:var(--bg-card-hover)}
    .pos-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .pos-symbol{display:flex;align-items:center;gap:8px}
    .pos-symbol .icon{width:32px;height:32px;border-radius:50%;background:var(--accent-dim);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:900;color:var(--accent)}
    .pos-symbol .name{font-size:15px;font-weight:800}
    .pos-pnl{font-size:16px;font-weight:800}
    .pos-pnl.up{color:var(--green)}.pos-pnl.down{color:var(--red)}
    .pos-detail{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:12px}
    .pos-amount{font-size:12px;color:var(--text-secondary)}
    .pos-amount b{color:var(--text-primary);font-weight:700}
    .pos-price{font-size:18px;font-weight:800}

    /* PnL bar */
    .pnl-bar{position:relative;height:5px;border-radius:3px;background:rgba(255,255,255,.05)}
    .pnl-bar-fill{position:absolute;top:0;left:0;height:100%;border-radius:3px;transition:width .5s ease}
    .pnl-bar-fill.up{background:linear-gradient(90deg,var(--accent),var(--green))}
    .pnl-bar-fill.down{background:linear-gradient(90deg,var(--red),var(--accent))}
    .pnl-bar-dot{position:absolute;top:-3.5px;width:12px;height:12px;border-radius:50%;border:2.5px solid var(--bg-primary);transition:left .5s ease}
    .pnl-bar-dot.up{background:var(--green)}.pnl-bar-dot.down{background:var(--red)}
    .pnl-labels{display:flex;justify-content:space-between;margin-top:5px;font-size:9px;color:var(--text-tertiary);font-weight:500}
    .pos-meta{display:flex;gap:14px;margin-top:10px;font-size:11px;color:var(--text-tertiary)}
    .pos-meta b{color:var(--text-secondary);font-weight:600}
    .pos-empty{text-align:center;padding:36px 20px;color:var(--text-tertiary)}
    .pos-empty .ico{font-size:36px;margin-bottom:8px}
    .pos-empty p{font-size:13px;line-height:1.5}

    /* === MARKET TAB === */
    .market-list{padding:0 20px;display:flex;flex-direction:column}
    .market-row{display:flex;align-items:center;padding:14px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;gap:12px}
    .market-row:last-child{border:none}
    .market-row:active{background:var(--bg-card-hover);margin:0 -8px;padding:14px 8px;border-radius:var(--radius-sm)}
    .mkt-icon{width:36px;height:36px;border-radius:50%;background:var(--bg-card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900;color:var(--text-primary);flex-shrink:0}
    .mkt-info{flex:1;min-width:0}
    .mkt-name{font-size:14px;font-weight:700}
    .mkt-vol{font-size:11px;color:var(--text-tertiary);margin-top:1px}
    .mkt-signal{font-size:9px;font-weight:700;padding:2px 7px;border-radius:6px;margin-left:4px}
    .mkt-signal.BUY{background:var(--green-dim);color:var(--green)}
    .mkt-signal.SELL{background:var(--red-dim);color:var(--red)}
    .mkt-signal.HOLD{background:rgba(255,255,255,.04);color:var(--text-tertiary)}
    .mkt-patterns{font-size:10px;color:var(--text-secondary);margin-top:2px;line-height:1.4}
    .mkt-mtf{font-size:9px;font-weight:700;padding:2px 6px;border-radius:6px;margin-left:4px}
    .mkt-mtf.buy{background:var(--green-dim);color:var(--green)}
    .mkt-mtf.sell{background:var(--red-dim);color:var(--red)}
    .mkt-mtf.neutral{background:rgba(255,255,255,.04);color:var(--text-tertiary)}
    .mkt-score{font-size:9px;color:var(--text-tertiary);margin-left:4px}
    .dd-bar{display:flex;align-items:center;gap:8px;padding:12px 20px;font-size:11px;color:var(--text-secondary)}
    .dd-item{display:flex;align-items:center;gap:4px}
    .dd-item b{font-weight:700;color:var(--text-primary)}
    .pos-badges{display:flex;gap:4px;margin-top:6px}
    .pos-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:6px}
    .pos-badge.dca{background:var(--yellow-dim);color:var(--yellow)}
    .pos-badge.partial{background:var(--accent-dim);color:var(--accent)}
    .sent-bar{display:flex;align-items:center;gap:6px;padding:8px 20px;margin-bottom:8px}
    .sent-pill{font-size:10px;font-weight:700;padding:3px 8px;border-radius:8px;display:flex;align-items:center;gap:4px}
    .sent-pill.bullish{background:var(--green-dim);color:var(--green)}
    .sent-pill.bearish{background:var(--red-dim);color:var(--red)}
    .sent-pill.neutral{background:rgba(255,255,255,.04);color:var(--text-tertiary)}
    .sent-pill .ico{font-size:12px}
    .fg-gauge{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;border:3px solid}
    .mkt-right{text-align:right;flex-shrink:0}
    .mkt-price{font-size:14px;font-weight:700;transition:color .3s}
    .mkt-price.fg{color:var(--green)}.mkt-price.fr{color:var(--red)}
    .mkt-change{font-size:11px;font-weight:600;margin-top:1px}
    .mkt-change.up{color:var(--green)}.mkt-change.down{color:var(--red)}
    .mkt-spark{width:60px;height:24px;flex-shrink:0}
    .mkt-spark svg{width:100%;height:100%}

    /* === HISTORY TAB === */
    .history-summary{margin:0 20px 16px;padding:18px;display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);border-radius:var(--radius-md);overflow:hidden}
    .hs-cell{background:var(--bg-secondary);padding:14px 10px;text-align:center}
    .hs-val{font-size:18px;font-weight:800}
    .hs-label{font-size:10px;color:var(--text-tertiary);margin-top:3px}

    .trade-list{padding:0 20px}
    .trade-item{display:flex;align-items:center;gap:12px;padding:13px 0;border-bottom:1px solid var(--border)}
    .trade-item:last-child{border:none}
    .trade-icon{width:34px;height:34px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
    .trade-icon.buy{background:var(--green-dim)}.trade-icon.sell{background:var(--red-dim)}.trade-icon.win{background:var(--green-dim)}
    .trade-info{flex:1;min-width:0}
    .trade-main{font-size:13px;font-weight:600;line-height:1.4}
    .trade-main b{font-weight:700}
    .trade-sub{font-size:11px;color:var(--text-tertiary);margin-top:1px}
    .trade-right{text-align:right;flex-shrink:0}
    .trade-amt{font-size:13px;font-weight:700}
    .trade-pnl{font-size:11px;font-weight:600;margin-top:1px}
    .trade-pnl.up{color:var(--green)}.trade-pnl.down{color:var(--red)}

    /* === LOG TAB === */
    .log-container{padding:0 20px}
    .log-box{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-md);padding:14px;max-height:calc(100dvh - 180px);overflow-y:auto;font-family:'SF Mono','Fira Code',monospace;font-size:10.5px;line-height:2;scrollbar-width:thin;scrollbar-color:#222 transparent}
    .log-box::-webkit-scrollbar{width:3px}.log-box::-webkit-scrollbar-thumb{background:#333;border-radius:2px}
    .log-l{opacity:.85}.log-l .t{color:var(--text-tertiary)}.log-l .tag{font-weight:700}
    .log-l.INFO .tag{color:#06b6d4}.log-l.WARN .tag{color:#f59e0b}.log-l.ERROR .tag{color:var(--red)}.log-l.TRADE .tag{color:var(--yellow)}

    /* === Modal === */
    .modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:200;display:none;align-items:flex-end;justify-content:center}
    .modal-bg.open{display:flex}
    .modal-sheet{background:var(--bg-secondary);border-radius:var(--radius-xl) var(--radius-xl) 0 0;width:100%;max-width:430px;max-height:85vh;overflow-y:auto;padding:12px 20px calc(32px + var(--safe-b));animation:slideUp .3s ease}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .modal-handle{width:36px;height:4px;background:var(--text-tertiary);border-radius:2px;margin:0 auto 16px;opacity:.4}
    .modal-title{text-align:center;font-size:18px;font-weight:800;margin-bottom:4px}
    .modal-subtitle{text-align:center;font-size:11px;color:var(--text-tertiary);margin-bottom:16px}
    .chart-legend{display:flex;gap:12px;justify-content:center;font-size:10px;color:var(--text-secondary);margin-bottom:12px}
    .chart-legend span{display:flex;align-items:center;gap:4px}
    .chart-legend .dot{width:8px;height:3px;border-radius:1px}
    .chart-area{width:100%;height:260px;margin-bottom:16px}
    .chart-area canvas{width:100%!important;height:100%!important}
    .modal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .modal-cell{text-align:center;padding:14px 8px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md)}
    .modal-cell .v{font-size:16px;font-weight:800}
    .modal-cell .l{font-size:10px;color:var(--text-tertiary);margin-top:3px}

    /* === Toast === */
    .toast-wrap{position:fixed;top:12px;left:50%;transform:translateX(-50%);z-index:999;display:flex;flex-direction:column;gap:8px;pointer-events:none;max-width:400px;width:90%}
    .toast{padding:14px 18px;border-radius:var(--radius-md);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);animation:fadeIn .3s ease,fadeOut .3s ease 3.7s forwards;display:flex;align-items:center;gap:10px;font-size:13px;font-weight:600;pointer-events:auto}
    .toast.buy{background:var(--green-dim);border:1px solid rgba(14,203,129,.25);color:var(--green)}
    .toast.win{background:var(--green-dim);border:1px solid rgba(14,203,129,.25);color:var(--green)}
    .toast.loss{background:var(--red-dim);border:1px solid rgba(246,70,93,.25);color:var(--red)}
    .toast .ti{font-size:20px}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeOut{to{opacity:0;transform:translateY(-8px)}}

    /* Sound toggle */
    .sound-toggle{background:none;border:none;font-size:18px;cursor:pointer;padding:4px 6px;border-radius:8px;transition:background .15s}
    .sound-toggle:active{background:var(--bg-card-hover)}

    /* Portfolio hero sub */
    .hero-portfolio{display:flex;align-items:center;justify-content:center;gap:6px;font-size:12px;font-weight:600;color:var(--text-secondary);margin-top:8px}
    .hero-portfolio .arrow{color:var(--text-tertiary)}

    /* RSI badge */
    .rsi-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:6px;margin-left:4px}
    .rsi-badge.oversold{background:var(--green-dim);color:var(--green)}
    .rsi-badge.low{background:var(--green-dim);color:var(--green)}
    .rsi-badge.neutral{background:rgba(255,255,255,.04);color:var(--text-tertiary)}
    .rsi-badge.high{background:var(--red-dim);color:var(--red)}
    .rsi-badge.overbought{background:var(--red-dim);color:var(--red)}

    /* === LEARNING TAB === */
    .learn-header{padding:0 20px;margin-bottom:16px}
    .learn-header .conf{display:flex;align-items:center;gap:8px;margin-top:8px}
    .conf-bar{flex:1;height:6px;border-radius:3px;background:rgba(255,255,255,.06);overflow:hidden}
    .conf-fill{height:100%;border-radius:3px;transition:width .5s}
    .conf-label{font-size:11px;font-weight:700;min-width:36px;text-align:right}

    .learn-section{margin:0 20px 16px}
    .learn-section h3{font-size:12px;font-weight:700;color:var(--text-secondary);margin-bottom:10px;letter-spacing:.3px}

    .symbol-table{width:100%;border-collapse:collapse}
    .symbol-table th{font-size:10px;color:var(--text-tertiary);font-weight:600;text-align:left;padding:6px 8px;border-bottom:1px solid var(--border)}
    .symbol-table td{font-size:12px;padding:8px;border-bottom:1px solid var(--border)}
    .symbol-table tr:last-child td{border:none}

    .hour-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:3px}
    .hour-cell{text-align:center;padding:6px 2px;border-radius:6px;font-size:9px;font-weight:700;line-height:1.4}
    .hour-cell .h{color:var(--text-tertiary);font-weight:500}

    .param-list{display:flex;flex-direction:column;gap:6px}
    .param-row{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm)}
    .param-name{font-size:12px;font-weight:600;color:var(--text-secondary)}
    .param-val{font-size:13px;font-weight:800}

    .bl-list{display:flex;flex-wrap:wrap;gap:6px}
    .bl-chip{font-size:11px;font-weight:700;padding:4px 10px;border-radius:8px;background:var(--red-dim);color:var(--red)}

    .learn-btn{width:100%;padding:14px;border:none;border-radius:var(--radius-md);background:var(--accent);color:#fff;font-size:14px;font-weight:700;cursor:pointer;transition:all .15s;margin-top:8px}
    .learn-btn:active{transform:scale(.98);opacity:.8}
    .learn-btn:disabled{opacity:.4;cursor:not-allowed}
    .learn-meta{font-size:11px;color:var(--text-tertiary);text-align:center;margin-top:8px}

    @media(max-width:360px){.hero-amount{font-size:36px}.stats-row{grid-template-columns:repeat(2,1fr)}.hour-grid{grid-template-columns:repeat(8,1fr)}}
  </style>
</head>
<body>
<div class="app">
  <div class="toast-wrap" id="toasts"></div>

  <!-- Modal -->
  <div class="modal-bg" id="modal" onclick="if(event.target===this)closeModal()">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-title" id="mTitle">-</div>
      <div class="modal-subtitle">5ë¶„ë´‰ ì°¨íŠ¸ - ìµœê·¼ 5ì‹œê°„</div>
      <div class="chart-legend">
        <span><span class="dot" style="background:var(--green)"></span>ì–‘ë´‰</span>
        <span><span class="dot" style="background:var(--red)"></span>ìŒë´‰</span>
        <span><span class="dot" style="background:rgba(99,102,241,.5)"></span>ë³¼ë¦°ì €</span>
        <span><span class="dot" style="background:var(--yellow)"></span>ì§„ì…ê°€</span>
      </div>
      <div class="chart-area"><canvas id="cc"></canvas></div>
      <div class="modal-grid" id="mStats"></div>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- HOME -->
    <div class="tab-panel active" id="panelHome">
      <div class="status-bar">
        <div class="status-left"><div class="status-dot" id="sDot"></div><span class="status-label" id="sLabel">ìë™ë§¤ë§¤ ì¤‘</span></div>
        <div class="status-right"><span id="sRight">-</span> <button class="sound-toggle" id="soundBtn" onclick="toggleSound()" title="ì•Œë¦¼ìŒ ON/OFF">ğŸ”Š</button></div>
      </div>

      <div class="sent-bar" id="sentBar" style="display:none"></div>
      <div class="home-hero">
        <div class="hero-label">ì˜¤ëŠ˜ ìˆ˜ìµ</div>
        <div class="hero-amount" id="heroAmt" style="color:var(--text-tertiary)">0ì›</div>
        <div class="hero-sub zero" id="heroBadge">ì•„ì§ ë³€ë™ ì—†ìŒ</div>
        <div class="hero-portfolio" id="heroPortfolio" style="display:none"></div>
      </div>
      <div class="hero-chart" id="heroChart"></div>

      <div class="stats-row" id="statsRow">
        <div class="stat-cell"><div class="stat-val" id="stWin">0</div><div class="stat-label">ìŠ¹</div></div>
        <div class="stat-cell"><div class="stat-val" id="stLoss">0</div><div class="stat-label">íŒ¨</div></div>
        <div class="stat-cell"><div class="stat-val" id="stRate">0%</div><div class="stat-label">ìŠ¹ë¥ </div></div>
        <div class="stat-cell"><div class="stat-val" id="stTrades">0</div><div class="stat-label">ë§¤ë§¤</div></div>
      </div>

      <div class="bot-card glass section-gap" id="botCard">
        <div class="bot-icon">ğŸ¤–</div>
        <div class="bot-info">
          <div class="bot-title" id="botTitle">ì‹œì¥ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”</div>
          <div class="bot-desc" id="botDesc">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
        </div>
      </div>

      <div class="dd-bar" id="ddBar" style="display:none"></div>
      <div style="padding:0 20px"><h2 style="font-size:13px;font-weight:700;color:var(--text-secondary);margin-bottom:12px">ë³´ìœ  ì½”ì¸</h2></div>
      <div class="pos-list" id="posList">
        <div class="pos-empty glass"><div class="ico">ğŸ”</div><p>ì•„ì§ ë§¤ìˆ˜í•œ ì½”ì¸ì´ ì—†ì–´ìš”<br>ë´‡ì´ ì¢‹ì€ íƒ€ì´ë°ì„ ì°¾ê³  ìˆì–´ìš”</p></div>
      </div>

      <div style="padding:0 20px"><h2 style="font-size:13px;font-weight:700;color:var(--text-secondary);margin-bottom:12px">ìµœê·¼ í™œë™</h2></div>
      <div id="feedList" style="padding:0 20px;margin-bottom:16px">
        <div class="trade-item"><div class="trade-icon buy">ğŸ”</div><div class="trade-info"><div class="trade-main">ë´‡ì´ ì‹œì‘ë˜ì—ˆì–´ìš”</div><div class="trade-sub">ë§¤ìˆ˜ ì‹œê·¸ë„ ëŒ€ê¸° ì¤‘</div></div></div>
      </div>
    </div>

    <!-- MARKET -->
    <div class="tab-panel" id="panelMarket">
      <div class="status-bar"><div class="status-left"><span class="status-label">ì‹œì¥ í˜„í™©</span></div><div class="status-right" id="mktTime">-</div></div>
      <div class="market-list" id="marketList"></div>
    </div>

    <!-- HISTORY -->
    <div class="tab-panel" id="panelHistory">
      <div class="status-bar"><div class="status-left"><span class="status-label">ë§¤ë§¤ ê¸°ë¡</span></div><div class="status-right">ì˜¤ëŠ˜</div></div>
      <div class="history-summary" id="histSummary">
        <div class="hs-cell"><div class="hs-val" style="color:var(--green)" id="hWin">0</div><div class="hs-label">ìŠ¹ë¦¬</div></div>
        <div class="hs-cell"><div class="hs-val" style="color:var(--red)" id="hLoss">0</div><div class="hs-label">íŒ¨ë°°</div></div>
        <div class="hs-cell"><div class="hs-val" id="hTotal">0ì›</div><div class="hs-label">ì‹¤í˜„ ì†ìµ</div></div>
      </div>
      <div class="trade-list" id="histList"></div>
    </div>

    <!-- LOG -->
    <div class="tab-panel" id="panelLog">
      <div class="status-bar"><div class="status-left"><span class="status-label">ì‹¤ì‹œê°„ ë¡œê·¸</span></div><div class="status-right" id="logCount">0ê±´</div></div>
      <div class="log-container"><div class="log-box" id="logBox"></div></div>
    </div>

    <!-- LEARNING -->
    <div class="tab-panel" id="panelLearn">
      <div class="status-bar"><div class="status-left"><span class="status-label">ìê°€í•™ìŠµ</span></div><div class="status-right" id="learnRight">-</div></div>

      <div class="learn-header">
        <div class="conf">
          <span style="font-size:11px;color:var(--text-secondary);font-weight:600">ì‹ ë¢°ë„</span>
          <div class="conf-bar"><div class="conf-fill" id="confFill" style="width:0%;background:var(--text-tertiary)"></div></div>
          <span class="conf-label" id="confLabel">-</span>
        </div>
      </div>

      <div class="learn-section">
        <h3>ì¢…ëª©ë³„ ì„±ì í‘œ</h3>
        <div class="glass" style="overflow-x:auto;padding:4px">
          <table class="symbol-table" id="learnSymTable">
            <thead><tr><th>ì¢…ëª©</th><th>ê±°ë˜</th><th>ìŠ¹ë¥ </th><th>í‰ê· </th><th>ì ìˆ˜</th></tr></thead>
            <tbody id="learnSymBody"><tr><td colspan="5" style="text-align:center;color:var(--text-tertiary);padding:20px">ë°ì´í„° ì—†ìŒ</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="learn-section">
        <h3>ì‹œê°„ëŒ€ë³„ ìˆ˜ìµë¥ </h3>
        <div class="hour-grid" id="hourGrid"></div>
      </div>

      <div class="learn-section">
        <h3>ì ìš© ì¤‘ì¸ íŒŒë¼ë¯¸í„°</h3>
        <div class="param-list" id="paramList"></div>
      </div>

      <div class="learn-section" id="blSection" style="display:none">
        <h3>ë¸”ë™ë¦¬ìŠ¤íŠ¸</h3>
        <div class="bl-list" id="blList"></div>
      </div>

      <div class="learn-section">
        <button class="learn-btn" id="learnBtn" onclick="triggerLearning()">ì§€ê¸ˆ í•™ìŠµ ì‹¤í–‰</button>
        <div class="learn-meta" id="learnMeta">-</div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('Home')">
      <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span>í™ˆ</span>
    </div>
    <div class="nav-item" onclick="switchTab('Market')">
      <svg viewBox="0 0 24 24"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
      <span>ì‹œì¥</span>
    </div>
    <div class="nav-item" onclick="switchTab('History')">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <span>ê¸°ë¡</span>
    </div>
    <div class="nav-item" onclick="switchTab('Log')">
      <svg viewBox="0 0 24 24"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
      <span>ë¡œê·¸</span>
    </div>
    <div class="nav-item" onclick="switchTab('Learn')">
      <svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      <span>í•™ìŠµ</span>
    </div>
  </div>
</div>

<script>
let ws, prevPrices={}, logN=0, animPnl=0, lastData=null;
const audio = new (window.AudioContext||window.webkitAudioContext)();
let soundOn = localStorage.getItem('soundOn') !== 'false';

function updateSoundBtn(){
  const btn=document.getElementById('soundBtn');
  btn.textContent=soundOn?'ğŸ”Š':'ğŸ”‡';
}
function toggleSound(){
  soundOn=!soundOn;
  localStorage.setItem('soundOn',soundOn?'true':'false');
  updateSoundBtn();
}
document.addEventListener('DOMContentLoaded',updateSoundBtn);

function getRsiBadge(rsi){
  if(rsi==null)return'';
  const val=Math.round(rsi);
  let cls;
  if(rsi<30)cls='oversold';else if(rsi<40)cls='low';else if(rsi<=60)cls='neutral';else if(rsi<=70)cls='high';else cls='overbought';
  const label=rsi<30?'ê³¼ë§¤ë„':rsi>70?'ê³¼ë§¤ìˆ˜':val;
  return`<span class="rsi-badge ${cls}">RSI ${label}</span>`;
}

function switchTab(name){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('panel'+name).classList.add('active');
  event.currentTarget.classList.add('active');
}

function beep(type){
  try{
    const o=audio.createOscillator(),g=audio.createGain();
    o.connect(g);g.connect(audio.destination);g.gain.value=.05;
    if(type==='buy'){o.frequency.value=660;o.type='sine';g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.2);o.start();o.stop(audio.currentTime+.2)}
    else if(type==='win'){o.frequency.value=880;o.type='sine';g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.12);o.start();o.stop(audio.currentTime+.12);setTimeout(()=>{const o2=audio.createOscillator(),g2=audio.createGain();o2.connect(g2);g2.connect(audio.destination);o2.frequency.value=1100;o2.type='sine';g2.gain.value=.05;g2.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.15);o2.start();o2.stop(audio.currentTime+.15)},100)}
    else{o.frequency.value=280;o.type='sawtooth';g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.3);o.start();o.stop(audio.currentTime+.3)}
  }catch(e){}
}

function showToast(trade){
  const buy=trade.action==='BUY',sym=trade.symbol.replace('/KRW','');
  const win=trade.pnl!=null&&trade.pnl>0;
  const cls=buy?'buy':(win?'win':'loss');
  const icon=buy?'ğŸŸ¢':(win?'ğŸ‰':'ğŸ”´');
  const pnl=trade.pnl!=null?` (${trade.pnl>0?'+':''}${trade.pnl.toFixed(1)}%)`:'';
  const amt=trade.amount?` ${Math.round(trade.amount).toLocaleString()}ì›`:'';
  const msg=buy?`${sym} ${amt} ë§¤ìˆ˜`:`${sym} ë§¤ë„${pnl}`;
  const el=document.createElement('div');el.className=`toast ${cls}`;
  el.innerHTML=`<span class="ti">${icon}</span><span>${msg}</span>`;
  document.getElementById('toasts').appendChild(el);
  if(soundOn){beep(cls);if(navigator.vibrate)navigator.vibrate(buy?[60,30,60]:[120,60,120])}
  setTimeout(()=>el.remove(),4000);
}

function fmt(n){if(n==null)return'-';if(n>=1e6)return Math.round(n).toLocaleString();if(n>=100)return Math.round(n).toLocaleString();if(n>=1)return n.toFixed(1);return n.toFixed(4)}

function spark(prices,w=60,h=24){
  if(!prices||prices.length<2)return'';
  const mn=Math.min(...prices),mx=Math.max(...prices),r=mx-mn||1,s=w/(prices.length-1);
  const pts=prices.map((p,i)=>`${(i*s).toFixed(1)},${(h-((p-mn)/r)*(h-2)-1).toFixed(1)}`).join(' ');
  const up=prices[prices.length-1]>=prices[0],c=up?'var(--green)':'var(--red)';
  return`<svg viewBox="0 0 ${w} ${h}"><polyline points="${pts}" fill="none" stroke="${c}" stroke-width="1.5" stroke-linecap="round"/></svg>`;
}

function pnlSpark(hist,w=380,h=56){
  if(!hist||hist.length<2)return'';
  const vals=hist.map(h=>h.total);
  const mn=Math.min(...vals,0),mx=Math.max(...vals,0),r=mx-mn||1,s=w/(vals.length-1);
  const zy=(h-3-((0-mn)/r)*(h-6)).toFixed(1);
  const pts=vals.map((v,i)=>`${(i*s).toFixed(1)},${(h-3-((v-mn)/r)*(h-6)).toFixed(1)}`).join(' ');
  const last=vals[vals.length-1],c=last>=0?'var(--green)':'var(--red)';
  const gid='pg'+Math.random().toString(36).slice(2,6);
  const fy=pts.split(' ')[0].split(',')[1],lx=((vals.length-1)*s).toFixed(1);
  return`<svg viewBox="0 0 ${w} ${h}"><defs><linearGradient id="${gid}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${c}" stop-opacity=".2"/><stop offset="100%" stop-color="${c}" stop-opacity="0"/></linearGradient></defs><line x1="0" y1="${zy}" x2="${w}" y2="${zy}" stroke="var(--text-tertiary)" stroke-width=".5" stroke-dasharray="3,3" opacity=".3"/><polygon points="0,${fy} ${pts} ${lx},${zy} 0,${zy}" fill="url(#${gid})"/><polyline points="${pts}" fill="none" stroke="${c}" stroke-width="1.8" stroke-linecap="round"/></svg>`;
}

function animCount(target){
  const el=document.getElementById('heroAmt');
  const diff=target-animPnl;
  if(Math.abs(diff)<1){animPnl=target;el.textContent=`${target>=0?'+':''}${Math.round(target).toLocaleString()}ì›`;return}
  let step=0;const inc=diff/12;
  const t=setInterval(()=>{step++;animPnl+=inc;
    el.textContent=`${animPnl>=0?'+':''}${Math.round(animPnl).toLocaleString()}ì›`;
    if(step>=12){clearInterval(t);animPnl=target}},25);
}

function connect(){
  const p=location.protocol==='https:'?'wss:':'ws:';
  ws=new WebSocket(`${p}//${location.host}`);
  ws.onopen=()=>{document.getElementById('sDot').className='status-dot';document.getElementById('sLabel').textContent='ìë™ë§¤ë§¤ ì¤‘';audio.resume()};
  ws.onclose=()=>{document.getElementById('sDot').className='status-dot off';document.getElementById('sLabel').textContent='ì—°ê²° ëŠê¹€';setTimeout(connect,3000)};
  ws.onmessage=e=>{const m=JSON.parse(e.data);
    if(m.type==='status'){lastData=m.data;renderHome(m.data);renderMarket(m.data);renderHistory(m.data);renderLearning(m.data.learning)}
    if(m.type==='trades')renderFeed(m.data);
    if(m.type==='trade_event')showToast(m.data);
    if(m.type==='log')addLog(m.data);
    if(m.type==='logs')m.data.forEach(l=>addLog(l));
    if(m.type==='learning_status')handleLearningStatus(m.data);
  };
}

function renderHome(d){
  // Status
  const regimeLabel = d.regime ? {trending:'ì¶”ì„¸ì¥',ranging:'íš¡ë³´ì¥',volatile:'ê¸‰ë³€ì¥',unknown:'ë¶„ì„ì¤‘'}[d.regime.regime]||'ë¶„ì„ì¤‘' : '';
  document.getElementById('sRight').textContent=`ìŠ¤ìº” ${d.scanCount}íšŒ${regimeLabel?' Â· '+regimeLabel:''}`;

  // Sentiment bar
  const sent=d.sentiment;
  const sentBar=document.getElementById('sentBar');
  if(sent&&sent.overall){
    sentBar.style.display='flex';
    const fg=sent.fearGreed||{};
    const fgVal=fg.value||50;
    const fgColor=fgVal<=25?'var(--green)':fgVal<=40?'var(--green)':fgVal<=60?'var(--text-tertiary)':fgVal<=75?'var(--red)':'var(--red)';
    const fgLabel=fg.label||'Neutral';
    const ov=sent.overall;
    const ovCls=ov.signal?.includes('bull')?'bullish':ov.signal?.includes('bear')?'bearish':'neutral';
    const redditCls=sent.reddit?.signal?.includes('bull')?'bullish':sent.reddit?.signal?.includes('bear')?'bearish':'neutral';
    const newsCls=sent.news?.signal?.includes('bull')?'bullish':sent.news?.signal?.includes('bear')?'bearish':'neutral';
    sentBar.innerHTML=`<span class="sent-pill ${ovCls}"><span class="ico">ğŸ§ </span>${ov.score>0?'+':''}${ov.score}</span><span class="sent-pill neutral" style="border-color:${fgColor};color:${fgColor}"><span class="ico">ğŸ˜±</span>F&G ${fgVal}</span><span class="sent-pill ${redditCls}"><span class="ico">ğŸ“¡</span>Reddit ${sent.reddit?.score||0}</span><span class="sent-pill ${newsCls}"><span class="ico">ğŸ“°</span>ë‰´ìŠ¤ ${sent.news?.score||0}</span>`;
  } else { sentBar.style.display='none'; }

  // Hero PnL
  const total=d.pnlHistory?.length?d.pnlHistory[d.pnlHistory.length-1].total:d.dailyPnl;
  animCount(total);
  const el=document.getElementById('heroAmt');
  el.style.color=total>0?'var(--green)':total<0?'var(--red)':'var(--text-tertiary)';
  const badge=document.getElementById('heroBadge');
  if(total>0){badge.className='hero-sub up';badge.textContent=`+${Math.round(total).toLocaleString()}ì› ìˆ˜ìµ ì¤‘`}
  else if(total<0){badge.className='hero-sub down';badge.textContent=`${Math.round(total).toLocaleString()}ì› ì†ì‹¤ ì¤‘`}
  else{badge.className='hero-sub zero';badge.textContent='ì•„ì§ ë³€ë™ ì—†ìŒ'}
  document.getElementById('heroChart').innerHTML=pnlSpark(d.pnlHistory);

  // Portfolio value
  const portfolioEl=document.getElementById('heroPortfolio');
  if(d.positions?.length){
    const totalInvested=d.positions.reduce((s,p)=>s+(p.amount||0),0);
    const totalCurrent=d.positions.reduce((s,p)=>s+(p.amount||0)*(1+(p.pnlPct||0)/100),0);
    const diff=totalCurrent-totalInvested;
    portfolioEl.style.display='flex';
    portfolioEl.innerHTML=`íˆ¬ì ${Math.round(totalInvested).toLocaleString()}ì› <span class="arrow">â†’</span> <span style="color:${diff>=0?'var(--green)':'var(--red)'}">í‰ê°€ ${Math.round(totalCurrent).toLocaleString()}ì›</span>`;
  } else {portfolioEl.style.display='none'}

  // Stats
  const s=d.stats||{};
  document.getElementById('stWin').textContent=s.wins||0;
  document.getElementById('stWin').style.color='var(--green)';
  document.getElementById('stLoss').textContent=s.losses||0;
  document.getElementById('stLoss').style.color='var(--red)';
  document.getElementById('stRate').textContent=(s.winRate||0)+'%';
  document.getElementById('stRate').style.color=s.winRate>=50?'var(--green)':'var(--red)';
  document.getElementById('stTrades').textContent=(s.todayBuys||0)+(s.totalTrades||0);

  // Bot card
  const posN=d.positionCount;
  if(posN===0){
    document.getElementById('botTitle').textContent='ì¢‹ì€ ë§¤ìˆ˜ íƒ€ì´ë°ì„ ì°¾ê³  ìˆì–´ìš”';
    document.getElementById('botDesc').textContent=`${d.symbols?.length||0}ê°œ ì½”ì¸ ê°ì‹œ ì¤‘`;
  } else {
    document.getElementById('botTitle').textContent=`${posN}ê°œ ì½”ì¸ì„ ë³´ìœ í•˜ê³  ìˆì–´ìš”`;
    const sizeMult=d.drawdown?.sizingMultiplier;
    document.getElementById('botDesc').textContent=sizeMult&&sizeMult<1?`ì†ì ˆ/ìµì ˆ ìë™ê´€ë¦¬ Â· ì‚¬ì´ì§• ${Math.round(sizeMult*100)}%`:`ì†ì ˆ -2% / ìµì ˆ +5% ìë™ ê´€ë¦¬ ì¤‘`;
  }

  // Drawdown bar
  const dd=d.drawdown;
  const ddBar=document.getElementById('ddBar');
  if(dd){
    ddBar.style.display='flex';
    const sharpeColor=dd.sharpeRatio>0.5?'var(--green)':dd.sharpeRatio>0?'var(--yellow)':'var(--red)';
    const lossColor=dd.consecutiveLosses>=3?'var(--red)':dd.consecutiveLosses>=2?'var(--yellow)':'var(--text-primary)';
    ddBar.innerHTML=`<div class="dd-item">Sharpe <b style="color:${sharpeColor}">${dd.sharpeRatio}</b></div><div class="dd-item">ì—°ì†ì†ì‹¤ <b style="color:${lossColor}">${dd.consecutiveLosses}</b></div><div class="dd-item">ìµœëŒ€DD <b>${dd.maxDrawdownPct}%</b></div><div class="dd-item">í¬ì§€ì…˜ <b>${dd.dynamicMaxPositions}ê°œ</b></div>`;
  }

  // Positions
  const pl=document.getElementById('posList');
  if(!d.positions?.length){
    pl.innerHTML='<div class="pos-empty glass"><div class="ico">ğŸ”</div><p>ì•„ì§ ë§¤ìˆ˜í•œ ì½”ì¸ì´ ì—†ì–´ìš”<br>ë´‡ì´ ì¢‹ì€ íƒ€ì´ë°ì„ ì°¾ê³  ìˆì–´ìš”</p></div>';
  } else {
    pl.innerHTML=d.positions.map(p=>{
      const pnl=p.pnlPct||0,up=pnl>=0;
      const curVal=Math.round(p.amount*(1+pnl/100));
      const barPct=Math.max(0,Math.min(100,(pnl+2)/7*100));
      const sym=p.symbol.replace('/KRW','');
      return`<div class="pos-card glass" onclick="openChart('${p.symbol}')">
        <div class="pos-head">
          <div class="pos-symbol"><div class="icon">${sym.slice(0,2)}</div><div class="name">${sym}</div></div>
          <div class="pos-pnl ${up?'up':'down'}">${up?'+':''}${pnl.toFixed(2)}%</div>
        </div>
        <div class="pos-detail">
          <div class="pos-amount">${Math.round(p.amount).toLocaleString()}ì› â†’ <b>${curVal.toLocaleString()}ì›</b></div>
          <div class="pos-price" style="color:${up?'var(--green)':'var(--red)'}">${fmt(p.currentPrice)}</div>
        </div>
        <div class="pnl-bar">
          <div class="pnl-bar-fill ${up?'up':'down'}" style="width:${barPct}%"></div>
          <div class="pnl-bar-dot ${up?'up':'down'}" style="left:calc(${barPct}% - 6px)"></div>
        </div>
        <div class="pnl-labels"><span>ì†ì ˆ -2%</span><span>ì§„ì…</span><span>ìµì ˆ +5%</span></div>
        ${p.dcaCount||p.partialSells?`<div class="pos-badges">${p.dcaCount?`<span class="pos-badge dca">DCA ${p.dcaCount}íšŒ</span>`:''}${p.partialSells?`<span class="pos-badge partial">ë¶„í• ë§¤ë„ ${p.partialSells}íšŒ</span>`:''}</div>`:''}
        <div class="pos-meta">
          <span>ì§„ì…ê°€ <b>${fmt(p.entryPrice)}</b></span>
          <span>ë³´ìœ  <b>${p.holdMinutes}ë¶„</b></span>
          <span style="color:var(--accent)">ì°¨íŠ¸ ë³´ê¸° â†’</span>
        </div>
      </div>`;
    }).join('');
  }
}

function renderFeed(trades){
  const el=document.getElementById('feedList');
  if(!trades?.length){el.innerHTML='<div class="trade-item"><div class="trade-icon buy">ğŸ”</div><div class="trade-info"><div class="trade-main">ë´‡ì´ ì‹œì‘ë˜ì—ˆì–´ìš”</div><div class="trade-sub">ë§¤ìˆ˜ ì‹œê·¸ë„ ëŒ€ê¸° ì¤‘</div></div></div>';return}
  el.innerHTML=trades.slice(0,8).map(t=>{
    const buy=t.action==='BUY',sym=t.symbol.replace('/KRW','');
    const time=new Date(t.timestamp).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
    const icon=buy?'ğŸ’°':'ğŸ’¸';
    const cls=buy?'buy':(t.pnl>0?'win':'sell');
    const amt=t.amount?`${Math.round(t.amount).toLocaleString()}ì›`:'';
    let msg,pnlStr='';
    if(buy){msg=`<b>${sym}</b> ë§¤ìˆ˜`}
    else{msg=`<b>${sym}</b> ë§¤ë„`;if(t.pnl!=null)pnlStr=`<span class="trade-pnl ${t.pnl>=0?'up':'down'}">${t.pnl>=0?'+':''}${t.pnl.toFixed(1)}%</span>`}
    return`<div class="trade-item">
      <div class="trade-icon ${cls}">${icon}</div>
      <div class="trade-info"><div class="trade-main">${msg}</div><div class="trade-sub">${time} Â· ${t.reason||''}</div></div>
      <div class="trade-right"><div class="trade-amt">${amt}</div>${pnlStr}</div>
    </div>`;
  }).join('');
}

function renderMarket(d){
  document.getElementById('mktTime').textContent=new Date().toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const sd=d.symbolData||[];
  const held=new Set(d.positions?.map(p=>p.symbol)||[]);
  document.getElementById('marketList').innerHTML=sd.map(s=>{
    const sym=s.symbol.replace('/KRW','');
    const ch=s.change!=null?s.change:0;
    const chStr=ch>=0?`+${ch.toFixed(2)}%`:`${ch.toFixed(2)}%`;
    const prev=prevPrices[s.symbol];
    let flash='';
    if(prev&&s.price){if(s.price>prev)flash='fg';else if(s.price<prev)flash='fr'}
    if(s.price)prevPrices[s.symbol]=s.price;
    const act=s.action||'HOLD';
    const isHeld=held.has(s.symbol);
    // Patterns and MTF
    const cp=s.patterns?.candle||[];
    const chp=s.patterns?.chart||[];
    const allPats=[...cp.map(p=>p.emoji+p.name),...chp.map(p=>p.emoji+p.name)];
    const patStr=allPats.length>0?allPats.slice(0,3).join(' '):'';
    const mtfSig=s.mtf?.signal||'';
    const mtfCls=mtfSig.includes('buy')?'buy':mtfSig.includes('sell')?'sell':'neutral';
    const scoreStr=s.scores?`B:${s.scores.buy?.toFixed(1)||0} S:${s.scores.sell?.toFixed(1)||0}`:'';
    return`<div class="market-row" onclick="openChart('${s.symbol}')" ${isHeld?'style="background:var(--green-dim);border-radius:var(--radius-sm);margin:0 -8px;padding:14px 8px"':''}>
      <div class="mkt-icon">${sym.slice(0,2)}</div>
      <div class="mkt-info">
        <div class="mkt-name">${sym} ${isHeld?'<span style="font-size:10px;color:var(--green);font-weight:600">ë³´ìœ ì¤‘</span>':''} <span class="mkt-signal ${act}">${act==='BUY'?'ë§¤ìˆ˜':act==='SELL'?'ë§¤ë„':'ê´€ë§'}</span> ${getRsiBadge(s.indicators?.rsi)}${mtfSig?`<span class="mkt-mtf ${mtfCls}">${mtfSig}</span>`:''}</div>
        <div class="mkt-vol">24h ${ch>=0?'â–²':'â–¼'} ${Math.abs(ch).toFixed(2)}%${scoreStr?` Â· <span class="mkt-score">${scoreStr}</span>`:''}</div>
        ${patStr?`<div class="mkt-patterns">${patStr}</div>`:''}
      </div>
      <div class="mkt-spark">${spark(s.sparkline)}</div>
      <div class="mkt-right">
        <div class="mkt-price ${flash}">${s.price?fmt(s.price):'-'}</div>
        <div class="mkt-change ${ch>0?'up':ch<0?'down':''}">${chStr}</div>
      </div>
    </div>`;
  }).join('');
  setTimeout(()=>document.querySelectorAll('.fg,.fr').forEach(e=>{e.classList.remove('fg','fr')}),500);
}

function renderHistory(d){
  const s=d.stats||{};
  document.getElementById('hWin').textContent=s.wins||0;
  document.getElementById('hLoss').textContent=s.losses||0;
  const pnl=d.dailyPnl||0;
  const hT=document.getElementById('hTotal');
  hT.textContent=`${pnl>=0?'+':''}${Math.round(pnl).toLocaleString()}ì›`;
  hT.style.color=pnl>=0?'var(--green)':'var(--red)';

  const trades=(d.todayTrades||[]).slice().reverse();
  if(!trades.length){document.getElementById('histList').innerHTML='<div style="text-align:center;padding:40px;color:var(--text-tertiary)">ì˜¤ëŠ˜ ë§¤ë§¤ ê¸°ë¡ì´ ì—†ì–´ìš”</div>';return}
  document.getElementById('histList').innerHTML=trades.map(t=>{
    const buy=t.action==='BUY',sym=t.symbol.replace('/KRW','');
    const time=new Date(t.timestamp).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
    const icon=buy?'ğŸ’°':'ğŸ’¸';
    const cls=buy?'buy':(t.pnl>0?'win':'sell');
    const amt=t.amount?`${Math.round(t.amount).toLocaleString()}ì›`:`${Math.round(t.price*t.quantity).toLocaleString()}ì›`;
    let pnlStr='';
    if(!buy&&t.pnl!=null)pnlStr=`<div class="trade-pnl ${t.pnl>=0?'up':'down'}">${t.pnl>=0?'+':''}${t.pnl.toFixed(2)}%</div>`;
    return`<div class="trade-item">
      <div class="trade-icon ${cls}">${icon}</div>
      <div class="trade-info"><div class="trade-main"><b>${sym}</b> ${buy?'ë§¤ìˆ˜':'ë§¤ë„'}</div><div class="trade-sub">${time} Â· ${t.reason||''}</div></div>
      <div class="trade-right"><div class="trade-amt">${amt}</div>${pnlStr}</div>
    </div>`;
  }).join('');
}

function addLog(entry){
  const box=document.getElementById('logBox');
  const time=new Date(entry.time).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const line=document.createElement('div');
  line.className=`log-l ${entry.level}`;
  line.innerHTML=`<span class="t">${time}</span> <span class="tag">[${entry.tag}]</span> ${entry.msg}`;
  box.appendChild(line);logN++;
  if(logN>80){box.removeChild(box.firstChild);logN--}
  box.scrollTop=box.scrollHeight;
  document.getElementById('logCount').textContent=logN+'ê±´';
}

// Chart Modal
async function openChart(symbol){
  document.getElementById('modal').classList.add('open');
  document.getElementById('mTitle').textContent=symbol.replace('/KRW','')+' ì°¨íŠ¸';
  try{const r=await fetch(`/api/candles/${encodeURIComponent(symbol)}`);const data=await r.json();drawChart(data)}
  catch(e){document.getElementById('mStats').innerHTML='<div style="color:var(--red);text-align:center;padding:20px;grid-column:span 3">ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨</div>'}
}
function closeModal(){document.getElementById('modal').classList.remove('open')}

function drawChart(data){
  const canvas=document.getElementById('cc');
  const dpr=window.devicePixelRatio||1;
  const rect=canvas.parentElement.getBoundingClientRect();
  const W=rect.width,H=260;
  canvas.width=W*dpr;canvas.height=H*dpr;
  canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);

  const candles=data.candles||[];if(!candles.length)return;
  const vH=36,cH=H-vH-8,n=candles.length;
  const cw=Math.max(2,(W-16)/n*.55),gap=(W-16)/n;

  let pMin=Infinity,pMax=-Infinity,vMax=0;
  candles.forEach(c=>{
    const lo=c.bb?Math.min(c.low,c.bb.lower):c.low;
    const hi=c.bb?Math.max(c.high,c.bb.upper):c.high;
    if(lo<pMin)pMin=lo;if(hi>pMax)pMax=hi;if(c.volume>vMax)vMax=c.volume});
  const pR=pMax-pMin||1;
  const py=p=>4+(1-(p-pMin)/pR)*cH;

  // BB fill
  ctx.beginPath();
  candles.forEach((c,i)=>{if(!c.bb)return;const x=8+i*gap+gap/2;if(i===0||!candles[i-1].bb)ctx.moveTo(x,py(c.bb.upper));else ctx.lineTo(x,py(c.bb.upper))});
  for(let i=n-1;i>=0;i--){if(!candles[i].bb)continue;ctx.lineTo(8+i*gap+gap/2,py(candles[i].bb.lower))}
  ctx.closePath();ctx.fillStyle='rgba(99,102,241,.06)';ctx.fill();

  ['upper','middle','lower'].forEach((k,idx)=>{
    ctx.beginPath();ctx.strokeStyle=idx===1?'rgba(99,102,241,.3)':'rgba(99,102,241,.15)';
    ctx.lineWidth=idx===1?1:.5;if(idx!==1)ctx.setLineDash([3,3]);else ctx.setLineDash([]);
    let st=false;candles.forEach((c,i)=>{if(!c.bb)return;const x=8+i*gap+gap/2;if(!st){ctx.moveTo(x,py(c.bb[k]));st=true}else ctx.lineTo(x,py(c.bb[k]))});
    ctx.stroke();ctx.setLineDash([])});

  const pos=data.position;
  if(pos){
    ctx.setLineDash([5,3]);
    [[pos.entryPrice,'#FCD535','ì§„ì…ê°€'],[pos.stopLoss,'#F6465D','ì†ì ˆ'],[pos.takeProfit,'#0ECB81','ìµì ˆ']].forEach(([p,c,label])=>{
      ctx.beginPath();ctx.strokeStyle=c;ctx.lineWidth=1;
      ctx.moveTo(0,py(p));ctx.lineTo(W,py(p));ctx.stroke();
      ctx.fillStyle=c;ctx.font='bold 10px Inter';ctx.fillText(`${label} ${fmt(p)}`,4,py(p)-4)});
    ctx.setLineDash([]);
  }

  candles.forEach((c,i)=>{
    const x=8+i*gap+gap/2,up=c.close>=c.open,col=up?'#0ECB81':'#F6465D';
    ctx.beginPath();ctx.strokeStyle=col;ctx.lineWidth=1;ctx.moveTo(x,py(c.high));ctx.lineTo(x,py(c.low));ctx.stroke();
    const t=py(Math.max(c.open,c.close)),b=py(Math.min(c.open,c.close));
    ctx.fillStyle=col;ctx.fillRect(x-cw/2,t,cw,Math.max(1,b-t));
    const vy=H-(c.volume/(vMax||1))*vH;
    ctx.fillStyle=up?'rgba(14,203,129,.12)':'rgba(246,70,93,.12)';
    ctx.fillRect(x-cw/2,vy,cw,H-vy)});

  const last=candles[n-1];
  if(last){const y=py(last.close);ctx.fillStyle=last.close>=last.open?'#0ECB81':'#F6465D';
    ctx.beginPath();ctx.moveTo(W-1,y);ctx.lineTo(W-7,y-4);ctx.lineTo(W-7,y+4);ctx.closePath();ctx.fill();
    ctx.font='bold 10px Inter';ctx.textAlign='right';ctx.fillText(fmt(last.close),W-9,y+3);ctx.textAlign='left'}

  const info=document.getElementById('mStats');
  if(pos){
    const pnlPct=((last.close-pos.entryPrice)/pos.entryPrice*100).toFixed(2);
    const up=parseFloat(pnlPct)>=0;
    info.innerHTML=`
      <div class="modal-cell"><div class="v" style="color:var(--yellow)">${fmt(pos.entryPrice)}</div><div class="l">ì§„ì…ê°€</div></div>
      <div class="modal-cell"><div class="v">${fmt(last.close)}</div><div class="l">í˜„ì¬ê°€</div></div>
      <div class="modal-cell"><div class="v" style="color:${up?'var(--green)':'var(--red)'}">${up?'+':''}${pnlPct}%</div><div class="l">ìˆ˜ìµë¥ </div></div>`;
  } else {
    info.innerHTML=`
      <div class="modal-cell"><div class="v">${fmt(last.close)}</div><div class="l">í˜„ì¬ê°€</div></div>
      <div class="modal-cell"><div class="v">${fmt(last.high)}</div><div class="l">ê³ ê°€</div></div>
      <div class="modal-cell"><div class="v">${fmt(last.low)}</div><div class="l">ì €ê°€</div></div>`;
  }
}

// â”€â”€â”€ Learning Tab â”€â”€â”€

function renderLearning(learn) {
  if (!learn) {
    document.getElementById('learnRight').textContent = 'í•™ìŠµ ë°ì´í„° ì—†ìŒ';
    document.getElementById('confLabel').textContent = '-';
    document.getElementById('confFill').style.width = '0%';
    return;
  }

  // Meta
  const ago = learn.updatedAt ? timeAgo(learn.updatedAt) : '-';
  document.getElementById('learnRight').textContent = `${learn.tradesAnalyzed}ìŒ ë¶„ì„ Â· ${ago}`;
  document.getElementById('learnMeta').textContent = `ë§ˆì§€ë§‰ í•™ìŠµ: ${ago} Â· ${learn.tradesAnalyzed}ìŒ ë¶„ì„`;

  // Confidence bar
  const conf = Math.round((learn.confidence || 0) * 100);
  const confColor = conf >= 70 ? 'var(--green)' : conf >= 50 ? 'var(--yellow)' : 'var(--red)';
  document.getElementById('confFill').style.width = conf + '%';
  document.getElementById('confFill').style.background = confColor;
  document.getElementById('confLabel').textContent = conf + '%';
  document.getElementById('confLabel').style.color = confColor;

  // Symbol table
  const syms = learn.analysis?.bySymbol || {};
  const sorted = Object.values(syms).sort((a, b) => (b.score || 0) - (a.score || 0));
  const tbody = document.getElementById('learnSymBody');
  if (sorted.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-tertiary);padding:20px">ë°ì´í„° ì—†ìŒ</td></tr>';
  } else {
    tbody.innerHTML = sorted.map(s => {
      const sym = s.symbol.replace('/KRW', '');
      const pnlColor = s.avgPnl >= 0 ? 'var(--green)' : 'var(--red)';
      const scoreColor = s.score >= 70 ? 'var(--green)' : s.score >= 40 ? 'var(--yellow)' : 'var(--red)';
      const bl = (learn.blacklist || []).includes(s.symbol);
      return `<tr>
        <td style="font-weight:700">${sym}${bl ? ' <span style="color:var(--red);font-size:9px">BAN</span>' : ''}</td>
        <td>${s.trades}</td>
        <td style="font-weight:700">${s.winRate}%</td>
        <td style="color:${pnlColor};font-weight:600">${s.avgPnl >= 0 ? '+' : ''}${s.avgPnl.toFixed(1)}%</td>
        <td style="color:${scoreColor};font-weight:800">${s.score}</td>
      </tr>`;
    }).join('');
  }

  // Hour grid
  const hours = learn.analysis?.byHour || {};
  const preferred = new Set(learn.preferredHours || []);
  const avoid = new Set(learn.avoidHours || []);
  let hourHtml = '';
  for (let h = 0; h < 24; h++) {
    const stat = hours[h];
    let bg = 'rgba(255,255,255,.03)';
    let color = 'var(--text-tertiary)';
    if (stat && stat.trades > 0) {
      if (stat.avgPnl > 1) { bg = 'var(--green-dim)'; color = 'var(--green)'; }
      else if (stat.avgPnl > 0) { bg = 'rgba(99,102,241,.12)'; color = 'var(--accent)'; }
      else if (stat.avgPnl > -1) { bg = 'var(--yellow-dim)'; color = 'var(--yellow)'; }
      else { bg = 'var(--red-dim)'; color = 'var(--red)'; }
    }
    const border = preferred.has(h) ? '2px solid var(--green)' : avoid.has(h) ? '2px solid var(--red)' : '1px solid transparent';
    const pnlText = stat && stat.trades > 0 ? `${stat.avgPnl >= 0 ? '+' : ''}${stat.avgPnl.toFixed(1)}` : 'Â·';
    hourHtml += `<div class="hour-cell" style="background:${bg};color:${color};border:${border}"><div class="h">${h}ì‹œ</div>${pnlText}</div>`;
  }
  document.getElementById('hourGrid').innerHTML = hourHtml;

  // Params
  const params = learn.params;
  const paramNames = {RSI_OVERSOLD:'RSI ê³¼ë§¤ë„',RSI_OVERBOUGHT:'RSI ê³¼ë§¤ìˆ˜',STOP_LOSS_PCT:'ì†ì ˆì„ ',TAKE_PROFIT_PCT:'ìµì ˆì„ ',MAX_HOLD_HOURS:'ìµœëŒ€ë³´ìœ '};
  const paramUnits = {RSI_OVERSOLD:'',RSI_OVERBOUGHT:'',STOP_LOSS_PCT:'%',TAKE_PROFIT_PCT:'%',MAX_HOLD_HOURS:'ì‹œê°„'};
  if (params) {
    document.getElementById('paramList').innerHTML = Object.entries(paramNames).map(([key, name]) => {
      const val = params[key];
      if (val == null) return '';
      return `<div class="param-row"><span class="param-name">${name}</span><span class="param-val">${val}${paramUnits[key]}</span></div>`;
    }).join('');
  } else {
    document.getElementById('paramList').innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-tertiary);font-size:12px">ê¸°ë³¸ê°’ ì‚¬ìš© ì¤‘</div>';
  }

  // Blacklist
  const bl = learn.blacklist || [];
  const blSection = document.getElementById('blSection');
  if (bl.length > 0) {
    blSection.style.display = 'block';
    document.getElementById('blList').innerHTML = bl.map(s => `<span class="bl-chip">${s.replace('/KRW', '')}</span>`).join('');
  } else {
    blSection.style.display = 'none';
  }
}

function triggerLearning() {
  if (!ws || ws.readyState !== 1) return;
  const btn = document.getElementById('learnBtn');
  btn.disabled = true;
  btn.textContent = 'í•™ìŠµ ì‹¤í–‰ ì¤‘...';
  ws.send(JSON.stringify({ command: 'run_learning' }));
}

function handleLearningStatus(data) {
  const btn = document.getElementById('learnBtn');
  if (data.status === 'done') {
    btn.disabled = false;
    btn.textContent = 'ì§€ê¸ˆ í•™ìŠµ ì‹¤í–‰';
    showToast({ action: 'BUY', symbol: 'í•™ìŠµ/ì™„ë£Œ', amount: 0, reason: 'í•™ìŠµ ì™„ë£Œ' });
  } else if (data.status === 'error') {
    btn.disabled = false;
    btn.textContent = 'ì§€ê¸ˆ í•™ìŠµ ì‹¤í–‰';
  }
}

function timeAgo(ts) {
  const diff = Date.now() - ts;
  if (diff < 60000) return 'ë°©ê¸ˆ ì „';
  if (diff < 3600000) return Math.round(diff / 60000) + 'ë¶„ ì „';
  if (diff < 86400000) return Math.round(diff / 3600000) + 'ì‹œê°„ ì „';
  return Math.round(diff / 86400000) + 'ì¼ ì „';
}

connect();
</script>
</body>
</html>
