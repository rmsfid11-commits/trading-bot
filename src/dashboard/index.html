<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="íŠ¸ë ˆì´ë”©">
  <meta name="theme-color" content="#0A0A0F">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" rel="stylesheet">
  <title>íŠ¸ë ˆì´ë”© ë´‡</title>
  <style>
    :root {
      --bg-primary: #0A0A0F;
      --bg-secondary: #1A1A22;
      --bg-card: rgba(255,255,255,.06);
      --bg-card-hover: rgba(255,255,255,.10);
      --border: rgba(255,255,255,.08);
      --border-active: rgba(49,130,246,.4);
      --text-primary: #F0F0F5;
      --text-secondary: #8A8A9A;
      --text-tertiary: #4A4A5A;
      --accent: #3182F6;
      --accent-dim: rgba(49,130,246,.12);
      --green: #00C48C;
      --green-dim: rgba(0,196,140,.10);
      --green-glow: rgba(0,196,140,.15);
      --red: #FF4757;
      --red-dim: rgba(255,71,87,.10);
      --red-glow: rgba(255,71,87,.12);
      --yellow: #FCD535;
      --yellow-dim: rgba(252,213,53,.10);
      --glass: rgba(255,255,255,.06);
      --glass-border: rgba(255,255,255,.12);
      --glass-blur: 40px;
      --glass-highlight: rgba(255,255,255,.08);
      --glass-shadow: rgba(0,0,0,.1);
      --radius-sm: 10px;
      --radius-md: 16px;
      --radius-lg: 22px;
      --radius-xl: 28px;
      --nav-h: 68px;
      --safe-b: env(safe-area-inset-bottom, 0px);
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      font-family:'Pretendard Variable','Pretendard',-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
      background-color:var(--bg-primary);
      background-image:radial-gradient(ellipse at 20% 15%,rgba(30,60,120,.30) 0%,transparent 55%),radial-gradient(ellipse at 80% 50%,rgba(20,80,100,.20) 0%,transparent 50%),radial-gradient(ellipse at 40% 85%,rgba(40,50,110,.18) 0%,transparent 50%);
      background-attachment:fixed;
      color:var(--text-primary);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased;letter-spacing:-0.02em;
    }

    /* === Layout === */
    .app{max-width:430px;margin:0 auto;position:relative;min-height:100dvh;display:flex;flex-direction:column}
    .tab-content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:calc(var(--nav-h) + var(--safe-b) + 16px)}
    .tab-panel{display:none;padding:0 20px}
    .tab-panel.active{display:block;animation:fadeSlide .35s cubic-bezier(.4,0,.2,1)}
    @keyframes fadeSlide{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

    /* === Bottom Nav === */
    .bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:rgba(10,10,15,.85);backdrop-filter:blur(40px) saturate(1.8);-webkit-backdrop-filter:blur(40px) saturate(1.8);border-top:1px solid var(--glass-border);box-shadow:0 -4px 30px var(--glass-shadow),inset 0 1px 0 var(--glass-highlight);padding:8px 0 calc(8px + var(--safe-b));z-index:100;display:flex}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 2px;cursor:pointer;transition:all .2s;-webkit-user-select:none;min-width:0}
    .nav-item svg{width:20px;height:20px;stroke:var(--text-tertiary);fill:none;stroke-width:1.8;transition:all .2s}
    .nav-item span{font-size:9px;font-weight:600;color:var(--text-tertiary);transition:all .2s}
    .nav-item.active svg{stroke:var(--accent)}.nav-item.active span{color:var(--accent)}

    /* === Glass Card === */
    .glass{
      position:relative;overflow:hidden;
      background:var(--glass);
      backdrop-filter:blur(var(--glass-blur)) saturate(1.6);-webkit-backdrop-filter:blur(var(--glass-blur)) saturate(1.6);
      border:1px solid var(--glass-border);border-radius:var(--radius-lg);
      box-shadow:0 8px 32px var(--glass-shadow),inset 0 1px 0 var(--glass-highlight);
    }
    .glass>*{position:relative;z-index:2}
    .glass::after{
      content:'';position:absolute;inset:0;border-radius:inherit;
      background:radial-gradient(circle 180px at var(--tx,-100px) var(--ty,-100px),rgba(255,255,255,.08),transparent 70%);
      pointer-events:none;z-index:1;opacity:0;transition:opacity .4s;
    }
    .glass.touched::after{opacity:1}
    .profit-glow{box-shadow:0 8px 40px var(--green-glow),inset 0 1px 0 rgba(0,196,140,.06)}
    .loss-glow{box-shadow:0 8px 40px var(--red-glow),inset 0 1px 0 rgba(255,71,87,.05)}
    .section-gap{margin-bottom:16px}
    .section-head{display:flex;align-items:center;justify-content:space-between;padding:20px 20px 0}
    .section-head h2{font-size:13px;font-weight:700;color:var(--text-secondary);letter-spacing:.3px}
    .section-head .badge{font-size:11px;font-weight:600;color:var(--text-tertiary)}

    /* === Status Bar === */
    .status-bar{display:flex;align-items:center;justify-content:space-between;padding:14px 20px}
    .status-left{display:flex;align-items:center;gap:8px}
    .status-dot{width:8px;height:8px;border-radius:50%;position:relative}
    .status-dot.on{background:var(--green);box-shadow:0 0 8px var(--green-glow)}
    .status-dot.on::after{content:'';position:absolute;inset:-3px;border-radius:50%;border:2px solid var(--green);opacity:.3;animation:ping 2s cubic-bezier(0,0,.2,1) infinite}
    @keyframes ping{75%,100%{transform:scale(2);opacity:0}}
    .status-dot.off{background:var(--red);box-shadow:0 0 8px var(--red-glow)}
    .status-label{font-size:13px;font-weight:600;color:var(--text-primary)}
    .status-right{font-size:11px;color:var(--text-tertiary);font-weight:500}

    /* === HOME TAB === */
    .home-hero{padding:20px 20px 12px}
    .hero-total-row{text-align:center;margin-bottom:14px}
    .hero-total-label{font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:4px;letter-spacing:.02em}
    .hero-total-amount{font-size:36px;font-weight:900;letter-spacing:-2px;color:var(--text-primary);line-height:1.1}
    .hero-balance-bar{display:flex;height:6px;border-radius:3px;overflow:hidden;margin:10px 0 6px;background:var(--bg-card)}
    .hero-balance-bar .cash{background:var(--text-tertiary);transition:width .5s}
    .hero-balance-bar .invest{background:var(--accent);transition:width .5s}
    .hero-balance-detail{display:flex;justify-content:space-between;font-size:12px;font-weight:600;margin-bottom:10px}
    .hero-balance-detail .bal-item{display:flex;align-items:center;gap:5px}
    .hero-balance-detail .bal-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
    .hero-balance-detail .bal-label{color:var(--text-tertiary);font-weight:500}
    .hero-balance-detail .bal-val{color:var(--text-primary)}
    .hero-divider{height:1px;background:var(--border);margin:10px 0}
    .hero-pnl-box{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:12px 16px;margin-bottom:10px}
    .hero-pnl-title{font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
    .hero-pnl-main{font-size:28px;font-weight:900;letter-spacing:-1.5px;line-height:1.1;margin-bottom:8px}
    .hero-pnl-detail{display:flex;gap:14px;font-size:12px;font-weight:700}
    .hero-pnl-detail .lbl{color:var(--text-tertiary);font-weight:500}
    .hero-stat-row{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:12px 16px;margin-bottom:10px}
    .hero-stat-title{font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
    .hero-stat-grid{display:flex;justify-content:space-between;font-size:12px}
    .hero-stat-grid .item{text-align:center}
    .hero-stat-grid .val{font-weight:800;font-size:14px}
    .hero-stat-grid .lbl{font-size:9px;color:var(--text-tertiary);margin-top:2px}
    .hero-trades{margin-top:0}
    .hero-trades .ht-title{font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:6px}
    .hero-trade-item{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px}
    .hero-trade-item:last-child{border:none}
    .hero-trade-item .sym{font-weight:700}
    .hero-trade-item .pnl{font-weight:700}
    .hero-trade-item .pnl.up{color:var(--green)}.hero-trade-item .pnl.down{color:var(--red)}
    .hero-trade-item .ago{color:var(--text-tertiary);font-size:10px}
    .hero-sub{margin-top:10px;display:inline-flex;align-items:center;gap:5px;font-size:13px;font-weight:700;padding:6px 16px;border-radius:20px;transition:all .3s}
    .hero-sub.up{color:var(--green);background:var(--green-dim)}
    .hero-sub.down{color:var(--red);background:var(--red-dim)}
    .hero-sub.zero{color:var(--text-tertiary);background:rgba(255,255,255,.04)}
    .hero-chart{height:60px;margin-top:12px;padding:0 20px}
    .hero-chart svg{width:100%;height:100%}

    /* Stats row */
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);border-radius:var(--radius-md);overflow:hidden;margin:0 20px 16px}
    .stat-cell{background:var(--bg-secondary);padding:14px 8px;text-align:center}
    .stat-val{font-size:17px;font-weight:800}
    .stat-label{font-size:10px;color:var(--text-tertiary);margin-top:3px;font-weight:500}

    /* Bot card */
    .bot-card{margin:0 20px 16px;padding:16px 18px;display:flex;align-items:center;gap:14px}
    .bot-icon{width:46px;height:46px;border-radius:16px;background:linear-gradient(135deg,var(--accent),#6C5CE7);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;box-shadow:0 4px 16px rgba(49,130,246,.2)}
    .bot-info{flex:1;min-width:0}
    .bot-title{font-size:14px;font-weight:700;line-height:1.3}
    .bot-desc{font-size:12px;color:var(--text-secondary);margin-top:1px}

    /* Position cards */
    .pos-list{padding:0 20px;display:flex;flex-direction:column;gap:10px;margin-bottom:16px}
    .pos-card{padding:16px 18px;cursor:pointer;transition:all .15s;-webkit-user-select:none}
    .pos-card:active{transform:scale(.98);background:var(--bg-card-hover)}
    .pos-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .pos-symbol{display:flex;align-items:center;gap:8px}
    .pos-symbol .icon{width:32px;height:32px;border-radius:50%;background:var(--accent-dim);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:900;color:var(--accent)}
    .pos-symbol .name{font-size:15px;font-weight:800}
    .pos-pnl{font-size:16px;font-weight:800}
    .pos-pnl.up{color:var(--green)}.pos-pnl.down{color:var(--red)}
    .pos-detail{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:12px}
    .pos-amount{font-size:12px;color:var(--text-secondary)}
    .pos-amount b{color:var(--text-primary);font-weight:700}
    .pos-price{font-size:18px;font-weight:800}

    /* PnL bar */
    .pnl-bar{position:relative;height:5px;border-radius:3px;background:rgba(255,255,255,.05)}
    .pnl-bar-fill{position:absolute;top:0;left:0;height:100%;border-radius:3px;transition:width .5s ease}
    .pnl-bar-fill.up{background:linear-gradient(90deg,var(--accent),var(--green))}
    .pnl-bar-fill.down{background:linear-gradient(90deg,var(--red),var(--accent))}
    .pnl-bar-dot{position:absolute;top:-3.5px;width:12px;height:12px;border-radius:50%;border:2.5px solid var(--bg-primary);transition:left .5s ease}
    .pnl-bar-dot.up{background:var(--green)}.pnl-bar-dot.down{background:var(--red)}
    .pnl-labels{display:flex;justify-content:space-between;margin-top:5px;font-size:9px;color:var(--text-tertiary);font-weight:500}
    .pos-meta{display:flex;gap:14px;margin-top:10px;font-size:11px;color:var(--text-tertiary)}
    .pos-meta b{color:var(--text-secondary);font-weight:600}
    .pos-empty{text-align:center;padding:36px 20px;color:var(--text-tertiary)}
    .pos-empty .ico{font-size:36px;margin-bottom:8px}
    .pos-empty p{font-size:13px;line-height:1.5}

    /* === MARKET TAB === */
    .market-list{padding:0 20px;display:flex;flex-direction:column}
    .market-row{display:flex;align-items:center;padding:14px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;gap:12px}
    .market-row:last-child{border:none}
    .market-row:active{background:var(--bg-card-hover);margin:0 -8px;padding:14px 8px;border-radius:var(--radius-sm)}
    .mkt-icon{width:36px;height:36px;border-radius:50%;background:var(--bg-card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:900;color:var(--text-primary);flex-shrink:0}
    .mkt-info{flex:1;min-width:0}
    .mkt-name{font-size:14px;font-weight:700}
    .mkt-vol{font-size:11px;color:var(--text-tertiary);margin-top:1px}
    .mkt-signal{font-size:9px;font-weight:700;padding:2px 7px;border-radius:6px;margin-left:4px}
    .mkt-signal.BUY{background:var(--green-dim);color:var(--green)}
    .mkt-signal.SELL{background:var(--red-dim);color:var(--red)}
    .mkt-signal.HOLD{background:rgba(255,255,255,.04);color:var(--text-tertiary)}
    .mkt-patterns{font-size:10px;color:var(--text-secondary);margin-top:2px;line-height:1.4}
    .mkt-mtf{font-size:9px;font-weight:700;padding:2px 6px;border-radius:6px;margin-left:4px}
    .mkt-mtf.buy{background:var(--green-dim);color:var(--green)}
    .mkt-mtf.sell{background:var(--red-dim);color:var(--red)}
    .mkt-mtf.neutral{background:rgba(255,255,255,.04);color:var(--text-tertiary)}
    .mkt-score{font-size:9px;color:var(--text-tertiary);margin-left:4px}
    .dd-bar{display:flex;align-items:center;gap:8px;padding:12px 20px;font-size:11px;color:var(--text-secondary)}
    .dd-item{display:flex;align-items:center;gap:4px}
    .dd-item b{font-weight:700;color:var(--text-primary)}
    .pos-badges{display:flex;gap:4px;margin-top:6px}
    .pos-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:6px}
    .pos-badge.dca{background:var(--yellow-dim);color:var(--yellow)}
    .pos-badge.partial{background:var(--accent-dim);color:var(--accent)}
    .sent-bar{display:flex;align-items:center;gap:6px;padding:8px 20px;margin-bottom:8px}
    .sent-pill{font-size:10px;font-weight:700;padding:3px 8px;border-radius:8px;display:flex;align-items:center;gap:4px}
    .sent-pill.bullish{background:var(--green-dim);color:var(--green)}
    .sent-pill.bearish{background:var(--red-dim);color:var(--red)}
    .sent-pill.neutral{background:rgba(255,255,255,.04);color:var(--text-tertiary)}
    .sent-pill .ico{font-size:12px}
    .fg-gauge{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;border:3px solid}
    .mkt-right{text-align:right;flex-shrink:0}
    .mkt-price{font-size:14px;font-weight:700;transition:color .3s}
    .mkt-price.fg{color:var(--green)}.mkt-price.fr{color:var(--red)}
    .mkt-change{font-size:11px;font-weight:600;margin-top:1px}
    .mkt-change.up{color:var(--green)}.mkt-change.down{color:var(--red)}
    .mkt-spark{width:60px;height:24px;flex-shrink:0}
    .mkt-spark svg{width:100%;height:100%}

    /* === HISTORY TAB === */
    .history-summary{margin:0 20px 16px;padding:18px;display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);border-radius:var(--radius-md);overflow:hidden}
    .hs-cell{background:var(--bg-secondary);padding:14px 10px;text-align:center}
    .hs-val{font-size:18px;font-weight:800}
    .hs-label{font-size:10px;color:var(--text-tertiary);margin-top:3px}

    .trade-list{padding:0 20px}
    .trade-item{display:flex;align-items:center;gap:12px;padding:13px 0;border-bottom:1px solid var(--border)}
    .trade-item:last-child{border:none}
    .trade-icon{width:34px;height:34px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
    .trade-icon.buy{background:var(--green-dim)}.trade-icon.sell{background:var(--red-dim)}.trade-icon.win{background:var(--green-dim)}
    .trade-info{flex:1;min-width:0}
    .trade-main{font-size:13px;font-weight:600;line-height:1.4}
    .trade-main b{font-weight:700}
    .trade-sub{font-size:11px;color:var(--text-tertiary);margin-top:1px}
    .trade-right{text-align:right;flex-shrink:0}
    .trade-amt{font-size:13px;font-weight:700}
    .trade-pnl{font-size:11px;font-weight:600;margin-top:1px}
    .trade-pnl.up{color:var(--green)}.trade-pnl.down{color:var(--red)}

    .trade-item.expandable{cursor:pointer;-webkit-user-select:none}
    .trade-item.expandable:active{opacity:.7}
    .trade-detail{max-height:0;overflow:hidden;transition:max-height .3s ease;padding:0 12px;font-size:11px;color:var(--text-secondary)}
    .trade-detail.open{max-height:400px;padding:8px 12px}
    .trade-detail .td-row{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--border)}
    .trade-detail .td-row:last-child{border:none}
    .trade-detail .td-label{color:var(--text-tertiary)}
    .trade-detail .td-val{font-weight:600}
    .trade-detail .td-reasons{padding:6px 0}
    .trade-detail .td-reason-item{padding:2px 0;display:flex;align-items:center;gap:4px}
    .trade-detail .td-reason-item::before{content:'';width:4px;height:4px;border-radius:50%;background:var(--accent);flex-shrink:0}
    .trade-detail .td-section{font-size:10px;font-weight:700;color:var(--text-tertiary);margin-top:6px;margin-bottom:2px;letter-spacing:.3px}
    .trade-detail .td-val.rsi-low{color:var(--green)}.trade-detail .td-val.rsi-high{color:var(--red)}.trade-detail .td-val.rsi-mid{color:var(--text-secondary)}

    /* === LOG TAB === */
    .log-container{padding:0 20px}
    .log-box{background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:var(--radius-md);padding:16px;max-height:calc(100dvh - 180px);overflow-y:auto;font-family:'SF Mono','Fira Code','Cascadia Code',monospace;font-size:10.5px;line-height:2.1;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.1) transparent}
    .log-box::-webkit-scrollbar{width:3px}.log-box::-webkit-scrollbar-thumb{background:#333;border-radius:2px}
    .log-l{opacity:.85}.log-l .t{color:var(--text-tertiary)}.log-l .tag{font-weight:700}
    .log-l.INFO .tag{color:#06b6d4}.log-l.WARN .tag{color:#f59e0b}.log-l.ERROR .tag{color:var(--red)}.log-l.TRADE .tag{color:var(--yellow)}

    /* === Modal === */
    .modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:200;display:none;align-items:flex-end;justify-content:center}
    .modal-bg.open{display:flex}
    .modal-sheet{background:var(--bg-secondary);border-radius:var(--radius-xl) var(--radius-xl) 0 0;width:100%;max-width:430px;max-height:85vh;overflow-y:auto;padding:12px 20px calc(32px + var(--safe-b));animation:slideUp .3s ease}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .modal-handle{width:36px;height:4px;background:var(--text-tertiary);border-radius:2px;margin:0 auto 16px;opacity:.4}
    .modal-title{text-align:center;font-size:18px;font-weight:800;margin-bottom:4px}
    .modal-subtitle{text-align:center;font-size:11px;color:var(--text-tertiary);margin-bottom:16px}
    .chart-legend{display:flex;gap:12px;justify-content:center;font-size:10px;color:var(--text-secondary);margin-bottom:12px}
    .chart-legend span{display:flex;align-items:center;gap:4px}
    .chart-legend .dot{width:8px;height:3px;border-radius:1px}
    .chart-area{width:100%;height:260px;margin-bottom:16px}
    .chart-area canvas{width:100%!important;height:100%!important}
    .modal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .modal-cell{text-align:center;padding:14px 8px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md)}
    .modal-cell .v{font-size:16px;font-weight:800}
    .modal-cell .l{font-size:10px;color:var(--text-tertiary);margin-top:3px}

    /* === Toast === */
    .toast-wrap{position:fixed;top:12px;left:50%;transform:translateX(-50%);z-index:999;display:flex;flex-direction:column;gap:8px;pointer-events:none;max-width:400px;width:90%}
    .toast{padding:14px 18px;border-radius:var(--radius-md);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);animation:fadeIn .3s ease,fadeOut .3s ease 3.7s forwards;display:flex;align-items:center;gap:10px;font-size:13px;font-weight:600;pointer-events:auto}
    .toast.buy{background:var(--green-dim);border:1px solid rgba(14,203,129,.25);color:var(--green)}
    .toast.win{background:var(--green-dim);border:1px solid rgba(14,203,129,.25);color:var(--green)}
    .toast.loss{background:var(--red-dim);border:1px solid rgba(246,70,93,.25);color:var(--red)}
    .toast .ti{font-size:20px}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeOut{to{opacity:0;transform:translateY(-8px)}}

    /* Sound toggle */
    .sound-toggle{background:none;border:none;font-size:18px;cursor:pointer;padding:4px 6px;border-radius:8px;transition:background .15s}
    .sound-toggle:active{background:var(--bg-card-hover)}

    /* Portfolio hero sub */
    /* hero-portfolio removed â€” integrated into hero balance section */

    /* RSI badge */
    .rsi-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:6px;margin-left:4px}
    .rsi-badge.oversold{background:var(--green-dim);color:var(--green)}
    .rsi-badge.low{background:var(--green-dim);color:var(--green)}
    .rsi-badge.neutral{background:rgba(255,255,255,.04);color:var(--text-tertiary)}
    .rsi-badge.high{background:var(--red-dim);color:var(--red)}
    .rsi-badge.overbought{background:var(--red-dim);color:var(--red)}

    /* === LEARNING TAB === */
    .learn-header{padding:0 20px;margin-bottom:16px}
    .learn-header .conf{display:flex;align-items:center;gap:8px;margin-top:8px}
    .conf-bar{flex:1;height:6px;border-radius:3px;background:rgba(255,255,255,.06);overflow:hidden}
    .conf-fill{height:100%;border-radius:3px;transition:width .5s}
    .conf-label{font-size:11px;font-weight:700;min-width:36px;text-align:right}

    .learn-section{margin:0 20px 16px}
    .learn-section h3{font-size:12px;font-weight:700;color:var(--text-secondary);margin-bottom:10px;letter-spacing:.3px}

    .symbol-table{width:100%;border-collapse:collapse}
    .symbol-table th{font-size:10px;color:var(--text-tertiary);font-weight:600;text-align:left;padding:6px 8px;border-bottom:1px solid var(--border)}
    .symbol-table td{font-size:12px;padding:8px;border-bottom:1px solid var(--border)}
    .symbol-table tr:last-child td{border:none}

    .hour-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:3px}
    .hour-cell{text-align:center;padding:6px 2px;border-radius:6px;font-size:9px;font-weight:700;line-height:1.4}
    .hour-cell .h{color:var(--text-tertiary);font-weight:500}

    .param-list{display:flex;flex-direction:column;gap:6px}
    .param-row{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm)}
    .param-name{font-size:12px;font-weight:600;color:var(--text-secondary)}
    .param-val{font-size:13px;font-weight:800}

    .bl-list{display:flex;flex-wrap:wrap;gap:6px}
    .bl-chip{font-size:11px;font-weight:700;padding:4px 10px;border-radius:8px;background:var(--red-dim);color:var(--red)}

    .learn-btn{width:100%;padding:14px;border:none;border-radius:var(--radius-md);background:var(--accent);color:#fff;font-size:14px;font-weight:700;cursor:pointer;transition:all .15s;margin-top:8px}
    .learn-btn:active{transform:scale(.98);opacity:.8}
    .learn-btn:disabled{opacity:.4;cursor:not-allowed}
    .learn-meta{font-size:11px;color:var(--text-tertiary);text-align:center;margin-top:8px}

    /* Info Modal */
    .info-bg{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px)}
    .info-bg.show{display:flex}
    .info-sheet{width:100%;max-width:430px;background:var(--bg-secondary);border-radius:var(--radius-xl) var(--radius-xl) 0 0;padding:16px 24px 32px;max-height:70vh;overflow-y:auto;animation:slideUp .2s ease}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .info-handle{width:36px;height:4px;border-radius:2px;background:var(--text-tertiary);margin:0 auto 16px;opacity:.4}
    .info-title{font-size:18px;font-weight:800;margin-bottom:4px}
    .info-subtitle{font-size:12px;color:var(--text-secondary);margin-bottom:16px}
    .info-desc{font-size:13px;line-height:1.7;color:var(--text-secondary)}
    .info-desc b{color:var(--text-primary);font-weight:700}
    .info-desc .good{color:var(--green)}.info-desc .bad{color:var(--red)}.info-desc .warn{color:var(--yellow)}
    .info-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
    .info-row:last-child{border:none}
    .info-key{font-size:12px;color:var(--text-secondary)}
    .info-val{font-size:13px;font-weight:700}
    .info-list{margin:12px 0;padding-left:16px}
    .info-list li{font-size:12px;line-height:1.8;color:var(--text-secondary)}
    .tappable{cursor:pointer;-webkit-user-select:none;transition:opacity .15s}
    .tappable:active{opacity:.6}

    /* === P&L Chart === */
    .pnl-chart-section{margin:0 20px 16px}
    .pnl-chart-title{font-size:13px;font-weight:700;color:var(--text-secondary);margin-bottom:10px}
    .pnl-chart-wrap{position:relative;width:100%;height:200px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden}
    .pnl-chart-wrap canvas{width:100%!important;height:100%!important}
    .pnl-chart-empty{display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-tertiary);font-size:13px}
    .pnl-tf-btn{padding:5px 8px;font-size:10px;font-weight:700;border:none;background:var(--bg-card);color:var(--text-tertiary);cursor:pointer;transition:all .15s;outline:none}
    .pnl-tf-btn.active{background:var(--accent);color:#fff}
    .pnl-tf-btn:active{opacity:.7}

    /* === Position Cards (enhanced) === */
    .pos-card-progress{position:relative;height:4px;border-radius:2px;background:rgba(255,255,255,.06);margin-top:8px}
    .pos-card-progress-fill{height:100%;border-radius:2px;transition:width .5s ease}
    .pos-card-progress-label{display:flex;justify-content:space-between;margin-top:3px;font-size:9px;color:var(--text-tertiary)}

    /* === Settings Tab === */
    .settings-section{margin:0 20px 16px}
    .settings-section h3{font-size:12px;font-weight:700;color:var(--text-secondary);margin-bottom:10px;letter-spacing:.3px}
    .bl-mode-toggle{display:flex;gap:0;border-radius:var(--radius-sm);overflow:hidden;border:1px solid var(--border);margin-bottom:12px}
    .bl-mode-btn{flex:1;padding:10px;text-align:center;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;background:var(--bg-card);color:var(--text-secondary);border:none;outline:none}
    .bl-mode-btn.active{background:var(--accent);color:#fff}
    .bl-add-row{display:flex;gap:8px;margin-bottom:12px}
    .bl-input{flex:1;padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-card);color:var(--text-primary);font-size:13px;font-weight:500;outline:none;transition:border-color .2s}
    .bl-input:focus{border-color:var(--accent)}
    .bl-input::placeholder{color:var(--text-tertiary)}
    .bl-add-btn{padding:10px 18px;border:none;border-radius:var(--radius-sm);background:var(--accent);color:#fff;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s;white-space:nowrap}
    .bl-add-btn:active{transform:scale(.96);opacity:.8}
    .bl-tags{display:flex;flex-wrap:wrap;gap:8px}
    .bl-tag{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:700;transition:all .15s}
    .bl-tag.blacklist{background:var(--red-dim);color:var(--red)}
    .bl-tag.whitelist{background:var(--green-dim);color:var(--green)}
    .bl-tag .bl-x{cursor:pointer;font-size:14px;opacity:.7;transition:opacity .15s;line-height:1}
    .bl-tag .bl-x:hover{opacity:1}
    .bl-empty{text-align:center;padding:24px;color:var(--text-tertiary);font-size:13px}

    /* === AI Chatbot === */
    .chat-fab{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b) + 16px);right:max(calc((100vw - 430px)/2 + 16px), 16px);width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#6C5CE7);border:none;color:#fff;font-size:24px;cursor:pointer;z-index:90;box-shadow:0 4px 20px rgba(49,130,246,.4);display:flex;align-items:center;justify-content:center;transition:transform .2s,box-shadow .2s}
    .chat-fab:active{transform:scale(.9)}
    .chat-fab.has-panel{background:var(--red);box-shadow:0 4px 20px rgba(255,71,87,.4)}
    .chat-panel{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b));left:50%;transform:translateX(-50%);width:100%;max-width:430px;height:0;overflow:hidden;background:var(--bg-secondary);border-radius:var(--radius-xl) var(--radius-xl) 0 0;border:1px solid var(--glass-border);border-bottom:none;z-index:95;transition:height .3s ease;display:flex;flex-direction:column}
    .chat-panel.open{height:400px;box-shadow:0 -8px 40px rgba(0,0,0,.3)}
    .chat-header{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0}
    .chat-header-title{font-size:14px;font-weight:700;display:flex;align-items:center;gap:6px}
    .chat-close{background:none;border:none;color:var(--text-tertiary);font-size:20px;cursor:pointer;padding:4px}
    .chat-messages{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:8px}
    .chat-msg{max-width:85%;padding:10px 14px;border-radius:16px;font-size:13px;line-height:1.5;word-break:break-word}
    .chat-msg.user{align-self:flex-end;background:var(--accent);color:#fff;border-bottom-right-radius:4px}
    .chat-msg.bot{align-self:flex-start;background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary);border-bottom-left-radius:4px}
    .chat-msg.bot.loading{color:var(--text-tertiary);font-style:italic}
    .chat-quick{display:flex;gap:6px;padding:8px 16px;flex-shrink:0;overflow-x:auto}
    .chat-quick::-webkit-scrollbar{display:none}
    .chat-quick-btn{padding:6px 12px;border-radius:16px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .15s}
    .chat-quick-btn:active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .chat-input-row{display:flex;gap:8px;padding:8px 16px 12px;border-top:1px solid var(--border);flex-shrink:0}
    .chat-input{flex:1;padding:10px 14px;border:1px solid var(--border);border-radius:20px;background:var(--bg-card);color:var(--text-primary);font-size:13px;outline:none;transition:border-color .2s}
    .chat-input:focus{border-color:var(--accent)}
    .chat-input::placeholder{color:var(--text-tertiary)}
    .chat-send{width:40px;height:40px;border-radius:50%;border:none;background:var(--accent);color:#fff;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
    .chat-send:disabled{opacity:.4;cursor:default}
    .chat-send:active:not(:disabled){transform:scale(.9)}

    @media(max-width:360px){.hero-total-amount{font-size:28px}.hero-pnl-main{font-size:22px}.stats-row{grid-template-columns:repeat(2,1fr)}.hour-grid{grid-template-columns:repeat(8,1fr)}}
  </style>
</head>
<body>
<div class="app">
  <div class="toast-wrap" id="toasts"></div>

  <!-- Info Modal -->
  <div class="info-bg" id="infoModal" onclick="if(event.target===this)closeInfo()">
    <div class="info-sheet">
      <div class="info-handle"></div>
      <div class="info-title" id="infoTitle">-</div>
      <div class="info-subtitle" id="infoSub">-</div>
      <div class="info-desc" id="infoBody">-</div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-bg" id="modal" onclick="if(event.target===this)closeModal()">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-title" id="mTitle">-</div>
      <div class="modal-subtitle">5ë¶„ë´‰ ì°¨íŠ¸ - ìµœê·¼ 5ì‹œê°„</div>
      <div class="chart-legend">
        <span><span class="dot" style="background:var(--green)"></span>ì–‘ë´‰</span>
        <span><span class="dot" style="background:var(--red)"></span>ìŒë´‰</span>
        <span><span class="dot" style="background:rgba(99,102,241,.5)"></span>ë³¼ë¦°ì €</span>
        <span><span class="dot" style="background:var(--yellow)"></span>ì§„ì…ê°€</span>
      </div>
      <div class="chart-area"><canvas id="cc"></canvas></div>
      <div class="modal-grid" id="mStats"></div>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- HOME -->
    <div class="tab-panel active" id="panelHome">
      <div class="status-bar">
        <div class="status-left"><div class="status-dot" id="sDot"></div><span class="status-label" id="sLabel">ì—°ê²° ì¤‘...</span></div>
        <div class="status-right"><span id="sRight">-</span> <button class="sound-toggle" id="soundBtn" onclick="toggleSound()" title="ì•Œë¦¼ìŒ ON/OFF">ğŸ”Š</button></div>
      </div>

      <div class="sent-bar tappable" id="sentBar" style="display:none" onclick="showInfo('sentiment')"></div>
      <div class="home-hero">
        <!-- ì—…ë¹„íŠ¸ ì´ ìì‚° -->
        <div class="hero-total-row">
          <div class="hero-total-label">ì—…ë¹„íŠ¸ ì´ ìì‚°</div>
          <div class="hero-total-amount" id="heroTotalAsset">0ì›</div>
        </div>
        <!-- í˜„ê¸ˆ/íˆ¬ì ë¹„ìœ¨ ë°” -->
        <div class="hero-balance-bar">
          <div class="cash" id="heroBarCash" style="width:100%"></div>
          <div class="invest" id="heroBarInvest" style="width:0%"></div>
        </div>
        <div class="hero-balance-detail">
          <div class="bal-item"><div class="bal-dot" style="background:var(--text-tertiary)"></div><span class="bal-label">í˜„ê¸ˆ</span> <span class="bal-val" id="heroFreeBal">0ì›</span></div>
          <div class="bal-item"><div class="bal-dot" style="background:var(--accent)"></div><span class="bal-label">íˆ¬ìì¤‘</span> <span class="bal-val" id="heroInvestBal">0ì›</span></div>
        </div>
        <!-- í‰ê°€ì†ìµ -->
        <div class="hero-pnl-box" id="heroEvalBox" style="display:none">
          <div class="hero-pnl-title"><span>í˜„ì¬ í‰ê°€ì†ìµ</span><span id="heroEvalPct" style="color:var(--text-tertiary)">0%</span></div>
          <div class="hero-pnl-main" id="heroEvalPnl" style="color:var(--text-tertiary)">0ì›</div>
          <div class="hero-pnl-detail">
            <div><span class="lbl">íˆ¬ìì›ê¸ˆ</span> <span id="heroEvalCost" style="color:var(--text-primary)">0ì›</span></div>
            <div><span class="lbl">í‰ê°€ê¸ˆì•¡</span> <span id="heroEvalCur" style="color:var(--text-primary)">0ì›</span></div>
            <div><span class="lbl">í¬ì§€ì…˜</span> <span id="heroEvalCnt" style="color:var(--text-primary)">0ê°œ</span></div>
          </div>
        </div>
        <!-- ì˜¤ëŠ˜ ì†ìµ -->
        <div class="hero-pnl-box">
          <div class="hero-pnl-title"><span>ì˜¤ëŠ˜ ì†ìµ</span><span id="heroPnlPct" style="color:var(--text-tertiary)">0%</span></div>
          <div class="hero-pnl-main" id="heroTodayPnl" style="color:var(--text-tertiary)">0ì›</div>
          <div class="hero-pnl-detail">
            <div><span class="lbl">ì‹¤í˜„</span> <span id="heroRealized" style="color:var(--text-tertiary)">0ì›</span></div>
            <div><span class="lbl">ë¯¸ì‹¤í˜„</span> <span id="heroUnrealized" style="color:var(--text-tertiary)">0ì›</span></div>
            <div><span class="lbl">íˆ¬ìì†ìµ</span> <span id="heroInvestPnl" style="color:var(--text-tertiary)">0ì›</span></div>
          </div>
        </div>
        <!-- ì˜¤ëŠ˜ ë§¤ë§¤ í†µê³„ -->
        <div class="hero-stat-row" id="heroStatRow">
          <div class="hero-stat-title"><span>ì˜¤ëŠ˜ ë§¤ë§¤</span><span id="heroWinLoss" style="color:var(--text-tertiary)">-</span></div>
          <div class="hero-stat-grid">
            <div class="item"><div class="val" id="heroTodayBuys">0</div><div class="lbl">ë§¤ìˆ˜</div></div>
            <div class="item"><div class="val" id="heroTodaySells">0</div><div class="lbl">ë§¤ë„</div></div>
            <div class="item"><div class="val" id="heroWinRate" style="color:var(--text-tertiary)">0%</div><div class="lbl">ìŠ¹ë¥ </div></div>
            <div class="item"><div class="val" id="heroAvgPnl" style="color:var(--text-tertiary)">0%</div><div class="lbl">í‰ê· </div></div>
          </div>
        </div>
        <!-- ìµœê·¼ ê±°ë˜ -->
        <div class="hero-trades" id="heroTrades"></div>
      </div>
      <div class="hero-chart" id="heroChart"></div>

      <div class="stats-row tappable" id="statsRow" onclick="showInfo('stats')">
        <div class="stat-cell"><div class="stat-val" id="stWin">0</div><div class="stat-label">ìŠ¹</div></div>
        <div class="stat-cell"><div class="stat-val" id="stLoss">0</div><div class="stat-label">íŒ¨</div></div>
        <div class="stat-cell"><div class="stat-val" id="stRate">0%</div><div class="stat-label">ìŠ¹ë¥ </div></div>
        <div class="stat-cell"><div class="stat-val" id="stTrades">0</div><div class="stat-label">ë§¤ë§¤</div></div>
      </div>
      <div id="learnSummary" style="margin:0 20px 12px;display:none">
        <div class="glass" style="padding:14px 16px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <span style="font-size:12px;font-weight:700;color:var(--text-secondary)">ìê°€í•™ìŠµ</span>
            <span style="font-size:11px;color:var(--text-tertiary)" id="lsAge">-</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <span style="font-size:11px;color:var(--text-secondary)">ì‹ ë¢°ë„</span>
            <div style="flex:1;height:5px;border-radius:3px;background:rgba(255,255,255,.06);overflow:hidden"><div id="lsConfBar" style="height:100%;border-radius:3px;width:0%;transition:width .5s"></div></div>
            <span style="font-size:11px;font-weight:700" id="lsConfVal">-</span>
          </div>
          <div style="display:flex;gap:12px;font-size:11px;color:var(--text-secondary)">
            <span>ë¶„ì„ <b id="lsTrades" style="color:var(--text-primary)">-</b>ìŒ</span>
            <span>í‰ê· ìˆ˜ìµ <b id="lsAvgPnl" style="color:var(--text-primary)">-</b></span>
            <span>ìµœê³  <b id="lsBest" style="color:var(--green)">-</b></span>
          </div>
        </div>
      </div>

      <div class="perf-metrics tappable" id="perfMetrics" style="padding:0 20px;margin-bottom:12px;display:none" onclick="showInfo('perf')">
        <div class="stats-row" style="margin-bottom:0">
          <div class="stat-cell"><div class="stat-val" id="pmSharpe">-</div><div class="stat-label">ìƒ¤í”„</div></div>
          <div class="stat-cell"><div class="stat-val" id="pmSortino">-</div><div class="stat-label">ì†Œë¥´í‹°ë…¸</div></div>
          <div class="stat-cell"><div class="stat-val" id="pmPF">-</div><div class="stat-label">ìˆ˜ìµíŒ©í„°</div></div>
          <div class="stat-cell"><div class="stat-val" id="pmRR">-</div><div class="stat-label">ì†ìµë¹„</div></div>
        </div>
      </div>

      <div class="pnl-chart-section">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <div class="pnl-chart-title" style="margin-bottom:0">ìˆ˜ìµë¥  ì¶”ì´</div>
          <div id="pnlTfTabs" style="display:flex;gap:0;border-radius:8px;overflow:hidden;border:1px solid var(--border)">
            <button class="pnl-tf-btn" data-tf="15m" onclick="setPnlTf('15m')">15ë¶„</button>
            <button class="pnl-tf-btn" data-tf="30m" onclick="setPnlTf('30m')">30ë¶„</button>
            <button class="pnl-tf-btn" data-tf="1h" onclick="setPnlTf('1h')">1ì‹œê°„</button>
            <button class="pnl-tf-btn" data-tf="4h" onclick="setPnlTf('4h')">4ì‹œê°„</button>
            <button class="pnl-tf-btn active" data-tf="1d" onclick="setPnlTf('1d')">ì¼ë³„</button>
          </div>
        </div>
        <div class="pnl-chart-wrap glass" id="pnlChartWrap">
          <canvas id="pnlCanvas"></canvas>
          <div class="pnl-chart-empty" id="pnlChartEmpty">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>

      <div class="bot-card glass section-gap tappable" id="botCard" onclick="showInfo('bot')">
        <div class="bot-icon">ğŸ¤–</div>
        <div class="bot-info">
          <div class="bot-title" id="botTitle">ì‹œì¥ì„ ë¶„ì„í•˜ê³  ìˆì–´ìš”</div>
          <div class="bot-desc" id="botDesc">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
        </div>
      </div>

      <div id="adaptiveInfo" style="display:none;padding:4px 20px;display:flex;flex-wrap:wrap;gap:2px"></div>
      <div class="dd-bar tappable" id="ddBar" style="display:none" onclick="showInfo('drawdown')"></div>
      <div style="padding:0 20px"><h2 style="font-size:13px;font-weight:700;color:var(--text-secondary);margin-bottom:12px">ë³´ìœ  ì½”ì¸</h2></div>
      <div class="pos-list" id="posList">
        <div class="pos-empty glass"><div class="ico">ğŸ”</div><p>ì•„ì§ ë§¤ìˆ˜í•œ ì½”ì¸ì´ ì—†ì–´ìš”<br>ë´‡ì´ ì¢‹ì€ íƒ€ì´ë°ì„ ì°¾ê³  ìˆì–´ìš”</p></div>
      </div>

      <div style="padding:0 20px"><h2 style="font-size:13px;font-weight:700;color:var(--text-secondary);margin-bottom:12px">ìµœê·¼ í™œë™</h2></div>
      <div id="feedList" style="padding:0 20px;margin-bottom:16px">
        <div class="trade-item"><div class="trade-icon buy">ğŸ”</div><div class="trade-info"><div class="trade-main">ë´‡ì´ ì‹œì‘ë˜ì—ˆì–´ìš”</div><div class="trade-sub">ë§¤ìˆ˜ ì‹œê·¸ë„ ëŒ€ê¸° ì¤‘</div></div></div>
      </div>
    </div>

    <!-- MARKET -->
    <div class="tab-panel" id="panelMarket">
      <div class="status-bar"><div class="status-left"><span class="status-label">ì‹œì¥ í˜„í™©</span></div><div class="status-right" id="mktTime">-</div></div>
      <div class="market-list" id="marketList"></div>
    </div>

    <!-- HISTORY -->
    <div class="tab-panel" id="panelHistory">
      <div class="status-bar"><div class="status-left"><span class="status-label">ë§¤ë§¤ ê¸°ë¡</span></div><div class="status-right" id="histPeriod">ì „ì²´</div></div>
      <div class="history-summary" id="histSummary">
        <div class="hs-cell"><div class="hs-val" style="color:var(--green)" id="hWin">0</div><div class="hs-label">ìŠ¹ë¦¬</div></div>
        <div class="hs-cell"><div class="hs-val" style="color:var(--red)" id="hLoss">0</div><div class="hs-label">íŒ¨ë°°</div></div>
        <div class="hs-cell"><div class="hs-val" id="hTotal">0ì›</div><div class="hs-label">ì‹¤í˜„ ì†ìµ</div></div>
      </div>
      <div class="trade-list" id="histList"></div>
    </div>

    <!-- LOG -->
    <div class="tab-panel" id="panelLog">
      <div class="status-bar"><div class="status-left"><span class="status-label">ì‹¤ì‹œê°„ ë¡œê·¸</span></div><div class="status-right" id="logCount">0ê±´</div></div>
      <div class="log-container"><div class="log-box" id="logBox"></div></div>
    </div>

    <!-- LEARNING -->
    <div class="tab-panel" id="panelLearn">
      <div class="status-bar"><div class="status-left"><span class="status-label">ìê°€í•™ìŠµ</span></div><div class="status-right" id="learnRight">-</div></div>

      <div class="learn-header">
        <div class="conf">
          <span style="font-size:11px;color:var(--text-secondary);font-weight:600">ì‹ ë¢°ë„</span>
          <div class="conf-bar"><div class="conf-fill" id="confFill" style="width:0%;background:var(--text-tertiary)"></div></div>
          <span class="conf-label" id="confLabel">-</span>
        </div>
      </div>

      <div class="learn-section">
        <h3>ì¢…ëª©ë³„ ì„±ì í‘œ</h3>
        <div class="glass" style="overflow-x:auto;padding:4px">
          <table class="symbol-table" id="learnSymTable">
            <thead><tr><th>ì¢…ëª©</th><th>ê±°ë˜</th><th>ìŠ¹ë¥ </th><th>í‰ê· </th><th>ì ìˆ˜</th></tr></thead>
            <tbody id="learnSymBody"><tr><td colspan="5" style="text-align:center;color:var(--text-tertiary);padding:20px">ë°ì´í„° ì—†ìŒ</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="learn-section">
        <h3>ì‹œê°„ëŒ€ë³„ ìˆ˜ìµë¥ </h3>
        <div class="hour-grid" id="hourGrid"></div>
      </div>

      <div class="learn-section">
        <h3>ì ìš© ì¤‘ì¸ íŒŒë¼ë¯¸í„°</h3>
        <div class="param-list" id="paramList"></div>
      </div>

      <div class="learn-section" id="blSection" style="display:none">
        <h3>ë¸”ë™ë¦¬ìŠ¤íŠ¸</h3>
        <div class="bl-list" id="blList"></div>
      </div>

      <div class="learn-section" id="comboSection" style="display:none">
        <h3>ì‹œê·¸ë„ ì¡°í•©ë³„ ì„±ê³¼</h3>
        <div class="glass" style="overflow-x:auto;padding:4px">
          <table class="symbol-table" id="comboTable">
            <thead><tr><th>ì¡°í•©</th><th>ê±°ë˜</th><th>ìŠ¹ë¥ </th><th>í‰ê· </th><th>ì¶”ì„¸</th></tr></thead>
            <tbody id="comboBody"></tbody>
          </table>
        </div>
        <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px;text-align:center" id="comboMeta"></div>
      </div>

      <div class="learn-section" id="btSection" style="display:none">
        <h3>ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼</h3>
        <div class="glass" style="padding:14px" id="btResults"></div>
        <div style="font-size:10px;color:var(--text-tertiary);margin-top:6px;text-align:center" id="btMeta"></div>
      </div>

      <div class="learn-section" style="display:flex;gap:8px">
        <button class="learn-btn" id="learnBtn" onclick="triggerLearning()" style="flex:1">í•™ìŠµ ì‹¤í–‰</button>
        <button class="learn-btn" id="btBtn" onclick="triggerBacktest()" style="flex:1;background:var(--bg-card);border:1px solid var(--accent);color:var(--accent)">ë°±í…ŒìŠ¤íŠ¸</button>
      </div>
      <div class="learn-meta" id="learnMeta">-</div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-panel" id="panelSettings">
      <div class="status-bar"><div class="status-left"><span class="status-label">ì„¤ì •</span></div><div class="status-right" id="settingsRight">-</div></div>

      <div class="settings-section">
        <h3>ì¢…ëª© í•„í„°</h3>
        <div class="bl-mode-toggle" id="blModeToggle">
          <button class="bl-mode-btn active" id="blModeBlack" onclick="setBlMode('blacklist')">ë¸”ë™ë¦¬ìŠ¤íŠ¸</button>
          <button class="bl-mode-btn" id="blModeWhite" onclick="setBlMode('whitelist')">í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸</button>
        </div>
        <p style="font-size:11px;color:var(--text-tertiary);margin-bottom:12px" id="blModeDesc">ë¸”ë™ë¦¬ìŠ¤íŠ¸: ì•„ë˜ ì¢…ëª©ì„ ë§¤ë§¤ì—ì„œ ì œì™¸í•©ë‹ˆë‹¤</p>
        <div class="bl-add-row">
          <input class="bl-input" id="blSymInput" type="text" placeholder="ì¢…ëª©ëª… (ì˜ˆ: BTC, ETH)" autocomplete="off" />
          <button class="bl-add-btn" onclick="addBlSymbol()">ì¢…ëª© ì¶”ê°€</button>
        </div>
        <div class="glass" style="padding:14px">
          <div class="bl-tags" id="blTagsContainer">
            <div class="bl-empty" id="blTagsEmpty">ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>
          </div>
        </div>
      </div>

      <div class="settings-section" style="margin-top:20px">
        <h3>í•™ìŠµ ë¸”ë™ë¦¬ìŠ¤íŠ¸</h3>
        <p style="font-size:11px;color:var(--text-tertiary);margin-bottom:10px">ìê°€í•™ìŠµìœ¼ë¡œ ìë™ ì¶”ê°€ëœ ì¢…ëª©</p>
        <div class="glass" style="padding:14px">
          <div class="bl-tags" id="learnBlTags">
            <div class="bl-empty">í•™ìŠµ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì—†ìŒ</div>
          </div>
        </div>
      </div>
    </div>

    <!-- System Tab -->
    <div class="tab-panel" id="panelSystem">
      <div class="status-bar"><div class="status-left"><span class="status-label">ì‹œìŠ¤í…œ ì •ë³´</span></div><div class="status-right" id="sysVersion">v2.0</div></div>

      <div class="learn-section">
        <h3>í™œì„± ì§€í‘œ</h3>
        <div class="glass" style="padding:16px" id="sysIndicators"></div>
      </div>

      <div class="learn-section">
        <h3>ë§¤ë§¤ ê¸°ì¤€</h3>
        <div class="glass" style="padding:16px" id="sysStrategy"></div>
      </div>

      <div class="learn-section">
        <h3>ì „ëµ ì„±ê³¼ TOP</h3>
        <div class="glass" style="padding:4px" id="sysTopStrategies"></div>
      </div>

      <div class="learn-section">
        <h3>ì‹¤ì‹œê°„ ìƒíƒœ</h3>
        <div class="glass" style="padding:16px" id="sysLiveStatus"></div>
      </div>
    </div>

    <!-- Updates Tab -->
    <div class="tab-panel" id="panelUpdates">
      <div class="status-bar"><div class="status-left"><span class="status-label">ì—…ë°ì´íŠ¸ ê¸°ë¡</span></div><div class="status-right">v2.0</div></div>
      <div id="updatesList" style="padding:0 4px"></div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('Home')">
      <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span>í™ˆ</span>
    </div>
    <div class="nav-item" onclick="switchTab('Market')">
      <svg viewBox="0 0 24 24"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
      <span>ì‹œì¥</span>
    </div>
    <div class="nav-item" onclick="switchTab('History')">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <span>ê¸°ë¡</span>
    </div>
    <div class="nav-item" onclick="switchTab('Settings')">
      <svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
      <span>ì„¤ì •</span>
    </div>
    <div class="nav-item" onclick="switchTab('System')">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      <span>ì‹œìŠ¤í…œ</span>
    </div>
    <div class="nav-item" onclick="switchTab('Updates')">
      <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      <span>ì—…ë°ì´íŠ¸</span>
    </div>
    <div class="nav-item" onclick="switchTab('Learn')">
      <svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      <span>í•™ìŠµ</span>
    </div>
  </div>

  <!-- AI Chatbot -->
  <button class="chat-fab" id="chatFab" onclick="toggleChat()">ğŸ’¬</button>
  <div class="chat-panel" id="chatPanel">
    <div class="chat-header">
      <div class="chat-header-title">ğŸ¤– AI ì–´ì‹œìŠ¤í„´íŠ¸</div>
      <button class="chat-close" onclick="toggleChat()">âœ•</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-msg bot">ì•ˆë…•í•˜ì„¸ìš”! ë´‡ ìƒíƒœì— ëŒ€í•´ ê¶ê¸ˆí•œ ê±¸ ë¬¼ì–´ë³´ì„¸ìš”.</div>
    </div>
    <div class="chat-quick">
      <button class="chat-quick-btn" onclick="chatQuick('í˜„ì¬ ìƒíƒœ ìš”ì•½í•´ì¤˜')">í˜„í™©</button>
      <button class="chat-quick-btn" onclick="chatQuick('ì˜¤ëŠ˜ ê±°ë˜ ë‚´ì—­ ì•Œë ¤ì¤˜')">ì˜¤ëŠ˜ê±°ë˜</button>
      <button class="chat-quick-btn" onclick="chatQuick('ë³´ìœ  í¬ì§€ì…˜ ë¶„ì„í•´ì¤˜')">í¬ì§€ì…˜</button>
      <button class="chat-quick-btn" onclick="chatQuick('ì‹œì¥ ë¶„ìœ„ê¸° ì–´ë•Œ?')">ì‹œì¥</button>
    </div>
    <div class="chat-input-row">
      <input class="chat-input" id="chatInput" type="text" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." maxlength="500" onkeydown="if(event.key==='Enter')sendChat()">
      <button class="chat-send" id="chatSendBtn" onclick="sendChat()">â¤</button>
    </div>
  </div>
</div>

<script>
window.onerror=function(msg,src,line){document.getElementById('sLabel').textContent='JSì—ëŸ¬:'+msg+' L'+line;return false};
let ws, prevPrices={}, logN=0, animPnl=0, lastData=null;
let audio;try{audio=new (window.AudioContext||window.webkitAudioContext)()}catch(e){audio=null}
let soundOn = localStorage.getItem('soundOn') !== 'false';

// Coin colors for icons
const COIN_COLORS={
  BTC:['#F7931A','#E8820E'],ETH:['#627EEA','#4A67D6'],XRP:['#00AAE4','#0090C1'],
  SOL:['#9945FF','#14F195'],DOGE:['#C2A633','#A08B28'],ADA:['#0033AD','#002280'],
  DOT:['#E6007A','#C20066'],MATIC:['#8247E5','#6B37C8'],AVAX:['#E84142','#C53535'],
  LINK:['#2A5ADA','#1E48B8'],ATOM:['#2E3148','#6F7390'],UNI:['#FF007A','#D40066'],
  SAND:['#04ADEF','#0390C9'],MANA:['#FF2D55','#D42447'],AXS:['#0055D5','#0044AA'],
  NEAR:['#00C08B','#00A076'],APT:['#00BFA6','#009E8A'],SUI:['#4DA2FF','#3A8BE0'],
  SEI:['#9B1C2E','#7D1625'],ARB:['#28A0F0','#1E87CC'],OP:['#FF0420','#D40319'],
  USDT:['#26A17B','#1E8C6A'],IP:['#6366F1','#4F46E5'],
  DEFAULT:['#3182F6','#1B6AE0']
};
function getCoinColor(sym){const s=sym.replace('/KRW','');return COIN_COLORS[s]||COIN_COLORS.DEFAULT}

function updateSoundBtn(){
  const btn=document.getElementById('soundBtn');
  btn.textContent=soundOn?'ğŸ”Š':'ğŸ”‡';
}
function toggleSound(){
  soundOn=!soundOn;
  localStorage.setItem('soundOn',soundOn?'true':'false');
  updateSoundBtn();
}

function closeInfo(){document.getElementById('infoModal').classList.remove('show')}
function showInfo(key){
  const d=lastData;
  const el=document.getElementById('infoModal');
  const t=document.getElementById('infoTitle');
  const s=document.getElementById('infoSub');
  const b=document.getElementById('infoBody');
  let title='',sub='',body='';

  if(key==='stats'){
    const st=d?.stats||{};
    title='ì˜¤ëŠ˜ ë§¤ë§¤ ì„±ì ';
    sub='ìì •ì— ì´ˆê¸°í™”ë©ë‹ˆë‹¤';
    body=`<div class="info-row"><span class="info-key">ë§¤ìˆ˜</span><span class="info-val">${st.todayBuys||0}íšŒ</span></div>`+
    `<div class="info-row"><span class="info-key">ë§¤ë„ (ìŠ¹)</span><span class="info-val good">${st.wins||0}íšŒ</span></div>`+
    `<div class="info-row"><span class="info-key">ë§¤ë„ (íŒ¨)</span><span class="info-val bad">${st.losses||0}íšŒ</span></div>`+
    `<div class="info-row"><span class="info-key">ìŠ¹ë¥ </span><span class="info-val">${st.winRate||0}%</span></div>`+
    `<div class="info-row"><span class="info-key">í‰ê·  ì†ìµ</span><span class="info-val">${st.avgPnl||0}ì›</span></div>`+
    (st.bestTrade?`<div class="info-row"><span class="info-key">ìµœê³  ìˆ˜ìµ</span><span class="info-val good">${st.bestTrade.symbol} +${Math.round(st.bestTrade.pnl)}ì›</span></div>`:'')+
    (st.worstTrade?`<div class="info-row"><span class="info-key">ìµœëŒ€ ì†ì‹¤</span><span class="info-val bad">${st.worstTrade.symbol} ${Math.round(st.worstTrade.pnl)}ì›</span></div>`:'');
  }

  else if(key==='perf'){
    const dd=d?.drawdown||{};
    title='ì„±ê³¼ ì§€í‘œ';
    sub='ìµœê·¼ 50ê±°ë˜ ê¸°ì¤€ ê³„ì‚°';
    body=`<div class="info-row"><span class="info-key">ìƒ¤í”„ ë¹„ìœ¨</span><span class="info-val">${dd.sharpeRatio||'-'}</span></div>`+
    `<p class="info-desc">ìˆ˜ìµ ëŒ€ë¹„ <b>ì „ì²´ ë³€ë™ì„±</b> ë¹„ìœ¨. <b class="good">0.5 ì´ìƒ</b>ì´ë©´ ì–‘í˜¸, <b class="bad">0 ì´í•˜</b>ë©´ ì†ì‹¤ ì¤‘.</p>`+
    `<div class="info-row"><span class="info-key">ì†Œë¥´í‹°ë…¸ ë¹„ìœ¨</span><span class="info-val">${dd.sortinoRatio||'-'}</span></div>`+
    `<p class="info-desc">ìƒ¤í”„ì™€ ë¹„ìŠ·í•˜ì§€ë§Œ <b>í•˜ë½ ë³€ë™ì„±ë§Œ</b> íŒ¨ë„í‹°. ìˆ˜ìµì´ ë“¤ì­‰ë‚ ì­‰í•´ë„ ì†ì‹¤ë§Œ ì ìœ¼ë©´ ë†’ê²Œ ë‚˜ì˜´. ë” í˜„ì‹¤ì ì¸ ì§€í‘œ.</p>`+
    `<div class="info-row"><span class="info-key">ìˆ˜ìµíŒ©í„° (PF)</span><span class="info-val">${dd.profitFactor||'-'}</span></div>`+
    `<p class="info-desc"><b>ì´ ìˆ˜ìµ / ì´ ì†ì‹¤</b>. <b class="good">1.5 ì´ìƒ</b>ì´ë©´ ì¢‹ê³ , <b class="bad">1.0 ì´í•˜</b>ë©´ ì†ì‹¤ì´ ë” í¼. í˜„ì¬ ${dd.profitFactor>=1.5?'<b class="good">ì–‘í˜¸</b>':dd.profitFactor>=1?'<b class="warn">ë³¸ì „ ìˆ˜ì¤€</b>':'<b class="bad">ê°œì„  í•„ìš”</b>'}.</p>`+
    `<div class="info-row"><span class="info-key">ì†ìµë¹„ (R:R)</span><span class="info-val">${dd.riskReward||'-'}</span></div>`+
    `<p class="info-desc"><b>í‰ê·  ìˆ˜ìµ / í‰ê·  ì†ì‹¤</b>. <b class="good">1.5 ì´ìƒ</b>ì´ë©´ ì´ê¸¸ ë•Œ ì§ˆ ë•Œë³´ë‹¤ 1.5ë°° ë” ë²ŒìŒ. í˜„ì¬ ${dd.riskReward>=1.5?'<b class="good">ì¢‹ìŒ</b>':dd.riskReward>=1?'<b class="warn">ë³´í†µ</b>':'<b class="bad">ê°œì„  í•„ìš” â€” ì§ˆ ë•Œ ë” ë§ì´ ìƒëŠ” ì¤‘</b>'}.</p>`;
  }

  else if(key==='drawdown'){
    const dd=d?.drawdown||{};
    title='ë¦¬ìŠ¤í¬ í˜„í™©';
    sub='ë“œë¡œë‹¤ìš´ ê¸°ë°˜ ìë™ ì¡°ì ˆ';
    body=`<div class="info-row"><span class="info-key">ì—°ì† ì†ì‹¤</span><span class="info-val">${dd.consecutiveLosses||0}íšŒ</span></div>`+
    `<p class="info-desc">ì—°ì† ì†ì‹¤ì´ ë§ìœ¼ë©´ ìë™ìœ¼ë¡œ í¬ì§€ì…˜ ìˆ˜ì™€ íˆ¬ì ë¹„ì¤‘ì„ ì¤„ì…ë‹ˆë‹¤.<br>2ì—°íŒ¨â†’85%, 3ì—°íŒ¨â†’70%, 5ì—°íŒ¨â†’50%</p>`+
    `<div class="info-row"><span class="info-key">ìµœëŒ€ ë“œë¡œë‹¤ìš´</span><span class="info-val">${dd.maxDrawdownPct||0}%</span></div>`+
    `<p class="info-desc">ìµœê³ ì  ëŒ€ë¹„ ìµœëŒ€ í•˜ë½ í­. <b class="good">5% ì´ë‚´</b> ì–‘í˜¸, <b class="warn">10%</b> ì£¼ì˜, <b class="bad">15% ì´ìƒ</b> ìœ„í—˜.</p>`+
    `<div class="info-row"><span class="info-key">ë™ì  í¬ì§€ì…˜ í•œë„</span><span class="info-val">${dd.dynamicMaxPositions||3}ê°œ</span></div>`+
    `<p class="info-desc">ì—°ì† ì†ì‹¤ì— ë”°ë¼ ìë™ ì¡°ì ˆë©ë‹ˆë‹¤. ê¸°ë³¸ 3ê°œ, ì—°íŒ¨ ì‹œ ì¤„ì–´ë“¦.</p>`+
    `<div class="info-row"><span class="info-key">ì‚¬ì´ì§• ë°°ìœ¨</span><span class="info-val">${Math.round((dd.sizingMultiplier||1)*100)}%</span></div>`+
    `<p class="info-desc">íˆ¬ì ê¸ˆì•¡ ë¹„ìœ¨. ì—°ì† ì†ì‹¤ ì‹œ ìë™ìœ¼ë¡œ ì¶•ì†Œë©ë‹ˆë‹¤.</p>`+
    `<div class="info-row"><span class="info-key">ë¡¤ë§ ìŠ¹ë¥  (ìµœê·¼ 20)</span><span class="info-val">${dd.rollingWinRate||0}%</span></div>`;
  }

  else if(key==='sentiment'){
    const sent=d?.sentiment;
    const fg=sent?.fearGreed||{};
    const kimchi=d?.kimchi;
    const pending=d?.pendingSignals||[];
    title='ì‹œì¥ ê°ì„± ë¶„ì„';
    sub='ì™¸ë¶€ ë°ì´í„° ê¸°ë°˜ ì‹œì¥ ì‹¬ë¦¬';
    body=`<div class="info-row"><span class="info-key">Fear & Greed</span><span class="info-val">${fg.value||'?'} (${fg.label||'?'})</span></div>`+
    `<p class="info-desc">0~100 ì‚¬ì´ ê°’. <b class="good">0~25: ê·¹ë‹¨ ê³µí¬</b> (ì—­ë°œìƒ ë§¤ìˆ˜ ê¸°íšŒ), <b>26~50: ê³µí¬</b>, 51~75: íƒìš•, <b class="bad">76~100: ê·¹ë‹¨ íƒìš•</b> (ë§¤ë„ ê³ ë ¤).<br><br>í˜„ì¬ <b>${fg.value||0}</b>ì´ë¼ ë§¤ìˆ˜ ê¸°ì¤€ì´ <b>${fg.value<15?'2ë°°':fg.value<25?'1.6ë°°':fg.value<40?'1.3ë°°':'ì •ìƒ'}</b>ë¡œ ë†’ì•„ì ¸ ìˆì–´ìš”.${fg.value<15?' ë§¤ìˆ˜ì ìˆ˜ 8 ì´ìƒë§Œ í†µê³¼!':''}</p>`+
    `<div class="info-row"><span class="info-key">ì¢…í•© ê°ì„±</span><span class="info-val">${sent?.overall?.signal||'?'} (${sent?.overall?.score||0})</span></div>`+
    `<p class="info-desc">Reddit + ë‰´ìŠ¤ + F&G ì¢…í•©. ì–‘ìˆ˜ë©´ ê¸ì •ì , ìŒìˆ˜ë©´ ë¶€ì •ì .</p>`+
    (kimchi?`<div class="info-row"><span class="info-key">ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„</span><span class="info-val">${kimchi.avgPremium>0?'+':''}${kimchi.avgPremium}%</span></div><p class="info-desc">í•œêµ­ ê±°ë˜ì†Œì™€ í•´ì™¸ ê±°ë˜ì†Œ ê°€ê²© ì°¨ì´. <b class="bad">3% ì´ìƒ</b>ì´ë©´ ê³¼ì—´, <b class="good">-1% ì´í•˜</b>ë©´ í• ì¸.</p>`:'')+
    (pending.length>0?`<div class="info-row"><span class="info-key">í™•ì¸ëŒ€ê¸° ì¢…ëª©</span><span class="info-val">${pending.length}ê°œ</span></div><p class="info-desc">ë§¤ìˆ˜ ì‹œê·¸ë„ì´ ë‚˜ì™”ì§€ë§Œ <b>í™•ì¸ ìº”ë“¤</b>ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘.<br>ë‹¤ìŒ 5ë¶„ë´‰ì´ <b class="good">ì–‘ë´‰(ì´ˆë¡)</b>ì´ë©´ ë§¤ìˆ˜ ì‹¤í–‰, <b class="bad">ìŒë´‰(ë¹¨ê°•)</b>ì´ë©´ ì·¨ì†Œ.<br><br>ëŒ€ê¸° ì¢…ëª©: <b>${pending.join(', ')}</b></p>`:'')+
    `<div class="info-row"><span class="info-key">ì¼ì¼ ì†ì‹¤ í•œë„</span><span class="info-val">${d?.dailyPnl?.toLocaleString()||0}ì› / -10,000ì›</span></div>`+
    `<p class="info-desc">í•˜ë£¨ -10,000ì› ì´ˆê³¼ ì†ì‹¤ ì‹œ ìë™ ë§¤ë§¤ ì¤‘ë‹¨. í•œë„ 80% ê·¼ì ‘ ì‹œ 30ë¶„ ì¿¨ë‹¤ìš´.</p>`;
  }

  else if(key==='bot'){
    const pos=d?.positionCount||0;
    const maxP=d?.maxPositions||3;
    const regime=d?.regime;
    title='ë´‡ ì „ëµ ìƒíƒœ';
    sub='í˜„ì¬ ì ìš© ì¤‘ì¸ ì„¤ì •';
    body=`<div class="info-row"><span class="info-key">í¬ì§€ì…˜</span><span class="info-val">${pos}/${maxP}ê°œ</span></div>`+
    `<div class="info-row"><span class="info-key">ì‹œì¥ ë ˆì§</span><span class="info-val">${regime?{trending:'ì¶”ì„¸ì¥',ranging:'íš¡ë³´ì¥',volatile:'ê¸‰ë³€ì¥'}[regime.regime]||regime.regime:'ë¶„ì„ ì¤‘'}</span></div>`+
    `<p class="info-desc">ì‹œì¥ ìƒíƒœì— ë”°ë¼ ì „ëµì´ ìë™ ì¡°ì ˆë©ë‹ˆë‹¤.<br><b>ì¶”ì„¸ì¥</b>: íŠ¸ë Œë“œ ë”°ë¼ê°€ê¸°<br><b>íš¡ë³´ì¥</b>: ë³¼ë¦°ì €ë°´ë“œ ë°˜ì „<br><b>ê¸‰ë³€ì¥</b>: ë§¤ë§¤ ë³´ìˆ˜ì </p>`+
    `<div class="info-row"><span class="info-key">ì†ì ˆ</span><span class="info-val">-1.5% (ATR ë™ì )</span></div>`+
    `<div class="info-row"><span class="info-key">ë¸Œë ˆì´í¬ì´ë¸</span><span class="info-val">+1.5%ì— í™œì„±</span></div>`+
    `<p class="info-desc">+1.5% ìˆ˜ìµ ë„ë‹¬ ì‹œ ì†ì ˆì„ ì´ ì§„ì…ê°€ë¡œ ì´ë™ â†’ <b class="good">ë³¸ì „ ë³´ì¥</b></p>`+
    `<div class="info-row"><span class="info-key">ë¶„í• ë§¤ë„</span><span class="info-val">+2%â†’40%, +4%â†’40%</span></div>`+
    `<p class="info-desc">ìˆ˜ìµ ë‚˜ë©´ ë‹¨ê³„ì ìœ¼ë¡œ ë§¤ë„í•´ì„œ í™•ì • ìˆ˜ìµ. ë‚˜ë¨¸ì§€ 20%ëŠ” íŠ¸ë ˆì¼ë§.</p>`+
    `<div class="info-row"><span class="info-key">íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘</span><span class="info-val">+2.5% í›„ ìµœê³ ê°€-1.2%</span></div>`+
    `<p class="info-desc">ìˆ˜ìµì´ +2.5% ë„˜ìœ¼ë©´ ìµœê³ ê°€ë¥¼ ë”°ë¼ê°. ìµœê³ ê°€ì—ì„œ 1.2% ë–¨ì–´ì§€ë©´ ìë™ ë§¤ë„.</p>`+
    `<div class="info-row"><span class="info-key">ì¿¨ë‹¤ìš´</span><span class="info-val">15ë¶„</span></div>`+
    `<div class="info-row"><span class="info-key">ì‹œê°„ë‹¹ ë§¤ìˆ˜</span><span class="info-val">ìµœëŒ€ 3íšŒ</span></div>`+
    `<div class="info-row"><span class="info-key">ìµœëŒ€ ë³´ìœ </span><span class="info-val">4ì‹œê°„ (ê°•ì œ 8ì‹œê°„)</span></div>`;
  }

  t.textContent=title;s.textContent=sub;b.innerHTML=body;
  el.classList.add('show');
}
document.addEventListener('DOMContentLoaded',updateSoundBtn);

// Glass touch effect
document.addEventListener('touchstart',e=>{const g=e.target.closest('.glass');if(!g)return;const r=g.getBoundingClientRect();g.style.setProperty('--tx',(e.touches[0].clientX-r.left)+'px');g.style.setProperty('--ty',(e.touches[0].clientY-r.top)+'px');g.classList.add('touched')},{passive:true});
document.addEventListener('touchend',()=>document.querySelectorAll('.touched').forEach(e=>e.classList.remove('touched')));

function getRsiBadge(rsi){
  if(rsi==null)return'';
  const val=Math.round(rsi);
  let cls;
  if(rsi<30)cls='oversold';else if(rsi<40)cls='low';else if(rsi<=60)cls='neutral';else if(rsi<=70)cls='high';else cls='overbought';
  const label=rsi<30?'ê³¼ë§¤ë„':rsi>70?'ê³¼ë§¤ìˆ˜':val;
  return`<span class="rsi-badge ${cls}">RSI ${label}</span>`;
}

function switchTab(name){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('panel'+name).classList.add('active');
  event.currentTarget.classList.add('active');
}

function beep(type){
  try{
    const o=audio.createOscillator(),g=audio.createGain();
    o.connect(g);g.connect(audio.destination);g.gain.value=.05;
    if(type==='buy'){o.frequency.value=660;o.type='sine';g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.2);o.start();o.stop(audio.currentTime+.2)}
    else if(type==='win'){o.frequency.value=880;o.type='sine';g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.12);o.start();o.stop(audio.currentTime+.12);setTimeout(()=>{const o2=audio.createOscillator(),g2=audio.createGain();o2.connect(g2);g2.connect(audio.destination);o2.frequency.value=1100;o2.type='sine';g2.gain.value=.05;g2.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.15);o2.start();o2.stop(audio.currentTime+.15)},100)}
    else{o.frequency.value=280;o.type='sawtooth';g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.3);o.start();o.stop(audio.currentTime+.3)}
  }catch(e){}
}

function showToast(trade){
  const buy=trade.action==='BUY',sym=trade.symbol.replace('/KRW','');
  const win=trade.pnl!=null&&trade.pnl>0;
  const cls=buy?'buy':(win?'win':'loss');
  const icon=buy?'ğŸŸ¢':(win?'ğŸ‰':'ğŸ”´');
  const pnl=trade.pnl!=null?` (${trade.pnl>0?'+':''}${trade.pnl.toFixed(1)}%)`:'';
  const amt=trade.amount?` ${Math.round(trade.amount).toLocaleString()}ì›`:'';
  const msg=buy?`${sym} ${amt} ë§¤ìˆ˜`:`${sym} ë§¤ë„${pnl}`;
  const el=document.createElement('div');el.className=`toast ${cls}`;
  el.innerHTML=`<span class="ti">${icon}</span><span>${msg}</span>`;
  document.getElementById('toasts').appendChild(el);
  if(soundOn){beep(cls);if(navigator.vibrate)navigator.vibrate(buy?[60,30,60]:[120,60,120])}
  setTimeout(()=>el.remove(),4000);
}

function fmt(n){if(n==null)return'-';if(n>=1e6)return Math.round(n).toLocaleString();if(n>=100)return Math.round(n).toLocaleString();if(n>=1)return n.toFixed(1);return n.toFixed(4)}

function spark(prices,w=60,h=24){
  if(!prices||prices.length<2)return'';
  const mn=Math.min(...prices),mx=Math.max(...prices),r=mx-mn||1,s=w/(prices.length-1);
  const pts=prices.map((p,i)=>`${(i*s).toFixed(1)},${(h-((p-mn)/r)*(h-2)-1).toFixed(1)}`).join(' ');
  const up=prices[prices.length-1]>=prices[0],c=up?'var(--green)':'var(--red)';
  return`<svg viewBox="0 0 ${w} ${h}"><polyline points="${pts}" fill="none" stroke="${c}" stroke-width="1.5" stroke-linecap="round"/></svg>`;
}

function pnlSpark(hist,w=380,h=56){
  if(!hist||hist.length<2)return'';
  const vals=hist.map(h=>h.total);
  const mn=Math.min(...vals,0),mx=Math.max(...vals,0),r=mx-mn||1,s=w/(vals.length-1);
  const zy=(h-3-((0-mn)/r)*(h-6)).toFixed(1);
  const pts=vals.map((v,i)=>`${(i*s).toFixed(1)},${(h-3-((v-mn)/r)*(h-6)).toFixed(1)}`).join(' ');
  const last=vals[vals.length-1],c=last>=0?'var(--green)':'var(--red)';
  const gid='pg'+Math.random().toString(36).slice(2,6);
  const fy=pts.split(' ')[0].split(',')[1],lx=((vals.length-1)*s).toFixed(1);
  return`<svg viewBox="0 0 ${w} ${h}"><defs><linearGradient id="${gid}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${c}" stop-opacity=".2"/><stop offset="100%" stop-color="${c}" stop-opacity="0"/></linearGradient></defs><line x1="0" y1="${zy}" x2="${w}" y2="${zy}" stroke="var(--text-tertiary)" stroke-width=".5" stroke-dasharray="3,3" opacity=".3"/><polygon points="0,${fy} ${pts} ${lx},${zy} 0,${zy}" fill="url(#${gid})"/><polyline points="${pts}" fill="none" stroke="${c}" stroke-width="1.8" stroke-linecap="round"/></svg>`;
}

function animCount(target){
  const el=document.getElementById('heroTodayPnl');
  if(!el)return;
  const diff=target-animPnl;
  if(Math.abs(diff)<1){animPnl=target;el.textContent=`${target>=0?'+':''}${Math.round(target).toLocaleString()}ì›`;return}
  let step=0;const inc=diff/12;
  const t=setInterval(()=>{step++;animPnl+=inc;
    el.textContent=`${animPnl>=0?'+':''}${Math.round(animPnl).toLocaleString()}ì›`;
    if(step>=12){clearInterval(t);animPnl=target}},25);
}

let pollTimer=null;
let wsConnected=false;

function handleStatusData(d){
  lastData=d;
  try{renderHome(d)}catch(err){console.error('renderHome error:',err)}
  try{renderMarket(d)}catch(err){console.error('renderMarket error:',err)}
  try{renderHistory(d)}catch(err){console.error('renderHistory error:',err)}
  try{renderFeed(d.todayTrades||d.recentTrades||[])}catch(err){console.error('renderFeed error:',err)}
  try{renderLearning(d.learning)}catch(err){}
  try{renderCombo(d.combo)}catch(err){}
  try{renderBacktest(d.backtest)}catch(err){}
  try{renderSystemTab(d)}catch(err){console.error('renderSystem error:',err)}
  try{renderSettingsTab(d)}catch(err){console.error('renderSettings error:',err)}
}

let tradesLoaded=false;
function startPolling(){
  if(pollTimer)return;
  async function poll(){
    try{
      const r=await fetch('/api/status');
      if(!r.ok)throw new Error('HTTP '+r.status);
      const d=await r.json();
      handleStatusData(d);
      document.getElementById('sDot').className='status-dot on';
      document.getElementById('sLabel').textContent=wsConnected?'ìë™ë§¤ë§¤ ì¤‘':'ìë™ë§¤ë§¤ ì¤‘ (í´ë§)';
      if(!tradesLoaded){
        tradesLoaded=true;
        try{const tr=await fetch('/api/trades');const td=await tr.json();renderFeed(td)}catch(e){}
        try{const lr=await fetch('/api/logs');const ld=await lr.json();ld.forEach(l=>addLog(l))}catch(e){}
      }
    }catch(e){
      document.getElementById('sLabel').textContent='í´ë§ ì—ëŸ¬: '+e.message;
    }
  }
  poll();
  pollTimer=setInterval(poll,5000);
}

function stopPolling(){
  if(pollTimer){clearInterval(pollTimer);pollTimer=null}
}

function connect(){
  const p=location.protocol==='https:'?'wss:':'ws:';
  let wsUrl=`${p}//${location.host}`;
  console.log('WebSocket ì—°ê²° ì‹œë„:',wsUrl);
  try{ws=new WebSocket(wsUrl)}catch(e){console.error('WS ìƒì„± ì‹¤íŒ¨:',e);startPolling();return}

  // 5ì´ˆ ì•ˆì— ì—°ê²° ì•ˆë˜ë©´ í´ë§ ì‹œì‘
  const fallbackTimer=setTimeout(()=>{
    if(!wsConnected){console.log('WS 5ì´ˆ íƒ€ì„ì•„ì›ƒ, í´ë§ ì „í™˜');startPolling()}
  },5000);

  ws.onopen=()=>{
    wsConnected=true;clearTimeout(fallbackTimer);stopPolling();
    document.getElementById('sDot').className='status-dot on';
    document.getElementById('sLabel').textContent='ìë™ë§¤ë§¤ ì¤‘';
    try{audio.resume()}catch(e){}
    console.log('WebSocket ì—°ê²° ì„±ê³µ');
  };
  ws.onclose=()=>{
    wsConnected=false;
    document.getElementById('sDot').className='status-dot off';
    document.getElementById('sLabel').textContent='ì¬ì—°ê²° ì¤‘...';
    startPolling();
    setTimeout(connect,5000);
  };
  ws.onerror=e=>{console.error('WebSocket error:',e)};
  ws.onmessage=e=>{
    let m;
    try{m=JSON.parse(e.data)}catch(err){console.error('JSON parse error:',err);return}
    if(m.type==='status')handleStatusData(m.data);
    if(m.type==='trades')renderFeed(m.data);
    if(m.type==='trade_event')showToast(m.data);
    if(m.type==='log')addLog(m.data);
    if(m.type==='logs')m.data.forEach(l=>addLog(l));
    if(m.type==='learning_status')handleLearningStatus(m.data);
    if(m.type==='backtest_status')handleBacktestStatus(m.data);
  };
}

function renderHome(d){
  // Status
  const regimeLabel = d.regime ? {trending:'ì¶”ì„¸ì¥',ranging:'íš¡ë³´ì¥',volatile:'ê¸‰ë³€ì¥',unknown:'ë¶„ì„ì¤‘'}[d.regime.regime]||'ë¶„ì„ì¤‘' : '';
  document.getElementById('sRight').textContent=`ìŠ¤ìº” ${d.scanCount}íšŒ${regimeLabel?' Â· '+regimeLabel:''}`;

  // Sentiment bar
  const sent=d.sentiment;
  const sentBar=document.getElementById('sentBar');
  if(sent&&sent.overall){
    sentBar.style.display='flex';
    const fg=sent.fearGreed||{};
    const fgVal=fg.value||50;
    const fgColor=fgVal<=25?'var(--green)':fgVal<=40?'var(--green)':fgVal<=60?'var(--text-tertiary)':fgVal<=75?'var(--red)':'var(--red)';
    const fgLabel=fg.label||'Neutral';
    const ov=sent.overall;
    const ovCls=ov.signal?.includes('bull')?'bullish':ov.signal?.includes('bear')?'bearish':'neutral';
    const redditCls=sent.reddit?.signal?.includes('bull')?'bullish':sent.reddit?.signal?.includes('bear')?'bearish':'neutral';
    const newsCls=sent.news?.signal?.includes('bull')?'bullish':sent.news?.signal?.includes('bear')?'bearish':'neutral';
    const kimchi=d.kimchi;
    const kpStr=kimchi&&kimchi.avgPremium!=null?`<span class="sent-pill ${kimchi.avgPremium>3?'bearish':kimchi.avgPremium<-1?'bullish':'neutral'}"><span class="ico">ğŸ‡°ğŸ‡·</span>ê¹€í”„ ${kimchi.avgPremium>0?'+':''}${kimchi.avgPremium}%</span>`:'';
    const paperStr=d.paperMode?`<span class="sent-pill neutral" style="border:1px solid var(--yellow);color:var(--yellow)">ğŸ“ í˜ì´í¼</span>`:'';
    const pendingStr=d.pendingSignals?.length?`<span class="sent-pill neutral"><span class="ico">â³</span>í™•ì¸ëŒ€ê¸° ${d.pendingSignals.length}</span>`:'';
    sentBar.innerHTML=`${paperStr}<span class="sent-pill ${ovCls}"><span class="ico">ğŸ§ </span>${ov.score>0?'+':''}${ov.score}</span><span class="sent-pill neutral" style="border-color:${fgColor};color:${fgColor}"><span class="ico">ğŸ˜±</span>F&G ${fgVal}</span><span class="sent-pill ${redditCls}"><span class="ico">ğŸ“¡</span>Reddit ${sent.reddit?.score||0}</span><span class="sent-pill ${newsCls}"><span class="ico">ğŸ“°</span>ë‰´ìŠ¤ ${sent.news?.score||0}</span>${kpStr}${pendingStr}`;
  } else { sentBar.style.display='none'; }

  // â”€â”€ ì—…ë¹„íŠ¸ ì”ê³  (ì„œë²„ì—ì„œ ì‹¤ì‹œê°„ ìºì‹œ) â”€â”€
  const bal=d.balance||{};
  const totalAsset=bal.totalAsset||0;
  const freeKRW=bal.free||0;
  const investCurrent=bal.investedCurrent||0;
  const investCost=bal.investedCost||0;

  // ì´ ìì‚°
  document.getElementById('heroTotalAsset').textContent=totalAsset.toLocaleString()+'ì›';

  // í˜„ê¸ˆ/íˆ¬ì ë¹„ìœ¨ ë°”
  const cashPct=totalAsset>0?Math.round(freeKRW/totalAsset*100):100;
  const investPct=100-cashPct;
  document.getElementById('heroBarCash').style.width=cashPct+'%';
  document.getElementById('heroBarInvest').style.width=investPct+'%';
  document.getElementById('heroFreeBal').textContent=freeKRW.toLocaleString()+'ì›';
  document.getElementById('heroInvestBal').textContent=investCurrent.toLocaleString()+'ì›';

  // â”€â”€ í˜„ì¬ í‰ê°€ì†ìµ (í¬ì§€ì…˜ ìˆì„ ë•Œë§Œ) â”€â”€
  const evalBox=document.getElementById('heroEvalBox');
  if(investCost>0){
    evalBox.style.display='';
    const evalPnl=investCurrent-investCost;
    const evalPct=investCost>0?(evalPnl/investCost*100):0;
    const epEl=document.getElementById('heroEvalPnl');
    epEl.textContent=(evalPnl>=0?'+':'')+Math.round(evalPnl).toLocaleString()+'ì›';
    epEl.style.color=evalPnl>0?'var(--green)':evalPnl<0?'var(--red)':'var(--text-tertiary)';
    const epcEl=document.getElementById('heroEvalPct');
    epcEl.textContent=(evalPct>=0?'+':'')+evalPct.toFixed(2)+'%';
    epcEl.style.color=evalPnl>0?'var(--green)':evalPnl<0?'var(--red)':'var(--text-tertiary)';
    document.getElementById('heroEvalCost').textContent=investCost.toLocaleString()+'ì›';
    document.getElementById('heroEvalCur').textContent=investCurrent.toLocaleString()+'ì›';
    document.getElementById('heroEvalCnt').textContent=(d.positions?.length||0)+'ê°œ';
  } else { evalBox.style.display='none'; }

  // â”€â”€ ì˜¤ëŠ˜ ì†ìµ â”€â”€
  const st=d.stats||{};
  const lastPnl=d.pnlHistory?.length?d.pnlHistory[d.pnlHistory.length-1]:null;
  const todayRealized=lastPnl?lastPnl.realized:d.dailyPnl;
  const todayUnrealized=lastPnl?lastPnl.unrealized:0;
  const todayTotal=lastPnl?lastPnl.total:(d.dailyPnl||0);

  // íˆ¬ì ì†ìµ = í˜„ì¬ í‰ê°€ê¸ˆì•¡ - ë§¤ìˆ˜ ì›ê¸ˆ
  const investPnl=investCurrent-investCost;

  const pnlEl=document.getElementById('heroTodayPnl');
  pnlEl.textContent=(todayTotal>=0?'+':'')+Math.round(todayTotal).toLocaleString()+'ì›';
  pnlEl.style.color=todayTotal>0?'var(--green)':todayTotal<0?'var(--red)':'var(--text-tertiary)';
  animCount(todayTotal);

  // ì†ìµë¥  (ì´ìì‚° ëŒ€ë¹„)
  const pnlPctVal=totalAsset>0?(todayTotal/totalAsset*100):0;
  const pctEl=document.getElementById('heroPnlPct');
  pctEl.textContent=(pnlPctVal>=0?'+':'')+pnlPctVal.toFixed(2)+'%';
  pctEl.style.color=pnlPctVal>0?'var(--green)':pnlPctVal<0?'var(--red)':'var(--text-tertiary)';

  // ì‹¤í˜„/ë¯¸ì‹¤í˜„/íˆ¬ìì†ìµ
  const rEl=document.getElementById('heroRealized');
  rEl.textContent=(todayRealized>=0?'+':'')+Math.round(todayRealized).toLocaleString()+'ì›';
  rEl.style.color=todayRealized>0?'var(--green)':todayRealized<0?'var(--red)':'var(--text-tertiary)';
  const uEl=document.getElementById('heroUnrealized');
  uEl.textContent=(todayUnrealized>=0?'+':'')+Math.round(todayUnrealized).toLocaleString()+'ì›';
  uEl.style.color=todayUnrealized>0?'var(--green)':todayUnrealized<0?'var(--red)':'var(--text-tertiary)';
  const ipEl=document.getElementById('heroInvestPnl');
  ipEl.textContent=(investPnl>=0?'+':'')+Math.round(investPnl).toLocaleString()+'ì›';
  ipEl.style.color=investPnl>0?'var(--green)':investPnl<0?'var(--red)':'var(--text-tertiary)';

  // ì˜¤ëŠ˜ ë§¤ë§¤ í†µê³„
  const tw=st.todayWins||0,tl=st.todayLosses||0,twr=st.todayWinRate||0;
  document.getElementById('heroWinLoss').innerHTML=`<span style="color:var(--green)">${tw}ìŠ¹</span> | <span style="color:var(--red)">${tl}íŒ¨</span> | ${twr}%`;
  document.getElementById('heroWinLoss').style.color='';
  document.getElementById('heroTodayBuys').textContent=st.todayBuys||0;
  document.getElementById('heroTodaySells').textContent=st.todaySells||0;
  const wrEl=document.getElementById('heroWinRate');
  wrEl.textContent=twr+'%';
  wrEl.style.color=twr>=50?'var(--green)':twr>0?'var(--red)':'var(--text-tertiary)';
  const apEl=document.getElementById('heroAvgPnl');
  const todayAvg=st.todayAvgPnl||0;
  apEl.textContent=(todayAvg>=0?'+':'')+todayAvg.toFixed(1)+'%';
  apEl.style.color=todayAvg>0?'var(--green)':todayAvg<0?'var(--red)':'var(--text-tertiary)';

  // ìµœê·¼ ê±°ë˜ 3ê±´ (SELLë§Œ)
  const heroTradesEl=document.getElementById('heroTrades');
  const recentSells=(d.todayTrades||[]).filter(t=>t.action==='SELL'&&t.pnl!=null).slice(0,3);
  if(recentSells.length>0){
    heroTradesEl.innerHTML='<div class="ht-title">ìµœê·¼ ê±°ë˜</div>'+recentSells.map(t=>{
      const sym=(t.symbol||'').replace('/KRW','');
      const pnlAmt=t.pnlAmount!=null?t.pnlAmount:(t.amount?t.amount*t.pnl/100:t.pnl);
      const cls=pnlAmt>=0?'up':'down';
      const ago=timeAgo(t.timestamp);
      return `<div class="hero-trade-item"><span class="sym">${sym}</span><span class="pnl ${cls}">${pnlAmt>=0?'+':''}${Math.round(pnlAmt).toLocaleString()}ì› (${t.pnl>=0?'+':''}${t.pnl.toFixed(1)}%)</span><span class="ago">${ago}</span></div>`;
    }).join('');
  } else { heroTradesEl.innerHTML=''; }

  document.getElementById('heroChart').innerHTML=pnlSpark(d.pnlHistory);

  // (í¬íŠ¸í´ë¦¬ì˜¤ ì •ë³´ëŠ” hero ìƒë‹¨ì— í†µí•©ë¨)

  // Stats (ì „ì²´ ëˆ„ì )
  const s=d.stats||{};
  document.getElementById('stWin').textContent=s.wins||0;
  document.getElementById('stWin').style.color='var(--green)';
  document.getElementById('stLoss').textContent=s.losses||0;
  document.getElementById('stLoss').style.color='var(--red)';
  document.getElementById('stRate').textContent=(s.winRate||0)+'%';
  document.getElementById('stRate').style.color=s.winRate>=50?'var(--green)':'var(--red)';
  document.getElementById('stTrades').textContent=(s.totalTrades||0);

  // Learning summary on home
  try{
    var ls=d.learning;
    var lsEl=document.getElementById('learnSummary');
    if(ls&&ls.tradesAnalyzed>0){
      lsEl.style.display='block';
      var conf=Math.round((ls.confidence||0)*100);
      var confColor=conf>=70?'var(--green)':conf>=50?'var(--yellow)':'var(--red)';
      document.getElementById('lsConfBar').style.width=conf+'%';
      document.getElementById('lsConfBar').style.background=confColor;
      document.getElementById('lsConfVal').textContent=conf+'%';
      document.getElementById('lsConfVal').style.color=confColor;
      document.getElementById('lsTrades').textContent=ls.tradesAnalyzed;
      document.getElementById('lsAge').textContent=ls.updatedAt?timeAgo(ls.updatedAt):'';
      var avgP=s.avgPnl||0;
      document.getElementById('lsAvgPnl').textContent=(avgP>=0?'+':'')+avgP.toFixed(1)+'%';
      document.getElementById('lsAvgPnl').style.color=avgP>=0?'var(--green)':'var(--red)';
      var best=s.bestTrade;
      document.getElementById('lsBest').textContent=best?('+'+best.pnl.toFixed(1)+'%'):'-';
    } else { lsEl.style.display='none'; }
  }catch(e){console.error('learnSummary error:',e)}

  // Bot card
  const posN=d.positionCount;
  const af=d.adaptiveFilter;
  if(posN===0){
    document.getElementById('botTitle').textContent='ì¢‹ì€ ë§¤ìˆ˜ íƒ€ì´ë°ì„ ì°¾ê³  ìˆì–´ìš”';
    document.getElementById('botDesc').textContent=`${d.symbols?.length||0}ê°œ ì½”ì¸ ê°ì‹œ ì¤‘`;
  } else {
    document.getElementById('botTitle').textContent=`${posN}ê°œ ì½”ì¸ì„ ë³´ìœ í•˜ê³  ìˆì–´ìš”`;
    const sizeMult=d.drawdown?.sizingMultiplier;
    document.getElementById('botDesc').textContent=sizeMult&&sizeMult<1?`ì†ì ˆ/ìµì ˆ ìë™ê´€ë¦¬ Â· ì‚¬ì´ì§• ${Math.round(sizeMult*100)}%`:`ì†ì ˆ -2% / ìµì ˆ +5% ìë™ ê´€ë¦¬ ì¤‘`;
  }
  // ì ì‘ í•„í„° ìƒíƒœ í‘œì‹œ
  const afEl=document.getElementById('adaptiveInfo');
  if(afEl&&af&&af.reasons?.length>0){
    afEl.style.display='block';
    const afPills=af.reasons.map(r=>{
      const isBlock=r.includes('ë¹„í™œì„±')||r.includes('ì¿¨ë‹¤ìš´');
      const cls=isBlock?'bearish':(r.includes('ì¶•ì†Œ')?'neutral':'neutral');
      return`<span class="sent-pill ${cls}" style="font-size:10px;margin:2px">âš¡${r}</span>`;
    }).join('');
    afEl.innerHTML=afPills;
  } else if(afEl){afEl.style.display='none';}

  // Drawdown bar
  const dd=d.drawdown;
  const ddBar=document.getElementById('ddBar');
  if(dd){
    ddBar.style.display='flex';
    const sharpeColor=dd.sharpeRatio>0.5?'var(--green)':dd.sharpeRatio>0?'var(--yellow)':'var(--red)';
    const lossColor=dd.consecutiveLosses>=3?'var(--red)':dd.consecutiveLosses>=2?'var(--yellow)':'var(--text-primary)';
    ddBar.innerHTML=`<div class="dd-item">Sharpe <b style="color:${sharpeColor}">${dd.sharpeRatio}</b></div><div class="dd-item">ì—°ì†ì†ì‹¤ <b style="color:${lossColor}">${dd.consecutiveLosses}</b></div><div class="dd-item">ìµœëŒ€DD <b>${dd.maxDrawdownPct}%</b></div><div class="dd-item">í¬ì§€ì…˜ <b>${dd.dynamicMaxPositions}ê°œ</b></div>`;

    // ì„±ê³¼ ì§€í‘œ (Sortino, Profit Factor, Risk:Reward)
    try{
      const pm=document.getElementById('perfMetrics');
      if(pm&&(dd.sortinoRatio!=null||dd.profitFactor!=null)){
        pm.style.display='block';
        const colorVal=(v,good,bad)=>v>=good?'var(--green)':v>=bad?'var(--yellow)':'var(--red)';
        document.getElementById('pmSharpe').textContent=dd.sharpeRatio||'-';
        document.getElementById('pmSharpe').style.color=colorVal(dd.sharpeRatio,0.5,0);
        document.getElementById('pmSortino').textContent=dd.sortinoRatio||'-';
        document.getElementById('pmSortino').style.color=colorVal(dd.sortinoRatio,0.5,0);
        document.getElementById('pmPF').textContent=dd.profitFactor||'-';
        document.getElementById('pmPF').style.color=colorVal(dd.profitFactor,1.5,1.0);
        document.getElementById('pmRR').textContent=dd.riskReward||'-';
        document.getElementById('pmRR').style.color=colorVal(dd.riskReward,1.5,1.0);
      }
    }catch(e){console.error('perfMetrics error:',e)}
  }

  // Positions
  const pl=document.getElementById('posList');
  if(!d.positions?.length){
    pl.innerHTML='<div class="pos-empty glass"><div class="ico">ğŸ“­</div><p>ë³´ìœ  í¬ì§€ì…˜ ì—†ìŒ<br>ë´‡ì´ ì¢‹ì€ íƒ€ì´ë°ì„ ì°¾ê³  ìˆì–´ìš”</p></div>';
  } else {
    pl.innerHTML=d.positions.map(p=>{
      const pnl=p.pnlPct||0,up=pnl>=0;
      const curVal=Math.round(p.amount*(1+pnl/100));
      const pnlKrw=curVal-Math.round(p.amount);
      const barPct=Math.max(0,Math.min(100,(pnl+2)/7*100));
      const sym=p.symbol.replace('/KRW','');
      const [c1,c2]=getCoinColor(sym);
      const glowCls=up?'profit-glow':'loss-glow';
      // Hold time formatted
      const holdH=Math.floor(p.holdMinutes/60);
      const holdM=p.holdMinutes%60;
      const holdStr=holdH>0?holdH+'ì‹œê°„ '+holdM+'ë¶„':holdM+'ë¶„';
      // Progress bar from entry to take-profit
      const tpPct=(p.takeProfit&&p.entryPrice)?((p.takeProfit-p.entryPrice)/p.entryPrice*100):5;
      const progressPct=Math.max(0,Math.min(100,(pnl/tpPct)*100));
      const progressColor=up?'linear-gradient(90deg,var(--accent),var(--green))':'linear-gradient(90deg,var(--red),var(--accent))';
      return`<div class="pos-card glass ${glowCls}" onclick="openChart('${p.symbol}')" style="${up?'background:rgba(0,196,140,.04)':'background:rgba(255,71,87,.04)'}">
        <div class="pos-head">
          <div class="pos-symbol"><div class="icon" style="background:linear-gradient(135deg,${c1},${c2});color:#fff">${sym.slice(0,2)}</div><div class="name">${sym}</div></div>
          <div style="text-align:right">
            <div class="pos-pnl ${up?'up':'down'}">${up?'+':''}${pnl.toFixed(2)}%</div>
            <div style="font-size:11px;font-weight:600;color:${up?'var(--green)':'var(--red)'}">${pnlKrw>=0?'+':''}${pnlKrw.toLocaleString()}ì›</div>
          </div>
        </div>
        <div class="pos-detail">
          <div class="pos-amount">${Math.round(p.amount).toLocaleString()}ì› â†’ <b>${curVal.toLocaleString()}ì›</b></div>
          <div class="pos-price" style="color:${up?'var(--green)':'var(--red)'}">${fmt(p.currentPrice)}</div>
        </div>
        <div class="pnl-bar">
          <div class="pnl-bar-fill ${up?'up':'down'}" style="width:${barPct}%"></div>
          <div class="pnl-bar-dot ${up?'up':'down'}" style="left:calc(${barPct}% - 6px)"></div>
        </div>
        <div class="pnl-labels"><span>ì†ì ˆ ${fmt(p.stopLoss)}</span><span>ì§„ì… ${fmt(p.entryPrice)}</span><span>ìµì ˆ ${fmt(p.takeProfit)}</span></div>
        <div class="pos-card-progress"><div class="pos-card-progress-fill" style="width:${progressPct}%;background:${progressColor}"></div></div>
        <div class="pos-card-progress-label"><span>ì§„ì…ê°€</span><span style="font-weight:600;color:${up?'var(--green)':'var(--red)'}">${Math.round(progressPct)}%</span><span>ëª©í‘œê°€</span></div>
        ${p.dcaCount||p.partialSells||p.breakevenSet||p.trailingActive?`<div class="pos-badges">${p.breakevenSet?`<span class="pos-badge" style="background:var(--green-dim);color:var(--green)">BE ë³¸ì „ë³´ì¥</span>`:''}${p.trailingActive?`<span class="pos-badge" style="background:var(--accent-dim);color:var(--accent)">Trail ìµœê³ ${p.highestPnlPct||0}%</span>`:''}${p.dcaCount?`<span class="pos-badge dca">DCA ${p.dcaCount}íšŒ</span>`:''}${p.partialSells?`<span class="pos-badge partial">ë¶„í• ë§¤ë„ ${p.partialSells}íšŒ</span>`:''}</div>`:''}
        <div class="pos-meta">
          <span>ì§„ì…ê°€ <b>${fmt(p.entryPrice)}</b></span>
          <span>ë³´ìœ  <b>${holdStr}</b></span>
          <span style="color:var(--accent)">ì°¨íŠ¸ ë³´ê¸° â†’</span>
        </div>
      </div>`;
    }).join('');
  }
}

function renderFeed(trades){
  const el=document.getElementById('feedList');
  if(!trades?.length){el.innerHTML='<div class="trade-item"><div class="trade-icon buy">ğŸ”</div><div class="trade-info"><div class="trade-main">ë´‡ì´ ì‹œì‘ë˜ì—ˆì–´ìš”</div><div class="trade-sub">ë§¤ìˆ˜ ì‹œê·¸ë„ ëŒ€ê¸° ì¤‘</div></div></div>';return}
  el.innerHTML=trades.slice(0,8).map(t=>{
    const isBuy=t.action==='BUY'||t.action==='DCA',isDCA=t.action==='DCA',sym=t.symbol.replace('/KRW','');
    const time=new Date(t.timestamp).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
    const icon=isBuy?(isDCA?'ğŸ“¥':'ğŸ’°'):'ğŸ’¸';
    const cls=isBuy?'buy':(t.pnl>0?'win':'sell');
    const amt=t.amount?`${Math.round(t.amount).toLocaleString()}ì›`:'';
    let msg,pnlStr='';
    if(isBuy){msg=`<b>${sym}</b> ${isDCA?'ë¬¼íƒ€ê¸°':'ë§¤ìˆ˜'}`}
    else{msg=`<b>${sym}</b> ë§¤ë„`;if(t.pnl!=null)pnlStr=`<span class="trade-pnl ${t.pnl>=0?'up':'down'}">${t.pnl>=0?'+':''}${t.pnl.toFixed(1)}%</span>`}
    const detail=buildTradeDetail(t);
    const expandCls=detail?'expandable':'';
    return`<div class="trade-item ${expandCls}" ${detail?'onclick="toggleTradeDetail(this)"':''}>
      <div class="trade-icon ${cls}">${icon}</div>
      <div class="trade-info"><div class="trade-main">${msg}</div><div class="trade-sub">${time} Â· ${t.reason||''}</div></div>
      <div class="trade-right"><div class="trade-amt">${amt}</div>${pnlStr}</div>
    </div>${detail}`;
  }).join('');
}

function renderMarket(d){
  document.getElementById('mktTime').textContent=new Date().toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const sd=d.symbolData||[];
  const held=new Set(d.positions?.map(p=>p.symbol)||[]);
  document.getElementById('marketList').innerHTML=sd.map(s=>{
    const sym=s.symbol.replace('/KRW','');
    const ch=s.change!=null?s.change:0;
    const chStr=ch>=0?`+${ch.toFixed(2)}%`:`${ch.toFixed(2)}%`;
    const prev=prevPrices[s.symbol];
    let flash='';
    if(prev&&s.price){if(s.price>prev)flash='fg';else if(s.price<prev)flash='fr'}
    if(s.price)prevPrices[s.symbol]=s.price;
    const act=s.action||'HOLD';
    const isHeld=held.has(s.symbol);
    const [mc1,mc2]=getCoinColor(sym);
    // Patterns and MTF
    const cp=s.patterns?.candle||[];
    const chp=s.patterns?.chart||[];
    const allPats=[...cp.map(p=>p.emoji+p.name),...chp.map(p=>p.emoji+p.name)];
    const patStr=allPats.length>0?allPats.slice(0,3).join(' '):'';
    const mtfSig=s.mtf?.signal||'';
    const mtfCls=mtfSig.includes('buy')?'buy':mtfSig.includes('sell')?'sell':'neutral';
    const scoreStr=s.scores?`B:${s.scores.buy?.toFixed(1)||0} S:${s.scores.sell?.toFixed(1)||0}`:'';
    const obStr=s.orderbook&&Math.abs(s.orderbook)>0.3?`<span style="font-size:9px;color:${s.orderbook>0?'var(--green)':'var(--red)'}">${s.orderbook>0?'ë§¤ìˆ˜â†‘':'ë§¤ë„â†‘'}</span>`:'';
    const vwapInfo=s.indicators?.vwap;
    const vwapStr=vwapInfo&&vwapInfo.signal!=='neutral'?`<span style="font-size:9px;color:${vwapInfo.score>0?'var(--green)':'var(--red)'}">VWAP${vwapInfo.deviation>0?'+':''}${vwapInfo.deviation}%</span>`:'';
    const divInfo=s.indicators?.macd?.divergence;
    const divStr=divInfo&&divInfo.type!=='none'?`<span style="font-size:9px;color:${divInfo.type==='bullish'?'var(--green)':'var(--red)'}">DIV${divInfo.type==='bullish'?'â†‘':'â†“'}</span>`:'';
    return`<div class="market-row" onclick="openChart('${s.symbol}')" ${isHeld?'style="background:var(--green-dim);border-radius:var(--radius-sm);margin:0 -8px;padding:14px 8px"':''}>
      <div class="mkt-icon" style="background:linear-gradient(135deg,${mc1},${mc2});color:#fff">${sym.slice(0,2)}</div>
      <div class="mkt-info">
        <div class="mkt-name">${sym} ${isHeld?'<span style="font-size:10px;color:var(--green);font-weight:600">ë³´ìœ ì¤‘</span>':''} <span class="mkt-signal ${act}">${act==='BUY'?'ë§¤ìˆ˜':act==='SELL'?'ë§¤ë„':'ê´€ë§'}</span> ${getRsiBadge(s.indicators?.rsi)}${mtfSig?`<span class="mkt-mtf ${mtfCls}">${mtfSig}</span>`:''}</div>
        <div class="mkt-vol">24h ${ch>=0?'â–²':'â–¼'} ${Math.abs(ch).toFixed(2)}%${scoreStr?` Â· <span class="mkt-score">${scoreStr}</span>`:''}${obStr?' Â· '+obStr:''}${vwapStr?' Â· '+vwapStr:''}${divStr?' Â· '+divStr:''}</div>
        ${patStr?`<div class="mkt-patterns">${patStr}</div>`:''}
      </div>
      <div class="mkt-spark">${spark(s.sparkline)}</div>
      <div class="mkt-right">
        <div class="mkt-price ${flash}">${s.price?fmt(s.price):'-'}</div>
        <div class="mkt-change ${ch>0?'up':ch<0?'down':''}">${chStr}</div>
      </div>
    </div>`;
  }).join('');
  setTimeout(()=>document.querySelectorAll('.fg,.fr').forEach(e=>{e.classList.remove('fg','fr')}),500);
}

function toggleTradeDetail(el){
  const detail=el.nextElementSibling;
  if(detail&&detail.classList.contains('trade-detail')){detail.classList.toggle('open')}
}

function buildTradeDetail(t){
  const buy=t.action==='BUY';
  const snap=t.snapshot||{};
  const hasSnap=snap.rsi!=null||snap.buyScore!=null;
  const hasReason=t.reason&&t.reason.length>0;
  if(!hasSnap&&!hasReason)return'';

  let html='<div class="trade-detail">';

  // Reason section
  if(hasReason){
    const label=buy?'ë§¤ìˆ˜ ì‚¬ìœ ':'ë§¤ë„ ì‚¬ìœ ';
    html+=`<div class="td-section">${label}</div><div class="td-reasons">`;
    const parts=t.reason.split(/[,ï¼Œ]/).map(s=>s.trim()).filter(Boolean);
    parts.forEach(p=>{html+=`<div class="td-reason-item">${p}</div>`});
    html+='</div>';
  }

  // Scores
  if(snap.buyScore!=null||snap.sellScore!=null){
    html+='<div class="td-section">ì‹œê·¸ë„ ì ìˆ˜</div>';
    if(snap.buyScore!=null)html+=`<div class="td-row"><span class="td-label">ë§¤ìˆ˜ ì ìˆ˜</span><span class="td-val" style="color:var(--green)">${snap.buyScore}</span></div>`;
    if(snap.sellScore!=null)html+=`<div class="td-row"><span class="td-label">ë§¤ë„ ì ìˆ˜</span><span class="td-val" style="color:var(--red)">${snap.sellScore}</span></div>`;
  }

  // Indicators
  if(snap.rsi!=null||snap.bbPosition!=null||snap.macdTrend||snap.volumeRatio!=null){
    html+='<div class="td-section">ì§€í‘œ ìƒíƒœ</div>';
    if(snap.rsi!=null){
      const rCls=snap.rsi<30?'rsi-low':snap.rsi>70?'rsi-high':'rsi-mid';
      const rLabel=snap.rsi<30?'ê³¼ë§¤ë„':snap.rsi>70?'ê³¼ë§¤ìˆ˜':'ì¤‘ë¦½';
      html+=`<div class="td-row"><span class="td-label">RSI</span><span class="td-val ${rCls}">${snap.rsi} (${rLabel})</span></div>`;
    }
    if(snap.bbPosition!=null){
      const bpPct=Math.round(snap.bbPosition*100);
      const bLabel=bpPct<20?'í•˜ë‹¨ ê·¼ì ‘':bpPct>80?'ìƒë‹¨ ê·¼ì ‘':'ì¤‘ê°„ëŒ€';
      html+=`<div class="td-row"><span class="td-label">ë³¼ë¦°ì € ìœ„ì¹˜</span><span class="td-val">${bpPct}% (${bLabel})</span></div>`;
    }
    if(snap.macdTrend){
      const mColor=snap.macdBullish?'var(--green)':'var(--red)';
      const mLabel=snap.macdTrend==='UP'?'ìƒìŠ¹':snap.macdTrend==='DOWN'?'í•˜ë½':'íš¡ë³´';
      html+=`<div class="td-row"><span class="td-label">MACD</span><span class="td-val" style="color:${mColor}">${mLabel}${snap.macdBullish?' (ê³¨ë“ í¬ë¡œìŠ¤)':''}</span></div>`;
    }
    if(snap.volumeRatio!=null){
      const vr=typeof snap.volumeRatio==='number'?snap.volumeRatio.toFixed(1):snap.volumeRatio;
      const vColor=snap.volumeHigh?'var(--green)':'var(--text-secondary)';
      html+=`<div class="td-row"><span class="td-label">ê±°ë˜ëŸ‰ ë°°ìˆ˜</span><span class="td-val" style="color:${vColor}">${vr}x${snap.volumeHigh?' (ê¸‰ì¦)':''}</span></div>`;
    }
    if(snap.vwap&&snap.vwap.signal!=='neutral'){
      html+=`<div class="td-row"><span class="td-label">VWAP</span><span class="td-val">${snap.vwap.signal} (${snap.vwap.deviation>0?'+':''}${snap.vwap.deviation}%)</span></div>`;
    }
    if(snap.macdDivergence&&snap.macdDivergence!=='none'){
      const dColor=snap.macdDivergence==='bullish'?'var(--green)':'var(--red)';
      html+=`<div class="td-row"><span class="td-label">MACD ë‹¤ì´ë²„ì „ìŠ¤</span><span class="td-val" style="color:${dColor}">${snap.macdDivergence==='bullish'?'ê°•ì„¸':'ì•½ì„¸'}</span></div>`;
    }
  }

  // Market regime
  const regime=snap.regime||t.regime;
  if(regime||(snap.volatilityBreakout&&snap.volatilityBreakout!=='NONE')){
    html+='<div class="td-section">ì‹œì¥ ìƒíƒœ</div>';
    if(regime){
      const rMap={trending:'ì¶”ì„¸',ranging:'íš¡ë³´',volatile:'ê¸‰ë³€',unknown:'ë¶„ì„ì¤‘'};
      html+=`<div class="td-row"><span class="td-label">ì‹œì¥ êµ­ë©´</span><span class="td-val">${rMap[regime]||regime}</span></div>`;
    }
    if(snap.volatilityBreakout&&snap.volatilityBreakout!=='NONE'){
      html+=`<div class="td-row"><span class="td-label">ë³€ë™ì„± ëŒíŒŒ</span><span class="td-val" style="color:var(--yellow)">${snap.volatilityBreakout}</span></div>`;
    }
  }

  // MTF / Bandit
  if(t.mtfSignal||t.banditProfile||snap.mtfSignal){
    html+='<div class="td-section">ì¶”ê°€ ì •ë³´</div>';
    const mtf=t.mtfSignal||snap.mtfSignal;
    if(mtf)html+=`<div class="td-row"><span class="td-label">ë‹¤ì¤‘ì‹œê°„ ì‹œê·¸ë„</span><span class="td-val">${mtf}</span></div>`;
    if(t.banditProfile)html+=`<div class="td-row"><span class="td-label">ì „ëµ í”„ë¡œí•„</span><span class="td-val">${t.banditProfile}</span></div>`;
  }

  // Candle/Chart patterns
  if(snap.candlePatterns?.length||snap.chartPatterns?.length){
    html+='<div class="td-section">íŒ¨í„´</div>';
    const allPats=[...(snap.candlePatterns||[]),...(snap.chartPatterns||[])];
    html+=`<div class="td-row"><span class="td-label">ê°ì§€ íŒ¨í„´</span><span class="td-val">${allPats.join(', ')}</span></div>`;
  }

  html+='</div>';
  return html;
}

function renderHistory(d){
  const s=d.stats||{};
  document.getElementById('hWin').textContent=s.wins||0;
  document.getElementById('hLoss').textContent=s.losses||0;
  const pnl=d.dailyPnl||0;
  const hT=document.getElementById('hTotal');
  hT.textContent=`${pnl>=0?'+':''}${Math.round(pnl).toLocaleString()}ì›`;
  hT.style.color=pnl>=0?'var(--green)':'var(--red)';
  document.getElementById('histPeriod').textContent=`${s.totalTrades||0}ê±´ Â· ìŠ¹ë¥  ${s.winRate||0}%`;

  // ì „ì²´ ìµœê·¼ ê¸°ë¡ í‘œì‹œ (recentTrades ì‚¬ìš©, ì—†ìœ¼ë©´ todayTrades í´ë°±)
  const trades=(d.recentTrades||d.todayTrades||[]).slice().reverse();
  if(!trades.length){document.getElementById('histList').innerHTML='<div style="text-align:center;padding:40px;color:var(--text-tertiary)">ë§¤ë§¤ ê¸°ë¡ì´ ì—†ì–´ìš”</div>';return}

  // ë‚ ì§œë³„ ê·¸ë£¨í•‘
  var lastDate='';
  document.getElementById('histList').innerHTML=trades.map(function(t){
    var isBuy=t.action==='BUY'||t.action==='DCA',sym=t.symbol.replace('/KRW','');
    var d2=new Date(t.timestamp);
    var dateStr=(d2.getMonth()+1)+'/'+(d2.getDate())+'ì¼';
    var time=d2.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
    var isDCA=t.action==='DCA';
    var icon=isBuy?(isDCA?'ğŸ“¥':'ğŸ’°'):'ğŸ’¸';
    var cls=isBuy?'buy':(t.pnl>0?'win':'sell');
    var actionLabel=isDCA?'ë¬¼íƒ€ê¸°':(isBuy?'ë§¤ìˆ˜':'ë§¤ë„');
    var amt=t.amount?Math.round(t.amount).toLocaleString()+'ì›':Math.round(t.price*t.quantity).toLocaleString()+'ì›';
    var pnlStr='';
    if(!isBuy&&t.pnl!=null)pnlStr='<div class="trade-pnl '+(t.pnl>=0?'up':'down')+'">'+(t.pnl>=0?'+':'')+t.pnl.toFixed(2)+'%</div>';
    var detail=buildTradeDetail(t);
    var expandCls=detail?'expandable':'';
    var expandHint=detail?'<span style="font-size:9px;color:var(--text-tertiary);margin-left:4px">ìƒì„¸ â–¾</span>':'';
    var dateSep='';
    if(dateStr!==lastDate){lastDate=dateStr;dateSep='<div style="padding:10px 0 6px;font-size:11px;font-weight:700;color:var(--text-tertiary);border-top:1px solid var(--border);margin-top:4px">'+dateStr+'</div>'}
    return dateSep+'<div class="trade-item '+expandCls+'" '+(detail?'onclick="toggleTradeDetail(this)"':'')+'>'+
      '<div class="trade-icon '+cls+'">'+icon+'</div>'+
      '<div class="trade-info"><div class="trade-main"><b>'+sym+'</b> '+actionLabel+expandHint+'</div><div class="trade-sub">'+time+' Â· '+(t.reason||'')+'</div></div>'+
      '<div class="trade-right"><div class="trade-amt">'+amt+'</div>'+pnlStr+'</div>'+
    '</div>'+(detail||'');
  }).join('');
}

function addLog(entry){
  const box=document.getElementById('logBox');
  const time=new Date(entry.time).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const line=document.createElement('div');
  line.className=`log-l ${entry.level}`;
  line.innerHTML=`<span class="t">${time}</span> <span class="tag">[${entry.tag}]</span> ${entry.msg}`;
  box.appendChild(line);logN++;
  if(logN>80){box.removeChild(box.firstChild);logN--}
  box.scrollTop=box.scrollHeight;
  document.getElementById('logCount').textContent=logN+'ê±´';
}

// Chart Modal
async function openChart(symbol){
  document.getElementById('modal').classList.add('open');
  document.getElementById('mTitle').textContent=symbol.replace('/KRW','')+' ì°¨íŠ¸';
  try{const r=await fetch(`/api/candles/${encodeURIComponent(symbol)}`);const data=await r.json();drawChart(data)}
  catch(e){document.getElementById('mStats').innerHTML='<div style="color:var(--red);text-align:center;padding:20px;grid-column:span 3">ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨</div>'}
}
function closeModal(){document.getElementById('modal').classList.remove('open')}

function drawChart(data){
  const canvas=document.getElementById('cc');
  const dpr=window.devicePixelRatio||1;
  const rect=canvas.parentElement.getBoundingClientRect();
  const W=rect.width,H=260;
  canvas.width=W*dpr;canvas.height=H*dpr;
  canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);

  const candles=data.candles||[];if(!candles.length)return;
  const vH=36,cH=H-vH-8,n=candles.length;
  const cw=Math.max(2,(W-16)/n*.55),gap=(W-16)/n;

  let pMin=Infinity,pMax=-Infinity,vMax=0;
  candles.forEach(c=>{
    const lo=c.bb?Math.min(c.low,c.bb.lower):c.low;
    const hi=c.bb?Math.max(c.high,c.bb.upper):c.high;
    if(lo<pMin)pMin=lo;if(hi>pMax)pMax=hi;if(c.volume>vMax)vMax=c.volume});
  const pR=pMax-pMin||1;
  const py=p=>4+(1-(p-pMin)/pR)*cH;

  // BB fill
  ctx.beginPath();
  candles.forEach((c,i)=>{if(!c.bb)return;const x=8+i*gap+gap/2;if(i===0||!candles[i-1].bb)ctx.moveTo(x,py(c.bb.upper));else ctx.lineTo(x,py(c.bb.upper))});
  for(let i=n-1;i>=0;i--){if(!candles[i].bb)continue;ctx.lineTo(8+i*gap+gap/2,py(candles[i].bb.lower))}
  ctx.closePath();ctx.fillStyle='rgba(49,130,246,.06)';ctx.fill();

  ['upper','middle','lower'].forEach((k,idx)=>{
    ctx.beginPath();ctx.strokeStyle=idx===1?'rgba(49,130,246,.3)':'rgba(49,130,246,.15)';
    ctx.lineWidth=idx===1?1:.5;if(idx!==1)ctx.setLineDash([3,3]);else ctx.setLineDash([]);
    let st=false;candles.forEach((c,i)=>{if(!c.bb)return;const x=8+i*gap+gap/2;if(!st){ctx.moveTo(x,py(c.bb[k]));st=true}else ctx.lineTo(x,py(c.bb[k]))});
    ctx.stroke();ctx.setLineDash([])});

  const pos=data.position;
  if(pos){
    ctx.setLineDash([5,3]);
    [[pos.entryPrice,'#FCD535','ì§„ì…ê°€'],[pos.stopLoss,'#FF4757','ì†ì ˆ'],[pos.takeProfit,'#00C48C','ìµì ˆ']].forEach(([p,c,label])=>{
      ctx.beginPath();ctx.strokeStyle=c;ctx.lineWidth=1;
      ctx.moveTo(0,py(p));ctx.lineTo(W,py(p));ctx.stroke();
      ctx.fillStyle=c;ctx.font='bold 10px Pretendard Variable';ctx.fillText(`${label} ${fmt(p)}`,4,py(p)-4)});
    ctx.setLineDash([]);
  }

  candles.forEach((c,i)=>{
    const x=8+i*gap+gap/2,up=c.close>=c.open,col=up?'#00C48C':'#FF4757';
    ctx.beginPath();ctx.strokeStyle=col;ctx.lineWidth=1;ctx.moveTo(x,py(c.high));ctx.lineTo(x,py(c.low));ctx.stroke();
    const t=py(Math.max(c.open,c.close)),b=py(Math.min(c.open,c.close));
    ctx.fillStyle=col;ctx.fillRect(x-cw/2,t,cw,Math.max(1,b-t));
    const vy=H-(c.volume/(vMax||1))*vH;
    ctx.fillStyle=up?'rgba(0,196,140,.1)':'rgba(255,71,87,.1)';
    ctx.fillRect(x-cw/2,vy,cw,H-vy)});

  const last=candles[n-1];
  if(last){const y=py(last.close);ctx.fillStyle=last.close>=last.open?'#00C48C':'#FF4757';
    ctx.beginPath();ctx.moveTo(W-1,y);ctx.lineTo(W-7,y-4);ctx.lineTo(W-7,y+4);ctx.closePath();ctx.fill();
    ctx.font='bold 10px Pretendard Variable';ctx.textAlign='right';ctx.fillText(fmt(last.close),W-9,y+3);ctx.textAlign='left'}

  const info=document.getElementById('mStats');
  if(pos){
    const pnlPct=((last.close-pos.entryPrice)/pos.entryPrice*100).toFixed(2);
    const up=parseFloat(pnlPct)>=0;
    info.innerHTML=`
      <div class="modal-cell"><div class="v" style="color:var(--yellow)">${fmt(pos.entryPrice)}</div><div class="l">ì§„ì…ê°€</div></div>
      <div class="modal-cell"><div class="v">${fmt(last.close)}</div><div class="l">í˜„ì¬ê°€</div></div>
      <div class="modal-cell"><div class="v" style="color:${up?'var(--green)':'var(--red)'}">${up?'+':''}${pnlPct}%</div><div class="l">ìˆ˜ìµë¥ </div></div>`;
  } else {
    info.innerHTML=`
      <div class="modal-cell"><div class="v">${fmt(last.close)}</div><div class="l">í˜„ì¬ê°€</div></div>
      <div class="modal-cell"><div class="v">${fmt(last.high)}</div><div class="l">ê³ ê°€</div></div>
      <div class="modal-cell"><div class="v">${fmt(last.low)}</div><div class="l">ì €ê°€</div></div>`;
  }
}

// â”€â”€â”€ Learning Tab â”€â”€â”€

function renderLearning(learn) {
  if (!learn) {
    document.getElementById('learnRight').textContent = 'í•™ìŠµ ë°ì´í„° ì—†ìŒ';
    document.getElementById('confLabel').textContent = '-';
    document.getElementById('confFill').style.width = '0%';
    return;
  }

  // Meta
  const ago = learn.updatedAt ? timeAgo(learn.updatedAt) : '-';
  document.getElementById('learnRight').textContent = `${learn.tradesAnalyzed}ìŒ ë¶„ì„ Â· ${ago}`;
  document.getElementById('learnMeta').textContent = `ë§ˆì§€ë§‰ í•™ìŠµ: ${ago} Â· ${learn.tradesAnalyzed}ìŒ ë¶„ì„`;

  // Confidence bar
  const conf = Math.round((learn.confidence || 0) * 100);
  const confColor = conf >= 70 ? 'var(--green)' : conf >= 50 ? 'var(--yellow)' : 'var(--red)';
  document.getElementById('confFill').style.width = conf + '%';
  document.getElementById('confFill').style.background = confColor;
  document.getElementById('confLabel').textContent = conf + '%';
  document.getElementById('confLabel').style.color = confColor;

  // Symbol table
  const syms = learn.analysis?.bySymbol || {};
  const sorted = Object.values(syms).sort((a, b) => (b.score || 0) - (a.score || 0));
  const tbody = document.getElementById('learnSymBody');
  if (sorted.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-tertiary);padding:20px">ë°ì´í„° ì—†ìŒ</td></tr>';
  } else {
    tbody.innerHTML = sorted.map(s => {
      const sym = s.symbol.replace('/KRW', '');
      const pnlColor = s.avgPnl >= 0 ? 'var(--green)' : 'var(--red)';
      const scoreColor = s.score >= 70 ? 'var(--green)' : s.score >= 40 ? 'var(--yellow)' : 'var(--red)';
      const bl = (learn.blacklist || []).includes(s.symbol);
      return `<tr>
        <td style="font-weight:700">${sym}${bl ? ' <span style="color:var(--red);font-size:9px">BAN</span>' : ''}</td>
        <td>${s.trades}</td>
        <td style="font-weight:700">${s.winRate}%</td>
        <td style="color:${pnlColor};font-weight:600">${s.avgPnl >= 0 ? '+' : ''}${s.avgPnl.toFixed(1)}%</td>
        <td style="color:${scoreColor};font-weight:800">${s.score}</td>
      </tr>`;
    }).join('');
  }

  // Hour grid
  const hours = learn.analysis?.byHour || {};
  const preferred = new Set(learn.preferredHours || []);
  const avoid = new Set(learn.avoidHours || []);
  let hourHtml = '';
  for (let h = 0; h < 24; h++) {
    const stat = hours[h];
    let bg = 'rgba(255,255,255,.03)';
    let color = 'var(--text-tertiary)';
    if (stat && stat.trades > 0) {
      if (stat.avgPnl > 1) { bg = 'var(--green-dim)'; color = 'var(--green)'; }
      else if (stat.avgPnl > 0) { bg = 'rgba(99,102,241,.12)'; color = 'var(--accent)'; }
      else if (stat.avgPnl > -1) { bg = 'var(--yellow-dim)'; color = 'var(--yellow)'; }
      else { bg = 'var(--red-dim)'; color = 'var(--red)'; }
    }
    const border = preferred.has(h) ? '2px solid var(--green)' : avoid.has(h) ? '2px solid var(--red)' : '1px solid transparent';
    const pnlText = stat && stat.trades > 0 ? `${stat.avgPnl >= 0 ? '+' : ''}${stat.avgPnl.toFixed(1)}` : 'Â·';
    hourHtml += `<div class="hour-cell" style="background:${bg};color:${color};border:${border}"><div class="h">${h}ì‹œ</div>${pnlText}</div>`;
  }
  document.getElementById('hourGrid').innerHTML = hourHtml;

  // Params
  const params = learn.params;
  const paramNames = {RSI_OVERSOLD:'RSI ê³¼ë§¤ë„',RSI_OVERBOUGHT:'RSI ê³¼ë§¤ìˆ˜',STOP_LOSS_PCT:'ì†ì ˆì„ ',TAKE_PROFIT_PCT:'ìµì ˆì„ ',MAX_HOLD_HOURS:'ìµœëŒ€ë³´ìœ '};
  const paramUnits = {RSI_OVERSOLD:'',RSI_OVERBOUGHT:'',STOP_LOSS_PCT:'%',TAKE_PROFIT_PCT:'%',MAX_HOLD_HOURS:'ì‹œê°„'};
  if (params) {
    document.getElementById('paramList').innerHTML = Object.entries(paramNames).map(([key, name]) => {
      const val = params[key];
      if (val == null) return '';
      return `<div class="param-row"><span class="param-name">${name}</span><span class="param-val">${val}${paramUnits[key]}</span></div>`;
    }).join('');
  } else {
    document.getElementById('paramList').innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-tertiary);font-size:12px">ê¸°ë³¸ê°’ ì‚¬ìš© ì¤‘</div>';
  }

  // Blacklist
  const bl = learn.blacklist || [];
  const blSection = document.getElementById('blSection');
  if (bl.length > 0) {
    blSection.style.display = 'block';
    document.getElementById('blList').innerHTML = bl.map(s => `<span class="bl-chip">${s.replace('/KRW', '')}</span>`).join('');
  } else {
    blSection.style.display = 'none';
  }
}

function renderCombo(combo) {
  const sec = document.getElementById('comboSection');
  if (!combo?.stats?.length) { sec.style.display = 'none'; return; }
  sec.style.display = 'block';

  const tbody = document.getElementById('comboBody');
  tbody.innerHTML = combo.stats.map(c => {
    const wrColor = c.winRate >= 60 ? 'var(--green)' : c.winRate >= 40 ? 'var(--yellow)' : 'var(--red)';
    const pnlColor = c.avgPnl >= 0 ? 'var(--green)' : 'var(--red)';
    const trendIcon = c.recentTrend === 'improving' ? '<span style="color:var(--green)">â†‘</span>' :
                      c.recentTrend === 'declining' ? '<span style="color:var(--red)">â†“</span>' : 'â†’';
    return `<tr>
      <td style="font-weight:700;font-size:11px">${c.combo}</td>
      <td>${c.trades}</td>
      <td style="color:${wrColor};font-weight:700">${c.winRate}%</td>
      <td style="color:${pnlColor};font-weight:600">${c.avgPnl >= 0 ? '+' : ''}${c.avgPnl}%</td>
      <td style="text-align:center">${trendIcon}</td>
    </tr>`;
  }).join('');

  const meta = combo.minBuyScore;
  if (meta) {
    document.getElementById('comboMeta').textContent = `ë™ì  ë§¤ìˆ˜ ê¸°ì¤€: ${meta.minBuyScore}ì  Â· ${meta.reason}`;
  }
}

function renderBacktest(bt) {
  const sec = document.getElementById('btSection');
  if (!bt?.summary) { sec.style.display = 'none'; return; }
  sec.style.display = 'block';

  const s = bt.summary;
  const results = bt.results || {};
  const symbols = Object.keys(results).filter(k => !results[k].error);

  let html = `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
    <div style="text-align:center"><div style="font-size:18px;font-weight:800">${s.currentAvgWinRate}%</div><div style="font-size:10px;color:var(--text-tertiary)">í˜„ì¬ ìŠ¹ë¥ </div></div>
    <div style="text-align:center"><div style="font-size:18px;font-weight:800;color:var(--green)">${s.bestAvgWinRate}%</div><div style="font-size:10px;color:var(--text-tertiary)">ìµœì  ìŠ¹ë¥ </div></div>
    <div style="text-align:center"><div style="font-size:18px;font-weight:800;color:${s.improvement > 0 ? 'var(--green)' : 'var(--text-tertiary)'}">${s.improvement > 0 ? '+' : ''}${s.improvement}%p</div><div style="font-size:10px;color:var(--text-tertiary)">ê°œì„ í­</div></div>
  </div>`;

  // ì¢…ëª©ë³„ ê²°ê³¼
  if (symbols.length > 0) {
    html += '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;font-weight:600">ì¢…ëª©ë³„ ê²°ê³¼</div>';
    html += symbols.map(sym => {
      const r = results[sym];
      const cs = r.currentStrategy?.stats;
      const bs = r.gridSearch?.best?.stats;
      const atr = r.atrComparison;
      if (!cs) return '';
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px">
        <span style="font-weight:700">${sym.replace('/KRW','')}</span>
        <span style="color:var(--text-secondary)">${cs.totalTrades}ê±°ë˜ Â· ìŠ¹ë¥  ${cs.winRate}%</span>
        <span style="font-weight:600;color:${cs.returnPct >= 0 ? 'var(--green)' : 'var(--red)'}">${cs.returnPct >= 0 ? '+' : ''}${cs.returnPct}%</span>
        ${atr ? `<span style="font-size:10px;color:${atr.winner === 'ATR' ? 'var(--green)' : 'var(--text-tertiary)'}">${atr.winner === 'ATR' ? 'ATRìŠ¹' : 'ê³ ì •ìŠ¹'}</span>` : ''}
      </div>`;
    }).join('');
  }

  // ì¶”ì²œ íŒŒë¼ë¯¸í„°
  if (s.recommendedParams) {
    const rp = s.recommendedParams;
    html += `<div style="margin-top:12px;padding:10px;background:var(--accent-dim);border-radius:var(--radius-sm);font-size:11px">
      <div style="font-weight:700;color:var(--accent);margin-bottom:4px">ì¶”ì²œ íŒŒë¼ë¯¸í„°</div>
      <div style="color:var(--text-secondary)">SL ${rp.STOP_LOSS_PCT || '-'}% Â· TP +${rp.TAKE_PROFIT_PCT || '-'}% Â· RSI ${rp.RSI_OVERSOLD || '-'}/${rp.RSI_OVERBOUGHT || '-'} Â· ë§¤ìˆ˜ê¸°ì¤€ ${rp.BUY_THRESHOLD || '-'}ì </div>
    </div>`;
  }

  document.getElementById('btResults').innerHTML = html;
  document.getElementById('btMeta').textContent = bt.runAt ? `ë§ˆì§€ë§‰ ì‹¤í–‰: ${timeAgo(bt.runAt)}` : '';
}

function triggerLearning() {
  if (!ws || ws.readyState !== 1) return;
  const btn = document.getElementById('learnBtn');
  btn.disabled = true;
  btn.textContent = 'í•™ìŠµ ì¤‘...';
  ws.send(JSON.stringify({ command: 'run_learning' }));
}

function triggerBacktest() {
  if (!ws || ws.readyState !== 1) return;
  const btn = document.getElementById('btBtn');
  btn.disabled = true;
  btn.textContent = 'í…ŒìŠ¤íŠ¸ ì¤‘...';
  ws.send(JSON.stringify({ command: 'run_backtest' }));
}

function handleLearningStatus(data) {
  const btn = document.getElementById('learnBtn');
  if (data.status === 'done') {
    btn.disabled = false;
    btn.textContent = 'í•™ìŠµ ì‹¤í–‰';
    showToast({ action: 'BUY', symbol: 'í•™ìŠµ/ì™„ë£Œ', amount: 0, reason: 'í•™ìŠµ ì™„ë£Œ' });
  } else if (data.status === 'error') {
    btn.disabled = false;
    btn.textContent = 'í•™ìŠµ ì‹¤í–‰';
  }
}

function handleBacktestStatus(data) {
  const btn = document.getElementById('btBtn');
  if (data.status === 'done') {
    btn.disabled = false;
    btn.textContent = 'ë°±í…ŒìŠ¤íŠ¸';
    btn.style.background = 'var(--bg-card)';
    showToast({ action: 'BUY', symbol: 'ë°±í…ŒìŠ¤íŠ¸/ì™„ë£Œ', amount: 0, reason: 'ë°±í…ŒìŠ¤íŠ¸ ì™„ë£Œ' });
    if (data.result) renderBacktest(data.result);
  } else if (data.status === 'error') {
    btn.disabled = false;
    btn.textContent = 'ë°±í…ŒìŠ¤íŠ¸';
  } else if (data.status === 'running') {
    btn.textContent = 'ì‹¤í–‰ ì¤‘...';
    btn.style.background = 'var(--accent-dim)';
  }
}

function timeAgo(ts) {
  const diff = Date.now() - ts;
  if (diff < 60000) return 'ë°©ê¸ˆ ì „';
  if (diff < 3600000) return Math.round(diff / 60000) + 'ë¶„ ì „';
  if (diff < 86400000) return Math.round(diff / 3600000) + 'ì‹œê°„ ì „';
  return Math.round(diff / 86400000) + 'ì¼ ì „';
}

// === SYSTEM TAB ===
const SYSTEM_VERSION = 'v2.1.0';
const INDICATORS = [
  { name: 'RSI', desc: 'ìƒëŒ€ê°•ë„ì§€ìˆ˜ â€” ê³¼ë§¤ìˆ˜/ê³¼ë§¤ë„ ê°ì§€', icon: '\u{1F4CA}' },
  { name: 'ë³¼ë¦°ì € ë°´ë“œ', desc: 'ê°€ê²© ë²”ìœ„ ì´íƒˆ ê°ì§€, ìƒë‹¨/í•˜ë‹¨ í„°ì¹˜', icon: '\u{1F4C8}' },
  { name: 'MACD', desc: 'ê³¨ë“ í¬ë¡œìŠ¤/ë°ë“œí¬ë¡œìŠ¤, ì¶”ì„¸ ë°©í–¥', icon: '\u{3030}\uFE0F' },
  { name: 'VWAP', desc: 'ê±°ë˜ëŸ‰ê°€ì¤‘í‰ê· ê°€ê²© ëŒ€ë¹„ ì´ê²©ë„', icon: '\u2696\uFE0F' },
  { name: 'ê±°ë˜ëŸ‰ ë¶„ì„', desc: 'í‰ê·  ëŒ€ë¹„ ê±°ë˜ëŸ‰ ê¸‰ì¦/ê¸‰ê° ê°ì§€', icon: '\u{1F4F6}' },
  { name: 'ë©€í‹°íƒ€ì„í”„ë ˆì„', desc: '5ë¶„/1ì‹œê°„/4ì‹œê°„ ë´‰ ë°©í–¥ ì¢…í•©', icon: '\u{1F504}' },
  { name: 'ê°ì„± ë¶„ì„', desc: 'Reddit\u00B7ë‰´ìŠ¤\u00B7Fear&Greed ì¢…í•©', icon: '\u{1F9E0}' },
  { name: 'í˜¸ê°€ ë¶„ì„', desc: 'ë§¤ìˆ˜/ë§¤ë„ë²½ ë¹„ìœ¨ë¡œ ë°©í–¥ì„± íŒë‹¨', icon: '\u{1F4CB}' },
  { name: 'ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„', desc: 'í•œêµ­ í”„ë¦¬ë¯¸ì—„ ê¸°ë°˜ ë§¤ìˆ˜/ë§¤ë„ ë³´ì •', icon: '\u{1F1F0}\u{1F1F7}' },
  { name: 'íŒ¨í„´ ì¸ì‹', desc: 'ë„ì§€\u00B7ë§ì¹˜\u00B7ì‚¼ë³‘ ë“± ìº”ë“¤ìŠ¤í‹± íŒ¨í„´', icon: '\u{1F56F}\uFE0F' },
  { name: 'ì°¨íŠ¸ íŒ¨í„´', desc: 'ì‚¼ê°ìˆ˜ë ´\u00B7ì´ì¤‘ë°”ë‹¥\u00B7í—¤ë“œì•¤ìˆ„ë”', icon: '\u{1F4D0}' },
  { name: 'ìƒê´€ê´€ê³„', desc: 'ë³´ìœ  ì¢…ëª© ê°„ ìƒê´€ê´€ê³„ë¡œ ë¶„ì‚° íˆ¬ì', icon: '\u{1F517}' },
];

const RISK_FEATURES = [
  { name: 'ìë™ ì†ì ˆ', desc: 'ì„¤ì •ëœ ì†ì ˆì„  ë„ë‹¬ ì‹œ ìë™ ë§¤ë„' },
  { name: 'ë¶„í•  ë§¤ë„', desc: '+3%ì— 30%, +5%ì— 30%, ë‚˜ë¨¸ì§€ íŠ¸ë ˆì¼ë§' },
  { name: 'íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘', desc: '+3% í›„ ìµœê³ ì  ëŒ€ë¹„ -1.5% ì´íƒˆ ì‹œ ë§¤ë„' },
  { name: 'ë¸Œë ˆì´í¬ì´ë¸', desc: '+2% ë„ë‹¬ í›„ ì†ì ˆì„ ì„ ë§¤ì…ê°€ë¡œ ì´ë™' },
  { name: 'íœ©ì˜ ë°©ì§€', desc: 'ì†ì ˆì„  3íšŒ í„°ì¹˜ + 5ë¶„ ê²½ê³¼ í›„ ë§¤ë„' },
  { name: 'F&G ì—­ë°œìƒ', desc: 'ê·¹ë‹¨ ê³µí¬ ì‹œ ë§¤ìˆ˜ ê¸°ì¤€ í•˜í–¥ (ê¸°íšŒ í¬ì°©)' },
  { name: 'ìê°€í•™ìŠµ', desc: 'ê±°ë˜ ë°ì´í„° ê¸°ë°˜ íŒŒë¼ë¯¸í„° ìë™ ìµœì í™”' },
  { name: 'ì½¤ë³´ íŠ¸ë˜ì»¤', desc: 'ì‹œê·¸ë„ ì¡°í•©ë³„ ìŠ¹ë¥  ì¶”ì , ì €ìŠ¹ë¥  ì°¨ë‹¨' },
  { name: 'ë©€í‹°ìœ ì €', desc: 'ìµœëŒ€ 3ëª… ë…ë¦½ ë´‡, ì›¹ ë“±ë¡, ìë™ ì‹œì‘' },
];

function renderSystemTab(d) {
  var indEl = document.getElementById('sysIndicators');
  if (indEl) {
    indEl.innerHTML = INDICATORS.map(function(i) {
      return '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">' +
        '<span style="font-size:18px;width:28px;text-align:center">' + i.icon + '</span>' +
        '<div><div style="font-size:13px;font-weight:600;color:var(--text-primary)">' + i.name + '</div>' +
        '<div style="font-size:11px;color:var(--text-secondary)">' + i.desc + '</div></div>' +
        '<div style="margin-left:auto;width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green-glow);flex-shrink:0"></div>' +
        '</div>';
    }).join('');
  }

  var stratEl = document.getElementById('sysStrategy');
  if (stratEl && d) {
    var regime = d.regime ? ({trending:'ì¶”ì„¸ì¥',ranging:'íš¡ë³´ì¥',volatile:'ê¸‰ë³€ì¥',unknown:'ë¶„ì„ì¤‘'}[d.regime.regime]||'ë¶„ì„ì¤‘') : 'ë¶„ì„ì¤‘';
    var fg = d.sentiment ? d.sentiment.fearGreed : null;
    var fgStr = fg ? (fg.value + ' (' + fg.label + ')') : '-';
    var params = [
      ['ë§¤ìˆ˜ ê¸°ì¤€', 'RSI < 32 + ë³¼ë°´ í•˜ë‹¨ + ë³µí•© ì ìˆ˜'],
      ['ë§¤ë„ ê¸°ì¤€', 'RSI > 72 ë˜ëŠ” ë³¼ë°´ ìƒë‹¨ + ì‹œê·¸ë„'],
      ['ì†ì ˆ', '-2.5%'],
      ['ìµì ˆ', '+6% (ë¶„í• : +3%\u219230%, +5%\u219230%)'],
      ['íŠ¸ë ˆì¼ë§', '+3% í™œì„±, -1.5% ì´íƒˆ ì‹œ ë§¤ë„'],
      ['ìµœëŒ€ ë³´ìœ ', (d.maxPositions||10)+'ì¢…ëª©, ì¢…ëª©ë‹¹ '+(d.maxPositions?Math.round(100/d.maxPositions):10)+'%'],
      ['ì‹œì¥ ìƒíƒœ', regime],
      ['Fear & Greed', fgStr],
      ['ìŠ¤ìº” ì£¼ê¸°', '10ì´ˆ'],
      ['ìº”ë“¤', '5ë¶„ë´‰ 200ê°œ'],
    ];
    stratEl.innerHTML = params.map(function(p) {
      return '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)">' +
        '<span style="font-size:12px;color:var(--text-secondary)">' + p[0] + '</span>' +
        '<span style="font-size:12px;font-weight:600;color:var(--text-primary)">' + p[1] + '</span>' +
        '</div>';
    }).join('');
  }

  var topEl = document.getElementById('sysTopStrategies');
  if (topEl && d && d.combo && d.combo.stats && d.combo.stats.length) {
    var top5 = d.combo.stats.filter(function(c){ return c.trades >= 3; }).slice(0, 8);
    if (top5.length) {
      topEl.innerHTML = '<table class="symbol-table"><thead><tr><th>ì „ëµ ì¡°í•©</th><th>ê±°ë˜</th><th>ìŠ¹ë¥ </th><th>í‰ê· </th></tr></thead><tbody>' +
        top5.map(function(c) {
          var wr = c.winRate || 0;
          var color = wr >= 60 ? 'var(--green)' : wr >= 40 ? 'var(--yellow)' : 'var(--red)';
          var avgPnl = c.avgPnl || 0;
          return '<tr><td style="font-size:11px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + c.combo + '</td><td>' + c.trades + '</td><td style="color:' + color + ';font-weight:600">' + wr + '%</td><td style="color:' + (avgPnl>=0?'var(--green)':'var(--red)') + '">' + (avgPnl>0?'+':'') + avgPnl.toFixed(1) + '%</td></tr>';
        }).join('') +
        '</tbody></table>';
    } else {
      topEl.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-tertiary);font-size:13px">ì•„ì§ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤ (ìµœì†Œ 3ê±´ í•„ìš”)</div>';
    }
  }

  var liveEl = document.getElementById('sysLiveStatus');
  if (liveEl && d) {
    var items = [
      ['ê°ì‹œ ì¢…ëª©', (d.symbols ? d.symbols.length : 0) + 'ê°œ'],
      ['ë³´ìœ  í¬ì§€ì…˜', (d.positionCount || 0) + 'ê°œ'],
      ['ì˜¤ëŠ˜ ë§¤ìˆ˜', ((d.stats && d.stats.todayBuys) || 0) + 'íšŒ'],
      ['ì˜¤ëŠ˜ ë§¤ë„', ((d.stats && d.stats.totalTrades) || 0) + 'íšŒ'],
      ['ìŠ¹ë¥ ', ((d.stats && d.stats.winRate) || 0) + '%'],
      ['ì¼ì¼ ì†ìµ', (d.dailyPnl >= 0 ? '+' : '') + (d.dailyPnl || 0).toLocaleString() + 'ì›'],
      ['í•™ìŠµ ì‹ ë¢°ë„', d.learning ? (Math.round(d.learning.confidence * 100) + '%') : '-'],
      ['ë¶„ì„ ê±°ë˜', d.learning ? (d.learning.tradesAnalyzed + 'ê±´') : '-'],
    ];
    liveEl.innerHTML = items.map(function(it) {
      return '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)">' +
        '<span style="font-size:12px;color:var(--text-secondary)">' + it[0] + '</span>' +
        '<span style="font-size:12px;font-weight:600;color:var(--text-primary)">' + it[1] + '</span>' +
        '</div>';
    }).join('') +
    RISK_FEATURES.map(function(f) {
      return '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">' +
        '<div style="width:6px;height:6px;border-radius:50%;background:var(--green);flex-shrink:0"></div>' +
        '<div><span style="font-size:12px;font-weight:600;color:var(--text-primary)">' + f.name + '</span>' +
        '<span style="font-size:11px;color:var(--text-secondary)"> \u2014 ' + f.desc + '</span></div>' +
        '</div>';
    }).join('');
  }

  var verEl = document.getElementById('sysVersion');
  if (verEl) verEl.textContent = SYSTEM_VERSION;
}

// === UPDATES TAB ===
const CHANGELOG = [
  {
    version: 'v2.5.0',
    date: '2026-02-16',
    title: 'ìŠ¤ë§ˆíŠ¸ ì ì‘ í•„í„°',
    changes: [
      'ìƒˆë²½ ì‹œê°„ëŒ€(00-06ì‹œ) ë§¤ìˆ˜ ê¸°ì¤€ +0.5 ê°•í™” (ë¯¸êµ­ì¥ í—ˆìš©)',
      'ì—°ì† 2íŒ¨ ì´ìƒ â†’ 30ë¶„ ê°•ì œ ì¿¨ë‹¤ìš´ + ë§¤ìˆ˜ ê¸°ì¤€ ê°•í™”',
      'F&G ê·¹ë‹¨ ê³µí¬(20 ë¯¸ë§Œ) â†’ ìµœì†Œ ë§¤ìˆ˜ ì ìˆ˜ +1.0 ìƒí–¥',
      'ì˜¤ëŠ˜ ìŠ¹ë¥  40% ë¯¸ë§Œ(5ê±°ë˜+) â†’ í¬ì§€ì…˜ í¬ê¸° 50% ì¶•ì†Œ',
      'ê±°ë˜ ë‚´ì—­/ìµœê·¼ í™œë™ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìˆ˜ì •',
      'DCA(ë¬¼íƒ€ê¸°) ê±°ë˜ ì˜¬ë°”ë¥¸ í‘œì‹œ',
    ],
  },
  {
    version: 'v2.4.0',
    date: '2026-02-16',
    title: 'ìˆ˜ìµ ê·¹ëŒ€í™” 8ì¢… ê¸°ëŠ¥',
    changes: [
      'BB ìŠ¤í€´ì¦ˆ ê°ì§€ (ë³¼ë¦°ì €+ì¼ˆíŠ¸ë„ˆ ì••ì¶• ëŒíŒŒ ì‹œê·¸ë„)',
      'BTC ì„ í–‰ ì§€í‘œ (BTC 5ë¶„ ë³€í™”ìœ¨ â†’ ì•ŒíŠ¸ì½”ì¸ ë¶€ìŠ¤íŠ¸)',
      'ê³ ë˜ë²½ ê°ì§€ (í˜¸ê°€ì°½ 5x ëŒ€í˜•ì£¼ë¬¸ â†’ ì§€ì§€/ì €í•­)',
      'ì†ì ˆ íŒ¨í„´ AI ë¶„ì„ (RSI/BB/ì‹œê°„/ë ˆì§ë³„ 70%+ ì°¨ë‹¨)',
      'ì¢…ëª©ë³„ ìµœì  ë³´ìœ ì‹œê°„ í•™ìŠµ (ìˆ˜ìµê±°ë˜ ê¸°ë°˜)',
      'ìˆ˜ìˆ˜ë£Œ í¬í•¨ ì‹¤ìˆ˜ìµ í‘œì‹œ (0.05%Ã—2)',
      'ìŠ¤ìº˜í•‘ ëª¨ë“œ (4.5ì + â†’ +0.8% ë¹ ë¥¸ ìµì ˆ, í¬ì§€ì…˜ ê½‰ ì°¨ë„ +1 ì¶”ê°€ ìŠ¬ë¡¯)',
      'í˜„ê¸ˆ 70% í™œìš© (BASE_POSITION_PCT 22â†’23%)',
    ],
  },
  {
    version: 'v2.3.0',
    date: '2026-02-16',
    title: 'ì „ëµ ì¢…í•© ë¦¬ë·° + ë²„ê·¸ ìˆ˜ì •',
    changes: [
      'volatile ë ˆì§ ê°ì§€ ê¸°ì¤€ ì™„í™” (ATR 50â†’80%, 3â†’4%)',
      'volatile ë ˆì§ì—ì„œ DCA ë¬¼íƒ€ê¸° ì°¨ë‹¨',
      'F&G ê·¹ê³µí¬ + volatile = ë§¤ìˆ˜ ê¸°ì¤€ ê°•í™” (ê¸°ì¡´: í•˜í–¥)',
      'ë³€ë™ì„± ëŒíŒŒ ë§¤ìˆ˜ ì•ˆì „ì¥ì¹˜ (RSI<60, BB<0.85)',
      'MAX_POSITIONS 10â†’3 ì†Œì•¡ê³„ì¢Œ ì§‘ì¤‘',
    ],
  },
  {
    version: 'v2.2.0',
    date: '2026-02-16',
    title: 'ì—…ë¹„íŠ¸ ì”ê³  ì—°ë™ + AI ì±—ë´‡',
    changes: [
      'í™ˆ í™”ë©´ ì—…ë¹„íŠ¸ ì‹¤ì œ ì´ ìì‚° í‘œì‹œ',
      'í˜„ê¸ˆ/íˆ¬ì ë¹„ìœ¨ ë°” ì°¨íŠ¸',
      'í˜„ì¬ í‰ê°€ì†ìµ ë°•ìŠ¤ (ì›ê°€/í˜„ì¬ê°€/í‰ê°€ì†ìµ)',
      'ì˜¤ëŠ˜ ì‹¤í˜„/ë¯¸ì‹¤í˜„ ì†ìµ ë¶„ë¦¬ í‘œì‹œ',
      'AI ì±—ë´‡ (Claude Haiku, ì›” $1 ë¯¸ë§Œ)',
      'animCount ì—ëŸ¬ ìˆ˜ì •',
    ],
  },
  {
    version: 'v2.1.0',
    date: '2026-02-16',
    title: 'í†µê³„ ê°œì„  + í¬ì§€ì…˜ í™•ëŒ€',
    changes: [
      'í™ˆ í™”ë©´ ìŠ¹ë¥ /í†µê³„: ì˜¤ëŠ˜ë§Œ â†’ ì „ì²´ ëˆ„ì ìœ¼ë¡œ ë³€ê²½',
      'ë§¤ë§¤ ê¸°ë¡: ì „ì²´ ìµœê·¼ 50ê±´ í‘œì‹œ (ë‚ ì§œë³„ ê·¸ë£¨í•‘)',
      'í™ˆ í™”ë©´ì— ìê°€í•™ìŠµ ìš”ì•½ ì¹´ë“œ ì¶”ê°€ (ì‹ ë¢°ë„, ë¶„ì„ ìŒ, í‰ê· ìˆ˜ìµ)',
      'í¬ì§€ì…˜ ì œí•œ 4ê°œ â†’ 10ê°œë¡œ í™•ëŒ€',
      'ì§€ì •ê°€ ì£¼ë¬¸ (30ì´ˆ íƒ€ì„ì•„ì›ƒ â†’ ì‹œì¥ê°€ í´ë°±)',
      'ë³€ë™ì„± ëŒíŒŒ ì „ëµ (Larry Williams K=0.5)',
      'ìë™ íŒŒë¼ë¯¸í„° íŠœë‹ (7ì¼ë§ˆë‹¤)',
      'ë¸”ë™/í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ UI (ì„¤ì • íƒ­)',
      'ê¹€í”„ ì•Œë¦¼ (í”„ë¦¬ë¯¸ì—„ 5% ì´ìƒ/ì—­í”„ -2% ì´í•˜)',
      'ìˆ˜ìµë¥  ì°¨íŠ¸ (Canvas 30ì¼ P&L)',
    ],
  },
  {
    version: 'v2.0.0',
    date: '2026-02-16',
    title: 'ë©€í‹°ìœ ì € ì§€ì›',
    changes: [
      'ìµœëŒ€ 3ëª… ë…ë¦½ ë´‡ ì¸ìŠ¤í„´ìŠ¤ ì§€ì›',
      'ì›¹ ë“±ë¡ í˜ì´ì§€ (/register) \u2014 ì¹œêµ¬ê°€ ì§ì ‘ API í‚¤ ë“±ë¡',
      'ì´ˆëŒ€ ì½”ë“œ ë³´ì•ˆ',
      'ë“±ë¡ í›„ PM2 ì¬ì‹œì‘ ì—†ì´ ë´‡ ìë™ ì‹œì‘',
      'ìœ ì €ë³„ í¬íŠ¸ ìë™ í• ë‹¹ (3737, 3738, ...)',
      'ì „ì²´ ìœ ì € ê±°ë˜ ë°ì´í„° ì·¨í•© \u2192 ê¸€ë¡œë²Œ í•™ìŠµ',
      'F&G ì—­ë°œìƒ: ê·¹ë‹¨ ê³µí¬ ì‹œ ë§¤ìˆ˜ ê¸°íšŒë¡œ ì „í™˜',
      'ê°•í•œ ì‹œê·¸ë„(4ì +) í™•ì¸ ìº”ë“¤ ì—†ì´ ì¦‰ì‹œ ë§¤ìˆ˜',
      'ì•½í•œ ìŒë´‰(-0.3% ì´ë‚´) ë§¤ìˆ˜ í—ˆìš©',
    ],
  },
  {
    version: 'v1.5.0',
    date: '2026-02-15',
    title: 'ìê°€í•™ìŠµ + ì½¤ë³´ íŠ¸ë˜ì»¤',
    changes: [
      'ê±°ë˜ ë°ì´í„° ê¸°ë°˜ ìê°€í•™ìŠµ (RSI, ì†ì ˆ, ìµì ˆ ìë™ ìµœì í™”)',
      'ì‹œê·¸ë„ ì¡°í•©(ì½¤ë³´)ë³„ ìŠ¹ë¥  ì¶”ì ',
      'ì €ìŠ¹ë¥  ì½¤ë³´ ìë™ ì°¨ë‹¨',
      'ë™ì  ë§¤ìˆ˜ ê¸°ì¤€ (ì½¤ë³´ ê¸°ë°˜)',
      'Contextual Bandit: ì‹œì¥ ìƒí™©ë³„ ìµœì  í”„ë¡œí•„',
      'ë°±í…ŒìŠ¤íŠ¸ ìë™ ì‹¤í–‰ (í•™ìŠµ í›„)',
      'ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¢…ëª© ìë™ íšŒí”¼',
    ],
  },
  {
    version: 'v1.4.0',
    date: '2026-02-14',
    title: 'í˜¸ê°€ ë¶„ì„ + ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„',
    changes: [
      'í˜¸ê°€ì°½ ë§¤ìˆ˜/ë§¤ë„ë²½ ë¹„ìœ¨ ë¶„ì„',
      'ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ì‹¤ì‹œê°„ ì¶”ì ',
      'í”„ë¦¬ë¯¸ì—„ ê¸°ë°˜ ë§¤ìˆ˜/ë§¤ë„ ë³´ì •',
      'ì„±ê³¼ ì§€í‘œ ì¶”ê°€ (Sharpe, Sortino, Profit Factor)',
      'ë“œë¡œë‹¤ìš´ ê¸°ë°˜ ë™ì  í¬ì§€ì…˜ ì‚¬ì´ì§•',
    ],
  },
  {
    version: 'v1.3.0',
    date: '2026-02-13',
    title: 'ë©€í‹°íƒ€ì„í”„ë ˆì„ + ê°ì„± ë¶„ì„',
    changes: [
      '5ë¶„/1ì‹œê°„/4ì‹œê°„ ë´‰ ì¢…í•© ë¶„ì„ (MTF)',
      'Reddit ê°ì„± ë¶„ì„ (r/cryptocurrency)',
      'ë‰´ìŠ¤ ê°ì„± ë¶„ì„',
      'Fear & Greed Index ì—°ë™',
      'ê°ì„± ê¸°ë°˜ ë§¤ìˆ˜/ë§¤ë„ ë¶€ìŠ¤íŠ¸',
      'í™•ì¸ ìº”ë“¤ í•„í„° (ë§¤ìˆ˜ ì „ ë‹¤ìŒ ë´‰ í™•ì¸)',
    ],
  },
  {
    version: 'v1.2.0',
    date: '2026-02-12',
    title: 'íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ + ë¶„í•  ë§¤ë„',
    changes: [
      'íŠ¸ë ˆì¼ë§ ìŠ¤íƒ‘ (+3% í™œì„±, -1.5% ì´íƒˆ)',
      'ë¸Œë ˆì´í¬ì´ë¸ ìë™ ì´ë™ (+2% ë„ë‹¬ ì‹œ)',
      '3ë‹¨ê³„ ë¶„í•  ë§¤ë„ (+3%/30%, +5%/30%, ë‚˜ë¨¸ì§€)',
      'ê±°ë˜ëŸ‰ ìƒìœ„ 20ì¢…ëª© ìë™ ê°±ì‹  (1ì‹œê°„ ì£¼ê¸°)',
      'ì¿¨ë‹¤ìš´ ì‹œìŠ¤í…œ (ë§¤ë„ í›„ 10ë¶„)',
      'íœ©ì˜ ë°©ì§€ (ì†ì ˆì„  3íšŒ í„°ì¹˜ ë£°)',
    ],
  },
  {
    version: 'v1.1.0',
    date: '2026-02-11',
    title: 'MACD + íŒ¨í„´ ì¸ì‹',
    changes: [
      'MACD ê³¨ë“ í¬ë¡œìŠ¤/ë°ë“œí¬ë¡œìŠ¤',
      'VWAP ì´ê²©ë„ ë¶„ì„',
      'ìº”ë“¤ìŠ¤í‹± íŒ¨í„´ ì¸ì‹ (ë„ì§€, ë§ì¹˜, ì‚¼ë³‘ ë“±)',
      'ì°¨íŠ¸ íŒ¨í„´ ê°ì§€ (ì‚¼ê°ìˆ˜ë ´, ì´ì¤‘ë°”ë‹¥, í—¤ë“œì•¤ìˆ„ë”)',
      'ìƒê´€ê´€ê³„ ê¸°ë°˜ ë¶„ì‚° íˆ¬ì',
      'ë ˆì§ ê°ì§€ (ì¶”ì„¸/íš¡ë³´/ê¸‰ë³€)',
    ],
  },
  {
    version: 'v1.0.0',
    date: '2026-02-10',
    title: 'ì²« ì¶œì‹œ',
    changes: [
      'RSI ê³¼ë§¤ìˆ˜/ê³¼ë§¤ë„ ê¸°ë°˜ ë§¤ë§¤',
      'ë³¼ë¦°ì € ë°´ë“œ ìƒë‹¨/í•˜ë‹¨ í„°ì¹˜',
      'ê±°ë˜ëŸ‰ ê¸‰ì¦ ê°ì§€',
      'ìë™ ì†ì ˆ/ìµì ˆ',
      'ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ (WebSocket)',
      'PM2 í”„ë¡œì„¸ìŠ¤ ê´€ë¦¬',
    ],
  },
];

function renderUpdatesTab() {
  var el = document.getElementById('updatesList');
  if (!el) return;

  el.innerHTML = CHANGELOG.map(function(release, idx) {
    var isLatest = idx === 0;
    var borderStyle = isLatest ? 'border:1px solid var(--accent);box-shadow:0 0 20px rgba(49,130,246,.1)' : '';
    var titleColor = isLatest ? 'var(--accent)' : 'var(--text-primary)';
    var latestBadge = isLatest ? '<span style="font-size:10px;background:var(--accent);color:#fff;padding:2px 8px;border-radius:10px;font-weight:600">LATEST</span>' : '';

    return '<div class="glass" style="padding:16px;margin-bottom:12px;' + borderStyle + '">' +
      '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">' +
      '<div style="display:flex;align-items:center;gap:8px">' +
      '<span style="font-size:14px;font-weight:700;color:' + titleColor + '">' + release.version + '</span>' +
      latestBadge +
      '</div>' +
      '<span style="font-size:11px;color:var(--text-tertiary)">' + release.date + '</span>' +
      '</div>' +
      '<div style="font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:8px">' + release.title + '</div>' +
      '<div style="display:flex;flex-direction:column;gap:4px">' +
      release.changes.map(function(c) {
        return '<div style="display:flex;align-items:flex-start;gap:6px;font-size:12px;color:var(--text-secondary)">' +
          '<span style="color:var(--green);flex-shrink:0;margin-top:1px">+</span>' +
          '<span>' + c + '</span>' +
          '</div>';
      }).join('') +
      '</div>' +
      '</div>';
  }).join('');
}

// === P&L CHART (Canvas) ===
var pnlChartData = null;
var currentPnlTf = '1d';

function setPnlTf(tf) {
  currentPnlTf = tf;
  var btns = document.querySelectorAll('.pnl-tf-btn');
  for (var i = 0; i < btns.length; i++) {
    btns[i].className = btns[i].getAttribute('data-tf') === tf ? 'pnl-tf-btn active' : 'pnl-tf-btn';
  }
  fetchPnlHistory();
}

function fetchPnlHistory() {
  fetch('/api/pnl-history?tf=' + currentPnlTf)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      pnlChartData = data;
      drawPnlChart(data);
    })
    .catch(function(e) {
      console.error('PnL history fetch error:', e);
    });
}

function drawPnlChart(data) {
  var wrap = document.getElementById('pnlChartWrap');
  var canvas = document.getElementById('pnlCanvas');
  var empty = document.getElementById('pnlChartEmpty');

  if (!data || data.length < 1) {
    canvas.style.display = 'none';
    empty.style.display = 'flex';
    empty.textContent = 'ë§¤ë„ ê±°ë˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤';
    return;
  }
  // ë°ì´í„°ê°€ 1ê°œë©´ ì‹œì‘ì (0) ì¶”ê°€í•´ì„œ ìµœì†Œ 2í¬ì¸íŠ¸ í™•ë³´
  if (data.length === 1) {
    data = [{ date: '', pnl: 0, cumulative: 0, trades: 0 }, data[0]];
  }

  canvas.style.display = 'block';
  empty.style.display = 'none';

  var dpr = window.devicePixelRatio || 1;
  var rect = wrap.getBoundingClientRect();
  var W = rect.width;
  var H = 200;
  canvas.width = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  var ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  var vals = data.map(function(d) { return d.cumulative; });
  var padL = 55, padR = 12, padT = 16, padB = 30;
  var cW = W - padL - padR;
  var cH = H - padT - padB;

  var mn = Math.min.apply(null, vals.concat([0]));
  var mx = Math.max.apply(null, vals.concat([0]));
  var range = mx - mn || 1;
  // Add 10% padding
  mn = mn - range * 0.1;
  mx = mx + range * 0.1;
  range = mx - mn;

  var n = vals.length;
  var stepX = cW / Math.max(1, n - 1);

  function xPos(i) { return padL + i * stepX; }
  function yPos(v) { return padT + (1 - (v - mn) / range) * cH; }

  // Clear
  ctx.clearRect(0, 0, W, H);

  // Grid lines (horizontal)
  ctx.strokeStyle = 'rgba(255,255,255,0.06)';
  ctx.lineWidth = 0.5;
  var gridCount = 4;
  for (var g = 0; g <= gridCount; g++) {
    var gv = mn + (range * g / gridCount);
    var gy = yPos(gv);
    ctx.beginPath();
    ctx.moveTo(padL, gy);
    ctx.lineTo(W - padR, gy);
    ctx.stroke();

    // Y-axis labels
    ctx.fillStyle = 'rgba(255,255,255,0.35)';
    ctx.font = '10px Pretendard Variable, sans-serif';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    var label = Math.round(gv).toLocaleString();
    ctx.fillText(label, padL - 6, gy);
  }

  // Zero line
  var zeroY = yPos(0);
  ctx.strokeStyle = 'rgba(255,255,255,0.15)';
  ctx.lineWidth = 1;
  ctx.setLineDash([4, 4]);
  ctx.beginPath();
  ctx.moveTo(padL, zeroY);
  ctx.lineTo(W - padR, zeroY);
  ctx.stroke();
  ctx.setLineDash([]);

  // Gradient fill
  var lastVal = vals[n - 1];
  var isPositive = lastVal >= 0;
  var lineColor = isPositive ? '#00C48C' : '#FF4757';
  var fillGrad = ctx.createLinearGradient(0, padT, 0, padT + cH);
  if (isPositive) {
    fillGrad.addColorStop(0, 'rgba(0,196,140,0.18)');
    fillGrad.addColorStop(1, 'rgba(0,196,140,0.0)');
  } else {
    fillGrad.addColorStop(0, 'rgba(255,71,87,0.0)');
    fillGrad.addColorStop(1, 'rgba(255,71,87,0.18)');
  }

  // Fill area from line to zero
  ctx.beginPath();
  ctx.moveTo(xPos(0), zeroY);
  for (var i = 0; i < n; i++) {
    ctx.lineTo(xPos(i), yPos(vals[i]));
  }
  ctx.lineTo(xPos(n - 1), zeroY);
  ctx.closePath();
  ctx.fillStyle = fillGrad;
  ctx.fill();

  // Draw line segments (green above zero, red below)
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  ctx.lineCap = 'round';
  for (var i = 0; i < n - 1; i++) {
    var segColor = vals[i + 1] >= 0 ? '#00C48C' : '#FF4757';
    ctx.beginPath();
    ctx.strokeStyle = segColor;
    ctx.moveTo(xPos(i), yPos(vals[i]));
    ctx.lineTo(xPos(i + 1), yPos(vals[i + 1]));
    ctx.stroke();
  }

  // End dot
  ctx.beginPath();
  ctx.arc(xPos(n - 1), yPos(vals[n - 1]), 4, 0, Math.PI * 2);
  ctx.fillStyle = lineColor;
  ctx.fill();
  ctx.beginPath();
  ctx.arc(xPos(n - 1), yPos(vals[n - 1]), 6, 0, Math.PI * 2);
  ctx.strokeStyle = lineColor;
  ctx.lineWidth = 1.5;
  ctx.globalAlpha = 0.4;
  ctx.stroke();
  ctx.globalAlpha = 1;

  // X-axis labels (show ~5 dates)
  ctx.fillStyle = 'rgba(255,255,255,0.35)';
  ctx.font = '9px Pretendard Variable, sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  var labelInterval = Math.max(1, Math.floor(n / 5));
  for (var i = 0; i < n; i++) {
    if (i % labelInterval === 0 || i === n - 1) {
      var dt = data[i].date || '';
      var shortDate = currentPnlTf === '1d' ? dt.slice(5) : dt;
      ctx.fillText(shortDate, xPos(i), H - padB + 8);
    }
  }

  // End value label
  ctx.fillStyle = lineColor;
  ctx.font = 'bold 11px Pretendard Variable, sans-serif';
  ctx.textAlign = 'left';
  ctx.textBaseline = 'middle';
  var endLabel = (lastVal >= 0 ? '+' : '') + Math.round(lastVal).toLocaleString() + 'ì›';
  var endLabelX = xPos(n - 1) + 8;
  if (endLabelX + 60 > W) endLabelX = xPos(n - 1) - 8 - ctx.measureText(endLabel).width;
  ctx.fillText(endLabel, endLabelX, yPos(lastVal));
}

// === SETTINGS TAB: Blacklist/Whitelist ===
var currentBlData = { mode: 'blacklist', symbols: [] };

function fetchBlacklist() {
  fetch('/api/blacklist')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      currentBlData = data;
      renderBlacklist(data);
    })
    .catch(function(e) { console.error('Blacklist fetch error:', e); });
}

function renderBlacklist(data) {
  var mode = data.mode || 'blacklist';
  var symbols = data.symbols || [];

  // Update mode toggle
  var btnBlack = document.getElementById('blModeBlack');
  var btnWhite = document.getElementById('blModeWhite');
  if (mode === 'whitelist') {
    btnBlack.className = 'bl-mode-btn';
    btnWhite.className = 'bl-mode-btn active';
    document.getElementById('blModeDesc').textContent = 'í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸: ì•„ë˜ ì¢…ëª©ë§Œ ë§¤ë§¤í•©ë‹ˆë‹¤';
  } else {
    btnBlack.className = 'bl-mode-btn active';
    btnWhite.className = 'bl-mode-btn';
    document.getElementById('blModeDesc').textContent = 'ë¸”ë™ë¦¬ìŠ¤íŠ¸: ì•„ë˜ ì¢…ëª©ì„ ë§¤ë§¤ì—ì„œ ì œì™¸í•©ë‹ˆë‹¤';
  }

  // Render tags
  var container = document.getElementById('blTagsContainer');
  var emptyEl = document.getElementById('blTagsEmpty');
  if (symbols.length === 0) {
    container.innerHTML = '<div class="bl-empty" id="blTagsEmpty">ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }

  var tagCls = mode === 'whitelist' ? 'whitelist' : 'blacklist';
  container.innerHTML = symbols.map(function(sym) {
    var short = sym.replace('/KRW', '');
    return '<span class="bl-tag ' + tagCls + '">' + short +
      ' <span class="bl-x" onclick="removeBlSymbol(\'' + sym + '\')">&times;</span></span>';
  }).join('');
}

function setBlMode(mode) {
  fetch('/api/blacklist', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'set_mode', mode: mode })
  })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        currentBlData = data;
        renderBlacklist(data);
      }
    })
    .catch(function(e) { console.error('Set mode error:', e); });
}

function addBlSymbol() {
  var input = document.getElementById('blSymInput');
  var val = input.value.trim();
  if (!val) return;

  fetch('/api/blacklist', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'add', symbol: val })
  })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        currentBlData = data;
        renderBlacklist(data);
        input.value = '';
      }
    })
    .catch(function(e) { console.error('Add symbol error:', e); });
}

function removeBlSymbol(sym) {
  fetch('/api/blacklist', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'remove', symbol: sym })
  })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        currentBlData = data;
        renderBlacklist(data);
      }
    })
    .catch(function(e) { console.error('Remove symbol error:', e); });
}

// Handle Enter key in blacklist input
document.addEventListener('DOMContentLoaded', function() {
  var blInput = document.getElementById('blSymInput');
  if (blInput) {
    blInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') addBlSymbol();
    });
  }
});

// === Render settings tab from status data ===
function renderSettingsTab(d) {
  // Update learned blacklist section
  var learn = d && d.learning;
  var learnBl = learn && learn.blacklist ? learn.blacklist : [];
  var learnContainer = document.getElementById('learnBlTags');
  if (learnContainer) {
    if (learnBl.length === 0) {
      learnContainer.innerHTML = '<div class="bl-empty">í•™ìŠµ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì—†ìŒ</div>';
    } else {
      learnContainer.innerHTML = learnBl.map(function(sym) {
        var short = sym.replace('/KRW', '');
        return '<span class="bl-tag blacklist">' + short + '</span>';
      }).join('');
    }
  }

  // Settings right info
  var el = document.getElementById('settingsRight');
  if (el) {
    var total = currentBlData.symbols ? currentBlData.symbols.length : 0;
    el.textContent = total + 'ê°œ ì¢…ëª© í•„í„°';
  }
}

// === AI Chatbot ===
let chatOpen=false;
let chatSending=false;

function toggleChat(){
  chatOpen=!chatOpen;
  document.getElementById('chatPanel').classList.toggle('open',chatOpen);
  document.getElementById('chatFab').classList.toggle('has-panel',chatOpen);
  document.getElementById('chatFab').textContent=chatOpen?'âœ•':'ğŸ’¬';
  if(chatOpen)document.getElementById('chatInput').focus();
}

function chatQuick(msg){
  document.getElementById('chatInput').value=msg;
  sendChat();
}

function addChatMsg(text,role){
  var el=document.getElementById('chatMessages');
  var div=document.createElement('div');
  div.className='chat-msg '+role;
  div.textContent=text;
  el.appendChild(div);
  el.scrollTop=el.scrollHeight;
  return div;
}

async function sendChat(){
  if(chatSending)return;
  var input=document.getElementById('chatInput');
  var msg=input.value.trim();
  if(!msg)return;
  input.value='';
  addChatMsg(msg,'user');
  var loadingEl=addChatMsg('ìƒê° ì¤‘...','bot loading');
  chatSending=true;
  document.getElementById('chatSendBtn').disabled=true;
  try{
    var r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});
    var data=await r.json();
    loadingEl.remove();
    addChatMsg(data.reply||'ì‘ë‹µ ì—†ìŒ','bot');
  }catch(e){
    loadingEl.remove();
    addChatMsg('ì—°ê²° ì˜¤ë¥˜: '+e.message,'bot');
  }finally{
    chatSending=false;
    document.getElementById('chatSendBtn').disabled=false;
  }
}

// ì¦‰ì‹œ HTTP í´ë§ ì‹œì‘ (WebSocket ê´€ê³„ì—†ì´)
startPolling();
renderUpdatesTab();
fetchPnlHistory();
fetchBlacklist();
// Refresh PnL chart every 60 seconds
setInterval(fetchPnlHistory, 60000);
// WebSocketë„ ì‹œë„
try{connect()}catch(e){document.getElementById('sLabel').textContent='WSì‹¤íŒ¨:'+e.message}

// PWA Service Worker ë“±ë¡
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').then(()=>console.log('SW ë“±ë¡ ì™„ë£Œ')).catch(e=>console.log('SW ë“±ë¡ ì‹¤íŒ¨:',e));
}

// PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ (Android/Chrome)
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  deferredPrompt=e;
  showInstallBtn('android');
});

// iOS Safari ê°ì§€ â†’ ìˆ˜ë™ ì„¤ì¹˜ ì•ˆë‚´
(function(){
  var isIos=/iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
  var isSafari=/safari/.test(navigator.userAgent.toLowerCase())&&!/chrome/.test(navigator.userAgent.toLowerCase());
  var isStandalone=window.navigator.standalone===true||window.matchMedia('(display-mode:standalone)').matches;
  if(isIos&&isSafari&&!isStandalone){
    showInstallBtn('ios');
  }
})();

function showInstallBtn(type){
  if(document.getElementById('installBtn'))return;
  var btn=document.createElement('div');
  btn.id='installBtn';
  btn.style.cssText='position:fixed;top:12px;right:12px;z-index:200;background:var(--accent);color:#fff;padding:10px 16px;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(49,130,246,.3);display:flex;align-items:center;gap:6px;max-width:280px';
  if(type==='ios'){
    btn.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê¸°';
    btn.onclick=function(){
      var guide=document.createElement('div');
      guide.id='iosGuide';
      guide.style.cssText='position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;text-align:center;color:#fff;font-size:14px;gap:16px';
      guide.innerHTML='<div style="font-size:20px;font-weight:800">ì•±ì²˜ëŸ¼ ì„¤ì¹˜í•˜ê¸°</div>'
        +'<div style="font-size:40px">&#x2B06;&#xFE0F;</div>'
        +'<div>1. ì•„ë˜ <b>ê³µìœ  ë²„íŠ¼</b> <span style="font-size:18px">&#x1F4E4;</span> íƒ­</div>'
        +'<div>2. <b>"í™ˆ í™”ë©´ì— ì¶”ê°€"</b> ì„ íƒ</div>'
        +'<div>3. ì˜¤ë¥¸ìª½ ìœ„ <b>"ì¶”ê°€"</b> íƒ­</div>'
        +'<div style="margin-top:12px;font-size:11px;color:#888">í’€ìŠ¤í¬ë¦° ì•±ì²˜ëŸ¼ ì‹¤í–‰ë©ë‹ˆë‹¤</div>'
        +'<div onclick="this.parentNode.remove()" style="margin-top:16px;background:var(--accent);padding:10px 24px;border-radius:12px;cursor:pointer;font-weight:700">í™•ì¸</div>';
      document.body.appendChild(guide);
      btn.remove();
    };
  } else {
    btn.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>ì•± ì„¤ì¹˜';
    btn.onclick=async function(){
      if(!deferredPrompt)return;
      deferredPrompt.prompt();
      var result=await deferredPrompt.userChoice;
      if(result.outcome==='accepted')btn.remove();
      deferredPrompt=null;
    };
  }
  document.body.appendChild(btn);
  setTimeout(function(){if(btn.parentNode)btn.style.opacity='0.6'},15000);
}

window.addEventListener('appinstalled',function(){
  var btn=document.getElementById('installBtn');
  if(btn)btn.remove();
});
</script>
</body>
</html>
