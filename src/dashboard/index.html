<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="트레이딩">
  <meta name="theme-color" content="#0A0A0F">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css" rel="stylesheet">
  <title>트레이딩 봇</title>
  <style>
    :root {
      --bg-primary: #0A0A0F;
      --bg-secondary: #1A1A22;
      --bg-card: rgba(255,255,255,.06);
      --bg-card-hover: rgba(255,255,255,.10);
      --border: rgba(255,255,255,.08);
      --border-active: rgba(49,130,246,.4);
      --text-primary: #F0F0F5;
      --text-secondary: #8A8A9A;
      --text-tertiary: #4A4A5A;
      --accent: #3182F6;
      --accent-dim: rgba(49,130,246,.12);
      --green: #00C48C;
      --green-dim: rgba(0,196,140,.10);
      --green-glow: rgba(0,196,140,.15);
      --red: #FF4757;
      --red-dim: rgba(255,71,87,.10);
      --red-glow: rgba(255,71,87,.12);
      --yellow: #FCD535;
      --yellow-dim: rgba(252,213,53,.10);
      --glass: rgba(255,255,255,.06);
      --glass-border: rgba(255,255,255,.12);
      --glass-blur: 40px;
      --glass-highlight: rgba(255,255,255,.08);
      --glass-shadow: rgba(0,0,0,.1);
      --radius-sm: 10px;
      --radius-md: 16px;
      --radius-lg: 22px;
      --radius-xl: 28px;
      --nav-h: 68px;
      --safe-b: env(safe-area-inset-bottom, 0px);
    }

    /* === THEMES === */
    [data-theme="ocean"]{
      --bg-primary:#08111C;--bg-secondary:#0F1A2A;--bg-card:rgba(56,189,248,.05);--bg-card-hover:rgba(56,189,248,.09);
      --border:rgba(56,189,248,.08);--border-active:rgba(56,189,248,.35);
      --text-primary:#E2E8F0;--text-secondary:#64748B;--text-tertiary:#334155;
      --accent:#38BDF8;--accent-dim:rgba(56,189,248,.12);
      --green:#34D399;--green-dim:rgba(52,211,153,.10);--green-glow:rgba(52,211,153,.15);
      --red:#FB7185;--red-dim:rgba(251,113,133,.10);--red-glow:rgba(251,113,133,.12);
      --yellow:#FBBF24;--yellow-dim:rgba(251,191,36,.10);
      --glass:rgba(56,189,248,.04);--glass-border:rgba(56,189,248,.10);--glass-highlight:rgba(56,189,248,.06);--glass-shadow:rgba(0,0,0,.15);
    }
    [data-theme="ocean"] body{background-image:radial-gradient(ellipse at 20% 15%,rgba(14,65,100,.35) 0%,transparent 55%),radial-gradient(ellipse at 80% 50%,rgba(8,50,90,.25) 0%,transparent 50%),radial-gradient(ellipse at 40% 85%,rgba(10,40,80,.20) 0%,transparent 50%)}

    [data-theme="violet"]{
      --bg-primary:#0C0A14;--bg-secondary:#161228;--bg-card:rgba(139,92,246,.05);--bg-card-hover:rgba(139,92,246,.09);
      --border:rgba(139,92,246,.08);--border-active:rgba(139,92,246,.35);
      --text-primary:#EDE9FE;--text-secondary:#7C6F90;--text-tertiary:#3F3558;
      --accent:#A78BFA;--accent-dim:rgba(167,139,250,.12);
      --green:#4ADE80;--green-dim:rgba(74,222,128,.08);--green-glow:rgba(74,222,128,.15);
      --red:#FB7185;--red-dim:rgba(251,113,133,.08);--red-glow:rgba(251,113,133,.12);
      --yellow:#FBBF24;--yellow-dim:rgba(251,191,36,.08);
      --glass:rgba(139,92,246,.04);--glass-border:rgba(139,92,246,.10);--glass-highlight:rgba(139,92,246,.06);--glass-shadow:rgba(0,0,0,.18);
    }
    [data-theme="violet"] body{background-image:radial-gradient(ellipse at 20% 15%,rgba(50,20,100,.35) 0%,transparent 55%),radial-gradient(ellipse at 80% 50%,rgba(40,15,80,.25) 0%,transparent 50%),radial-gradient(ellipse at 40% 85%,rgba(30,10,70,.18) 0%,transparent 50%)}
    [data-theme="violet"] .glass{box-shadow:0 8px 32px var(--glass-shadow),inset 0 1px 0 var(--glass-highlight)}
    [data-theme="violet"] .bottom-nav{box-shadow:0 -4px 30px rgba(139,92,246,.06),inset 0 1px 0 rgba(139,92,246,.05)}
    [data-theme="violet"] .nav-item.active svg{stroke:var(--accent);filter:drop-shadow(0 0 4px rgba(167,139,250,.4))}
    [data-theme="violet"] .status-dot.on{box-shadow:0 0 10px var(--green-glow)}

    [data-theme="slate"]{
      --bg-primary:#0E0E12;--bg-secondary:#1A1A20;--bg-card:rgba(148,163,184,.05);--bg-card-hover:rgba(148,163,184,.09);
      --border:rgba(148,163,184,.08);--border-active:rgba(148,163,184,.30);
      --text-primary:#E2E8F0;--text-secondary:#94A3B8;--text-tertiary:#475569;
      --accent:#CBD5E1;--accent-dim:rgba(203,213,225,.12);
      --green:#4ADE80;--green-dim:rgba(74,222,128,.08);--green-glow:rgba(74,222,128,.12);
      --red:#F87171;--red-dim:rgba(248,113,113,.08);--red-glow:rgba(248,113,113,.12);
      --yellow:#FBBF24;--yellow-dim:rgba(251,191,36,.08);
      --glass:rgba(148,163,184,.04);--glass-border:rgba(148,163,184,.10);--glass-highlight:rgba(148,163,184,.06);--glass-shadow:rgba(0,0,0,.15);
    }
    [data-theme="slate"] body{background-image:radial-gradient(ellipse at 20% 15%,rgba(30,30,50,.35) 0%,transparent 55%),radial-gradient(ellipse at 80% 50%,rgba(25,25,40,.25) 0%,transparent 50%),radial-gradient(ellipse at 40% 85%,rgba(20,20,35,.18) 0%,transparent 50%)}
    [data-theme="slate"] .glass{box-shadow:0 8px 32px var(--glass-shadow),inset 0 1px 0 rgba(148,163,184,.05)}
    [data-theme="slate"] .bot-icon{background:linear-gradient(135deg,#94A3B8,#CBD5E1)!important}
    [data-theme="slate"] .hero-total-amount{background:linear-gradient(135deg,#94A3B8,#E2E8F0);-webkit-background-clip:text;-webkit-text-fill-color:transparent}

    /* Ocean theme overrides */
    [data-theme="ocean"] .glass{box-shadow:0 8px 32px var(--glass-shadow),inset 0 1px 0 rgba(56,189,248,.08)}
    [data-theme="ocean"] .bot-icon{background:linear-gradient(135deg,#0284C7,#38BDF8)!important}
    [data-theme="ocean"] .hero-total-amount{background:linear-gradient(135deg,#38BDF8 20%,#22D3EE 60%,#67E8F9);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    [data-theme="ocean"] .home-hero::before{background:radial-gradient(circle,#38BDF8 0%,transparent 70%);opacity:.08}
    [data-theme="ocean"] .bottom-nav{box-shadow:0 -4px 30px rgba(56,189,248,.08),inset 0 1px 0 rgba(56,189,248,.06)}
    [data-theme="ocean"] .nav-item.active svg{filter:drop-shadow(0 0 6px rgba(56,189,248,.5))}
    [data-theme="ocean"] .status-dot.on{box-shadow:0 0 12px var(--green-glow)}
    [data-theme="ocean"] .chat-fab{background:linear-gradient(135deg,#0284C7,#38BDF8)!important;box-shadow:0 4px 20px rgba(56,189,248,.3)}
    [data-theme="ocean"] .hero-pnl-box{border-color:rgba(56,189,248,.12)}
    [data-theme="ocean"] .hero-stat-row{border-color:rgba(56,189,248,.12)}
    [data-theme="ocean"] .hero-stat-row::before{background:linear-gradient(180deg,#38BDF8,#22D3EE)}
    [data-theme="ocean"] .bot-card{border-color:rgba(56,189,248,.15)}
    @keyframes oceanPulse{0%,100%{box-shadow:0 4px 20px rgba(56,189,248,.12)}50%{box-shadow:0 4px 28px rgba(56,189,248,.25)}}
    [data-theme="ocean"] .bot-card{animation:oceanPulse 3s ease-in-out infinite}

    /* Violet theme overrides */
    [data-theme="violet"] .bot-icon{background:linear-gradient(135deg,#7C3AED,#A78BFA)!important}
    [data-theme="violet"] .hero-total-amount{background:linear-gradient(135deg,#A78BFA 20%,#C084FC 60%,#E879F9);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    [data-theme="violet"] .home-hero::before{background:radial-gradient(circle,#A78BFA 0%,transparent 70%);opacity:.08}
    [data-theme="violet"] .chat-fab{background:linear-gradient(135deg,#7C3AED,#A78BFA)!important;box-shadow:0 4px 20px rgba(139,92,246,.3)}
    [data-theme="violet"] .learn-btn{background:var(--accent)}
    [data-theme="violet"] .pnl-tf-btn.active{background:var(--accent)}
    [data-theme="violet"] .hero-pnl-box{border-color:rgba(139,92,246,.12)}
    [data-theme="violet"] .hero-stat-row{border-color:rgba(139,92,246,.12)}
    [data-theme="violet"] .hero-stat-row::before{background:linear-gradient(180deg,#A78BFA,#E879F9)}
    [data-theme="violet"] .bot-card{border-color:rgba(139,92,246,.15)}
    @keyframes violetPulse{0%,100%{box-shadow:0 4px 20px rgba(139,92,246,.12)}50%{box-shadow:0 4px 28px rgba(139,92,246,.25)}}
    [data-theme="violet"] .bot-card{animation:violetPulse 3s ease-in-out infinite}

    /* Slate theme overrides */
    [data-theme="slate"] .hero-total-amount{background:linear-gradient(135deg,#E2E8F0 30%,#94A3B8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    [data-theme="slate"] .hero-stat-row::before{background:linear-gradient(180deg,#CBD5E1,#94A3B8)}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      font-family:'Pretendard Variable','Pretendard',-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
      background-color:var(--bg-primary);
      background-image:radial-gradient(ellipse at 20% 15%,rgba(30,60,120,.30) 0%,transparent 55%),radial-gradient(ellipse at 80% 50%,rgba(20,80,100,.20) 0%,transparent 50%),radial-gradient(ellipse at 40% 85%,rgba(40,50,110,.18) 0%,transparent 50%);
      background-attachment:fixed;
      color:var(--text-primary);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased;letter-spacing:-0.02em;
    }

    /* === Layout === */
    .app{max-width:430px;margin:0 auto;position:relative;min-height:100dvh;display:flex;flex-direction:column}
    .tab-content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:calc(var(--nav-h) + var(--safe-b) + 16px)}
    .tab-panel{display:none;padding:0 20px}
    .tab-panel.active{display:block;animation:fadeSlide .35s cubic-bezier(.4,0,.2,1)}
    @keyframes fadeSlide{from{opacity:0;transform:translateY(16px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
    .card-stagger>*{opacity:0;animation:fadeSlide .4s cubic-bezier(.4,0,.2,1) forwards}
    .card-stagger>*:nth-child(1){animation-delay:.05s}
    .card-stagger>*:nth-child(2){animation-delay:.1s}
    .card-stagger>*:nth-child(3){animation-delay:.15s}
    .card-stagger>*:nth-child(4){animation-delay:.2s}
    .card-stagger>*:nth-child(5){animation-delay:.25s}
    .card-stagger>*:nth-child(n+6){animation-delay:.3s}

    /* === Bottom Nav === */
    .bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:rgba(10,10,15,.85);backdrop-filter:blur(40px) saturate(1.8);-webkit-backdrop-filter:blur(40px) saturate(1.8);border-top:1px solid var(--glass-border);box-shadow:0 -4px 30px var(--glass-shadow),inset 0 1px 0 var(--glass-highlight);padding:8px 0 calc(8px + var(--safe-b));z-index:100;display:flex}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 2px;cursor:pointer;transition:all .2s;-webkit-user-select:none;min-width:0}
    .nav-item svg{width:20px;height:20px;stroke:var(--text-tertiary);fill:none;stroke-width:1.8;transition:all .2s}
    .nav-item span{font-size:10px;font-weight:600;color:var(--text-tertiary);transition:all .2s}
    .nav-item.active svg{stroke:var(--accent);filter:drop-shadow(0 0 6px var(--accent-dim))}.nav-item.active span{color:var(--accent);font-weight:700}

    /* === Glass Card === */
    .glass{
      position:relative;overflow:hidden;
      background:var(--glass);
      backdrop-filter:blur(var(--glass-blur)) saturate(1.6);-webkit-backdrop-filter:blur(var(--glass-blur)) saturate(1.6);
      border:1px solid var(--glass-border);border-radius:var(--radius-lg);
      box-shadow:0 8px 32px var(--glass-shadow),inset 0 1px 0 var(--glass-highlight);
    }
    .glass>*{position:relative;z-index:2}
    .glass::after{
      content:'';position:absolute;inset:0;border-radius:inherit;
      background:radial-gradient(circle 180px at var(--tx,-100px) var(--ty,-100px),rgba(255,255,255,.08),transparent 70%);
      pointer-events:none;z-index:1;opacity:0;transition:opacity .4s;
    }
    .glass.touched::after{opacity:1}
    .profit-glow{box-shadow:0 8px 40px var(--green-glow),inset 0 1px 0 rgba(0,196,140,.06)}
    .loss-glow{box-shadow:0 8px 40px var(--red-glow),inset 0 1px 0 rgba(255,71,87,.05)}
    .section-gap{margin-bottom:16px}
    .section-head{display:flex;align-items:center;justify-content:space-between;padding:20px 20px 0}
    .section-head h2{font-size:13px;font-weight:700;color:var(--text-secondary);letter-spacing:.3px}
    .section-head .badge{font-size:11px;font-weight:600;color:var(--text-tertiary)}

    /* === Status Bar === */
    .status-bar{display:flex;align-items:center;justify-content:space-between;padding:14px 20px}
    .status-left{display:flex;align-items:center;gap:8px}
    .status-dot{width:8px;height:8px;border-radius:50%;position:relative}
    .status-dot.on{background:var(--green);box-shadow:0 0 8px var(--green-glow)}
    .status-dot.on::after{content:'';position:absolute;inset:-3px;border-radius:50%;border:2px solid var(--green);opacity:.3;animation:ping 2s cubic-bezier(0,0,.2,1) infinite}
    @keyframes ping{75%,100%{transform:scale(2);opacity:0}}
    .status-dot.off{background:var(--red);box-shadow:0 0 8px var(--red-glow)}
    .status-label{font-size:13px;font-weight:600;color:var(--text-primary)}
    .status-right{font-size:11px;color:var(--text-tertiary);font-weight:500}

    /* === HOME TAB === */
    .home-hero{padding:20px 20px 12px;position:relative}
    .home-hero::before{content:'';position:absolute;top:-30px;left:50%;transform:translateX(-50%);width:200px;height:200px;border-radius:50%;background:radial-gradient(circle,var(--accent) 0%,transparent 70%);opacity:.06;pointer-events:none;filter:blur(40px)}
    .hero-total-row{text-align:center;margin-bottom:16px;padding:20px 0 16px;position:relative}
    .hero-total-label{font-size:12px;font-weight:700;color:var(--text-secondary);margin-bottom:8px;letter-spacing:.06em;text-transform:uppercase}
    .hero-total-amount{font-size:42px;font-weight:900;letter-spacing:-2.5px;color:var(--text-primary);line-height:1;background:linear-gradient(135deg,var(--text-primary) 40%,var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .hero-balance-bar{display:flex;height:8px;border-radius:4px;overflow:hidden;margin:10px 0 8px;background:var(--bg-card);box-shadow:inset 0 1px 3px rgba(0,0,0,.2)}
    .hero-balance-bar .cash{background:linear-gradient(90deg,var(--text-tertiary),rgba(255,255,255,.25));transition:width .6s cubic-bezier(.4,0,.2,1)}
    .hero-balance-bar .invest{background:linear-gradient(90deg,var(--accent),color-mix(in srgb,var(--accent),var(--green) 40%));transition:width .6s cubic-bezier(.4,0,.2,1)}
    .hero-balance-detail{display:flex;justify-content:space-between;font-size:12px;font-weight:600;margin-bottom:12px}
    .hero-balance-detail .bal-item{display:flex;align-items:center;gap:5px}
    .hero-balance-detail .bal-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .hero-balance-detail .bal-label{color:var(--text-tertiary);font-weight:500}
    .hero-balance-detail .bal-val{color:var(--text-primary);font-weight:700}
    .hero-divider{height:1px;background:var(--border);margin:10px 0}
    .hero-pnl-box{position:relative;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:14px 16px;margin-bottom:10px;overflow:hidden}
    .hero-pnl-box::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:0 3px 3px 0}
    .hero-pnl-box.profit::before{background:linear-gradient(180deg,var(--green),var(--accent))}
    .hero-pnl-box.loss::before{background:linear-gradient(180deg,var(--red),var(--accent))}
    .hero-pnl-title{font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
    .hero-pnl-main{font-size:30px;font-weight:900;letter-spacing:-1.5px;line-height:1.1;margin-bottom:8px}
    .hero-pnl-detail{display:flex;gap:14px;font-size:12px;font-weight:700}
    .hero-pnl-detail .lbl{color:var(--text-tertiary);font-weight:500}
    .hero-stat-row{position:relative;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:14px 16px;margin-bottom:10px;overflow:hidden}
    .hero-stat-row::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:linear-gradient(180deg,var(--accent),var(--yellow));border-radius:0 3px 3px 0}
    .hero-stat-title{font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
    .hero-stat-grid{display:flex;justify-content:space-between;font-size:12px}
    .hero-stat-grid .item{text-align:center}
    .hero-stat-grid .val{font-weight:800;font-size:15px}
    .hero-stat-grid .lbl{font-size:10px;color:var(--text-tertiary);margin-top:2px}
    .hero-trades{margin-top:0}
    .hero-trades .ht-title{font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:6px}
    .hero-trade-item{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px}
    .hero-trade-item:last-child{border:none}
    .hero-trade-item .sym{font-weight:700}
    .hero-trade-item .pnl{font-weight:700}
    .hero-trade-item .pnl.up{color:var(--green)}.hero-trade-item .pnl.down{color:var(--red)}
    .hero-trade-item .ago{color:var(--text-tertiary);font-size:10px}
    .hero-sub{margin-top:10px;display:inline-flex;align-items:center;gap:5px;font-size:13px;font-weight:700;padding:6px 16px;border-radius:20px;transition:all .3s}
    .hero-sub.up{color:var(--green);background:var(--green-dim)}
    .hero-sub.down{color:var(--red);background:var(--red-dim)}
    .hero-sub.zero{color:var(--text-tertiary);background:rgba(255,255,255,.04)}
    .hero-chart{height:60px;margin-top:12px;padding:0 20px}
    .hero-chart svg{width:100%;height:100%}

    /* Stats row */
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);border-radius:var(--radius-lg);overflow:hidden;margin:0 20px 16px;box-shadow:0 4px 20px rgba(0,0,0,.15)}
    .stat-cell{background:var(--bg-secondary);padding:16px 8px;text-align:center;position:relative}
    .stat-cell:not(:last-child)::after{content:'';position:absolute;right:0;top:20%;height:60%;width:1px;background:var(--border)}
    .stat-val{font-size:18px;font-weight:900}
    .stat-label{font-size:10px;color:var(--text-tertiary);margin-top:4px;font-weight:600;letter-spacing:.02em}

    /* Bot card */
    @keyframes botGlow{0%,100%{box-shadow:0 4px 20px rgba(49,130,246,.15)}50%{box-shadow:0 4px 28px rgba(49,130,246,.3)}}
    .bot-card{margin:0 20px 16px;padding:18px 20px;display:flex;align-items:center;gap:14px;border:1px solid var(--accent-dim);animation:botGlow 3s ease-in-out infinite}
    .bot-icon{width:48px;height:48px;border-radius:16px;background:linear-gradient(135deg,var(--accent),#6C5CE7);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;box-shadow:0 6px 20px rgba(49,130,246,.25)}
    .bot-info{flex:1;min-width:0}
    .bot-title{font-size:15px;font-weight:800;line-height:1.3}
    .bot-desc{font-size:12px;color:var(--text-secondary);margin-top:2px}

    /* Position cards */
    .pos-list{padding:0 20px;display:flex;flex-direction:column;gap:10px;margin-bottom:16px}
    .pos-card{padding:16px 18px;cursor:pointer;transition:all .2s;-webkit-user-select:none;position:relative;overflow:hidden}
    .pos-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:0 3px 3px 0}
    .pos-card.pos-up::before{background:linear-gradient(180deg,var(--green),var(--accent))}
    .pos-card.pos-up{box-shadow:0 4px 20px var(--green-glow)}
    .pos-card.pos-down::before{background:linear-gradient(180deg,var(--red),var(--accent))}
    .pos-card.pos-down{box-shadow:0 4px 20px var(--red-glow)}
    .pos-card:active{transform:scale(.97);background:var(--bg-card-hover)}
    .pos-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .pos-symbol{display:flex;align-items:center;gap:10px}
    .pos-symbol .icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:900}
    .pos-symbol .icon.up{background:var(--green-dim);color:var(--green)}
    .pos-symbol .icon.down{background:var(--red-dim);color:var(--red)}
    .pos-symbol .icon.neutral{background:var(--accent-dim);color:var(--accent)}
    .pos-symbol .name{font-size:15px;font-weight:800}
    .pos-pnl{font-size:17px;font-weight:900}
    .pos-pnl.up{color:var(--green)}.pos-pnl.down{color:var(--red)}
    .pos-detail{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:12px}
    .pos-amount{font-size:12px;color:var(--text-secondary)}
    .pos-amount b{color:var(--text-primary);font-weight:700}
    .pos-price{font-size:18px;font-weight:800}

    /* PnL bar */
    .pnl-bar{position:relative;height:5px;border-radius:3px;background:rgba(255,255,255,.05)}
    .pnl-bar-fill{position:absolute;top:0;left:0;height:100%;border-radius:3px;transition:width .5s ease}
    .pnl-bar-fill.up{background:linear-gradient(90deg,var(--accent),var(--green))}
    .pnl-bar-fill.down{background:linear-gradient(90deg,var(--red),var(--accent))}
    .pnl-bar-dot{position:absolute;top:-3.5px;width:12px;height:12px;border-radius:50%;border:2.5px solid var(--bg-primary);transition:left .5s ease}
    .pnl-bar-dot.up{background:var(--green)}.pnl-bar-dot.down{background:var(--red)}
    .pnl-labels{display:flex;justify-content:space-between;margin-top:5px;font-size:10px;color:var(--text-tertiary);font-weight:500}
    .pos-meta{display:flex;gap:14px;margin-top:10px;font-size:11px;color:var(--text-tertiary)}
    .pos-meta b{color:var(--text-secondary);font-weight:600}
    .pos-empty{text-align:center;padding:36px 20px;color:var(--text-tertiary)}
    .pos-empty .ico{font-size:36px;margin-bottom:8px}
    .pos-empty p{font-size:13px;line-height:1.5}

    /* === MARKET TAB === */
    .market-list{padding:0 20px;display:flex;flex-direction:column}
    .market-row{display:flex;align-items:center;padding:14px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;gap:12px}
    .market-row:last-child{border:none}
    .market-row:active{background:var(--bg-card-hover);margin:0 -8px;padding:14px 8px;border-radius:var(--radius-sm)}
    .mkt-icon{width:40px;height:40px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:900;color:#fff;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.15)}
    .mkt-info{flex:1;min-width:0}
    .mkt-name{font-size:14px;font-weight:700}
    .mkt-vol{font-size:11px;color:var(--text-tertiary);margin-top:1px}
    .mkt-signal{font-size:10px;font-weight:700;padding:2px 7px;border-radius:6px;margin-left:4px}
    .mkt-signal.BUY{background:var(--green-dim);color:var(--green)}
    .mkt-signal.SELL{background:var(--red-dim);color:var(--red)}
    .mkt-signal.HOLD{background:rgba(255,255,255,.04);color:var(--text-tertiary)}
    .mkt-patterns{font-size:10px;color:var(--text-secondary);margin-top:2px;line-height:1.4}
    .mkt-mtf{font-size:10px;font-weight:700;padding:2px 6px;border-radius:6px;margin-left:4px}
    .mkt-mtf.buy{background:var(--green-dim);color:var(--green)}
    .mkt-mtf.sell{background:var(--red-dim);color:var(--red)}
    .mkt-mtf.neutral{background:rgba(255,255,255,.04);color:var(--text-tertiary)}
    .mkt-score{font-size:10px;color:var(--text-tertiary);margin-left:4px}
    .dd-bar{display:flex;align-items:center;gap:8px;padding:12px 20px;font-size:11px;color:var(--text-secondary)}
    .dd-item{display:flex;align-items:center;gap:4px}
    .dd-item b{font-weight:700;color:var(--text-primary)}
    .pos-badges{display:flex;gap:4px;margin-top:6px}
    .pos-badge{font-size:10px;font-weight:700;padding:2px 6px;border-radius:6px}
    .pos-badge.dca{background:var(--yellow-dim);color:var(--yellow)}
    .pos-badge.partial{background:var(--accent-dim);color:var(--accent)}
    .sent-bar{display:flex;align-items:center;gap:6px;padding:8px 20px;margin-bottom:8px}
    .sent-pill{font-size:10px;font-weight:700;padding:3px 8px;border-radius:8px;display:flex;align-items:center;gap:4px}
    .sent-pill.bullish{background:var(--green-dim);color:var(--green)}
    .sent-pill.bearish{background:var(--red-dim);color:var(--red)}
    .sent-pill.neutral{background:rgba(255,255,255,.04);color:var(--text-tertiary)}
    .sent-pill .ico{font-size:12px}
    .fg-gauge{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;border:3px solid}
    .mkt-right{text-align:right;flex-shrink:0}
    .mkt-price{font-size:14px;font-weight:700;transition:color .3s}
    .mkt-price.fg{color:var(--green)}.mkt-price.fr{color:var(--red)}
    .mkt-change{font-size:11px;font-weight:600;margin-top:1px}
    .mkt-change.up{color:var(--green)}.mkt-change.down{color:var(--red)}
    .mkt-spark{width:60px;height:24px;flex-shrink:0}
    .mkt-spark svg{width:100%;height:100%}

    /* === HISTORY TAB === */
    .history-summary{margin:0 20px 16px;padding:0;display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);border-radius:var(--radius-lg);overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.15)}
    .hs-cell{background:var(--bg-secondary);padding:18px 10px;text-align:center;position:relative}
    .hs-val{font-size:20px;font-weight:900}
    .hs-label{font-size:10px;color:var(--text-tertiary);margin-top:4px;font-weight:600}

    .trade-list{padding:0 20px}
    .trade-item{display:flex;align-items:center;gap:12px;padding:13px 0;border-bottom:1px solid var(--border)}
    .trade-item:last-child{border:none}
    .trade-icon{width:34px;height:34px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
    .trade-icon.buy{background:var(--green-dim)}.trade-icon.sell{background:var(--red-dim)}.trade-icon.win{background:var(--green-dim)}
    .trade-info{flex:1;min-width:0}
    .trade-main{font-size:13px;font-weight:600;line-height:1.4}
    .trade-main b{font-weight:700}
    .trade-sub{font-size:11px;color:var(--text-tertiary);margin-top:1px}
    .trade-right{text-align:right;flex-shrink:0}
    .trade-amt{font-size:13px;font-weight:700}
    .trade-pnl{font-size:11px;font-weight:600;margin-top:1px}
    .trade-pnl.up{color:var(--green)}.trade-pnl.down{color:var(--red)}

    .trade-item.expandable{cursor:pointer;-webkit-user-select:none}
    .trade-item.expandable:active{opacity:.7}
    .trade-detail{max-height:0;overflow:hidden;transition:max-height .3s ease;padding:0 12px;font-size:11px;color:var(--text-secondary)}
    .trade-detail.open{max-height:400px;padding:8px 12px}
    .trade-detail .td-row{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--border)}
    .trade-detail .td-row:last-child{border:none}
    .trade-detail .td-label{color:var(--text-tertiary)}
    .trade-detail .td-val{font-weight:600}
    .trade-detail .td-reasons{padding:6px 0}
    .trade-detail .td-reason-item{padding:2px 0;display:flex;align-items:center;gap:4px}
    .trade-detail .td-reason-item::before{content:'';width:4px;height:4px;border-radius:50%;background:var(--accent);flex-shrink:0}
    .trade-detail .td-section{font-size:10px;font-weight:700;color:var(--text-tertiary);margin-top:6px;margin-bottom:2px;letter-spacing:.3px}
    .trade-detail .td-val.rsi-low{color:var(--green)}.trade-detail .td-val.rsi-high{color:var(--red)}.trade-detail .td-val.rsi-mid{color:var(--text-secondary)}

    /* === LOG TAB === */
    .log-container{padding:0 20px}
    .log-box{background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:var(--radius-md);padding:16px;max-height:calc(100dvh - 180px);overflow-y:auto;font-family:'SF Mono','Fira Code','Cascadia Code',monospace;font-size:10.5px;line-height:2.1;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.1) transparent}
    .log-box::-webkit-scrollbar{width:3px}.log-box::-webkit-scrollbar-thumb{background:#333;border-radius:2px}
    .log-l{opacity:.85}.log-l .t{color:var(--text-tertiary)}.log-l .tag{font-weight:700}
    .log-l.INFO .tag{color:#06b6d4}.log-l.WARN .tag{color:#f59e0b}.log-l.ERROR .tag{color:var(--red)}.log-l.TRADE .tag{color:var(--yellow)}

    /* === Modal === */
    .modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:200;display:none;align-items:flex-end;justify-content:center}
    .modal-bg.open{display:flex}
    .modal-sheet{background:var(--bg-secondary);border-radius:var(--radius-xl) var(--radius-xl) 0 0;width:100%;max-width:430px;max-height:85vh;overflow-y:auto;padding:12px 20px calc(32px + var(--safe-b));animation:slideUp .3s ease}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .modal-handle{width:36px;height:4px;background:var(--text-tertiary);border-radius:2px;margin:0 auto 16px;opacity:.4}
    .modal-title{text-align:center;font-size:18px;font-weight:800;margin-bottom:4px}
    .modal-subtitle{text-align:center;font-size:11px;color:var(--text-tertiary);margin-bottom:16px}
    .chart-legend{display:flex;gap:12px;justify-content:center;font-size:10px;color:var(--text-secondary);margin-bottom:12px}
    .chart-legend span{display:flex;align-items:center;gap:4px}
    .chart-legend .dot{width:8px;height:3px;border-radius:1px}
    .chart-area{width:100%;height:260px;margin-bottom:16px}
    .chart-area canvas{width:100%!important;height:100%!important}
    .modal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .modal-cell{text-align:center;padding:14px 8px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md)}
    .modal-cell .v{font-size:16px;font-weight:800}
    .modal-cell .l{font-size:10px;color:var(--text-tertiary);margin-top:3px}

    /* === Toast === */
    .toast-wrap{position:fixed;top:12px;left:50%;transform:translateX(-50%);z-index:999;display:flex;flex-direction:column;gap:8px;pointer-events:none;max-width:400px;width:90%}
    .toast{padding:14px 18px;border-radius:var(--radius-md);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);animation:fadeIn .3s ease,fadeOut .3s ease 3.7s forwards;display:flex;align-items:center;gap:10px;font-size:13px;font-weight:600;pointer-events:auto}
    .toast.buy{background:var(--green-dim);border:1px solid rgba(14,203,129,.25);color:var(--green)}
    .toast.win{background:var(--green-dim);border:1px solid rgba(14,203,129,.25);color:var(--green)}
    .toast.loss{background:var(--red-dim);border:1px solid rgba(246,70,93,.25);color:var(--red)}
    .toast .ti{font-size:20px}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeOut{to{opacity:0;transform:translateY(-8px)}}

    /* Sound toggle */
    .sound-toggle{background:none;border:none;font-size:18px;cursor:pointer;padding:4px 6px;border-radius:8px;transition:background .15s}
    .sound-toggle:active{background:var(--bg-card-hover)}

    /* Portfolio hero sub */
    /* hero-portfolio removed — integrated into hero balance section */

    /* RSI badge */
    .rsi-badge{font-size:10px;font-weight:700;padding:2px 6px;border-radius:6px;margin-left:4px}
    .rsi-badge.oversold{background:var(--green-dim);color:var(--green)}
    .rsi-badge.low{background:var(--green-dim);color:var(--green)}
    .rsi-badge.neutral{background:rgba(255,255,255,.04);color:var(--text-tertiary)}
    .rsi-badge.high{background:var(--red-dim);color:var(--red)}
    .rsi-badge.overbought{background:var(--red-dim);color:var(--red)}

    /* === LEARNING TAB === */
    .learn-header{padding:0 20px;margin-bottom:16px}
    .learn-header .conf{display:flex;align-items:center;gap:8px;margin-top:8px}
    .conf-bar{flex:1;height:6px;border-radius:3px;background:rgba(255,255,255,.06);overflow:hidden}
    .conf-fill{height:100%;border-radius:3px;transition:width .5s}
    .conf-label{font-size:11px;font-weight:700;min-width:36px;text-align:right}

    .learn-section{margin:0 20px 16px}
    .learn-section h3{font-size:12px;font-weight:700;color:var(--text-secondary);margin-bottom:10px;letter-spacing:.3px}

    .symbol-table{width:100%;border-collapse:collapse}
    .symbol-table th{font-size:10px;color:var(--text-tertiary);font-weight:600;text-align:left;padding:6px 8px;border-bottom:1px solid var(--border)}
    .symbol-table td{font-size:12px;padding:8px;border-bottom:1px solid var(--border)}
    .symbol-table tr:last-child td{border:none}

    .hour-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:3px}
    .hour-cell{text-align:center;padding:6px 2px;border-radius:6px;font-size:10px;font-weight:700;line-height:1.4}
    .hour-cell .h{color:var(--text-tertiary);font-weight:500}

    .param-list{display:flex;flex-direction:column;gap:6px}
    .param-row{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm)}
    .param-name{font-size:12px;font-weight:600;color:var(--text-secondary)}
    .param-val{font-size:13px;font-weight:800}

    .bl-list{display:flex;flex-wrap:wrap;gap:6px}
    .bl-chip{font-size:11px;font-weight:700;padding:4px 10px;border-radius:8px;background:var(--red-dim);color:var(--red)}

    .learn-btn{width:100%;padding:14px;border:none;border-radius:var(--radius-md);background:var(--accent);color:#fff;font-size:14px;font-weight:700;cursor:pointer;transition:all .15s;margin-top:8px}
    .learn-btn:active{transform:scale(.98);opacity:.8}
    .learn-btn:disabled{opacity:.4;cursor:not-allowed}
    .learn-meta{font-size:11px;color:var(--text-tertiary);text-align:center;margin-top:8px}

    /* Info Modal */
    .info-bg{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px)}
    .info-bg.show{display:flex}
    .info-sheet{width:100%;max-width:430px;background:var(--bg-secondary);border-radius:var(--radius-xl) var(--radius-xl) 0 0;padding:16px 24px 32px;max-height:70vh;overflow-y:auto;animation:slideUp .2s ease}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .info-handle{width:36px;height:4px;border-radius:2px;background:var(--text-tertiary);margin:0 auto 16px;opacity:.4}
    .info-title{font-size:18px;font-weight:800;margin-bottom:4px}
    .info-subtitle{font-size:12px;color:var(--text-secondary);margin-bottom:16px}
    .info-desc{font-size:13px;line-height:1.7;color:var(--text-secondary)}
    .info-desc b{color:var(--text-primary);font-weight:700}
    .info-desc .good{color:var(--green)}.info-desc .bad{color:var(--red)}.info-desc .warn{color:var(--yellow)}
    .info-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
    .info-row:last-child{border:none}
    .info-key{font-size:12px;color:var(--text-secondary)}
    .info-val{font-size:13px;font-weight:700}
    .info-list{margin:12px 0;padding-left:16px}
    .info-list li{font-size:12px;line-height:1.8;color:var(--text-secondary)}
    .tappable{cursor:pointer;-webkit-user-select:none;transition:opacity .15s}
    .tappable:active{opacity:.6}

    /* === P&L Chart === */
    .pnl-chart-section{margin:0 20px 16px}
    .pnl-chart-title{font-size:13px;font-weight:700;color:var(--text-secondary);margin-bottom:10px}
    .pnl-chart-wrap{position:relative;width:100%;height:200px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden}
    .pnl-chart-wrap canvas{width:100%!important;height:100%!important}
    .pnl-chart-empty{display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-tertiary);font-size:13px}
    .pnl-tf-btn{padding:5px 8px;font-size:10px;font-weight:700;border:none;background:var(--bg-card);color:var(--text-tertiary);cursor:pointer;transition:all .15s;outline:none}
    .pnl-tf-btn.active{background:var(--accent);color:#fff}
    .pnl-tf-btn:active{opacity:.7}

    /* === Position Cards (enhanced) === */
    .pos-card-progress{position:relative;height:4px;border-radius:2px;background:rgba(255,255,255,.06);margin-top:8px}
    .pos-card-progress-fill{height:100%;border-radius:2px;transition:width .5s ease}
    .pos-card-progress-label{display:flex;justify-content:space-between;margin-top:3px;font-size:10px;color:var(--text-tertiary)}

    /* === Settings Tab === */
    .settings-section{margin:0 20px 16px}
    .settings-section h3{font-size:12px;font-weight:700;color:var(--text-secondary);margin-bottom:10px;letter-spacing:.3px}
    .bl-mode-toggle{display:flex;gap:0;border-radius:var(--radius-sm);overflow:hidden;border:1px solid var(--border);margin-bottom:12px}
    .bl-mode-btn{flex:1;padding:10px;text-align:center;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;background:var(--bg-card);color:var(--text-secondary);border:none;outline:none}
    .bl-mode-btn.active{background:var(--accent);color:#fff}
    .bl-add-row{display:flex;gap:8px;margin-bottom:12px}
    .bl-input{flex:1;padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-card);color:var(--text-primary);font-size:13px;font-weight:500;outline:none;transition:border-color .2s}
    .bl-input:focus{border-color:var(--accent)}
    .bl-input::placeholder{color:var(--text-tertiary)}
    .bl-add-btn{padding:10px 18px;border:none;border-radius:var(--radius-sm);background:var(--accent);color:#fff;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s;white-space:nowrap}
    .bl-add-btn:active{transform:scale(.96);opacity:.8}
    .bl-tags{display:flex;flex-wrap:wrap;gap:8px}
    .bl-tag{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:700;transition:all .15s}
    .bl-tag.blacklist{background:var(--red-dim);color:var(--red)}
    .bl-tag.whitelist{background:var(--green-dim);color:var(--green)}
    .bl-tag .bl-x{cursor:pointer;font-size:14px;opacity:.7;transition:opacity .15s;line-height:1}
    .bl-tag .bl-x:hover{opacity:1}
    .bl-empty{text-align:center;padding:24px;color:var(--text-tertiary);font-size:13px}

    /* === AI Chatbot === */
    .chat-fab{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b) + 16px);right:max(calc((100vw - 430px)/2 + 16px), 16px);width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#6C5CE7);border:none;color:#fff;font-size:24px;cursor:pointer;z-index:90;box-shadow:0 4px 20px rgba(49,130,246,.4);display:flex;align-items:center;justify-content:center;transition:transform .2s,box-shadow .2s}
    .chat-fab:active{transform:scale(.9)}
    .chat-fab.has-panel{background:var(--red);box-shadow:0 4px 20px rgba(255,71,87,.4)}
    .chat-panel{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b));left:50%;transform:translateX(-50%);width:100%;max-width:430px;height:0;overflow:hidden;background:var(--bg-secondary);border-radius:var(--radius-xl) var(--radius-xl) 0 0;border:1px solid var(--glass-border);border-bottom:none;z-index:95;transition:height .3s ease;display:flex;flex-direction:column}
    .chat-panel.open{height:400px;box-shadow:0 -8px 40px rgba(0,0,0,.3)}
    .chat-header{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0}
    .chat-header-title{font-size:14px;font-weight:700;display:flex;align-items:center;gap:6px}
    .chat-close{background:none;border:none;color:var(--text-tertiary);font-size:20px;cursor:pointer;padding:4px}
    .chat-messages{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:8px}
    .chat-msg{max-width:85%;padding:10px 14px;border-radius:16px;font-size:13px;line-height:1.5;word-break:break-word}
    .chat-msg.user{align-self:flex-end;background:var(--accent);color:#fff;border-bottom-right-radius:4px}
    .chat-msg.bot{align-self:flex-start;background:var(--bg-card);border:1px solid var(--border);color:var(--text-primary);border-bottom-left-radius:4px}
    .chat-msg.bot.loading{color:var(--text-tertiary);font-style:italic}
    .chat-quick{display:flex;gap:6px;padding:8px 16px;flex-shrink:0;overflow-x:auto}
    .chat-quick::-webkit-scrollbar{display:none}
    .chat-quick-btn{padding:6px 12px;border-radius:16px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;transition:all .15s}
    .chat-quick-btn:active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .chat-input-row{display:flex;gap:8px;padding:8px 16px 12px;border-top:1px solid var(--border);flex-shrink:0}
    .chat-input{flex:1;padding:10px 14px;border:1px solid var(--border);border-radius:20px;background:var(--bg-card);color:var(--text-primary);font-size:13px;outline:none;transition:border-color .2s}
    .chat-input:focus{border-color:var(--accent)}
    .chat-input::placeholder{color:var(--text-tertiary)}
    .chat-send{width:40px;height:40px;border-radius:50%;border:none;background:var(--accent);color:#fff;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
    .chat-send:disabled{opacity:.4;cursor:default}
    .chat-send:active:not(:disabled){transform:scale(.9)}

    /* === Card Stagger Animation === */
    @keyframes cardEnter{from{opacity:0;transform:translateY(16px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
    .card-stagger>*{animation:cardEnter .4s cubic-bezier(.4,0,.2,1) both}
    .card-stagger>*:nth-child(1){animation-delay:.05s}.card-stagger>*:nth-child(2){animation-delay:.1s}
    .card-stagger>*:nth-child(3){animation-delay:.15s}.card-stagger>*:nth-child(4){animation-delay:.2s}
    .card-stagger>*:nth-child(5){animation-delay:.25s}.card-stagger>*:nth-child(6){animation-delay:.3s}

    /* === Micro Interactions === */
    .glass:active{transform:scale(.985);transition:transform .1s}
    .pos-card:active{transform:scale(.975)!important}
    .market-row:active{transform:scale(.985);transition:transform .1s}

    /* === Nav Active Indicator === */
    .nav-item{position:relative}
    .nav-item.active::before{content:'';position:absolute;top:-1px;left:50%;transform:translateX(-50%);width:20px;height:3px;border-radius:2px;background:var(--accent);animation:tabPop .3s cubic-bezier(.4,0,.2,1)}
    @keyframes tabPop{from{width:0;opacity:0}to{width:20px;opacity:1}}

    /* === Number Pulse on Change === */
    @keyframes numPulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    .num-pulse{animation:numPulse .3s ease}

    /* === Theme Picker === */
    .theme-picker{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .theme-btn{width:44px;height:44px;border-radius:14px;border:2px solid var(--border);cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;font-size:18px;background:var(--bg-card)}
    .theme-btn:active{transform:scale(.9)}
    .theme-btn.active{border-color:var(--accent);box-shadow:0 0 12px var(--accent-dim)}

    /* === More Sub-Tabs === */
    .more-tabs{display:flex;gap:0;padding:0 20px 12px}.more-tab{flex:1;padding:8px 0;font-size:12px;font-weight:700;color:var(--text-tertiary);border:none;background:none;cursor:pointer;text-align:center;border-bottom:2px solid transparent;transition:all .2s}.more-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    /* === Collapsible === */
    .fold-header{display:flex;align-items:center;justify-content:space-between;padding:8px 20px;cursor:pointer;-webkit-user-select:none}.fold-header span:first-child{font-size:12px;font-weight:700;color:var(--text-secondary)}.fold-chevron{font-size:14px;color:var(--text-tertiary);transition:transform .3s}.fold-header.open .fold-chevron{transform:rotate(180deg)}.fold-body{max-height:0;overflow:hidden;transition:max-height .3s ease}.fold-body.open{max-height:800px}
    /* === Market Search === */
    .mkt-search{padding:0 20px 10px}.mkt-search-input{width:100%;padding:10px 14px 10px 36px;border:1px solid var(--border);border-radius:var(--radius-md);background:var(--bg-card);color:var(--text-primary);font-size:13px;outline:none;transition:border-color .2s;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236a6a7a' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:12px center}.mkt-search-input:focus{border-color:var(--accent)}.mkt-search-input::placeholder{color:var(--text-tertiary)}
    /* === Skeleton === */
    @keyframes shimmer{0%{background-position:-400px 0}100%{background-position:400px 0}}.skeleton{background:linear-gradient(90deg,var(--bg-card) 25%,rgba(255,255,255,.08) 50%,var(--bg-card) 75%)!important;background-size:800px 100%;animation:shimmer 1.5s infinite;border-radius:8px;color:transparent!important;pointer-events:none}.skeleton *{visibility:hidden}
    /* === Menu Cards === */
    .menu-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:0 20px 16px}.menu-card{display:flex;flex-direction:column;align-items:center;gap:6px;padding:16px 8px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);cursor:pointer;transition:all .15s;-webkit-user-select:none}.menu-card:active{transform:scale(.96);background:var(--bg-card-hover)}.menu-card .mc-icon{font-size:22px}.menu-card .mc-text{font-size:12px;font-weight:600;color:var(--text-primary)}
    /* === Sent bar wrap === */
    .sent-bar{flex-wrap:wrap}

    /* === Pull to Refresh === */
    .ptr-indicator{text-align:center;padding:0;max-height:0;overflow:hidden;transition:max-height .3s,padding .3s;color:var(--accent);font-size:12px;font-weight:700}
    .ptr-indicator.visible{max-height:60px;padding:14px 0}
    .ptr-spinner{display:inline-block;width:20px;height:20px;border:2.5px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* === Price Flash === */
    @keyframes flashGreen{0%{background:var(--green-dim)}100%{background:transparent}}
    @keyframes flashRed{0%{background:var(--red-dim)}100%{background:transparent}}
    .flash-up{animation:flashGreen .6s ease-out}
    .flash-down{animation:flashRed .6s ease-out}

    /* === Confetti === */
    .confetti-wrap{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;overflow:hidden}
    .confetti-piece{position:absolute;width:8px;height:8px;top:-10px;border-radius:2px;animation:confettiFall 2.5s ease-in forwards}
    @keyframes confettiFall{0%{transform:translateY(0) rotate(0deg) scale(1);opacity:1}80%{opacity:1}100%{transform:translateY(100vh) rotate(720deg) scale(.3);opacity:0}}

    /* === Heatmap View === */
    .mkt-view-toggle{display:flex;gap:0;border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-left:auto}
    .mkt-view-btn{padding:6px 10px;background:none;border:none;color:var(--text-tertiary);font-size:14px;cursor:pointer;transition:all .2s}
    .mkt-view-btn.active{background:var(--accent-dim);color:var(--accent)}
    .heatmap{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;padding:0 20px}
    .hm-cell{position:relative;border-radius:var(--radius-md);padding:14px 10px;text-align:center;overflow:hidden;cursor:pointer;transition:transform .15s;min-height:70px;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .hm-cell:active{transform:scale(.95)}
    .hm-sym{font-size:13px;font-weight:800;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.3)}
    .hm-pct{font-size:16px;font-weight:900;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.3)}
    .hm-vol{font-size:9px;color:rgba(255,255,255,.7);margin-top:2px}

    /* === Daily Goal Progress === */
    .daily-goal{margin:0 20px 12px;padding:12px 16px;border-radius:var(--radius-md);background:var(--bg-card);border:1px solid var(--border)}
    .dg-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .dg-label{font-size:11px;font-weight:700;color:var(--text-secondary)}
    .dg-pct{font-size:13px;font-weight:900}
    .dg-bar{height:6px;border-radius:3px;background:rgba(255,255,255,.06);overflow:hidden}
    .dg-bar-fill{height:100%;border-radius:3px;transition:width .8s cubic-bezier(.4,0,.2,1)}
    .dg-bar-fill.on-track{background:linear-gradient(90deg,var(--accent),var(--green))}
    .dg-bar-fill.behind{background:linear-gradient(90deg,var(--yellow),var(--accent))}
    .dg-bar-fill.achieved{background:linear-gradient(90deg,var(--green),#34D399);box-shadow:0 0 10px var(--green-glow)}

    @media(max-width:360px){.hero-total-amount{font-size:28px}.hero-pnl-main{font-size:22px}.stats-row{grid-template-columns:repeat(2,1fr)}.hour-grid{grid-template-columns:repeat(8,1fr)}.heatmap{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
<div class="app">
  <div class="toast-wrap" id="toasts"></div>

  <!-- Info Modal -->
  <div class="info-bg" id="infoModal" onclick="if(event.target===this)closeInfo()">
    <div class="info-sheet">
      <div class="info-handle"></div>
      <div class="info-title" id="infoTitle">-</div>
      <div class="info-subtitle" id="infoSub">-</div>
      <div class="info-desc" id="infoBody">-</div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-bg" id="modal" onclick="if(event.target===this)closeModal()">
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="modal-title" id="mTitle">-</div>
      <div class="modal-subtitle">5분봉 차트 - 최근 5시간</div>
      <div class="chart-legend">
        <span><span class="dot" style="background:var(--green)"></span>양봉</span>
        <span><span class="dot" style="background:var(--red)"></span>음봉</span>
        <span><span class="dot" style="background:rgba(99,102,241,.5)"></span>볼린저</span>
        <span><span class="dot" style="background:var(--yellow)"></span>진입가</span>
      </div>
      <div class="chart-area"><canvas id="cc"></canvas></div>
      <div class="modal-grid" id="mStats"></div>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content" id="tabContent">
    <div class="ptr-indicator" id="ptrIndicator"><div class="ptr-spinner"></div> 새로고침 중...</div>
    <!-- HOME -->
    <div class="tab-panel active" id="panelHome">
      <div class="status-bar">
        <div class="status-left"><div class="status-dot" id="sDot"></div><span class="status-label" id="sLabel">연결 중...</span></div>
        <div class="status-right"><span id="sRight">-</span> <button class="sound-toggle" id="soundBtn" onclick="toggleSound()" title="알림음 ON/OFF">🔊</button></div>
      </div>

      <div class="sent-bar tappable" id="sentBar" style="display:none" onclick="showInfo('sentiment')"></div>
      <div class="home-hero card-stagger">
        <!-- 업비트 총 자산 -->
        <div class="hero-total-row">
          <div class="hero-total-label">업비트 총 자산</div>
          <div class="hero-total-amount skeleton" id="heroTotalAsset" style="min-height:40px;min-width:160px;display:inline-block">0원</div>
        </div>
        <!-- 현금/투자 비율 바 -->
        <div class="hero-balance-bar">
          <div class="cash" id="heroBarCash" style="width:100%"></div>
          <div class="invest" id="heroBarInvest" style="width:0%"></div>
        </div>
        <div class="hero-balance-detail">
          <div class="bal-item"><div class="bal-dot" style="background:var(--text-tertiary)"></div><span class="bal-label">현금</span> <span class="bal-val" id="heroFreeBal">0원</span></div>
          <div class="bal-item"><div class="bal-dot" style="background:var(--accent)"></div><span class="bal-label">투자중</span> <span class="bal-val" id="heroInvestBal">0원</span></div>
        </div>
        <!-- 평가손익 -->
        <div class="hero-pnl-box tappable" id="heroEvalBox" style="display:none" onclick="showInfo('evalPnl')">
          <div class="hero-pnl-title"><span>현재 평가손익 <span style="font-size:9px;opacity:.4">ⓘ</span></span><span id="heroEvalPct" style="color:var(--text-tertiary)">0%</span></div>
          <div class="hero-pnl-main" id="heroEvalPnl" style="color:var(--text-tertiary)">0원</div>
          <div class="hero-pnl-detail">
            <div><span class="lbl">투자원금</span> <span id="heroEvalCost" style="color:var(--text-primary)">0원</span></div>
            <div><span class="lbl">평가금액</span> <span id="heroEvalCur" style="color:var(--text-primary)">0원</span></div>
            <div><span class="lbl">포지션</span> <span id="heroEvalCnt" style="color:var(--text-primary)">0개</span></div>
          </div>
        </div>
        <!-- 오늘 손익 -->
        <div class="hero-pnl-box tappable" id="heroTodayBox" onclick="showInfo('todayPnl')">
          <div class="hero-pnl-title"><span>오늘 손익 <span style="font-size:9px;opacity:.4">ⓘ</span></span><span id="heroPnlPct" style="color:var(--text-tertiary)">0%</span></div>
          <div class="hero-pnl-main" id="heroTodayPnl" style="color:var(--text-tertiary)">0원</div>
          <div class="hero-pnl-detail">
            <div><span class="lbl">실현</span> <span id="heroRealized" style="color:var(--text-tertiary)">0원</span></div>
            <div><span class="lbl">미실현</span> <span id="heroUnrealized" style="color:var(--text-tertiary)">0원</span></div>
            <div><span class="lbl">투자손익</span> <span id="heroInvestPnl" style="color:var(--text-tertiary)">0원</span></div>
          </div>
        </div>
        <!-- 오늘 매매 통계 -->
        <div class="hero-stat-row tappable" id="heroStatRow" onclick="showInfo('todayStats')">
          <div class="hero-stat-title"><span>오늘 매매 <span style="font-size:9px;opacity:.4">ⓘ</span></span><span id="heroWinLoss" style="color:var(--text-tertiary)">-</span></div>
          <div class="hero-stat-grid">
            <div class="item"><div class="val" id="heroTodayBuys">0</div><div class="lbl">매수</div></div>
            <div class="item"><div class="val" id="heroTodaySells">0</div><div class="lbl">매도</div></div>
            <div class="item"><div class="val" id="heroWinRate" style="color:var(--text-tertiary)">0%</div><div class="lbl">승률</div></div>
            <div class="item"><div class="val" id="heroAvgPnl" style="color:var(--text-tertiary)">0%</div><div class="lbl">평균</div></div>
          </div>
        </div>
        <!-- 최근 거래 -->
        <div class="hero-trades" id="heroTrades"></div>
      </div>
      <div class="hero-chart" id="heroChart"></div>

      <div class="daily-goal" id="dailyGoal" style="display:none">
        <div class="dg-header"><span class="dg-label">오늘 수익 목표</span><span class="dg-pct" id="dgPct">0%</span></div>
        <div class="dg-bar"><div class="dg-bar-fill" id="dgFill" style="width:0%"></div></div>
      </div>

      <div style="padding:0 20px;margin-bottom:4px"><span style="font-size:11px;font-weight:600;color:var(--text-tertiary)">전체 누적 성적 <span style="font-size:9px;opacity:.4">ⓘ 탭하여 상세</span></span></div>
      <div class="stats-row tappable skeleton" id="statsRow" onclick="showInfo('stats')">
        <div class="stat-cell"><div class="stat-val" id="stWin">0</div><div class="stat-label">승</div></div>
        <div class="stat-cell"><div class="stat-val" id="stLoss">0</div><div class="stat-label">패</div></div>
        <div class="stat-cell"><div class="stat-val" id="stRate">0%</div><div class="stat-label">승률</div></div>
        <div class="stat-cell"><div class="stat-val" id="stTrades">0</div><div class="stat-label">매매</div></div>
      </div>
      <div id="learnSummary" style="margin:0 20px 12px;display:none">
        <div class="glass tappable" style="padding:14px 16px" onclick="showInfo('learning')">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <span style="font-size:12px;font-weight:700;color:var(--text-secondary)">자가학습 <span style="font-size:9px;opacity:.4">ⓘ</span></span>
            <span style="font-size:11px;color:var(--text-tertiary)" id="lsAge">-</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
            <span style="font-size:11px;color:var(--text-secondary)">신뢰도</span>
            <div style="flex:1;height:5px;border-radius:3px;background:rgba(255,255,255,.06);overflow:hidden"><div id="lsConfBar" style="height:100%;border-radius:3px;width:0%;transition:width .5s"></div></div>
            <span style="font-size:11px;font-weight:700" id="lsConfVal">-</span>
          </div>
          <div style="display:flex;gap:12px;font-size:11px;color:var(--text-secondary)">
            <span>분석 <b id="lsTrades" style="color:var(--text-primary)">-</b>쌍</span>
            <span>평균수익 <b id="lsAvgPnl" style="color:var(--text-primary)">-</b></span>
            <span>최고 <b id="lsBest" style="color:var(--green)">-</b></span>
          </div>
        </div>
      </div>

      <div class="perf-metrics tappable" id="perfMetrics" style="padding:0 20px;margin-bottom:12px;display:none" onclick="showInfo('perf')">
        <div class="stats-row" style="margin-bottom:0">
          <div class="stat-cell"><div class="stat-val" id="pmSharpe">-</div><div class="stat-label">샤프</div></div>
          <div class="stat-cell"><div class="stat-val" id="pmSortino">-</div><div class="stat-label">소르티노</div></div>
          <div class="stat-cell"><div class="stat-val" id="pmPF">-</div><div class="stat-label">수익팩터</div></div>
          <div class="stat-cell"><div class="stat-val" id="pmRR">-</div><div class="stat-label">손익비</div></div>
        </div>
      </div>

      <div class="pnl-chart-section">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <div class="pnl-chart-title tappable" style="margin-bottom:0" onclick="showInfo('pnlChart')">수익률 추이 <span style="font-size:9px;opacity:.4">ⓘ</span></div>
          <div id="pnlTfTabs" style="display:flex;gap:0;border-radius:8px;overflow:hidden;border:1px solid var(--border)">
            <button class="pnl-tf-btn" data-tf="15m" onclick="setPnlTf('15m')">15분</button>
            <button class="pnl-tf-btn" data-tf="30m" onclick="setPnlTf('30m')">30분</button>
            <button class="pnl-tf-btn" data-tf="1h" onclick="setPnlTf('1h')">1시간</button>
            <button class="pnl-tf-btn" data-tf="4h" onclick="setPnlTf('4h')">4시간</button>
            <button class="pnl-tf-btn active" data-tf="1d" onclick="setPnlTf('1d')">일별</button>
          </div>
        </div>
        <div class="pnl-chart-wrap glass" id="pnlChartWrap">
          <canvas id="pnlCanvas"></canvas>
          <div class="pnl-chart-empty" id="pnlChartEmpty">데이터를 불러오는 중...</div>
        </div>
      </div>

      <div class="bot-card glass section-gap tappable" id="botCard" onclick="showInfo('bot')">
        <div class="bot-icon">🤖</div>
        <div class="bot-info">
          <div class="bot-title" id="botTitle">시장을 분석하고 있어요</div>
          <div class="bot-desc" id="botDesc">잠시만 기다려주세요</div>
        </div>
      </div>

      <div class="fold-header" id="foldH_detail" onclick="toggleFold('detail')"><span>봇 상태 상세</span><span class="fold-chevron">▾</span></div>
      <div class="fold-body" id="foldB_detail">
        <div id="marketModeInfo" style="display:none;padding:4px 20px;display:flex;flex-wrap:wrap;gap:2px"></div>
        <div id="adaptiveInfo" style="display:none;padding:4px 20px;display:flex;flex-wrap:wrap;gap:2px"></div>
        <div class="dd-bar tappable" id="ddBar" style="display:none" onclick="showInfo('drawdown')"></div>
      </div>
      <div style="padding:0 20px"><h2 style="font-size:13px;font-weight:700;color:var(--text-secondary);margin-bottom:12px">보유 코인</h2></div>
      <div class="pos-list card-stagger" id="posList">
        <div class="pos-empty glass"><div class="ico">🔍</div><p>아직 매수한 코인이 없어요<br>봇이 좋은 타이밍을 찾고 있어요</p></div>
      </div>

      <div style="padding:0 20px"><h2 style="font-size:13px;font-weight:700;color:var(--text-secondary);margin-bottom:12px">최근 활동</h2></div>
      <div id="feedList" style="padding:0 20px;margin-bottom:16px">
        <div class="trade-item"><div class="trade-icon buy">🔍</div><div class="trade-info"><div class="trade-main">봇이 시작되었어요</div><div class="trade-sub">매수 시그널 대기 중</div></div></div>
      </div>
    </div>

    <!-- MARKET -->
    <div class="tab-panel" id="panelMarket">
      <div class="status-bar"><div class="status-left"><span class="status-label">시장 현황</span></div><div class="status-right" id="mktTime">-</div></div>
      <div class="mkt-search"><input class="mkt-search-input" type="text" placeholder="종목 검색 (BTC, ETH...)" oninput="filterMarket(this.value)" autocomplete="off"></div>
      <div style="padding:0 20px 8px;display:flex;align-items:center;justify-content:space-between">
        <span class="tappable" onclick="showInfo('marketGuide')" style="font-size:10px;color:var(--text-tertiary)">종목 탭 → 차트 · 시그널 뜻 보기 ⓘ</span>
        <div class="mkt-view-toggle">
          <button class="mkt-view-btn active" id="mktViewList" onclick="setMarketView('list')" title="리스트">☰</button>
          <button class="mkt-view-btn" id="mktViewHeat" onclick="setMarketView('heat')" title="히트맵">▦</button>
        </div>
      </div>
      <div class="market-list card-stagger" id="marketList"></div>
      <div class="heatmap" id="marketHeatmap" style="display:none"></div>
    </div>

    <!-- HISTORY -->
    <div class="tab-panel" id="panelHistory">
      <div class="status-bar"><div class="status-left"><span class="status-label">매매 기록</span></div><div class="status-right" id="histPeriod">전체</div></div>
      <div class="history-summary" id="histSummary">
        <div class="hs-cell"><div class="hs-val" style="color:var(--green)" id="hWin">0</div><div class="hs-label">승리</div></div>
        <div class="hs-cell"><div class="hs-val" style="color:var(--red)" id="hLoss">0</div><div class="hs-label">패배</div></div>
        <div class="hs-cell"><div class="hs-val" id="hTotal">0원</div><div class="hs-label">실현 손익</div></div>
      </div>
      <div class="trade-list" id="histList"></div>
    </div>

    <!-- LOG -->
    <div class="tab-panel" id="panelLog">
      <div class="status-bar"><div class="status-left"><span class="tappable" onclick="switchTab('Settings')" style="display:flex;align-items:center;gap:6px"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="var(--text-secondary)" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg><span class="status-label">실시간 로그</span></span></div><div class="status-right" id="logCount">0건</div></div>
      <div class="log-container"><div class="log-box" id="logBox"></div></div>
    </div>

    <!-- LEARNING -->
    <div class="tab-panel" id="panelLearn">
      <div class="status-bar"><div class="status-left"><span class="status-label">자가학습</span></div><div class="status-right" id="learnRight">-</div></div>

      <div class="learn-header">
        <div class="conf tappable" onclick="showInfo('confidence')">
          <span style="font-size:11px;color:var(--text-secondary);font-weight:600">신뢰도 <span style="font-size:9px;opacity:.4">ⓘ</span></span>
          <div class="conf-bar"><div class="conf-fill" id="confFill" style="width:0%;background:var(--text-tertiary)"></div></div>
          <span class="conf-label" id="confLabel">-</span>
        </div>
      </div>

      <div class="learn-section">
        <h3>종목별 성적표</h3>
        <div class="glass" style="overflow-x:auto;padding:4px">
          <table class="symbol-table" id="learnSymTable">
            <thead><tr><th>종목</th><th>거래</th><th>승률</th><th>평균</th><th>점수</th></tr></thead>
            <tbody id="learnSymBody"><tr><td colspan="5" style="text-align:center;color:var(--text-tertiary);padding:20px">데이터 없음</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="learn-section">
        <h3 class="tappable" onclick="showInfo('hourGrid')" style="cursor:pointer">시간대별 수익률 <span style="font-size:9px;opacity:.4">ⓘ</span></h3>
        <div class="hour-grid" id="hourGrid"></div>
      </div>

      <div class="learn-section">
        <h3>적용 중인 파라미터</h3>
        <div class="param-list" id="paramList"></div>
      </div>

      <div class="learn-section" id="blSection" style="display:none">
        <h3>블랙리스트</h3>
        <div class="bl-list" id="blList"></div>
      </div>

      <div class="learn-section" id="comboSection" style="display:none">
        <h3>시그널 조합별 성과</h3>
        <div class="glass" style="overflow-x:auto;padding:4px">
          <table class="symbol-table" id="comboTable">
            <thead><tr><th>조합</th><th>거래</th><th>승률</th><th>평균</th><th>추세</th></tr></thead>
            <tbody id="comboBody"></tbody>
          </table>
        </div>
        <div style="font-size:11px;color:var(--text-tertiary);margin-top:6px;text-align:center" id="comboMeta"></div>
      </div>

      <div class="learn-section" id="btSection" style="display:none">
        <h3>백테스트 결과</h3>
        <div class="glass" style="padding:14px" id="btResults"></div>
        <div style="font-size:10px;color:var(--text-tertiary);margin-top:6px;text-align:center" id="btMeta"></div>
      </div>

      <div class="learn-section" style="display:flex;gap:8px">
        <button class="learn-btn" id="learnBtn" onclick="triggerLearning()" style="flex:1">학습 실행</button>
        <button class="learn-btn" id="btBtn" onclick="triggerBacktest()" style="flex:1;background:var(--bg-card);border:1px solid var(--accent);color:var(--accent)">백테스트</button>
      </div>
      <div class="learn-meta" id="learnMeta">-</div>
    </div>

    <!-- Settings Tab (더보기) -->
    <div class="tab-panel" id="panelSettings">
      <div class="status-bar"><div class="status-left"><span class="status-label">더보기</span></div><div class="status-right" id="settingsRight">-</div></div>
      <div class="menu-grid">
        <div class="menu-card" onclick="switchTab('System')"><div class="mc-icon">⚙️</div><div class="mc-text">시스템</div></div>
        <div class="menu-card" onclick="switchTab('Log')"><div class="mc-icon">📋</div><div class="mc-text">로그</div></div>
        <div class="menu-card" onclick="switchTab('Updates')"><div class="mc-icon">📦</div><div class="mc-text">업데이트</div></div>
      </div>

      <div class="settings-section">
        <h3>테마</h3>
        <div class="theme-picker" id="themePicker">
          <button class="theme-btn active" data-theme="" onclick="setTheme('')" title="기본">🌙</button>
          <button class="theme-btn" data-theme="ocean" onclick="setTheme('ocean')" title="오션">🌊</button>
          <button class="theme-btn" data-theme="violet" onclick="setTheme('violet')" title="바이올렛">💎</button>
          <button class="theme-btn" data-theme="slate" onclick="setTheme('slate')" title="슬레이트">🪨</button>
        </div>
      </div>

      <div class="settings-section">
        <h3>종목 필터</h3>
        <div class="bl-mode-toggle" id="blModeToggle">
          <button class="bl-mode-btn active" id="blModeBlack" onclick="setBlMode('blacklist')">블랙리스트</button>
          <button class="bl-mode-btn" id="blModeWhite" onclick="setBlMode('whitelist')">화이트리스트</button>
        </div>
        <p style="font-size:11px;color:var(--text-tertiary);margin-bottom:12px" id="blModeDesc">블랙리스트: 아래 종목을 매매에서 제외합니다</p>
        <div class="bl-add-row">
          <input class="bl-input" id="blSymInput" type="text" placeholder="종목명 (예: BTC, ETH)" autocomplete="off" />
          <button class="bl-add-btn" onclick="addBlSymbol()">종목 추가</button>
        </div>
        <div class="glass" style="padding:14px">
          <div class="bl-tags" id="blTagsContainer">
            <div class="bl-empty" id="blTagsEmpty">등록된 종목이 없습니다</div>
          </div>
        </div>
      </div>

      <div class="settings-section" style="margin-top:20px">
        <h3>학습 블랙리스트</h3>
        <p style="font-size:11px;color:var(--text-tertiary);margin-bottom:10px">자가학습으로 자동 추가된 종목</p>
        <div class="glass" style="padding:14px">
          <div class="bl-tags" id="learnBlTags">
            <div class="bl-empty">학습 블랙리스트 없음</div>
          </div>
        </div>
      </div>
    </div>

    <!-- System Tab -->
    <div class="tab-panel" id="panelSystem">
      <div class="status-bar"><div class="status-left"><span class="tappable" onclick="switchTab('Settings')" style="display:flex;align-items:center;gap:6px"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="var(--text-secondary)" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg><span class="status-label">시스템 정보</span></span></div><div class="status-right" id="sysVersion">v2.0</div></div>

      <div class="learn-section">
        <h3>활성 지표</h3>
        <div class="glass" style="padding:16px" id="sysIndicators"></div>
      </div>

      <div class="learn-section">
        <h3>매매 기준</h3>
        <div class="glass" style="padding:16px" id="sysStrategy"></div>
      </div>

      <div class="learn-section">
        <h3>전략 성과 TOP</h3>
        <div class="glass" style="padding:4px" id="sysTopStrategies"></div>
      </div>

      <div class="learn-section">
        <h3>실시간 상태</h3>
        <div class="glass" style="padding:16px" id="sysLiveStatus"></div>
      </div>
    </div>

    <!-- Updates Tab -->
    <div class="tab-panel" id="panelUpdates">
      <div class="status-bar"><div class="status-left"><span class="tappable" onclick="switchTab('Settings')" style="display:flex;align-items:center;gap:6px"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="var(--text-secondary)" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg><span class="status-label">업데이트 기록</span></span></div><div class="status-right">v2.0</div></div>
      <div id="updatesList" style="padding:0 4px"></div>
    </div>
  </div>

  <!-- Bottom Nav (5 items) -->
  <div class="bottom-nav">
    <div class="nav-item active" data-tab="Home" onclick="switchTab('Home')">
      <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span>홈</span>
    </div>
    <div class="nav-item" data-tab="Market" onclick="switchTab('Market')">
      <svg viewBox="0 0 24 24"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
      <span>시장</span>
    </div>
    <div class="nav-item" data-tab="History" onclick="switchTab('History')">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <span>기록</span>
    </div>
    <div class="nav-item" data-tab="Learn" onclick="switchTab('Learn')">
      <svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      <span>학습</span>
    </div>
    <div class="nav-item" data-tab="More" onclick="switchTab('Settings')">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
      <span>더보기</span>
    </div>
  </div>

  <!-- AI Chatbot -->
  <button class="chat-fab" id="chatFab" onclick="toggleChat()">💬</button>
  <div class="chat-panel" id="chatPanel">
    <div class="chat-header">
      <div class="chat-header-title">🤖 AI 어시스턴트</div>
      <button class="chat-close" onclick="toggleChat()">✕</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-msg bot">안녕하세요! 봇 상태에 대해 궁금한 걸 물어보세요.</div>
    </div>
    <div class="chat-quick">
      <button class="chat-quick-btn" onclick="chatQuick('현재 상태 요약해줘')">현황</button>
      <button class="chat-quick-btn" onclick="chatQuick('오늘 거래 내역 알려줘')">오늘거래</button>
      <button class="chat-quick-btn" onclick="chatQuick('보유 포지션 분석해줘')">포지션</button>
      <button class="chat-quick-btn" onclick="chatQuick('시장 분위기 어때?')">시장</button>
    </div>
    <div class="chat-input-row">
      <input class="chat-input" id="chatInput" type="text" placeholder="질문을 입력하세요..." maxlength="500" onkeydown="if(event.key==='Enter')sendChat()">
      <button class="chat-send" id="chatSendBtn" onclick="sendChat()">➤</button>
    </div>
  </div>
</div>

<script>
window.onerror=function(msg,src,line){document.getElementById('sLabel').textContent='JS에러:'+msg+' L'+line;return false};
let ws, prevPrices={}, logN=0, animPnl=0, lastData=null;
let audio;try{audio=new (window.AudioContext||window.webkitAudioContext)()}catch(e){audio=null}
let soundOn = localStorage.getItem('soundOn') !== 'false';

// Coin colors for icons
const COIN_COLORS={
  BTC:['#F7931A','#E8820E'],ETH:['#627EEA','#4A67D6'],XRP:['#00AAE4','#0090C1'],
  SOL:['#9945FF','#14F195'],DOGE:['#C2A633','#A08B28'],ADA:['#0033AD','#002280'],
  DOT:['#E6007A','#C20066'],MATIC:['#8247E5','#6B37C8'],AVAX:['#E84142','#C53535'],
  LINK:['#2A5ADA','#1E48B8'],ATOM:['#2E3148','#6F7390'],UNI:['#FF007A','#D40066'],
  SAND:['#04ADEF','#0390C9'],MANA:['#FF2D55','#D42447'],AXS:['#0055D5','#0044AA'],
  NEAR:['#00C08B','#00A076'],APT:['#00BFA6','#009E8A'],SUI:['#4DA2FF','#3A8BE0'],
  SEI:['#9B1C2E','#7D1625'],ARB:['#28A0F0','#1E87CC'],OP:['#FF0420','#D40319'],
  USDT:['#26A17B','#1E8C6A'],IP:['#6366F1','#4F46E5'],
  DEFAULT:['#3182F6','#1B6AE0']
};
function getCoinColor(sym){const s=sym.replace('/KRW','');return COIN_COLORS[s]||COIN_COLORS.DEFAULT}

// === Theme ===
function setTheme(t){
  if(t)document.documentElement.setAttribute('data-theme',t);
  else document.documentElement.removeAttribute('data-theme');
  localStorage.setItem('dashTheme',t);
  document.querySelectorAll('.theme-btn').forEach(b=>b.classList.toggle('active',b.dataset.theme===t));
}
(function(){const t=localStorage.getItem('dashTheme');if(t)setTheme(t)})();

function updateSoundBtn(){
  const btn=document.getElementById('soundBtn');
  btn.textContent=soundOn?'🔊':'🔇';
}
function toggleSound(){
  soundOn=!soundOn;
  localStorage.setItem('soundOn',soundOn?'true':'false');
  updateSoundBtn();
}

function closeInfo(){document.getElementById('infoModal').classList.remove('show')}
function showInfo(key){
  const d=lastData;
  const el=document.getElementById('infoModal');
  const t=document.getElementById('infoTitle');
  const s=document.getElementById('infoSub');
  const b=document.getElementById('infoBody');
  let title='',sub='',body='';

  if(key==='stats'){
    const st=d?.stats||{};
    title='오늘 매매 성적';
    sub='자정에 초기화됩니다';
    body=`<div class="info-row"><span class="info-key">매수</span><span class="info-val">${st.todayBuys||0}회</span></div>`+
    `<div class="info-row"><span class="info-key">매도 (승)</span><span class="info-val good">${st.wins||0}회</span></div>`+
    `<div class="info-row"><span class="info-key">매도 (패)</span><span class="info-val bad">${st.losses||0}회</span></div>`+
    `<div class="info-row"><span class="info-key">승률</span><span class="info-val">${st.winRate||0}%</span></div>`+
    `<div class="info-row"><span class="info-key">평균 손익</span><span class="info-val">${st.avgPnl||0}원</span></div>`+
    (st.bestTrade?`<div class="info-row"><span class="info-key">최고 수익</span><span class="info-val good">${st.bestTrade.symbol} +${Math.round(st.bestTrade.pnl)}원</span></div>`:'')+
    (st.worstTrade?`<div class="info-row"><span class="info-key">최대 손실</span><span class="info-val bad">${st.worstTrade.symbol} ${Math.round(st.worstTrade.pnl)}원</span></div>`:'');
  }

  else if(key==='perf'){
    const dd=d?.drawdown||{};
    title='성과 지표';
    sub='최근 50거래 기준 계산';
    body=`<div class="info-row"><span class="info-key">샤프 비율</span><span class="info-val">${dd.sharpeRatio||'-'}</span></div>`+
    `<p class="info-desc">수익 대비 <b>전체 변동성</b> 비율. <b class="good">0.5 이상</b>이면 양호, <b class="bad">0 이하</b>면 손실 중.</p>`+
    `<div class="info-row"><span class="info-key">소르티노 비율</span><span class="info-val">${dd.sortinoRatio||'-'}</span></div>`+
    `<p class="info-desc">샤프와 비슷하지만 <b>하락 변동성만</b> 패널티. 수익이 들쭉날쭉해도 손실만 적으면 높게 나옴. 더 현실적인 지표.</p>`+
    `<div class="info-row"><span class="info-key">수익팩터 (PF)</span><span class="info-val">${dd.profitFactor||'-'}</span></div>`+
    `<p class="info-desc"><b>총 수익 / 총 손실</b>. <b class="good">1.5 이상</b>이면 좋고, <b class="bad">1.0 이하</b>면 손실이 더 큼. 현재 ${dd.profitFactor>=1.5?'<b class="good">양호</b>':dd.profitFactor>=1?'<b class="warn">본전 수준</b>':'<b class="bad">개선 필요</b>'}.</p>`+
    `<div class="info-row"><span class="info-key">손익비 (R:R)</span><span class="info-val">${dd.riskReward||'-'}</span></div>`+
    `<p class="info-desc"><b>평균 수익 / 평균 손실</b>. <b class="good">1.5 이상</b>이면 이길 때 질 때보다 1.5배 더 벌음. 현재 ${dd.riskReward>=1.5?'<b class="good">좋음</b>':dd.riskReward>=1?'<b class="warn">보통</b>':'<b class="bad">개선 필요 — 질 때 더 많이 잃는 중</b>'}.</p>`;
  }

  else if(key==='drawdown'){
    const dd=d?.drawdown||{};
    title='리스크 현황';
    sub='드로다운 기반 자동 조절';
    body=`<div class="info-row"><span class="info-key">연속 손실</span><span class="info-val">${dd.consecutiveLosses||0}회</span></div>`+
    `<p class="info-desc">연속 손실이 많으면 자동으로 포지션 수와 투자 비중을 줄입니다.<br>2연패→85%, 3연패→70%, 5연패→50%</p>`+
    `<div class="info-row"><span class="info-key">최대 드로다운</span><span class="info-val">${dd.maxDrawdownPct||0}%</span></div>`+
    `<p class="info-desc">최고점 대비 최대 하락 폭. <b class="good">5% 이내</b> 양호, <b class="warn">10%</b> 주의, <b class="bad">15% 이상</b> 위험.</p>`+
    `<div class="info-row"><span class="info-key">동적 포지션 한도</span><span class="info-val">${dd.dynamicMaxPositions||3}개</span></div>`+
    `<p class="info-desc">연속 손실에 따라 자동 조절됩니다. 기본 3개, 연패 시 줄어듦.</p>`+
    `<div class="info-row"><span class="info-key">사이징 배율</span><span class="info-val">${Math.round((dd.sizingMultiplier||1)*100)}%</span></div>`+
    `<p class="info-desc">투자 금액 비율. 연속 손실 시 자동으로 축소됩니다.</p>`+
    `<div class="info-row"><span class="info-key">롤링 승률 (최근 20)</span><span class="info-val">${dd.rollingWinRate||0}%</span></div>`;
  }

  else if(key==='sentiment'){
    const sent=d?.sentiment;
    const fg=sent?.fearGreed||{};
    const kimchi=d?.kimchi;
    const pending=d?.pendingSignals||[];
    title='시장 감성 분석';
    sub='외부 데이터 기반 시장 심리';
    body=`<div class="info-row"><span class="info-key">Fear & Greed</span><span class="info-val">${fg.value||'?'} (${fg.label||'?'})</span></div>`+
    `<p class="info-desc">0~100 사이 값. <b class="good">0~25: 극단 공포</b> (역발상 매수 기회), <b>26~50: 공포</b>, 51~75: 탐욕, <b class="bad">76~100: 극단 탐욕</b> (매도 고려).<br><br>현재 <b>${fg.value||0}</b>이라 매수 기준이 <b>${fg.value<15?'2배':fg.value<25?'1.6배':fg.value<40?'1.3배':'정상'}</b>로 높아져 있어요.${fg.value<15?' 매수점수 8 이상만 통과!':''}</p>`+
    `<div class="info-row"><span class="info-key">종합 감성</span><span class="info-val">${sent?.overall?.signal||'?'} (${sent?.overall?.score||0})</span></div>`+
    `<p class="info-desc">Reddit + 뉴스 + F&G 종합. 양수면 긍정적, 음수면 부정적.</p>`+
    (kimchi?`<div class="info-row"><span class="info-key">김치 프리미엄</span><span class="info-val">${kimchi.avgPremium>0?'+':''}${kimchi.avgPremium}%</span></div><p class="info-desc">한국 거래소와 해외 거래소 가격 차이. <b class="bad">3% 이상</b>이면 과열, <b class="good">-1% 이하</b>면 할인.</p>`:'')+
    (pending.length>0?`<div class="info-row"><span class="info-key">확인대기 종목</span><span class="info-val">${pending.length}개</span></div><p class="info-desc">매수 시그널이 나왔지만 <b>확인 캔들</b>을 기다리는 중.<br>다음 5분봉이 <b class="good">양봉(초록)</b>이면 매수 실행, <b class="bad">음봉(빨강)</b>이면 취소.<br><br>대기 종목: <b>${pending.join(', ')}</b></p>`:'')+
    `<div class="info-row"><span class="info-key">일일 손실 한도</span><span class="info-val">${d?.dailyPnl?.toLocaleString()||0}원 / -10,000원</span></div>`+
    `<p class="info-desc">하루 -10,000원 초과 손실 시 자동 매매 중단. 한도 80% 근접 시 30분 쿨다운.</p>`;
  }

  else if(key==='evalPnl'){
    const bal=d?.balance||{};
    const cost=bal.investedCost||0;
    const cur=bal.investedCurrent||0;
    const epnl=cur-cost;
    const epct=cost>0?(epnl/cost*100).toFixed(2):0;
    title='현재 평가손익';
    sub='보유 중인 코인의 미실현 손익';
    body=`<p class="info-desc"><b>투자원금</b>: 실제로 코인을 매수하는데 사용한 금액<br><b>평가금액</b>: 현재 시세 기준으로 코인의 가치<br><b>평가손익</b>: 평가금액 - 투자원금<br><br>아직 <b>매도하지 않은</b> 미실현 손익이에요. 매도해야 실현됩니다.</p>`+
    `<div class="info-row"><span class="info-key">투자원금</span><span class="info-val">${cost.toLocaleString()}원</span></div>`+
    `<div class="info-row"><span class="info-key">평가금액</span><span class="info-val">${cur.toLocaleString()}원</span></div>`+
    `<div class="info-row"><span class="info-key">평가손익</span><span class="info-val" style="color:${epnl>=0?'var(--green)':'var(--red)'}">${epnl>=0?'+':''}${Math.round(epnl).toLocaleString()}원 (${epct}%)</span></div>`+
    `<div class="info-row"><span class="info-key">보유 포지션</span><span class="info-val">${d?.positions?.length||0}개</span></div>`;
  }

  else if(key==='todayPnl'){
    const lp=d?.pnlHistory?.length?d.pnlHistory[d.pnlHistory.length-1]:null;
    const tr=lp?lp.realized:(d?.dailyPnl||0);
    const tu=lp?lp.unrealized:0;
    const tt=lp?lp.total:(d?.dailyPnl||0);
    title='오늘 손익';
    sub='자정에 초기화됩니다';
    body=`<p class="info-desc"><b>실현 손익</b>: 오늘 매도해서 <b class="good">확정된</b> 수익/손실<br><b>미실현 손익</b>: 보유 중인 코인의 현재 평가 차이 (변동됨)<br><b>투자손익</b>: 보유 코인의 매수원금 대비 현재가 차이<br><br>실현 + 미실현 = 오늘 총 손익이에요.</p>`+
    `<div class="info-row"><span class="info-key">오늘 총 손익</span><span class="info-val" style="color:${tt>=0?'var(--green)':'var(--red)'}">${tt>=0?'+':''}${Math.round(tt).toLocaleString()}원</span></div>`+
    `<div class="info-row"><span class="info-key">실현</span><span class="info-val" style="color:${tr>=0?'var(--green)':'var(--red)'}">${tr>=0?'+':''}${Math.round(tr).toLocaleString()}원</span></div>`+
    `<div class="info-row"><span class="info-key">미실현</span><span class="info-val" style="color:${tu>=0?'var(--green)':'var(--red)'}">${tu>=0?'+':''}${Math.round(tu).toLocaleString()}원</span></div>`+
    `<p class="info-desc" style="margin-top:12px">일일 손실 한도는 <b class="bad">-10,000원</b>이에요. 초과하면 자동 매매가 중단됩니다.</p>`;
  }

  else if(key==='todayStats'){
    const st=d?.stats||{};
    title='오늘 매매 통계';
    sub='자정에 초기화됩니다';
    body=`<p class="info-desc"><b>매수</b>: 봇이 코인을 산 횟수<br><b>매도</b>: 봇이 코인을 판 횟수 (손절/익절 포함)<br><b>승률</b>: 매도 중 수익을 낸 비율<br><b>평균</b>: 매도 거래의 평균 수익률</p>`+
    `<div class="info-row"><span class="info-key">오늘 매수</span><span class="info-val">${st.todayBuys||0}회</span></div>`+
    `<div class="info-row"><span class="info-key">오늘 매도</span><span class="info-val">${st.todaySells||0}회</span></div>`+
    `<div class="info-row"><span class="info-key">승/패</span><span class="info-val"><span style="color:var(--green)">${st.todayWins||0}승</span> / <span style="color:var(--red)">${st.todayLosses||0}패</span></span></div>`+
    `<div class="info-row"><span class="info-key">승률</span><span class="info-val" style="color:${(st.todayWinRate||0)>=50?'var(--green)':'var(--red)'}">${st.todayWinRate||0}%</span></div>`+
    `<div class="info-row"><span class="info-key">평균 수익률</span><span class="info-val" style="color:${(st.todayAvgPnl||0)>=0?'var(--green)':'var(--red)'}">${(st.todayAvgPnl||0)>=0?'+':''}${(st.todayAvgPnl||0).toFixed(1)}%</span></div>`+
    `<p class="info-desc" style="margin-top:8px">승률 <b class="good">50% 이상</b>이면 양호, <b class="bad">40% 미만</b>이면 자동으로 포지션 크기를 줄여요.</p>`;
  }

  else if(key==='learning'){
    const l=d?.learning||{};
    const conf=Math.round((l.confidence||0)*100);
    title='자가학습 시스템';
    sub='거래 데이터 기반 자동 최적화';
    body=`<p class="info-desc">봇이 과거 거래를 분석해서 <b>파라미터를 자동으로 최적화</b>합니다.</p>`+
    `<div class="info-row"><span class="info-key">신뢰도</span><span class="info-val" style="color:${conf>=70?'var(--green)':conf>=50?'var(--yellow)':'var(--red)'}">${conf}%</span></div>`+
    `<p class="info-desc">거래 데이터가 많을수록 높아져요. <b class="good">70% 이상</b>이면 학습 결과가 실제로 적용됩니다.</p>`+
    `<div class="info-row"><span class="info-key">분석 데이터</span><span class="info-val">${l.tradesAnalyzed||0}쌍</span></div>`+
    `<p class="info-desc">종목별 승률, 시간대별 수익률, 시그널 조합 등을 분석해요.</p>`+
    `<div class="info-row"><span class="info-key">최적화 항목</span><span class="info-val">RSI · 손절 · 익절 · 시간</span></div>`+
    `<p class="info-desc">학습 탭에서 <b>학습 실행</b> 버튼으로 수동 실행할 수 있어요. 평소에는 7일마다 자동 실행.</p>`;
  }

  else if(key==='confidence'){
    const l=d?.learning||{};
    const conf=Math.round((l.confidence||0)*100);
    title='학습 신뢰도';
    sub='학습 데이터의 신뢰성 지표';
    body=`<div class="info-row"><span class="info-key">현재 신뢰도</span><span class="info-val" style="color:${conf>=70?'var(--green)':conf>=50?'var(--yellow)':'var(--red)'}">${conf}%</span></div>`+
    `<p class="info-desc"><b>신뢰도 기준:</b><br>• <b class="good">70% 이상</b>: 학습 결과가 실제 파라미터에 적용됨<br>• <b class="warn">50~70%</b>: 데이터 부족, 참고만<br>• <b class="bad">50% 미만</b>: 아직 신뢰 불가, 기본값 사용</p>`+
    `<p class="info-desc" style="margin-top:8px">거래가 쌓일수록 신뢰도가 올라가요. 최소 <b>10거래</b> 이상이면 의미 있는 학습이 시작됩니다.</p>`;
  }

  else if(key==='hourGrid'){
    title='시간대별 수익률';
    sub='어느 시간대에 매매가 잘 되는지';
    body=`<p class="info-desc"><b>색상 의미:</b><br>• <b class="good">초록</b>: 평균 +1% 이상 (좋은 시간)<br>• <b style="color:var(--accent)">파란</b>: +0~1% (보통)<br>• <b class="warn">노란</b>: -0~1% (주의)<br>• <b class="bad">빨간</b>: -1% 이하 (나쁜 시간)<br>• <b style="color:var(--text-tertiary)">회색</b>: 거래 없음</p>`+
    `<p class="info-desc" style="margin-top:8px"><b>테두리 의미:</b><br>• <b class="good">초록 테두리</b>: 선호 시간대 (매수 부스트)<br>• <b class="bad">빨간 테두리</b>: 회피 시간대 (매수 패널티)</p>`+
    `<p class="info-desc" style="margin-top:8px">학습이 자동으로 좋은 시간대와 나쁜 시간대를 구분해서 매매에 반영해요.</p>`;
  }

  else if(key==='marketGuide'){
    title='시장 현황 읽는 법';
    sub='각 종목 카드의 정보 설명';
    body=`<p class="info-desc" style="margin-bottom:12px">종목을 <b>탭</b>하면 5분봉 차트를 볼 수 있어요.</p>`+
    `<div class="info-row"><span class="info-key" style="color:var(--green)">매수</span><span class="info-val">봇이 매수 시그널을 감지한 상태</span></div>`+
    `<div class="info-row"><span class="info-key" style="color:var(--red)">매도</span><span class="info-val">매도 시그널 (보유 시 익절/손절 고려)</span></div>`+
    `<div class="info-row"><span class="info-key">관망</span><span class="info-val">뚜렷한 시그널 없음, 대기 중</span></div>`+
    `<p class="info-desc" style="margin-top:12px"><b>RSI 뱃지:</b><br>• <b class="good">과매도</b> (30 미만): 많이 떨어져서 반등 가능성<br>• <b class="bad">과매수</b> (70 이상): 많이 올라서 하락 가능성<br>• 숫자: 현재 RSI 값 (중립대)</p>`+
    `<p class="info-desc" style="margin-top:8px"><b>MTF (다중시간):</b> 5분/1시간/4시간봉 종합 방향<br><b>B:/S:</b> 매수/매도 점수 (높을수록 강한 시그널)<br><b>VWAP:</b> 거래량가중평균 대비 이격도<br><b>DIV:</b> MACD 다이버전스 (추세 반전 신호)</p>`+
    `<p class="info-desc" style="margin-top:8px"><b>패턴:</b> 감지된 캔들/차트 패턴 (도지, 망치, 삼각수렴 등)</p>`;
  }

  else if(key==='pnlChart'){
    title='수익률 추이 차트';
    sub='시간별 누적 손익 그래프';
    body=`<p class="info-desc"><b class="good">초록선</b>: 누적 수익이 양수<br><b class="bad">빨간선</b>: 누적 수익이 음수<br><b>점선</b>: 0원 기준선<br><br>우상향이면 좋은 거예요!</p>`+
    `<p class="info-desc" style="margin-top:8px"><b>시간 단위 설명:</b><br>• 15분/30분/1시간: 단기 흐름 (오늘 내)<br>• 4시간: 중기 흐름<br>• 일별: 장기 추세 (매일 합산)</p>`+
    `<p class="info-desc" style="margin-top:8px">차트 끝의 <b>숫자</b>가 현재 누적 손익이에요.</p>`;
  }

  else if(key==='bot'){
    const pos=d?.positionCount||0;
    const maxP=d?.maxPositions||3;
    const regime=d?.regime;
    title='봇 전략 상태';
    sub='현재 적용 중인 설정';
    body=`<div class="info-row"><span class="info-key">포지션</span><span class="info-val">${pos}/${maxP}개</span></div>`+
    `<div class="info-row"><span class="info-key">시장 레짐</span><span class="info-val">${regime?{trending:'추세장',ranging:'횡보장',volatile:'급변장'}[regime.regime]||regime.regime:'분석 중'}</span></div>`+
    `<p class="info-desc">시장 상태에 따라 전략이 자동 조절됩니다.<br><b>추세장</b>: 트렌드 따라가기<br><b>횡보장</b>: 볼린저밴드 반전<br><b>급변장</b>: 매매 보수적</p>`+
    `<div class="info-row"><span class="info-key">손절</span><span class="info-val">-1.5% (ATR 동적)</span></div>`+
    `<div class="info-row"><span class="info-key">브레이크이븐</span><span class="info-val">+1.5%에 활성</span></div>`+
    `<p class="info-desc">+1.5% 수익 도달 시 손절선이 진입가로 이동 → <b class="good">본전 보장</b></p>`+
    `<div class="info-row"><span class="info-key">분할매도</span><span class="info-val">+2%→40%, +4%→40%</span></div>`+
    `<p class="info-desc">수익 나면 단계적으로 매도해서 확정 수익. 나머지 20%는 트레일링.</p>`+
    `<div class="info-row"><span class="info-key">트레일링 스탑</span><span class="info-val">+2.5% 후 최고가-1.2%</span></div>`+
    `<p class="info-desc">수익이 +2.5% 넘으면 최고가를 따라감. 최고가에서 1.2% 떨어지면 자동 매도.</p>`+
    `<div class="info-row"><span class="info-key">쿨다운</span><span class="info-val">15분</span></div>`+
    `<div class="info-row"><span class="info-key">시간당 매수</span><span class="info-val">최대 3회</span></div>`+
    `<div class="info-row"><span class="info-key">최대 보유</span><span class="info-val">4시간 (강제 8시간)</span></div>`;
  }

  t.textContent=title;s.textContent=sub;b.innerHTML=body;
  el.classList.add('show');
}
document.addEventListener('DOMContentLoaded',function(){updateSoundBtn();const t=localStorage.getItem('dashTheme')||'';setTheme(t)});

// Glass touch effect
document.addEventListener('touchstart',e=>{const g=e.target.closest('.glass');if(!g)return;const r=g.getBoundingClientRect();g.style.setProperty('--tx',(e.touches[0].clientX-r.left)+'px');g.style.setProperty('--ty',(e.touches[0].clientY-r.top)+'px');g.classList.add('touched')},{passive:true});
document.addEventListener('touchend',()=>document.querySelectorAll('.touched').forEach(e=>e.classList.remove('touched')));

function getRsiBadge(rsi){
  if(rsi==null)return'';
  const val=Math.round(rsi);
  let cls;
  if(rsi<30)cls='oversold';else if(rsi<40)cls='low';else if(rsi<=60)cls='neutral';else if(rsi<=70)cls='high';else cls='overbought';
  const label=rsi<30?'과매도':rsi>70?'과매수':val;
  return`<span class="rsi-badge ${cls}">RSI ${label}</span>`;
}

const MORE_TABS=['Settings','System','Log','Updates'];
const TAB_ORDER=['Home','Market','History','Learn','Settings'];
let currentTab='Home';
function switchTab(name){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('panel'+name).classList.add('active');
  currentTab=name;
  if(MORE_TABS.includes(name)){
    var moreNav=document.querySelector('[data-tab="More"]');if(moreNav)moreNav.classList.add('active');
  } else {
    var nav=document.querySelector('[data-tab="'+name+'"]');if(nav)nav.classList.add('active');
  }
}
// === Collapsible sections ===
function toggleFold(id){
  var h=document.getElementById('foldH_'+id);
  var b=document.getElementById('foldB_'+id);
  if(!h||!b)return;
  h.classList.toggle('open');b.classList.toggle('open');
}
// === Market Search ===
let mktSearchTerm='';
function filterMarket(val){mktSearchTerm=val.toUpperCase();if(lastData)renderMarket(lastData)}
// === Swipe Navigation ===
(function(){
  let sx=0,sy=0;
  var tc=document.querySelector('.tab-content');
  if(!tc)return;
  tc.addEventListener('touchstart',function(e){sx=e.touches[0].clientX;sy=e.touches[0].clientY},{passive:true});
  tc.addEventListener('touchend',function(e){
    var dx=e.changedTouches[0].clientX-sx,dy=e.changedTouches[0].clientY-sy;
    if(Math.abs(dx)<80||Math.abs(dy)>Math.abs(dx))return;
    var ci=TAB_ORDER.indexOf(currentTab);
    if(MORE_TABS.includes(currentTab))ci=TAB_ORDER.indexOf('Settings');
    if(ci<0)return;
    if(dx<0&&ci<TAB_ORDER.length-1)switchTab(TAB_ORDER[ci+1]);
    else if(dx>0&&ci>0)switchTab(TAB_ORDER[ci-1]);
  },{passive:true});
})()

function beep(type){
  try{
    const o=audio.createOscillator(),g=audio.createGain();
    o.connect(g);g.connect(audio.destination);g.gain.value=.05;
    if(type==='buy'){o.frequency.value=660;o.type='sine';g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.2);o.start();o.stop(audio.currentTime+.2)}
    else if(type==='win'){o.frequency.value=880;o.type='sine';g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.12);o.start();o.stop(audio.currentTime+.12);setTimeout(()=>{const o2=audio.createOscillator(),g2=audio.createGain();o2.connect(g2);g2.connect(audio.destination);o2.frequency.value=1100;o2.type='sine';g2.gain.value=.05;g2.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.15);o2.start();o2.stop(audio.currentTime+.15)},100)}
    else{o.frequency.value=280;o.type='sawtooth';g.gain.exponentialRampToValueAtTime(.001,audio.currentTime+.3);o.start();o.stop(audio.currentTime+.3)}
  }catch(e){}
}

function showToast(trade){
  const buy=trade.action==='BUY',sym=trade.symbol.replace('/KRW','');
  const win=trade.pnl!=null&&trade.pnl>0;
  const cls=buy?'buy':(win?'win':'loss');
  const icon=buy?'🟢':(win?'🎉':'🔴');
  const pnl=trade.pnl!=null?` (${trade.pnl>0?'+':''}${trade.pnl.toFixed(1)}%)`:'';
  const amt=trade.amount?` ${Math.round(trade.amount).toLocaleString()}원`:'';
  const msg=buy?`${sym} ${amt} 매수`:`${sym} 매도${pnl}`;
  const el=document.createElement('div');el.className=`toast ${cls}`;
  el.innerHTML=`<span class="ti">${icon}</span><span>${msg}</span>`;
  document.getElementById('toasts').appendChild(el);
  if(soundOn){beep(cls);if(navigator.vibrate)navigator.vibrate(buy?[60,30,60]:[120,60,120])}
  if(win&&typeof showConfetti==='function')showConfetti();
  setTimeout(()=>el.remove(),4000);
}

function fmt(n){if(n==null)return'-';if(n>=1e6)return Math.round(n).toLocaleString();if(n>=100)return Math.round(n).toLocaleString();if(n>=1)return n.toFixed(1);return n.toFixed(4)}

function spark(prices,w=60,h=24){
  if(!prices||prices.length<2)return'';
  const mn=Math.min(...prices),mx=Math.max(...prices),r=mx-mn||1,s=w/(prices.length-1);
  const pts=prices.map((p,i)=>`${(i*s).toFixed(1)},${(h-((p-mn)/r)*(h-2)-1).toFixed(1)}`).join(' ');
  const up=prices[prices.length-1]>=prices[0],c=up?'var(--green)':'var(--red)';
  return`<svg viewBox="0 0 ${w} ${h}"><polyline points="${pts}" fill="none" stroke="${c}" stroke-width="1.5" stroke-linecap="round"/></svg>`;
}

function pnlSpark(hist,w=380,h=56){
  if(!hist||hist.length<2)return'';
  const vals=hist.map(h=>h.total);
  const mn=Math.min(...vals,0),mx=Math.max(...vals,0),r=mx-mn||1,s=w/(vals.length-1);
  const zy=(h-3-((0-mn)/r)*(h-6)).toFixed(1);
  const pts=vals.map((v,i)=>`${(i*s).toFixed(1)},${(h-3-((v-mn)/r)*(h-6)).toFixed(1)}`).join(' ');
  const last=vals[vals.length-1],c=last>=0?'var(--green)':'var(--red)';
  const gid='pg'+Math.random().toString(36).slice(2,6);
  const fy=pts.split(' ')[0].split(',')[1],lx=((vals.length-1)*s).toFixed(1);
  return`<svg viewBox="0 0 ${w} ${h}"><defs><linearGradient id="${gid}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${c}" stop-opacity=".2"/><stop offset="100%" stop-color="${c}" stop-opacity="0"/></linearGradient></defs><line x1="0" y1="${zy}" x2="${w}" y2="${zy}" stroke="var(--text-tertiary)" stroke-width=".5" stroke-dasharray="3,3" opacity=".3"/><polygon points="0,${fy} ${pts} ${lx},${zy} 0,${zy}" fill="url(#${gid})"/><polyline points="${pts}" fill="none" stroke="${c}" stroke-width="1.8" stroke-linecap="round"/></svg>`;
}

function animCount(target){
  const el=document.getElementById('heroTodayPnl');
  if(!el)return;
  const diff=target-animPnl;
  if(Math.abs(diff)<1){animPnl=target;el.textContent=`${target>=0?'+':''}${Math.round(target).toLocaleString()}원`;return}
  let step=0;const inc=diff/12;
  const t=setInterval(()=>{step++;animPnl+=inc;
    el.textContent=`${animPnl>=0?'+':''}${Math.round(animPnl).toLocaleString()}원`;
    if(step>=12){clearInterval(t);animPnl=target}},25);
}

let pollTimer=null;
let wsConnected=false;

function handleStatusData(d){
  lastData=d;
  try{renderHome(d)}catch(err){console.error('renderHome error:',err)}
  try{renderMarket(d)}catch(err){console.error('renderMarket error:',err)}
  try{renderHistory(d)}catch(err){console.error('renderHistory error:',err)}
  try{renderFeed(d.todayTrades||d.recentTrades||[])}catch(err){console.error('renderFeed error:',err)}
  try{renderLearning(d.learning)}catch(err){}
  try{renderCombo(d.combo)}catch(err){}
  try{renderBacktest(d.backtest)}catch(err){}
  try{renderSystemTab(d)}catch(err){console.error('renderSystem error:',err)}
  try{renderSettingsTab(d)}catch(err){console.error('renderSettings error:',err)}
}

let tradesLoaded=false;
function startPolling(){
  if(pollTimer)return;
  async function poll(){
    try{
      const r=await fetch('/api/status');
      if(!r.ok)throw new Error('HTTP '+r.status);
      const d=await r.json();
      handleStatusData(d);
      document.getElementById('sDot').className='status-dot on';
      document.getElementById('sLabel').textContent=wsConnected?'자동매매 중':'자동매매 중 (폴링)';
      if(!tradesLoaded){
        tradesLoaded=true;
        try{const tr=await fetch('/api/trades');const td=await tr.json();renderFeed(td)}catch(e){}
        try{const lr=await fetch('/api/logs');const ld=await lr.json();ld.forEach(l=>addLog(l))}catch(e){}
      }
    }catch(e){
      document.getElementById('sLabel').textContent='폴링 에러: '+e.message;
    }
  }
  poll();
  pollTimer=setInterval(poll,5000);
}

function stopPolling(){
  if(pollTimer){clearInterval(pollTimer);pollTimer=null}
}

function connect(){
  const p=location.protocol==='https:'?'wss:':'ws:';
  let wsUrl=`${p}//${location.host}`;
  console.log('WebSocket 연결 시도:',wsUrl);
  try{ws=new WebSocket(wsUrl)}catch(e){console.error('WS 생성 실패:',e);startPolling();return}

  // 5초 안에 연결 안되면 폴링 시작
  const fallbackTimer=setTimeout(()=>{
    if(!wsConnected){console.log('WS 5초 타임아웃, 폴링 전환');startPolling()}
  },5000);

  ws.onopen=()=>{
    wsConnected=true;clearTimeout(fallbackTimer);stopPolling();
    document.getElementById('sDot').className='status-dot on';
    document.getElementById('sLabel').textContent='자동매매 중';
    try{audio.resume()}catch(e){}
    console.log('WebSocket 연결 성공');
  };
  ws.onclose=()=>{
    wsConnected=false;
    document.getElementById('sDot').className='status-dot off';
    document.getElementById('sLabel').textContent='재연결 중...';
    startPolling();
    setTimeout(connect,5000);
  };
  ws.onerror=e=>{console.error('WebSocket error:',e)};
  ws.onmessage=e=>{
    let m;
    try{m=JSON.parse(e.data)}catch(err){console.error('JSON parse error:',err);return}
    if(m.type==='status')handleStatusData(m.data);
    if(m.type==='trades')renderFeed(m.data);
    if(m.type==='trade_event')showToast(m.data);
    if(m.type==='log')addLog(m.data);
    if(m.type==='logs')m.data.forEach(l=>addLog(l));
    if(m.type==='learning_status')handleLearningStatus(m.data);
    if(m.type==='backtest_status')handleBacktestStatus(m.data);
  };
}

function renderHome(d){
  // Status
  const regimeLabel = d.regime ? {trending:'추세장',ranging:'횡보장',volatile:'급변장',unknown:'분석중'}[d.regime.regime]||'분석중' : '';
  document.getElementById('sRight').textContent=`스캔 ${d.scanCount}회${regimeLabel?' · '+regimeLabel:''}`;

  // Sentiment bar
  const sent=d.sentiment;
  const sentBar=document.getElementById('sentBar');
  if(sent&&sent.overall){
    sentBar.style.display='flex';
    const fg=sent.fearGreed||{};
    const fgVal=fg.value||50;
    const fgColor=fgVal<=25?'var(--green)':fgVal<=40?'var(--green)':fgVal<=60?'var(--text-tertiary)':fgVal<=75?'var(--red)':'var(--red)';
    const fgLabel=fg.label||'Neutral';
    const ov=sent.overall;
    const ovCls=ov.signal?.includes('bull')?'bullish':ov.signal?.includes('bear')?'bearish':'neutral';
    const redditCls=sent.reddit?.signal?.includes('bull')?'bullish':sent.reddit?.signal?.includes('bear')?'bearish':'neutral';
    const newsCls=sent.news?.signal?.includes('bull')?'bullish':sent.news?.signal?.includes('bear')?'bearish':'neutral';
    const kimchi=d.kimchi;
    const kpStr=kimchi&&kimchi.avgPremium!=null?`<span class="sent-pill ${kimchi.avgPremium>3?'bearish':kimchi.avgPremium<-1?'bullish':'neutral'}"><span class="ico">🇰🇷</span>김프 ${kimchi.avgPremium>0?'+':''}${kimchi.avgPremium}%</span>`:'';
    const paperStr=d.paperMode?`<span class="sent-pill neutral" style="border:1px solid var(--yellow);color:var(--yellow)">📝 페이퍼</span>`:'';
    const pendingStr=d.pendingSignals?.length?`<span class="sent-pill neutral"><span class="ico">⏳</span>확인대기 ${d.pendingSignals.length}</span>`:'';
    sentBar.innerHTML=`${paperStr}<span class="sent-pill ${ovCls}"><span class="ico">🧠</span>${ov.score>0?'+':''}${ov.score}</span><span class="sent-pill neutral" style="border-color:${fgColor};color:${fgColor}"><span class="ico">😱</span>F&G ${fgVal}</span><span class="sent-pill ${redditCls}"><span class="ico">📡</span>Reddit ${sent.reddit?.score||0}</span><span class="sent-pill ${newsCls}"><span class="ico">📰</span>뉴스 ${sent.news?.score||0}</span>${kpStr}${pendingStr}`;
  } else { sentBar.style.display='none'; }

  // ── 업비트 잔고 (서버에서 실시간 캐시) ──
  const bal=d.balance||{};
  const totalAsset=bal.totalAsset||0;
  const freeKRW=bal.free||0;
  const investCurrent=bal.investedCurrent||0;
  const investCost=bal.investedCost||0;

  // 총 자산 — skeleton 제거
  const heroEl=document.getElementById('heroTotalAsset');
  heroEl.classList.remove('skeleton');heroEl.style.minHeight='';heroEl.style.minWidth='';heroEl.style.display='';
  heroEl.textContent=totalAsset.toLocaleString()+'원';

  // 현금/투자 비율 바
  const cashPct=totalAsset>0?Math.round(freeKRW/totalAsset*100):100;
  const investPct=100-cashPct;
  document.getElementById('heroBarCash').style.width=cashPct+'%';
  document.getElementById('heroBarInvest').style.width=investPct+'%';
  document.getElementById('heroFreeBal').textContent=freeKRW.toLocaleString()+'원';
  document.getElementById('heroInvestBal').textContent=investCurrent.toLocaleString()+'원';

  // ── 현재 평가손익 (포지션 있을 때만) ──
  const evalBox=document.getElementById('heroEvalBox');
  if(investCost>0){
    evalBox.style.display='';
    const evalPnl=investCurrent-investCost;
    evalBox.classList.toggle('profit',evalPnl>=0);evalBox.classList.toggle('loss',evalPnl<0);
    const evalPct=investCost>0?(evalPnl/investCost*100):0;
    const epEl=document.getElementById('heroEvalPnl');
    epEl.textContent=(evalPnl>=0?'+':'')+Math.round(evalPnl).toLocaleString()+'원';
    epEl.style.color=evalPnl>0?'var(--green)':evalPnl<0?'var(--red)':'var(--text-tertiary)';
    const epcEl=document.getElementById('heroEvalPct');
    epcEl.textContent=(evalPct>=0?'+':'')+evalPct.toFixed(2)+'%';
    epcEl.style.color=evalPnl>0?'var(--green)':evalPnl<0?'var(--red)':'var(--text-tertiary)';
    document.getElementById('heroEvalCost').textContent=investCost.toLocaleString()+'원';
    document.getElementById('heroEvalCur').textContent=investCurrent.toLocaleString()+'원';
    document.getElementById('heroEvalCnt').textContent=(d.positions?.length||0)+'개';
  } else { evalBox.style.display='none'; }

  // ── 오늘 손익 ──
  const st=d.stats||{};
  const lastPnl=d.pnlHistory?.length?d.pnlHistory[d.pnlHistory.length-1]:null;
  const todayRealized=lastPnl?lastPnl.realized:d.dailyPnl;
  const todayUnrealized=lastPnl?lastPnl.unrealized:0;
  const todayTotal=lastPnl?lastPnl.total:(d.dailyPnl||0);

  // 투자 손익 = 현재 평가금액 - 매수 원금
  const investPnl=investCurrent-investCost;

  const pnlEl=document.getElementById('heroTodayPnl');
  pnlEl.textContent=(todayTotal>=0?'+':'')+Math.round(todayTotal).toLocaleString()+'원';
  pnlEl.style.color=todayTotal>0?'var(--green)':todayTotal<0?'var(--red)':'var(--text-tertiary)';
  const tdBox=document.getElementById('heroTodayBox');
  tdBox.classList.toggle('profit',todayTotal>=0);tdBox.classList.toggle('loss',todayTotal<0);
  animCount(todayTotal);
  try{renderDailyGoal(todayTotal,totalAsset);}catch(e){}

  // 손익률 (총자산 대비)
  const pnlPctVal=totalAsset>0?(todayTotal/totalAsset*100):0;
  const pctEl=document.getElementById('heroPnlPct');
  pctEl.textContent=(pnlPctVal>=0?'+':'')+pnlPctVal.toFixed(2)+'%';
  pctEl.style.color=pnlPctVal>0?'var(--green)':pnlPctVal<0?'var(--red)':'var(--text-tertiary)';

  // 실현/미실현/투자손익
  const rEl=document.getElementById('heroRealized');
  rEl.textContent=(todayRealized>=0?'+':'')+Math.round(todayRealized).toLocaleString()+'원';
  rEl.style.color=todayRealized>0?'var(--green)':todayRealized<0?'var(--red)':'var(--text-tertiary)';
  const uEl=document.getElementById('heroUnrealized');
  uEl.textContent=(todayUnrealized>=0?'+':'')+Math.round(todayUnrealized).toLocaleString()+'원';
  uEl.style.color=todayUnrealized>0?'var(--green)':todayUnrealized<0?'var(--red)':'var(--text-tertiary)';
  const ipEl=document.getElementById('heroInvestPnl');
  ipEl.textContent=(investPnl>=0?'+':'')+Math.round(investPnl).toLocaleString()+'원';
  ipEl.style.color=investPnl>0?'var(--green)':investPnl<0?'var(--red)':'var(--text-tertiary)';

  // 오늘 매매 통계
  const tw=st.todayWins||0,tl=st.todayLosses||0,twr=st.todayWinRate||0;
  document.getElementById('heroWinLoss').innerHTML=`<span style="color:var(--green)">${tw}승</span> | <span style="color:var(--red)">${tl}패</span> | ${twr}%`;
  document.getElementById('heroWinLoss').style.color='';
  document.getElementById('heroTodayBuys').textContent=st.todayBuys||0;
  document.getElementById('heroTodaySells').textContent=st.todaySells||0;
  const wrEl=document.getElementById('heroWinRate');
  wrEl.textContent=twr+'%';
  wrEl.style.color=twr>=50?'var(--green)':twr>0?'var(--red)':'var(--text-tertiary)';
  const apEl=document.getElementById('heroAvgPnl');
  const todayAvg=st.todayAvgPnl||0;
  apEl.textContent=(todayAvg>=0?'+':'')+todayAvg.toFixed(1)+'%';
  apEl.style.color=todayAvg>0?'var(--green)':todayAvg<0?'var(--red)':'var(--text-tertiary)';

  // 최근 거래 3건 (SELL만)
  const heroTradesEl=document.getElementById('heroTrades');
  const recentSells=(d.todayTrades||[]).filter(t=>t.action==='SELL'&&t.pnl!=null).slice(0,3);
  if(recentSells.length>0){
    heroTradesEl.innerHTML='<div class="ht-title">최근 거래</div>'+recentSells.map(t=>{
      const sym=(t.symbol||'').replace('/KRW','');
      const pnlAmt=t.pnlAmount!=null?t.pnlAmount:(t.amount?t.amount*t.pnl/100:t.pnl);
      const cls=pnlAmt>=0?'up':'down';
      const ago=timeAgo(t.timestamp);
      return `<div class="hero-trade-item"><span class="sym">${sym}</span><span class="pnl ${cls}">${pnlAmt>=0?'+':''}${Math.round(pnlAmt).toLocaleString()}원 (${t.pnl>=0?'+':''}${t.pnl.toFixed(1)}%)</span><span class="ago">${ago}</span></div>`;
    }).join('');
  } else { heroTradesEl.innerHTML=''; }

  document.getElementById('heroChart').innerHTML=pnlSpark(d.pnlHistory);

  // (포트폴리오 정보는 hero 상단에 통합됨)

  // Stats (전체 누적) — skeleton 제거
  document.getElementById('statsRow').classList.remove('skeleton');
  const s=d.stats||{};
  document.getElementById('stWin').textContent=s.wins||0;
  document.getElementById('stWin').style.color='var(--green)';
  document.getElementById('stLoss').textContent=s.losses||0;
  document.getElementById('stLoss').style.color='var(--red)';
  document.getElementById('stRate').textContent=(s.winRate||0)+'%';
  document.getElementById('stRate').style.color=s.winRate>=50?'var(--green)':'var(--red)';
  document.getElementById('stTrades').textContent=(s.totalTrades||0);

  // Learning summary on home
  try{
    var ls=d.learning;
    var lsEl=document.getElementById('learnSummary');
    if(ls&&ls.tradesAnalyzed>0){
      lsEl.style.display='block';
      var conf=Math.round((ls.confidence||0)*100);
      var confColor=conf>=70?'var(--green)':conf>=50?'var(--yellow)':'var(--red)';
      document.getElementById('lsConfBar').style.width=conf+'%';
      document.getElementById('lsConfBar').style.background=confColor;
      document.getElementById('lsConfVal').textContent=conf+'%';
      document.getElementById('lsConfVal').style.color=confColor;
      document.getElementById('lsTrades').textContent=ls.tradesAnalyzed;
      document.getElementById('lsAge').textContent=ls.updatedAt?timeAgo(ls.updatedAt):'';
      var avgP=s.avgPnl||0;
      document.getElementById('lsAvgPnl').textContent=(avgP>=0?'+':'')+avgP.toFixed(1)+'%';
      document.getElementById('lsAvgPnl').style.color=avgP>=0?'var(--green)':'var(--red)';
      var best=s.bestTrade;
      document.getElementById('lsBest').textContent=best?('+'+best.pnl.toFixed(1)+'%'):'-';
    } else { lsEl.style.display='none'; }
  }catch(e){console.error('learnSummary error:',e)}

  // Bot card
  const posN=d.positionCount;
  const af=d.adaptiveFilter;
  if(posN===0){
    document.getElementById('botTitle').textContent='좋은 매수 타이밍을 찾고 있어요';
    document.getElementById('botDesc').textContent=`${d.symbols?.length||0}개 코인 감시 중`;
  } else {
    document.getElementById('botTitle').textContent=`${posN}개 코인을 보유하고 있어요`;
    const sizeMult=d.drawdown?.sizingMultiplier;
    document.getElementById('botDesc').textContent=sizeMult&&sizeMult<1?`손절/익절 자동관리 · 사이징 ${Math.round(sizeMult*100)}%`:`손절 -2% / 익절 +5% 자동 관리 중`;
  }
  // 마켓 모드 표시
  const mm=d.marketMode;
  const mmEl=document.getElementById('marketModeInfo');
  if(mmEl&&mm&&mm.mode){
    const modeColors={aggressive:'var(--green)',defensive:'var(--red)',scalping:'var(--yellow)'};
    const modeIcons={aggressive:'🟢',defensive:'🔴',scalping:'🟡'};
    const modeNames={aggressive:'공격 모드',defensive:'방어 모드',scalping:'스캘핑 모드'};
    const mColor=modeColors[mm.mode]||'var(--text-secondary)';
    const mIcon=modeIcons[mm.mode]||'⚙️';
    const mName=modeNames[mm.mode]||mm.mode;
    const btcD=d.btcDominance?.value?` · BTC.D ${d.btcDominance.value}%`:'';
    const modePill=`<span class="sent-pill" style="font-size:11px;margin:2px;background:${mColor}20;color:${mColor};border:1px solid ${mColor}40;font-weight:700">${mIcon} ${mName} (${mm.score>0?'+':''}${mm.score})${btcD}</span>`;
    const mReasons=mm.reasons?.map(r=>`<span class="sent-pill neutral" style="font-size:10px;margin:1px">${r}</span>`).join('')||'';
    mmEl.style.display='flex';
    mmEl.innerHTML=modePill+mReasons;
  } else if(mmEl){mmEl.style.display='none';}
  // 적응 필터 상태 표시
  const afEl=document.getElementById('adaptiveInfo');
  if(afEl&&af&&af.reasons?.length>0){
    afEl.style.display='block';
    const afPills=af.reasons.map(r=>{
      const isBlock=r.includes('비활성')||r.includes('쿨다운');
      const cls=isBlock?'bearish':(r.includes('축소')?'neutral':'neutral');
      return`<span class="sent-pill ${cls}" style="font-size:10px;margin:2px">⚡${r}</span>`;
    }).join('');
    afEl.innerHTML=afPills;
  } else if(afEl){afEl.style.display='none';}

  // Drawdown bar
  const dd=d.drawdown;
  const ddBar=document.getElementById('ddBar');
  if(dd){
    ddBar.style.display='flex';
    const sharpeColor=dd.sharpeRatio>0.5?'var(--green)':dd.sharpeRatio>0?'var(--yellow)':'var(--red)';
    const lossColor=dd.consecutiveLosses>=3?'var(--red)':dd.consecutiveLosses>=2?'var(--yellow)':'var(--text-primary)';
    ddBar.innerHTML=`<div class="dd-item">Sharpe <b style="color:${sharpeColor}">${dd.sharpeRatio}</b></div><div class="dd-item">연속손실 <b style="color:${lossColor}">${dd.consecutiveLosses}</b></div><div class="dd-item">최대DD <b>${dd.maxDrawdownPct}%</b></div><div class="dd-item">포지션 <b>${dd.dynamicMaxPositions}개</b></div>`;

    // 성과 지표 (Sortino, Profit Factor, Risk:Reward)
    try{
      const pm=document.getElementById('perfMetrics');
      if(pm&&(dd.sortinoRatio!=null||dd.profitFactor!=null)){
        pm.style.display='block';
        const colorVal=(v,good,bad)=>v>=good?'var(--green)':v>=bad?'var(--yellow)':'var(--red)';
        document.getElementById('pmSharpe').textContent=dd.sharpeRatio||'-';
        document.getElementById('pmSharpe').style.color=colorVal(dd.sharpeRatio,0.5,0);
        document.getElementById('pmSortino').textContent=dd.sortinoRatio||'-';
        document.getElementById('pmSortino').style.color=colorVal(dd.sortinoRatio,0.5,0);
        document.getElementById('pmPF').textContent=dd.profitFactor||'-';
        document.getElementById('pmPF').style.color=colorVal(dd.profitFactor,1.5,1.0);
        document.getElementById('pmRR').textContent=dd.riskReward||'-';
        document.getElementById('pmRR').style.color=colorVal(dd.riskReward,1.5,1.0);
      }
    }catch(e){console.error('perfMetrics error:',e)}
  }

  // Positions
  const pl=document.getElementById('posList');
  if(!d.positions?.length){
    pl.innerHTML='<div class="pos-empty glass"><div class="ico">📭</div><p>보유 포지션 없음<br>봇이 좋은 타이밍을 찾고 있어요</p></div>';
  } else {
    pl.innerHTML=d.positions.map(p=>{
      const pnl=p.pnlPct||0,up=pnl>=0;
      const curVal=Math.round(p.amount*(1+pnl/100));
      const pnlKrw=curVal-Math.round(p.amount);
      const barPct=Math.max(0,Math.min(100,(pnl+2)/7*100));
      const sym=p.symbol.replace('/KRW','');
      const [c1,c2]=getCoinColor(sym);
      const glowCls=up?'profit-glow':'loss-glow';
      // Hold time formatted
      const holdH=Math.floor(p.holdMinutes/60);
      const holdM=p.holdMinutes%60;
      const holdStr=holdH>0?holdH+'시간 '+holdM+'분':holdM+'분';
      // Progress bar from entry to take-profit
      const tpPct=(p.takeProfit&&p.entryPrice)?((p.takeProfit-p.entryPrice)/p.entryPrice*100):5;
      const progressPct=Math.max(0,Math.min(100,(pnl/tpPct)*100));
      const progressColor=up?'linear-gradient(90deg,var(--accent),var(--green))':'linear-gradient(90deg,var(--red),var(--accent))';
      const badges=[];
      if(p.breakevenSet)badges.push('<span class="pos-badge" style="background:var(--green-dim);color:var(--green)">BE</span>');
      if(p.trailingActive)badges.push(`<span class="pos-badge" style="background:var(--accent-dim);color:var(--accent)">Trail</span>`);
      if(p.dcaCount)badges.push(`<span class="pos-badge dca">DCA${p.dcaCount}</span>`);
      if(p.partialSells)badges.push(`<span class="pos-badge partial">분할${p.partialSells}</span>`);
      return`<div class="pos-card glass ${up?'pos-up':'pos-down'}" onclick="openChart('${p.symbol}')">
        <div class="pos-head">
          <div class="pos-symbol"><div class="icon" style="background:linear-gradient(135deg,${c1},${c2});color:#fff">${sym.slice(0,2)}</div><div><div class="name">${sym}${badges.length?' '+badges.join(''):''}  </div><div style="font-size:11px;color:var(--text-secondary)">${Math.round(p.amount).toLocaleString()}원 · ${holdStr}</div></div></div>
          <div style="text-align:right">
            <div class="pos-pnl ${up?'up':'down'}">${up?'+':''}${pnl.toFixed(2)}%</div>
            <div style="font-size:12px;font-weight:700;color:${up?'var(--green)':'var(--red)'}">${pnlKrw>=0?'+':''}${pnlKrw.toLocaleString()}원</div>
          </div>
        </div>
        <div class="pos-card-progress" style="margin-top:4px"><div class="pos-card-progress-fill" style="width:${progressPct}%;background:${progressColor}"></div></div>
        <div class="pnl-labels"><span>손절 ${fmt(p.stopLoss)}</span><span>${fmt(p.currentPrice)}</span><span>익절 ${fmt(p.takeProfit)}</span></div>
      </div>`;
    }).join('');
  }
}

function renderFeed(trades){
  const el=document.getElementById('feedList');
  if(!trades?.length){el.innerHTML='<div class="trade-item"><div class="trade-icon buy">🔍</div><div class="trade-info"><div class="trade-main">봇이 시작되었어요</div><div class="trade-sub">매수 시그널 대기 중</div></div></div>';return}
  const feedExpanded=el.dataset.expanded==='1';
  const feedLimit=feedExpanded?20:3;
  const feedArr=trades.slice(0,feedLimit);
  const hasMore=trades.length>3&&!feedExpanded;
  el.innerHTML=feedArr.map(t=>{
    const isBuy=t.action==='BUY'||t.action==='DCA',isDCA=t.action==='DCA',sym=t.symbol.replace('/KRW','');
    const time=new Date(t.timestamp).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
    const icon=isBuy?(isDCA?'📥':'💰'):'💸';
    const cls=isBuy?'buy':(t.pnl>0?'win':'sell');
    const amt=t.amount?`${Math.round(t.amount).toLocaleString()}원`:'';
    let msg,pnlStr='';
    if(isBuy){msg=`<b>${sym}</b> ${isDCA?'물타기':'매수'}`}
    else{msg=`<b>${sym}</b> 매도`;if(t.pnl!=null)pnlStr=`<span class="trade-pnl ${t.pnl>=0?'up':'down'}">${t.pnl>=0?'+':''}${t.pnl.toFixed(1)}%</span>`}
    const detail=buildTradeDetail(t);
    const expandCls=detail?'expandable':'';
    return`<div class="trade-item ${expandCls}" ${detail?'onclick="toggleTradeDetail(this)"':''}>
      <div class="trade-icon ${cls}">${icon}</div>
      <div class="trade-info"><div class="trade-main">${msg}</div><div class="trade-sub">${time} · ${t.reason||''}</div></div>
      <div class="trade-right"><div class="trade-amt">${amt}</div>${pnlStr}</div>
    </div>${detail}`;
  }).join('')+(hasMore?`<div style="text-align:center;padding:10px"><button onclick="document.getElementById('feedList').dataset.expanded='1';if(lastData)renderFeed(lastData.todayTrades||lastData.recentTrades||[])" style="background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:8px 20px;color:var(--text-secondary);font-size:12px;font-weight:600;cursor:pointer">이전 활동 더보기 (${trades.length-3}건)</button></div>`:'');
}

function renderMarket(d){
  document.getElementById('mktTime').textContent=new Date().toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const sd=(d.symbolData||[]).filter(s=>{if(!mktSearchTerm)return true;return s.symbol.toUpperCase().includes(mktSearchTerm)});
  const held=new Set(d.positions?.map(p=>p.symbol)||[]);
  document.getElementById('marketList').innerHTML=sd.map(s=>{
    const sym=s.symbol.replace('/KRW','');
    const ch=s.change!=null?s.change:0;
    const chStr=ch>=0?`+${ch.toFixed(2)}%`:`${ch.toFixed(2)}%`;
    const prev=prevPrices[s.symbol];
    let flash='';
    if(prev&&s.price){if(s.price>prev)flash='fg';else if(s.price<prev)flash='fr'}
    if(s.price)prevPrices[s.symbol]=s.price;
    const act=s.action||'HOLD';
    const isHeld=held.has(s.symbol);
    const [mc1,mc2]=getCoinColor(sym);
    // Patterns and MTF
    const cp=s.patterns?.candle||[];
    const chp=s.patterns?.chart||[];
    const allPats=[...cp.map(p=>p.emoji+p.name),...chp.map(p=>p.emoji+p.name)];
    const patStr=allPats.length>0?allPats.slice(0,3).join(' '):'';
    const mtfSig=s.mtf?.signal||'';
    const mtfCls=mtfSig.includes('buy')?'buy':mtfSig.includes('sell')?'sell':'neutral';
    const scoreStr=s.scores?`B:${s.scores.buy?.toFixed(1)||0} S:${s.scores.sell?.toFixed(1)||0}`:'';
    const obStr=s.orderbook&&Math.abs(s.orderbook)>0.3?`<span style="font-size:10px;color:${s.orderbook>0?'var(--green)':'var(--red)'}">${s.orderbook>0?'매수↑':'매도↑'}</span>`:'';
    const vwapInfo=s.indicators?.vwap;
    const vwapStr=vwapInfo&&vwapInfo.signal!=='neutral'?`<span style="font-size:10px;color:${vwapInfo.score>0?'var(--green)':'var(--red)'}">VWAP${vwapInfo.deviation>0?'+':''}${vwapInfo.deviation}%</span>`:'';
    const divInfo=s.indicators?.macd?.divergence;
    const divStr=divInfo&&divInfo.type!=='none'?`<span style="font-size:10px;color:${divInfo.type==='bullish'?'var(--green)':'var(--red)'}">DIV${divInfo.type==='bullish'?'↑':'↓'}</span>`:'';
    return`<div class="market-row" onclick="openChart('${s.symbol}')" ${isHeld?'style="background:var(--green-dim);border-radius:var(--radius-sm);margin:0 -8px;padding:14px 8px"':''}>
      <div class="mkt-icon" style="background:linear-gradient(135deg,${mc1},${mc2});color:#fff">${sym.slice(0,2)}</div>
      <div class="mkt-info">
        <div class="mkt-name">${sym} ${isHeld?'<span style="font-size:10px;color:var(--green);font-weight:600">보유중</span>':''} <span class="mkt-signal ${act}">${act==='BUY'?'매수':act==='SELL'?'매도':'관망'}</span> ${getRsiBadge(s.indicators?.rsi)}${mtfSig?`<span class="mkt-mtf ${mtfCls}">${mtfSig}</span>`:''}</div>
        <div class="mkt-vol">24h ${ch>=0?'▲':'▼'} ${Math.abs(ch).toFixed(2)}%${scoreStr?` · <span class="mkt-score">${scoreStr}</span>`:''}${obStr?' · '+obStr:''}${vwapStr?' · '+vwapStr:''}${divStr?' · '+divStr:''}</div>
        ${patStr?`<div class="mkt-patterns">${patStr}</div>`:''}
      </div>
      <div class="mkt-spark">${spark(s.sparkline)}</div>
      <div class="mkt-right">
        <div class="mkt-price ${flash} ${flash==='fg'?'flash-up':flash==='fr'?'flash-down':''}">${s.price?fmt(s.price):'-'}</div>
        <div class="mkt-change ${ch>0?'up':ch<0?'down':''}">${chStr}</div>
      </div>
    </div>`;
  }).join('');
  setTimeout(()=>document.querySelectorAll('.fg,.fr').forEach(e=>{e.classList.remove('fg','fr')}),500);
  if(marketViewMode==='heat') try{renderHeatmap(d)}catch(e){}
}

function toggleTradeDetail(el){
  const detail=el.nextElementSibling;
  if(detail&&detail.classList.contains('trade-detail')){detail.classList.toggle('open')}
}

function buildTradeDetail(t){
  const buy=t.action==='BUY';
  const snap=t.snapshot||{};
  const hasSnap=snap.rsi!=null||snap.buyScore!=null;
  const hasReason=t.reason&&t.reason.length>0;
  if(!hasSnap&&!hasReason)return'';

  let html='<div class="trade-detail">';

  // Reason section
  if(hasReason){
    const label=buy?'매수 사유':'매도 사유';
    html+=`<div class="td-section">${label}</div><div class="td-reasons">`;
    const parts=t.reason.split(/[,，]/).map(s=>s.trim()).filter(Boolean);
    parts.forEach(p=>{html+=`<div class="td-reason-item">${p}</div>`});
    html+='</div>';
  }

  // Scores
  if(snap.buyScore!=null||snap.sellScore!=null){
    html+='<div class="td-section">시그널 점수</div>';
    if(snap.buyScore!=null)html+=`<div class="td-row"><span class="td-label">매수 점수</span><span class="td-val" style="color:var(--green)">${snap.buyScore}</span></div>`;
    if(snap.sellScore!=null)html+=`<div class="td-row"><span class="td-label">매도 점수</span><span class="td-val" style="color:var(--red)">${snap.sellScore}</span></div>`;
  }

  // Indicators
  if(snap.rsi!=null||snap.bbPosition!=null||snap.macdTrend||snap.volumeRatio!=null){
    html+='<div class="td-section">지표 상태</div>';
    if(snap.rsi!=null){
      const rCls=snap.rsi<30?'rsi-low':snap.rsi>70?'rsi-high':'rsi-mid';
      const rLabel=snap.rsi<30?'과매도':snap.rsi>70?'과매수':'중립';
      html+=`<div class="td-row"><span class="td-label">RSI</span><span class="td-val ${rCls}">${snap.rsi} (${rLabel})</span></div>`;
    }
    if(snap.bbPosition!=null){
      const bpPct=Math.round(snap.bbPosition*100);
      const bLabel=bpPct<20?'하단 근접':bpPct>80?'상단 근접':'중간대';
      html+=`<div class="td-row"><span class="td-label">볼린저 위치</span><span class="td-val">${bpPct}% (${bLabel})</span></div>`;
    }
    if(snap.macdTrend){
      const mColor=snap.macdBullish?'var(--green)':'var(--red)';
      const mLabel=snap.macdTrend==='UP'?'상승':snap.macdTrend==='DOWN'?'하락':'횡보';
      html+=`<div class="td-row"><span class="td-label">MACD</span><span class="td-val" style="color:${mColor}">${mLabel}${snap.macdBullish?' (골든크로스)':''}</span></div>`;
    }
    if(snap.volumeRatio!=null){
      const vr=typeof snap.volumeRatio==='number'?snap.volumeRatio.toFixed(1):snap.volumeRatio;
      const vColor=snap.volumeHigh?'var(--green)':'var(--text-secondary)';
      html+=`<div class="td-row"><span class="td-label">거래량 배수</span><span class="td-val" style="color:${vColor}">${vr}x${snap.volumeHigh?' (급증)':''}</span></div>`;
    }
    if(snap.vwap&&snap.vwap.signal!=='neutral'){
      html+=`<div class="td-row"><span class="td-label">VWAP</span><span class="td-val">${snap.vwap.signal} (${snap.vwap.deviation>0?'+':''}${snap.vwap.deviation}%)</span></div>`;
    }
    if(snap.macdDivergence&&snap.macdDivergence!=='none'){
      const dColor=snap.macdDivergence==='bullish'?'var(--green)':'var(--red)';
      html+=`<div class="td-row"><span class="td-label">MACD 다이버전스</span><span class="td-val" style="color:${dColor}">${snap.macdDivergence==='bullish'?'강세':'약세'}</span></div>`;
    }
  }

  // Market regime
  const regime=snap.regime||t.regime;
  if(regime||(snap.volatilityBreakout&&snap.volatilityBreakout!=='NONE')){
    html+='<div class="td-section">시장 상태</div>';
    if(regime){
      const rMap={trending:'추세',ranging:'횡보',volatile:'급변',unknown:'분석중'};
      html+=`<div class="td-row"><span class="td-label">시장 국면</span><span class="td-val">${rMap[regime]||regime}</span></div>`;
    }
    if(snap.volatilityBreakout&&snap.volatilityBreakout!=='NONE'){
      html+=`<div class="td-row"><span class="td-label">변동성 돌파</span><span class="td-val" style="color:var(--yellow)">${snap.volatilityBreakout}</span></div>`;
    }
  }

  // MTF / Bandit
  if(t.mtfSignal||t.banditProfile||snap.mtfSignal){
    html+='<div class="td-section">추가 정보</div>';
    const mtf=t.mtfSignal||snap.mtfSignal;
    if(mtf)html+=`<div class="td-row"><span class="td-label">다중시간 시그널</span><span class="td-val">${mtf}</span></div>`;
    if(t.banditProfile)html+=`<div class="td-row"><span class="td-label">전략 프로필</span><span class="td-val">${t.banditProfile}</span></div>`;
  }

  // Candle/Chart patterns
  if(snap.candlePatterns?.length||snap.chartPatterns?.length){
    html+='<div class="td-section">패턴</div>';
    const allPats=[...(snap.candlePatterns||[]),...(snap.chartPatterns||[])];
    html+=`<div class="td-row"><span class="td-label">감지 패턴</span><span class="td-val">${allPats.join(', ')}</span></div>`;
  }

  html+='</div>';
  return html;
}

function renderHistory(d){
  const s=d.stats||{};
  document.getElementById('hWin').textContent=s.wins||0;
  document.getElementById('hLoss').textContent=s.losses||0;
  const pnl=d.dailyPnl||0;
  const hT=document.getElementById('hTotal');
  hT.textContent=`${pnl>=0?'+':''}${Math.round(pnl).toLocaleString()}원`;
  hT.style.color=pnl>=0?'var(--green)':'var(--red)';
  document.getElementById('histPeriod').textContent=`${s.totalTrades||0}건 · 승률 ${s.winRate||0}%`;

  // 전체 최근 기록 표시 (recentTrades 사용, 없으면 todayTrades 폴백)
  const trades=(d.recentTrades||d.todayTrades||[]).slice().reverse();
  if(!trades.length){document.getElementById('histList').innerHTML='<div style="text-align:center;padding:40px;color:var(--text-tertiary)">매매 기록이 없어요</div>';return}

  // 날짜별 그루핑
  var lastDate='';
  document.getElementById('histList').innerHTML=trades.map(function(t){
    var isBuy=t.action==='BUY'||t.action==='DCA',sym=t.symbol.replace('/KRW','');
    var d2=new Date(t.timestamp);
    var dateStr=(d2.getMonth()+1)+'/'+(d2.getDate())+'일';
    var time=d2.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
    var isDCA=t.action==='DCA';
    var icon=isBuy?(isDCA?'📥':'💰'):'💸';
    var cls=isBuy?'buy':(t.pnl>0?'win':'sell');
    var actionLabel=isDCA?'물타기':(isBuy?'매수':'매도');
    var amt=t.amount?Math.round(t.amount).toLocaleString()+'원':Math.round(t.price*t.quantity).toLocaleString()+'원';
    var pnlStr='';
    if(!isBuy&&t.pnl!=null)pnlStr='<div class="trade-pnl '+(t.pnl>=0?'up':'down')+'">'+(t.pnl>=0?'+':'')+t.pnl.toFixed(2)+'%</div>';
    var detail=buildTradeDetail(t);
    var expandCls=detail?'expandable':'';
    var expandHint=detail?'<span style="font-size:10px;color:var(--text-tertiary);margin-left:4px">상세 ▾</span>':'';
    var dateSep='';
    if(dateStr!==lastDate){lastDate=dateStr;dateSep='<div style="padding:10px 0 6px;font-size:11px;font-weight:700;color:var(--text-tertiary);border-top:1px solid var(--border);margin-top:4px">'+dateStr+'</div>'}
    return dateSep+'<div class="trade-item '+expandCls+'" '+(detail?'onclick="toggleTradeDetail(this)"':'')+'>'+
      '<div class="trade-icon '+cls+'">'+icon+'</div>'+
      '<div class="trade-info"><div class="trade-main"><b>'+sym+'</b> '+actionLabel+expandHint+'</div><div class="trade-sub">'+time+' · '+(t.reason||'')+'</div></div>'+
      '<div class="trade-right"><div class="trade-amt">'+amt+'</div>'+pnlStr+'</div>'+
    '</div>'+(detail||'');
  }).join('');
}

function addLog(entry){
  const box=document.getElementById('logBox');
  const time=new Date(entry.time).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const line=document.createElement('div');
  line.className=`log-l ${entry.level}`;
  line.innerHTML=`<span class="t">${time}</span> <span class="tag">[${entry.tag}]</span> ${entry.msg}`;
  box.appendChild(line);logN++;
  if(logN>80){box.removeChild(box.firstChild);logN--}
  box.scrollTop=box.scrollHeight;
  document.getElementById('logCount').textContent=logN+'건';
}

// Chart Modal
async function openChart(symbol){
  document.getElementById('modal').classList.add('open');
  document.getElementById('mTitle').textContent=symbol.replace('/KRW','')+' 차트';
  try{const r=await fetch(`/api/candles/${encodeURIComponent(symbol)}`);const data=await r.json();drawChart(data)}
  catch(e){document.getElementById('mStats').innerHTML='<div style="color:var(--red);text-align:center;padding:20px;grid-column:span 3">차트 로딩 실패</div>'}
}
function closeModal(){document.getElementById('modal').classList.remove('open')}

function drawChart(data){
  const canvas=document.getElementById('cc');
  const dpr=window.devicePixelRatio||1;
  const rect=canvas.parentElement.getBoundingClientRect();
  const W=rect.width,H=260;
  canvas.width=W*dpr;canvas.height=H*dpr;
  canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);

  const candles=data.candles||[];if(!candles.length)return;
  const vH=36,cH=H-vH-8,n=candles.length;
  const cw=Math.max(2,(W-16)/n*.55),gap=(W-16)/n;

  let pMin=Infinity,pMax=-Infinity,vMax=0;
  candles.forEach(c=>{
    const lo=c.bb?Math.min(c.low,c.bb.lower):c.low;
    const hi=c.bb?Math.max(c.high,c.bb.upper):c.high;
    if(lo<pMin)pMin=lo;if(hi>pMax)pMax=hi;if(c.volume>vMax)vMax=c.volume});
  const pR=pMax-pMin||1;
  const py=p=>4+(1-(p-pMin)/pR)*cH;

  // BB fill
  ctx.beginPath();
  candles.forEach((c,i)=>{if(!c.bb)return;const x=8+i*gap+gap/2;if(i===0||!candles[i-1].bb)ctx.moveTo(x,py(c.bb.upper));else ctx.lineTo(x,py(c.bb.upper))});
  for(let i=n-1;i>=0;i--){if(!candles[i].bb)continue;ctx.lineTo(8+i*gap+gap/2,py(candles[i].bb.lower))}
  ctx.closePath();ctx.fillStyle='rgba(49,130,246,.06)';ctx.fill();

  ['upper','middle','lower'].forEach((k,idx)=>{
    ctx.beginPath();ctx.strokeStyle=idx===1?'rgba(49,130,246,.3)':'rgba(49,130,246,.15)';
    ctx.lineWidth=idx===1?1:.5;if(idx!==1)ctx.setLineDash([3,3]);else ctx.setLineDash([]);
    let st=false;candles.forEach((c,i)=>{if(!c.bb)return;const x=8+i*gap+gap/2;if(!st){ctx.moveTo(x,py(c.bb[k]));st=true}else ctx.lineTo(x,py(c.bb[k]))});
    ctx.stroke();ctx.setLineDash([])});

  const pos=data.position;
  if(pos){
    ctx.setLineDash([5,3]);
    [[pos.entryPrice,'#FCD535','진입가'],[pos.stopLoss,'#FF4757','손절'],[pos.takeProfit,'#00C48C','익절']].forEach(([p,c,label])=>{
      ctx.beginPath();ctx.strokeStyle=c;ctx.lineWidth=1;
      ctx.moveTo(0,py(p));ctx.lineTo(W,py(p));ctx.stroke();
      ctx.fillStyle=c;ctx.font='bold 10px Pretendard Variable';ctx.fillText(`${label} ${fmt(p)}`,4,py(p)-4)});
    ctx.setLineDash([]);
  }

  candles.forEach((c,i)=>{
    const x=8+i*gap+gap/2,up=c.close>=c.open,col=up?'#00C48C':'#FF4757';
    ctx.beginPath();ctx.strokeStyle=col;ctx.lineWidth=1;ctx.moveTo(x,py(c.high));ctx.lineTo(x,py(c.low));ctx.stroke();
    const t=py(Math.max(c.open,c.close)),b=py(Math.min(c.open,c.close));
    ctx.fillStyle=col;ctx.fillRect(x-cw/2,t,cw,Math.max(1,b-t));
    const vy=H-(c.volume/(vMax||1))*vH;
    ctx.fillStyle=up?'rgba(0,196,140,.1)':'rgba(255,71,87,.1)';
    ctx.fillRect(x-cw/2,vy,cw,H-vy)});

  const last=candles[n-1];
  if(last){const y=py(last.close);ctx.fillStyle=last.close>=last.open?'#00C48C':'#FF4757';
    ctx.beginPath();ctx.moveTo(W-1,y);ctx.lineTo(W-7,y-4);ctx.lineTo(W-7,y+4);ctx.closePath();ctx.fill();
    ctx.font='bold 10px Pretendard Variable';ctx.textAlign='right';ctx.fillText(fmt(last.close),W-9,y+3);ctx.textAlign='left'}

  const info=document.getElementById('mStats');
  if(pos){
    const pnlPct=((last.close-pos.entryPrice)/pos.entryPrice*100).toFixed(2);
    const up=parseFloat(pnlPct)>=0;
    info.innerHTML=`
      <div class="modal-cell"><div class="v" style="color:var(--yellow)">${fmt(pos.entryPrice)}</div><div class="l">진입가</div></div>
      <div class="modal-cell"><div class="v">${fmt(last.close)}</div><div class="l">현재가</div></div>
      <div class="modal-cell"><div class="v" style="color:${up?'var(--green)':'var(--red)'}">${up?'+':''}${pnlPct}%</div><div class="l">수익률</div></div>`;
  } else {
    info.innerHTML=`
      <div class="modal-cell"><div class="v">${fmt(last.close)}</div><div class="l">현재가</div></div>
      <div class="modal-cell"><div class="v">${fmt(last.high)}</div><div class="l">고가</div></div>
      <div class="modal-cell"><div class="v">${fmt(last.low)}</div><div class="l">저가</div></div>`;
  }
}

// ─── Learning Tab ───

function renderLearning(learn) {
  if (!learn) {
    document.getElementById('learnRight').textContent = '학습 데이터 없음';
    document.getElementById('confLabel').textContent = '-';
    document.getElementById('confFill').style.width = '0%';
    return;
  }

  // Meta
  const ago = learn.updatedAt ? timeAgo(learn.updatedAt) : '-';
  document.getElementById('learnRight').textContent = `${learn.tradesAnalyzed}쌍 분석 · ${ago}`;
  document.getElementById('learnMeta').textContent = `마지막 학습: ${ago} · ${learn.tradesAnalyzed}쌍 분석`;

  // Confidence bar
  const conf = Math.round((learn.confidence || 0) * 100);
  const confColor = conf >= 70 ? 'var(--green)' : conf >= 50 ? 'var(--yellow)' : 'var(--red)';
  document.getElementById('confFill').style.width = conf + '%';
  document.getElementById('confFill').style.background = confColor;
  document.getElementById('confLabel').textContent = conf + '%';
  document.getElementById('confLabel').style.color = confColor;

  // Symbol table
  const syms = learn.analysis?.bySymbol || {};
  const sorted = Object.values(syms).sort((a, b) => (b.score || 0) - (a.score || 0));
  const tbody = document.getElementById('learnSymBody');
  if (sorted.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-tertiary);padding:20px">데이터 없음</td></tr>';
  } else {
    tbody.innerHTML = sorted.map(s => {
      const sym = s.symbol.replace('/KRW', '');
      const pnlColor = s.avgPnl >= 0 ? 'var(--green)' : 'var(--red)';
      const scoreColor = s.score >= 70 ? 'var(--green)' : s.score >= 40 ? 'var(--yellow)' : 'var(--red)';
      const bl = (learn.blacklist || []).includes(s.symbol);
      return `<tr>
        <td style="font-weight:700">${sym}${bl ? ' <span style="color:var(--red);font-size:10px">BAN</span>' : ''}</td>
        <td>${s.trades}</td>
        <td style="font-weight:700">${s.winRate}%</td>
        <td style="color:${pnlColor};font-weight:600">${s.avgPnl >= 0 ? '+' : ''}${s.avgPnl.toFixed(1)}%</td>
        <td style="color:${scoreColor};font-weight:800">${s.score}</td>
      </tr>`;
    }).join('');
  }

  // Hour grid
  const hours = learn.analysis?.byHour || {};
  const preferred = new Set(learn.preferredHours || []);
  const avoid = new Set(learn.avoidHours || []);
  let hourHtml = '';
  for (let h = 0; h < 24; h++) {
    const stat = hours[h];
    let bg = 'rgba(255,255,255,.03)';
    let color = 'var(--text-tertiary)';
    if (stat && stat.trades > 0) {
      if (stat.avgPnl > 1) { bg = 'var(--green-dim)'; color = 'var(--green)'; }
      else if (stat.avgPnl > 0) { bg = 'rgba(99,102,241,.12)'; color = 'var(--accent)'; }
      else if (stat.avgPnl > -1) { bg = 'var(--yellow-dim)'; color = 'var(--yellow)'; }
      else { bg = 'var(--red-dim)'; color = 'var(--red)'; }
    }
    const border = preferred.has(h) ? '2px solid var(--green)' : avoid.has(h) ? '2px solid var(--red)' : '1px solid transparent';
    const pnlText = stat && stat.trades > 0 ? `${stat.avgPnl >= 0 ? '+' : ''}${stat.avgPnl.toFixed(1)}` : '·';
    hourHtml += `<div class="hour-cell" style="background:${bg};color:${color};border:${border}"><div class="h">${h}시</div>${pnlText}</div>`;
  }
  document.getElementById('hourGrid').innerHTML = hourHtml;

  // Params
  const params = learn.params;
  const paramNames = {RSI_OVERSOLD:'RSI 과매도',RSI_OVERBOUGHT:'RSI 과매수',STOP_LOSS_PCT:'손절선',TAKE_PROFIT_PCT:'익절선',MAX_HOLD_HOURS:'최대보유'};
  const paramUnits = {RSI_OVERSOLD:'',RSI_OVERBOUGHT:'',STOP_LOSS_PCT:'%',TAKE_PROFIT_PCT:'%',MAX_HOLD_HOURS:'시간'};
  if (params) {
    document.getElementById('paramList').innerHTML = Object.entries(paramNames).map(([key, name]) => {
      const val = params[key];
      if (val == null) return '';
      return `<div class="param-row"><span class="param-name">${name}</span><span class="param-val">${val}${paramUnits[key]}</span></div>`;
    }).join('');
  } else {
    document.getElementById('paramList').innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-tertiary);font-size:12px">기본값 사용 중</div>';
  }

  // Blacklist
  const bl = learn.blacklist || [];
  const blSection = document.getElementById('blSection');
  if (bl.length > 0) {
    blSection.style.display = 'block';
    document.getElementById('blList').innerHTML = bl.map(s => `<span class="bl-chip">${s.replace('/KRW', '')}</span>`).join('');
  } else {
    blSection.style.display = 'none';
  }
}

function renderCombo(combo) {
  const sec = document.getElementById('comboSection');
  if (!combo?.stats?.length) { sec.style.display = 'none'; return; }
  sec.style.display = 'block';

  const tbody = document.getElementById('comboBody');
  tbody.innerHTML = combo.stats.map(c => {
    const wrColor = c.winRate >= 60 ? 'var(--green)' : c.winRate >= 40 ? 'var(--yellow)' : 'var(--red)';
    const pnlColor = c.avgPnl >= 0 ? 'var(--green)' : 'var(--red)';
    const trendIcon = c.recentTrend === 'improving' ? '<span style="color:var(--green)">↑</span>' :
                      c.recentTrend === 'declining' ? '<span style="color:var(--red)">↓</span>' : '→';
    return `<tr>
      <td style="font-weight:700;font-size:11px">${c.combo}</td>
      <td>${c.trades}</td>
      <td style="color:${wrColor};font-weight:700">${c.winRate}%</td>
      <td style="color:${pnlColor};font-weight:600">${c.avgPnl >= 0 ? '+' : ''}${c.avgPnl}%</td>
      <td style="text-align:center">${trendIcon}</td>
    </tr>`;
  }).join('');

  const meta = combo.minBuyScore;
  if (meta) {
    document.getElementById('comboMeta').textContent = `동적 매수 기준: ${meta.minBuyScore}점 · ${meta.reason}`;
  }
}

function renderBacktest(bt) {
  const sec = document.getElementById('btSection');
  if (!bt?.summary) { sec.style.display = 'none'; return; }
  sec.style.display = 'block';

  const s = bt.summary;
  const results = bt.results || {};
  const symbols = Object.keys(results).filter(k => !results[k].error);

  let html = `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
    <div style="text-align:center"><div style="font-size:18px;font-weight:800">${s.currentAvgWinRate}%</div><div style="font-size:10px;color:var(--text-tertiary)">현재 승률</div></div>
    <div style="text-align:center"><div style="font-size:18px;font-weight:800;color:var(--green)">${s.bestAvgWinRate}%</div><div style="font-size:10px;color:var(--text-tertiary)">최적 승률</div></div>
    <div style="text-align:center"><div style="font-size:18px;font-weight:800;color:${s.improvement > 0 ? 'var(--green)' : 'var(--text-tertiary)'}">${s.improvement > 0 ? '+' : ''}${s.improvement}%p</div><div style="font-size:10px;color:var(--text-tertiary)">개선폭</div></div>
  </div>`;

  // 종목별 결과
  if (symbols.length > 0) {
    html += '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;font-weight:600">종목별 결과</div>';
    html += symbols.map(sym => {
      const r = results[sym];
      const cs = r.currentStrategy?.stats;
      const bs = r.gridSearch?.best?.stats;
      const atr = r.atrComparison;
      if (!cs) return '';
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px">
        <span style="font-weight:700">${sym.replace('/KRW','')}</span>
        <span style="color:var(--text-secondary)">${cs.totalTrades}거래 · 승률 ${cs.winRate}%</span>
        <span style="font-weight:600;color:${cs.returnPct >= 0 ? 'var(--green)' : 'var(--red)'}">${cs.returnPct >= 0 ? '+' : ''}${cs.returnPct}%</span>
        ${atr ? `<span style="font-size:10px;color:${atr.winner === 'ATR' ? 'var(--green)' : 'var(--text-tertiary)'}">${atr.winner === 'ATR' ? 'ATR승' : '고정승'}</span>` : ''}
      </div>`;
    }).join('');
  }

  // 추천 파라미터
  if (s.recommendedParams) {
    const rp = s.recommendedParams;
    html += `<div style="margin-top:12px;padding:10px;background:var(--accent-dim);border-radius:var(--radius-sm);font-size:11px">
      <div style="font-weight:700;color:var(--accent);margin-bottom:4px">추천 파라미터</div>
      <div style="color:var(--text-secondary)">SL ${rp.STOP_LOSS_PCT || '-'}% · TP +${rp.TAKE_PROFIT_PCT || '-'}% · RSI ${rp.RSI_OVERSOLD || '-'}/${rp.RSI_OVERBOUGHT || '-'} · 매수기준 ${rp.BUY_THRESHOLD || '-'}점</div>
    </div>`;
  }

  document.getElementById('btResults').innerHTML = html;
  document.getElementById('btMeta').textContent = bt.runAt ? `마지막 실행: ${timeAgo(bt.runAt)}` : '';
}

function triggerLearning() {
  if (!ws || ws.readyState !== 1) return;
  const btn = document.getElementById('learnBtn');
  btn.disabled = true;
  btn.textContent = '학습 중...';
  ws.send(JSON.stringify({ command: 'run_learning' }));
}

function triggerBacktest() {
  if (!ws || ws.readyState !== 1) return;
  const btn = document.getElementById('btBtn');
  btn.disabled = true;
  btn.textContent = '테스트 중...';
  ws.send(JSON.stringify({ command: 'run_backtest' }));
}

function handleLearningStatus(data) {
  const btn = document.getElementById('learnBtn');
  if (data.status === 'done') {
    btn.disabled = false;
    btn.textContent = '학습 실행';
    showToast({ action: 'BUY', symbol: '학습/완료', amount: 0, reason: '학습 완료' });
  } else if (data.status === 'error') {
    btn.disabled = false;
    btn.textContent = '학습 실행';
  }
}

function handleBacktestStatus(data) {
  const btn = document.getElementById('btBtn');
  if (data.status === 'done') {
    btn.disabled = false;
    btn.textContent = '백테스트';
    btn.style.background = 'var(--bg-card)';
    showToast({ action: 'BUY', symbol: '백테스트/완료', amount: 0, reason: '백테스트 완료' });
    if (data.result) renderBacktest(data.result);
  } else if (data.status === 'error') {
    btn.disabled = false;
    btn.textContent = '백테스트';
  } else if (data.status === 'running') {
    btn.textContent = '실행 중...';
    btn.style.background = 'var(--accent-dim)';
  }
}

function timeAgo(ts) {
  const diff = Date.now() - ts;
  if (diff < 60000) return '방금 전';
  if (diff < 3600000) return Math.round(diff / 60000) + '분 전';
  if (diff < 86400000) return Math.round(diff / 3600000) + '시간 전';
  return Math.round(diff / 86400000) + '일 전';
}

// === SYSTEM TAB ===
const SYSTEM_VERSION = 'v2.1.0';
const INDICATORS = [
  { name: 'RSI', desc: '상대강도지수 — 과매수/과매도 감지', icon: '\u{1F4CA}' },
  { name: '볼린저 밴드', desc: '가격 범위 이탈 감지, 상단/하단 터치', icon: '\u{1F4C8}' },
  { name: 'MACD', desc: '골든크로스/데드크로스, 추세 방향', icon: '\u{3030}\uFE0F' },
  { name: 'VWAP', desc: '거래량가중평균가격 대비 이격도', icon: '\u2696\uFE0F' },
  { name: '거래량 분석', desc: '평균 대비 거래량 급증/급감 감지', icon: '\u{1F4F6}' },
  { name: '멀티타임프레임', desc: '5분/1시간/4시간 봉 방향 종합', icon: '\u{1F504}' },
  { name: '감성 분석', desc: 'Reddit\u00B7뉴스\u00B7Fear&Greed 종합', icon: '\u{1F9E0}' },
  { name: '호가 분석', desc: '매수/매도벽 비율로 방향성 판단', icon: '\u{1F4CB}' },
  { name: '김치 프리미엄', desc: '한국 프리미엄 기반 매수/매도 보정', icon: '\u{1F1F0}\u{1F1F7}' },
  { name: '패턴 인식', desc: '도지\u00B7망치\u00B7삼병 등 캔들스틱 패턴', icon: '\u{1F56F}\uFE0F' },
  { name: '차트 패턴', desc: '삼각수렴\u00B7이중바닥\u00B7헤드앤숄더', icon: '\u{1F4D0}' },
  { name: '상관관계', desc: '보유 종목 간 상관관계로 분산 투자', icon: '\u{1F517}' },
];

const RISK_FEATURES = [
  { name: '자동 손절', desc: '설정된 손절선 도달 시 자동 매도' },
  { name: '분할 매도', desc: '+3%에 30%, +5%에 30%, 나머지 트레일링' },
  { name: '트레일링 스탑', desc: '+3% 후 최고점 대비 -1.5% 이탈 시 매도' },
  { name: '브레이크이븐', desc: '+2% 도달 후 손절선을 매입가로 이동' },
  { name: '휩쏘 방지', desc: '손절선 3회 터치 + 5분 경과 후 매도' },
  { name: 'F&G 역발상', desc: '극단 공포 시 매수 기준 하향 (기회 포착)' },
  { name: '자가학습', desc: '거래 데이터 기반 파라미터 자동 최적화' },
  { name: '콤보 트래커', desc: '시그널 조합별 승률 추적, 저승률 차단' },
  { name: '멀티유저', desc: '최대 3명 독립 봇, 웹 등록, 자동 시작' },
];

function renderSystemTab(d) {
  var indEl = document.getElementById('sysIndicators');
  if (indEl) {
    indEl.innerHTML = INDICATORS.map(function(i) {
      return '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">' +
        '<span style="font-size:18px;width:28px;text-align:center">' + i.icon + '</span>' +
        '<div><div style="font-size:13px;font-weight:600;color:var(--text-primary)">' + i.name + '</div>' +
        '<div style="font-size:11px;color:var(--text-secondary)">' + i.desc + '</div></div>' +
        '<div style="margin-left:auto;width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green-glow);flex-shrink:0"></div>' +
        '</div>';
    }).join('');
  }

  var stratEl = document.getElementById('sysStrategy');
  if (stratEl && d) {
    var regime = d.regime ? ({trending:'추세장',ranging:'횡보장',volatile:'급변장',unknown:'분석중'}[d.regime.regime]||'분석중') : '분석중';
    var fg = d.sentiment ? d.sentiment.fearGreed : null;
    var fgStr = fg ? (fg.value + ' (' + fg.label + ')') : '-';
    var params = [
      ['매수 기준', 'RSI < 32 + 볼밴 하단 + 복합 점수'],
      ['매도 기준', 'RSI > 72 또는 볼밴 상단 + 시그널'],
      ['손절', '-2.5%'],
      ['익절', '+6% (분할: +3%\u219230%, +5%\u219230%)'],
      ['트레일링', '+3% 활성, -1.5% 이탈 시 매도'],
      ['최대 보유', (d.maxPositions||10)+'종목, 종목당 '+(d.maxPositions?Math.round(100/d.maxPositions):10)+'%'],
      ['시장 상태', regime],
      ['Fear & Greed', fgStr],
      ['스캔 주기', '10초'],
      ['캔들', '5분봉 200개'],
    ];
    stratEl.innerHTML = params.map(function(p) {
      return '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)">' +
        '<span style="font-size:12px;color:var(--text-secondary)">' + p[0] + '</span>' +
        '<span style="font-size:12px;font-weight:600;color:var(--text-primary)">' + p[1] + '</span>' +
        '</div>';
    }).join('');
  }

  var topEl = document.getElementById('sysTopStrategies');
  if (topEl && d && d.combo && d.combo.stats && d.combo.stats.length) {
    var top5 = d.combo.stats.filter(function(c){ return c.trades >= 3; }).slice(0, 8);
    if (top5.length) {
      topEl.innerHTML = '<table class="symbol-table"><thead><tr><th>전략 조합</th><th>거래</th><th>승률</th><th>평균</th></tr></thead><tbody>' +
        top5.map(function(c) {
          var wr = c.winRate || 0;
          var color = wr >= 60 ? 'var(--green)' : wr >= 40 ? 'var(--yellow)' : 'var(--red)';
          var avgPnl = c.avgPnl || 0;
          return '<tr><td style="font-size:11px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + c.combo + '</td><td>' + c.trades + '</td><td style="color:' + color + ';font-weight:600">' + wr + '%</td><td style="color:' + (avgPnl>=0?'var(--green)':'var(--red)') + '">' + (avgPnl>0?'+':'') + avgPnl.toFixed(1) + '%</td></tr>';
        }).join('') +
        '</tbody></table>';
    } else {
      topEl.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-tertiary);font-size:13px">아직 데이터가 부족합니다 (최소 3건 필요)</div>';
    }
  }

  var liveEl = document.getElementById('sysLiveStatus');
  if (liveEl && d) {
    var items = [
      ['감시 종목', (d.symbols ? d.symbols.length : 0) + '개'],
      ['보유 포지션', (d.positionCount || 0) + '개'],
      ['오늘 매수', ((d.stats && d.stats.todayBuys) || 0) + '회'],
      ['오늘 매도', ((d.stats && d.stats.totalTrades) || 0) + '회'],
      ['승률', ((d.stats && d.stats.winRate) || 0) + '%'],
      ['일일 손익', (d.dailyPnl >= 0 ? '+' : '') + (d.dailyPnl || 0).toLocaleString() + '원'],
      ['학습 신뢰도', d.learning ? (Math.round(d.learning.confidence * 100) + '%') : '-'],
      ['분석 거래', d.learning ? (d.learning.tradesAnalyzed + '건') : '-'],
    ];
    liveEl.innerHTML = items.map(function(it) {
      return '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)">' +
        '<span style="font-size:12px;color:var(--text-secondary)">' + it[0] + '</span>' +
        '<span style="font-size:12px;font-weight:600;color:var(--text-primary)">' + it[1] + '</span>' +
        '</div>';
    }).join('') +
    RISK_FEATURES.map(function(f) {
      return '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">' +
        '<div style="width:6px;height:6px;border-radius:50%;background:var(--green);flex-shrink:0"></div>' +
        '<div><span style="font-size:12px;font-weight:600;color:var(--text-primary)">' + f.name + '</span>' +
        '<span style="font-size:11px;color:var(--text-secondary)"> \u2014 ' + f.desc + '</span></div>' +
        '</div>';
    }).join('');
  }

  var verEl = document.getElementById('sysVersion');
  if (verEl) verEl.textContent = SYSTEM_VERSION;
}

// === UPDATES TAB ===
const CHANGELOG = [
  {
    version: 'v2.7.0',
    date: '2026-02-17',
    title: '마켓 모드 자동 전환 + BTC 도미넌스',
    changes: [
      '3가지 마켓 모드: 공격(상승장) / 방어(하락장) / 스캘핑(횡보장)',
      'F&G + 레짐 + BTC 모멘텀 + BTC 도미넌스 종합 판단',
      '모드별 자동 파라미터: 매수기준, 포지션크기, 손절/익절, 트레일링, 최대보유',
      '방어 모드: 포지션 2개, -1.5% 손절, +3% 익절, DCA 비활성',
      '공격 모드: 포지션 4개, -2.5% 손절, +7% 익절, 넓은 트레일링',
      'BTC 도미넌스 추적 (CoinGecko): 알트 시즌/알트 약세 감지',
      '대시보드에 현재 마켓 모드 + 판단 근거 표시',
    ],
  },
  {
    version: 'v2.6.0',
    date: '2026-02-16',
    title: '승률 개선 4종',
    changes: [
      'EMA 트렌드 필터 (EMA20 < EMA50 하락추세 → 매수 -1.5)',
      '거래량 차단 강화 (외부 부스트로 점수 올라가도 0.5x 미만 완전 차단)',
      '정체 포지션 조기 정리 (3시간 → 2시간)',
      '종목별 최근 승률 가중치 (80%+ → +20%, 20%- → -30%)',
    ],
  },
  {
    version: 'v2.5.0',
    date: '2026-02-16',
    title: '스마트 적응 필터',
    changes: [
      '새벽 시간대(00-06시) 매수 기준 +0.5 강화 (미국장 허용)',
      '연속 2패 이상 → 30분 강제 쿨다운 + 매수 기준 강화',
      'F&G 극단 공포(20 미만) → 최소 매수 점수 +1.0 상향',
      '오늘 승률 40% 미만(5거래+) → 포지션 크기 50% 축소',
      '거래 내역/최근 활동 실시간 업데이트 수정',
      'DCA(물타기) 거래 올바른 표시',
    ],
  },
  {
    version: 'v2.4.0',
    date: '2026-02-16',
    title: '수익 극대화 8종 기능',
    changes: [
      'BB 스퀴즈 감지 (볼린저+켈트너 압축 돌파 시그널)',
      'BTC 선행 지표 (BTC 5분 변화율 → 알트코인 부스트)',
      '고래벽 감지 (호가창 5x 대형주문 → 지지/저항)',
      '손절 패턴 AI 분석 (RSI/BB/시간/레짐별 70%+ 차단)',
      '종목별 최적 보유시간 학습 (수익거래 기반)',
      '수수료 포함 실수익 표시 (0.05%×2)',
      '스캘핑 모드 (4.5점+ → +0.8% 빠른 익절, 포지션 꽉 차도 +1 추가 슬롯)',
      '현금 70% 활용 (BASE_POSITION_PCT 22→23%)',
    ],
  },
  {
    version: 'v2.3.0',
    date: '2026-02-16',
    title: '전략 종합 리뷰 + 버그 수정',
    changes: [
      'volatile 레짐 감지 기준 완화 (ATR 50→80%, 3→4%)',
      'volatile 레짐에서 DCA 물타기 차단',
      'F&G 극공포 + volatile = 매수 기준 강화 (기존: 하향)',
      '변동성 돌파 매수 안전장치 (RSI<60, BB<0.85)',
      'MAX_POSITIONS 10→3 소액계좌 집중',
    ],
  },
  {
    version: 'v2.2.0',
    date: '2026-02-16',
    title: '업비트 잔고 연동 + AI 챗봇',
    changes: [
      '홈 화면 업비트 실제 총 자산 표시',
      '현금/투자 비율 바 차트',
      '현재 평가손익 박스 (원가/현재가/평가손익)',
      '오늘 실현/미실현 손익 분리 표시',
      'AI 챗봇 (Claude Haiku, 월 $1 미만)',
      'animCount 에러 수정',
    ],
  },
  {
    version: 'v2.1.0',
    date: '2026-02-16',
    title: '통계 개선 + 포지션 확대',
    changes: [
      '홈 화면 승률/통계: 오늘만 → 전체 누적으로 변경',
      '매매 기록: 전체 최근 50건 표시 (날짜별 그루핑)',
      '홈 화면에 자가학습 요약 카드 추가 (신뢰도, 분석 쌍, 평균수익)',
      '포지션 제한 4개 → 10개로 확대',
      '지정가 주문 (30초 타임아웃 → 시장가 폴백)',
      '변동성 돌파 전략 (Larry Williams K=0.5)',
      '자동 파라미터 튜닝 (7일마다)',
      '블랙/화이트리스트 UI (설정 탭)',
      '김프 알림 (프리미엄 5% 이상/역프 -2% 이하)',
      '수익률 차트 (Canvas 30일 P&L)',
    ],
  },
  {
    version: 'v2.0.0',
    date: '2026-02-16',
    title: '멀티유저 지원',
    changes: [
      '최대 3명 독립 봇 인스턴스 지원',
      '웹 등록 페이지 (/register) \u2014 친구가 직접 API 키 등록',
      '초대 코드 보안',
      '등록 후 PM2 재시작 없이 봇 자동 시작',
      '유저별 포트 자동 할당 (3737, 3738, ...)',
      '전체 유저 거래 데이터 취합 \u2192 글로벌 학습',
      'F&G 역발상: 극단 공포 시 매수 기회로 전환',
      '강한 시그널(4점+) 확인 캔들 없이 즉시 매수',
      '약한 음봉(-0.3% 이내) 매수 허용',
    ],
  },
  {
    version: 'v1.5.0',
    date: '2026-02-15',
    title: '자가학습 + 콤보 트래커',
    changes: [
      '거래 데이터 기반 자가학습 (RSI, 손절, 익절 자동 최적화)',
      '시그널 조합(콤보)별 승률 추적',
      '저승률 콤보 자동 차단',
      '동적 매수 기준 (콤보 기반)',
      'Contextual Bandit: 시장 상황별 최적 프로필',
      '백테스트 자동 실행 (학습 후)',
      '블랙리스트 종목 자동 회피',
    ],
  },
  {
    version: 'v1.4.0',
    date: '2026-02-14',
    title: '호가 분석 + 김치 프리미엄',
    changes: [
      '호가창 매수/매도벽 비율 분석',
      '김치 프리미엄 실시간 추적',
      '프리미엄 기반 매수/매도 보정',
      '성과 지표 추가 (Sharpe, Sortino, Profit Factor)',
      '드로다운 기반 동적 포지션 사이징',
    ],
  },
  {
    version: 'v1.3.0',
    date: '2026-02-13',
    title: '멀티타임프레임 + 감성 분석',
    changes: [
      '5분/1시간/4시간 봉 종합 분석 (MTF)',
      'Reddit 감성 분석 (r/cryptocurrency)',
      '뉴스 감성 분석',
      'Fear & Greed Index 연동',
      '감성 기반 매수/매도 부스트',
      '확인 캔들 필터 (매수 전 다음 봉 확인)',
    ],
  },
  {
    version: 'v1.2.0',
    date: '2026-02-12',
    title: '트레일링 스탑 + 분할 매도',
    changes: [
      '트레일링 스탑 (+3% 활성, -1.5% 이탈)',
      '브레이크이븐 자동 이동 (+2% 도달 시)',
      '3단계 분할 매도 (+3%/30%, +5%/30%, 나머지)',
      '거래량 상위 20종목 자동 갱신 (1시간 주기)',
      '쿨다운 시스템 (매도 후 10분)',
      '휩쏘 방지 (손절선 3회 터치 룰)',
    ],
  },
  {
    version: 'v1.1.0',
    date: '2026-02-11',
    title: 'MACD + 패턴 인식',
    changes: [
      'MACD 골든크로스/데드크로스',
      'VWAP 이격도 분석',
      '캔들스틱 패턴 인식 (도지, 망치, 삼병 등)',
      '차트 패턴 감지 (삼각수렴, 이중바닥, 헤드앤숄더)',
      '상관관계 기반 분산 투자',
      '레짐 감지 (추세/횡보/급변)',
    ],
  },
  {
    version: 'v1.0.0',
    date: '2026-02-10',
    title: '첫 출시',
    changes: [
      'RSI 과매수/과매도 기반 매매',
      '볼린저 밴드 상단/하단 터치',
      '거래량 급증 감지',
      '자동 손절/익절',
      '실시간 대시보드 (WebSocket)',
      'PM2 프로세스 관리',
    ],
  },
];

function renderUpdatesTab() {
  var el = document.getElementById('updatesList');
  if (!el) return;

  el.innerHTML = CHANGELOG.map(function(release, idx) {
    var isLatest = idx === 0;
    var borderStyle = isLatest ? 'border:1px solid var(--accent);box-shadow:0 0 20px rgba(49,130,246,.1)' : '';
    var titleColor = isLatest ? 'var(--accent)' : 'var(--text-primary)';
    var latestBadge = isLatest ? '<span style="font-size:10px;background:var(--accent);color:#fff;padding:2px 8px;border-radius:10px;font-weight:600">LATEST</span>' : '';

    return '<div class="glass" style="padding:16px;margin-bottom:12px;' + borderStyle + '">' +
      '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">' +
      '<div style="display:flex;align-items:center;gap:8px">' +
      '<span style="font-size:14px;font-weight:700;color:' + titleColor + '">' + release.version + '</span>' +
      latestBadge +
      '</div>' +
      '<span style="font-size:11px;color:var(--text-tertiary)">' + release.date + '</span>' +
      '</div>' +
      '<div style="font-size:13px;font-weight:600;color:var(--text-primary);margin-bottom:8px">' + release.title + '</div>' +
      '<div style="display:flex;flex-direction:column;gap:4px">' +
      release.changes.map(function(c) {
        return '<div style="display:flex;align-items:flex-start;gap:6px;font-size:12px;color:var(--text-secondary)">' +
          '<span style="color:var(--green);flex-shrink:0;margin-top:1px">+</span>' +
          '<span>' + c + '</span>' +
          '</div>';
      }).join('') +
      '</div>' +
      '</div>';
  }).join('');
}

// === P&L CHART (Canvas) ===
var pnlChartData = null;
var currentPnlTf = '1d';

function setPnlTf(tf) {
  currentPnlTf = tf;
  var btns = document.querySelectorAll('.pnl-tf-btn');
  for (var i = 0; i < btns.length; i++) {
    btns[i].className = btns[i].getAttribute('data-tf') === tf ? 'pnl-tf-btn active' : 'pnl-tf-btn';
  }
  fetchPnlHistory();
}

function fetchPnlHistory() {
  fetch('/api/pnl-history?tf=' + currentPnlTf)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      pnlChartData = data;
      drawPnlChart(data);
    })
    .catch(function(e) {
      console.error('PnL history fetch error:', e);
    });
}

function drawPnlChart(data) {
  var wrap = document.getElementById('pnlChartWrap');
  var canvas = document.getElementById('pnlCanvas');
  var empty = document.getElementById('pnlChartEmpty');

  if (!data || data.length < 1) {
    canvas.style.display = 'none';
    empty.style.display = 'flex';
    empty.textContent = '매도 거래 데이터가 없습니다';
    return;
  }
  // 데이터가 1개면 시작점(0) 추가해서 최소 2포인트 확보
  if (data.length === 1) {
    data = [{ date: '', pnl: 0, cumulative: 0, trades: 0 }, data[0]];
  }

  canvas.style.display = 'block';
  empty.style.display = 'none';

  var dpr = window.devicePixelRatio || 1;
  var rect = wrap.getBoundingClientRect();
  var W = rect.width;
  var H = 200;
  canvas.width = W * dpr;
  canvas.height = H * dpr;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  var ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  var vals = data.map(function(d) { return d.cumulative; });
  var padL = 55, padR = 12, padT = 16, padB = 30;
  var cW = W - padL - padR;
  var cH = H - padT - padB;

  var mn = Math.min.apply(null, vals.concat([0]));
  var mx = Math.max.apply(null, vals.concat([0]));
  var range = mx - mn || 1;
  // Add 10% padding
  mn = mn - range * 0.1;
  mx = mx + range * 0.1;
  range = mx - mn;

  var n = vals.length;
  var stepX = cW / Math.max(1, n - 1);

  function xPos(i) { return padL + i * stepX; }
  function yPos(v) { return padT + (1 - (v - mn) / range) * cH; }

  // Clear
  ctx.clearRect(0, 0, W, H);

  // Grid lines (horizontal)
  ctx.strokeStyle = 'rgba(255,255,255,0.06)';
  ctx.lineWidth = 0.5;
  var gridCount = 4;
  for (var g = 0; g <= gridCount; g++) {
    var gv = mn + (range * g / gridCount);
    var gy = yPos(gv);
    ctx.beginPath();
    ctx.moveTo(padL, gy);
    ctx.lineTo(W - padR, gy);
    ctx.stroke();

    // Y-axis labels
    ctx.fillStyle = 'rgba(255,255,255,0.35)';
    ctx.font = '10px Pretendard Variable, sans-serif';
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    var label = Math.round(gv).toLocaleString();
    ctx.fillText(label, padL - 6, gy);
  }

  // Zero line
  var zeroY = yPos(0);
  ctx.strokeStyle = 'rgba(255,255,255,0.15)';
  ctx.lineWidth = 1;
  ctx.setLineDash([4, 4]);
  ctx.beginPath();
  ctx.moveTo(padL, zeroY);
  ctx.lineTo(W - padR, zeroY);
  ctx.stroke();
  ctx.setLineDash([]);

  // Gradient fill
  var lastVal = vals[n - 1];
  var isPositive = lastVal >= 0;
  var lineColor = isPositive ? '#00C48C' : '#FF4757';
  var fillGrad = ctx.createLinearGradient(0, padT, 0, padT + cH);
  if (isPositive) {
    fillGrad.addColorStop(0, 'rgba(0,196,140,0.18)');
    fillGrad.addColorStop(1, 'rgba(0,196,140,0.0)');
  } else {
    fillGrad.addColorStop(0, 'rgba(255,71,87,0.0)');
    fillGrad.addColorStop(1, 'rgba(255,71,87,0.18)');
  }

  // Fill area from line to zero
  ctx.beginPath();
  ctx.moveTo(xPos(0), zeroY);
  for (var i = 0; i < n; i++) {
    ctx.lineTo(xPos(i), yPos(vals[i]));
  }
  ctx.lineTo(xPos(n - 1), zeroY);
  ctx.closePath();
  ctx.fillStyle = fillGrad;
  ctx.fill();

  // Draw line segments (green above zero, red below)
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  ctx.lineCap = 'round';
  for (var i = 0; i < n - 1; i++) {
    var segColor = vals[i + 1] >= 0 ? '#00C48C' : '#FF4757';
    ctx.beginPath();
    ctx.strokeStyle = segColor;
    ctx.moveTo(xPos(i), yPos(vals[i]));
    ctx.lineTo(xPos(i + 1), yPos(vals[i + 1]));
    ctx.stroke();
  }

  // End dot
  ctx.beginPath();
  ctx.arc(xPos(n - 1), yPos(vals[n - 1]), 4, 0, Math.PI * 2);
  ctx.fillStyle = lineColor;
  ctx.fill();
  ctx.beginPath();
  ctx.arc(xPos(n - 1), yPos(vals[n - 1]), 6, 0, Math.PI * 2);
  ctx.strokeStyle = lineColor;
  ctx.lineWidth = 1.5;
  ctx.globalAlpha = 0.4;
  ctx.stroke();
  ctx.globalAlpha = 1;

  // X-axis labels (show ~5 dates)
  ctx.fillStyle = 'rgba(255,255,255,0.35)';
  ctx.font = '10px Pretendard Variable, sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  var labelInterval = Math.max(1, Math.floor(n / 5));
  for (var i = 0; i < n; i++) {
    if (i % labelInterval === 0 || i === n - 1) {
      var dt = data[i].date || '';
      var shortDate = currentPnlTf === '1d' ? dt.slice(5) : dt;
      ctx.fillText(shortDate, xPos(i), H - padB + 8);
    }
  }

  // End value label
  ctx.fillStyle = lineColor;
  ctx.font = 'bold 11px Pretendard Variable, sans-serif';
  ctx.textAlign = 'left';
  ctx.textBaseline = 'middle';
  var endLabel = (lastVal >= 0 ? '+' : '') + Math.round(lastVal).toLocaleString() + '원';
  var endLabelX = xPos(n - 1) + 8;
  if (endLabelX + 60 > W) endLabelX = xPos(n - 1) - 8 - ctx.measureText(endLabel).width;
  ctx.fillText(endLabel, endLabelX, yPos(lastVal));

  // Touch interaction — crosshair + tooltip
  var pnlTooltip = document.getElementById('pnlTooltip');
  if (!pnlTooltip) {
    pnlTooltip = document.createElement('div');
    pnlTooltip.id = 'pnlTooltip';
    pnlTooltip.style.cssText = 'position:absolute;top:0;left:0;pointer-events:none;display:none;z-index:10;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:11px;font-weight:700;color:var(--text-primary);white-space:nowrap;box-shadow:0 4px 12px rgba(0,0,0,.3)';
    wrap.appendChild(pnlTooltip);
  }
  var crosshair = document.getElementById('pnlCrosshair');
  if (!crosshair) {
    crosshair = document.createElement('div');
    crosshair.id = 'pnlCrosshair';
    crosshair.style.cssText = 'position:absolute;top:0;width:1px;pointer-events:none;display:none;z-index:5;background:var(--text-tertiary);opacity:.5';
    wrap.appendChild(crosshair);
  }
  var crossDot = document.getElementById('pnlCrossDot');
  if (!crossDot) {
    crossDot = document.createElement('div');
    crossDot.id = 'pnlCrossDot';
    crossDot.style.cssText = 'position:absolute;width:8px;height:8px;border-radius:50%;pointer-events:none;display:none;z-index:6;border:2px solid var(--bg-primary)';
    wrap.appendChild(crossDot);
  }

  function handlePnlTouch(e) {
    e.preventDefault();
    var touch = e.touches ? e.touches[0] : e;
    var rect = canvas.getBoundingClientRect();
    var x = touch.clientX - rect.left;
    var idx = Math.round((x - padL) / stepX);
    if (idx < 0) idx = 0; if (idx >= n) idx = n - 1;
    var val = vals[idx];
    var dt = data[idx].date || '';
    var color = val >= 0 ? 'var(--green)' : 'var(--red)';
    var pxX = xPos(idx) / W * 100;
    var pxY = yPos(val) / H * 100;

    crosshair.style.display = 'block';
    crosshair.style.left = (pxX) + '%';
    crosshair.style.height = '100%';

    crossDot.style.display = 'block';
    crossDot.style.left = 'calc(' + pxX + '% - 4px)';
    crossDot.style.top = pxY + '%';
    crossDot.style.background = val >= 0 ? '#00C48C' : '#FF4757';

    pnlTooltip.style.display = 'block';
    pnlTooltip.innerHTML = '<span style="color:var(--text-tertiary)">' + dt + '</span><br><span style="color:' + color + '">' + (val >= 0 ? '+' : '') + Math.round(val).toLocaleString() + '원</span>';
    var tipLeft = pxX > 70 ? (pxX - 30) : (pxX + 2);
    pnlTooltip.style.left = tipLeft + '%';
    pnlTooltip.style.top = Math.max(4, pxY - 20) + '%';
  }

  function hidePnlTouch() {
    crosshair.style.display = 'none';
    crossDot.style.display = 'none';
    pnlTooltip.style.display = 'none';
  }

  canvas.removeEventListener('touchstart', handlePnlTouch);
  canvas.removeEventListener('touchmove', handlePnlTouch);
  canvas.removeEventListener('touchend', hidePnlTouch);
  canvas.addEventListener('touchstart', handlePnlTouch, { passive: false });
  canvas.addEventListener('touchmove', handlePnlTouch, { passive: false });
  canvas.addEventListener('touchend', hidePnlTouch);
}

// === SETTINGS TAB: Blacklist/Whitelist ===
var currentBlData = { mode: 'blacklist', symbols: [] };

function fetchBlacklist() {
  fetch('/api/blacklist')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      currentBlData = data;
      renderBlacklist(data);
    })
    .catch(function(e) { console.error('Blacklist fetch error:', e); });
}

function renderBlacklist(data) {
  var mode = data.mode || 'blacklist';
  var symbols = data.symbols || [];

  // Update mode toggle
  var btnBlack = document.getElementById('blModeBlack');
  var btnWhite = document.getElementById('blModeWhite');
  if (mode === 'whitelist') {
    btnBlack.className = 'bl-mode-btn';
    btnWhite.className = 'bl-mode-btn active';
    document.getElementById('blModeDesc').textContent = '화이트리스트: 아래 종목만 매매합니다';
  } else {
    btnBlack.className = 'bl-mode-btn active';
    btnWhite.className = 'bl-mode-btn';
    document.getElementById('blModeDesc').textContent = '블랙리스트: 아래 종목을 매매에서 제외합니다';
  }

  // Render tags
  var container = document.getElementById('blTagsContainer');
  var emptyEl = document.getElementById('blTagsEmpty');
  if (symbols.length === 0) {
    container.innerHTML = '<div class="bl-empty" id="blTagsEmpty">등록된 종목이 없습니다</div>';
    return;
  }

  var tagCls = mode === 'whitelist' ? 'whitelist' : 'blacklist';
  container.innerHTML = symbols.map(function(sym) {
    var short = sym.replace('/KRW', '');
    return '<span class="bl-tag ' + tagCls + '">' + short +
      ' <span class="bl-x" onclick="removeBlSymbol(\'' + sym + '\')">&times;</span></span>';
  }).join('');
}

function setBlMode(mode) {
  fetch('/api/blacklist', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'set_mode', mode: mode })
  })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        currentBlData = data;
        renderBlacklist(data);
      }
    })
    .catch(function(e) { console.error('Set mode error:', e); });
}

function addBlSymbol() {
  var input = document.getElementById('blSymInput');
  var val = input.value.trim();
  if (!val) return;

  fetch('/api/blacklist', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'add', symbol: val })
  })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        currentBlData = data;
        renderBlacklist(data);
        input.value = '';
      }
    })
    .catch(function(e) { console.error('Add symbol error:', e); });
}

function removeBlSymbol(sym) {
  fetch('/api/blacklist', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'remove', symbol: sym })
  })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        currentBlData = data;
        renderBlacklist(data);
      }
    })
    .catch(function(e) { console.error('Remove symbol error:', e); });
}

// Handle Enter key in blacklist input
document.addEventListener('DOMContentLoaded', function() {
  var blInput = document.getElementById('blSymInput');
  if (blInput) {
    blInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') addBlSymbol();
    });
  }
});

// === Render settings tab from status data ===
function renderSettingsTab(d) {
  // Update learned blacklist section
  var learn = d && d.learning;
  var learnBl = learn && learn.blacklist ? learn.blacklist : [];
  var learnContainer = document.getElementById('learnBlTags');
  if (learnContainer) {
    if (learnBl.length === 0) {
      learnContainer.innerHTML = '<div class="bl-empty">학습 블랙리스트 없음</div>';
    } else {
      learnContainer.innerHTML = learnBl.map(function(sym) {
        var short = sym.replace('/KRW', '');
        return '<span class="bl-tag blacklist">' + short + '</span>';
      }).join('');
    }
  }

  // Settings right info
  var el = document.getElementById('settingsRight');
  if (el) {
    var total = currentBlData.symbols ? currentBlData.symbols.length : 0;
    el.textContent = total + '개 종목 필터';
  }
}

// === AI Chatbot ===
let chatOpen=false;
let chatSending=false;

function toggleChat(){
  chatOpen=!chatOpen;
  document.getElementById('chatPanel').classList.toggle('open',chatOpen);
  document.getElementById('chatFab').classList.toggle('has-panel',chatOpen);
  document.getElementById('chatFab').textContent=chatOpen?'✕':'💬';
  if(chatOpen)document.getElementById('chatInput').focus();
}

function chatQuick(msg){
  document.getElementById('chatInput').value=msg;
  sendChat();
}

function addChatMsg(text,role){
  var el=document.getElementById('chatMessages');
  var div=document.createElement('div');
  div.className='chat-msg '+role;
  div.textContent=text;
  el.appendChild(div);
  el.scrollTop=el.scrollHeight;
  return div;
}

async function sendChat(){
  if(chatSending)return;
  var input=document.getElementById('chatInput');
  var msg=input.value.trim();
  if(!msg)return;
  input.value='';
  addChatMsg(msg,'user');
  var loadingEl=addChatMsg('생각 중...','bot loading');
  chatSending=true;
  document.getElementById('chatSendBtn').disabled=true;
  try{
    var r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});
    var data=await r.json();
    loadingEl.remove();
    addChatMsg(data.reply||'응답 없음','bot');
  }catch(e){
    loadingEl.remove();
    addChatMsg('연결 오류: '+e.message,'bot');
  }finally{
    chatSending=false;
    document.getElementById('chatSendBtn').disabled=false;
  }
}

// 즉시 HTTP 폴링 시작 (WebSocket 관계없이)
startPolling();
renderUpdatesTab();
fetchPnlHistory();
fetchBlacklist();
// Refresh PnL chart every 60 seconds
setInterval(fetchPnlHistory, 60000);
// WebSocket도 시도
try{connect()}catch(e){document.getElementById('sLabel').textContent='WS실패:'+e.message}

// PWA Service Worker 등록
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').then(()=>console.log('SW 등록 완료')).catch(e=>console.log('SW 등록 실패:',e));
}

// PWA 설치 프롬프트 (Android/Chrome)
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  deferredPrompt=e;
  showInstallBtn('android');
});

// iOS Safari 감지 → 수동 설치 안내
(function(){
  var isIos=/iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
  var isSafari=/safari/.test(navigator.userAgent.toLowerCase())&&!/chrome/.test(navigator.userAgent.toLowerCase());
  var isStandalone=window.navigator.standalone===true||window.matchMedia('(display-mode:standalone)').matches;
  if(isIos&&isSafari&&!isStandalone){
    showInstallBtn('ios');
  }
})();

function showInstallBtn(type){
  if(document.getElementById('installBtn'))return;
  var btn=document.createElement('div');
  btn.id='installBtn';
  btn.style.cssText='position:fixed;top:12px;right:12px;z-index:200;background:var(--accent);color:#fff;padding:10px 16px;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(49,130,246,.3);display:flex;align-items:center;gap:6px;max-width:280px';
  if(type==='ios'){
    btn.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>홈 화면에 추가하기';
    btn.onclick=function(){
      var guide=document.createElement('div');
      guide.id='iosGuide';
      guide.style.cssText='position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;text-align:center;color:#fff;font-size:14px;gap:16px';
      guide.innerHTML='<div style="font-size:20px;font-weight:800">앱처럼 설치하기</div>'
        +'<div style="font-size:40px">&#x2B06;&#xFE0F;</div>'
        +'<div>1. 아래 <b>공유 버튼</b> <span style="font-size:18px">&#x1F4E4;</span> 탭</div>'
        +'<div>2. <b>"홈 화면에 추가"</b> 선택</div>'
        +'<div>3. 오른쪽 위 <b>"추가"</b> 탭</div>'
        +'<div style="margin-top:12px;font-size:11px;color:#888">풀스크린 앱처럼 실행됩니다</div>'
        +'<div onclick="this.parentNode.remove()" style="margin-top:16px;background:var(--accent);padding:10px 24px;border-radius:12px;cursor:pointer;font-weight:700">확인</div>';
      document.body.appendChild(guide);
      btn.remove();
    };
  } else {
    btn.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>앱 설치';
    btn.onclick=async function(){
      if(!deferredPrompt)return;
      deferredPrompt.prompt();
      var result=await deferredPrompt.userChoice;
      if(result.outcome==='accepted')btn.remove();
      deferredPrompt=null;
    };
  }
  document.body.appendChild(btn);
  setTimeout(function(){if(btn.parentNode)btn.style.opacity='0.6'},15000);
}

window.addEventListener('appinstalled',function(){
  var btn=document.getElementById('installBtn');
  if(btn)btn.remove();
});

// === PULL TO REFRESH ===
(function(){
  var tc=document.getElementById('tabContent');
  var ptr=document.getElementById('ptrIndicator');
  var startY=0,pulling=false;
  tc.addEventListener('touchstart',function(e){
    if(tc.scrollTop===0) startY=e.touches[0].clientY;
    else startY=0;
  },{passive:true});
  tc.addEventListener('touchmove',function(e){
    if(!startY)return;
    var dy=e.touches[0].clientY-startY;
    if(dy>60&&!pulling){pulling=true;ptr.classList.add('visible');}
  },{passive:true});
  tc.addEventListener('touchend',function(){
    if(pulling){
      pulling=false;
      fetchStatus();
      setTimeout(function(){ptr.classList.remove('visible');},1200);
    }
    startY=0;
  });
})();

// === PRICE FLASH ===
var prevPrices={};
function flashPrice(el,sym,newPrice){
  var old=prevPrices[sym];
  if(old!==undefined&&old!==newPrice){
    el.classList.remove('flash-up','flash-down');
    void el.offsetWidth;
    el.classList.add(newPrice>old?'flash-up':'flash-down');
  }
  prevPrices[sym]=newPrice;
}

// === CONFETTI ===
function showConfetti(){
  var wrap=document.createElement('div');
  wrap.className='confetti-wrap';
  var colors=['#00C48C','#3182F6','#FCD535','#FF4757','#A78BFA','#38BDF8','#E879F9'];
  for(var i=0;i<40;i++){
    var p=document.createElement('div');
    p.className='confetti-piece';
    p.style.left=Math.random()*100+'%';
    p.style.background=colors[Math.floor(Math.random()*colors.length)];
    p.style.animationDelay=(Math.random()*0.8)+'s';
    p.style.animationDuration=(2+Math.random()*1.5)+'s';
    p.style.width=(6+Math.random()*6)+'px';
    p.style.height=(6+Math.random()*6)+'px';
    p.style.borderRadius=Math.random()>0.5?'50%':'2px';
    wrap.appendChild(p);
  }
  document.body.appendChild(wrap);
  setTimeout(function(){wrap.remove();},4000);
}

// === HEATMAP VIEW ===
var marketViewMode='list';
function setMarketView(mode){
  marketViewMode=mode;
  document.getElementById('mktViewList').classList.toggle('active',mode==='list');
  document.getElementById('mktViewHeat').classList.toggle('active',mode==='heat');
  document.getElementById('marketList').style.display=mode==='list'?'':'none';
  document.getElementById('marketHeatmap').style.display=mode==='heat'?'':'none';
  if(mode==='heat'&&lastData) renderHeatmap(lastData);
}

function renderHeatmap(d){
  var el=document.getElementById('marketHeatmap');
  var syms=(d.symbolData||[]).slice().sort(function(a,b){return(b.volume||0)-(a.volume||0);});
  el.innerHTML=syms.map(function(s){
    var chg=s.change||0;
    var sym=s.symbol.replace('/KRW','');
    var intensity=Math.min(Math.abs(chg)/5,1);
    var bg;
    if(chg>0) bg='rgba(0,196,140,'+(.15+intensity*.45)+')';
    else if(chg<0) bg='rgba(255,71,87,'+(.15+intensity*.45)+')';
    else bg='rgba(255,255,255,.06)';
    var vol=s.volume?(s.volume/1e8).toFixed(1)+'억':'';
    return'<div class="hm-cell" onclick="openChart(\''+s.symbol+'\')" style="background:'+bg+'"><div class="hm-sym">'+sym+'</div><div class="hm-pct">'+(chg>=0?'+':'')+chg.toFixed(1)+'%</div>'+(vol?'<div class="hm-vol">'+vol+'</div>':'')+'</div>';
  }).join('');
}

// === DAILY GOAL ===
function renderDailyGoal(todayPnl,totalAsset){
  var el=document.getElementById('dailyGoal');
  if(!totalAsset||totalAsset<=0){el.style.display='none';return;}
  el.style.display='';
  var goalPct=0.5; // 0.5% daily target
  var goalAmt=totalAsset*goalPct/100;
  var progress=Math.max(0,Math.min(200,(todayPnl/goalAmt)*100));
  var pctEl=document.getElementById('dgPct');
  var fillEl=document.getElementById('dgFill');
  pctEl.textContent=progress.toFixed(0)+'% ('+Math.round(todayPnl).toLocaleString()+'/'+Math.round(goalAmt).toLocaleString()+'원)';
  pctEl.style.color=progress>=100?'var(--green)':progress>=50?'var(--accent)':'var(--yellow)';
  fillEl.style.width=Math.min(100,progress)+'%';
  fillEl.className='dg-bar-fill '+(progress>=100?'achieved':progress>=50?'on-track':'behind');
}
</script>
</body>
</html>
